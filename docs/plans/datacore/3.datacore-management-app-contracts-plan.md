# Kế hoạch chi tiết: Tầng Application.Contracts (`Aqt.CoreFW.Application.Contracts`) - Quản lý Danh mục Dữ liệu Cốt lõi (DataCore Management)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Application.Contracts` cho module Quản lý Danh mục Dữ liệu Cốt lõi (DataCore).

## 1. DTOs

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Application.Contracts/DataCores/Dtos` (Tạo thư mục `DataCores/Dtos` nếu chưa có)
-   **Tệp 1:** Tạo file `DataCoreDto.cs`
    ```csharp
    using System;
    using Aqt.CoreFW.DataCores; // Sử dụng Enum/Consts từ Domain.Shared namespace
    using Volo.Abp.Application.Dtos;

    namespace Aqt.CoreFW.Application.Contracts.DataCores.Dtos;

    public class DataCoreDto : FullAuditedEntityDto<Guid> // Kế thừa FullAuditedEntityDto
    {
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public DataCoreStatus Status { get; set; }
        public int Order { get; set; }
        public string? Description { get; set; }
        public Guid DataGroupId { get; set; } // ID của nhóm dữ liệu

        // Thông tin bổ sung về nhóm dữ liệu (optional, được fill bởi AppService)
        public string? DataGroupName { get; set; } // Tên của DataGroup
        public string? DataGroupCode { get; set; } // Mã của DataGroup (có thể hữu ích)
    }
    ```
-   **Tệp 2:** Tạo file `CreateUpdateDataCoreDto.cs`
    ```csharp
    using System;
    using System.ComponentModel.DataAnnotations;
    using Aqt.CoreFW.DataCores; // Sử dụng Enum/Consts từ Domain.Shared namespace

    namespace Aqt.CoreFW.Application.Contracts.DataCores.Dtos;

    public class CreateUpdateDataCoreDto
    {
        [Required]
        [StringLength(DataCoreConsts.MaxCodeLength)]
        public string Code { get; set; } = string.Empty; // Bắt buộc khi tạo

        [Required]
        [StringLength(DataCoreConsts.MaxNameLength)]
        public string Name { get; set; } = string.Empty;

        [Required]
        public DataCoreStatus Status { get; set; } = DataCoreStatus.Active;

        [Required]
        public int Order { get; set; }

        [StringLength(DataCoreConsts.MaxDescriptionLength)]
        public string? Description { get; set; }

        [Required] // DataGroupId là bắt buộc
        public Guid DataGroupId { get; set; }
    }
    ```
-   **Tệp 3:** Tạo file `GetDataCoresInput.cs`
    ```csharp
    using System;
    using Aqt.CoreFW.DataCores; // Sử dụng Enum/Consts từ Domain.Shared namespace
    using Volo.Abp.Application.Dtos;

    namespace Aqt.CoreFW.Application.Contracts.DataCores.Dtos;

    public class GetDataCoresInput : PagedAndSortedResultRequestDto // Kế thừa để hỗ trợ phân trang và sắp xếp
    {
        public string? Filter { get; set; } // Filter theo Code hoặc Name
        public DataCoreStatus? Status { get; set; } // Filter theo Status
        public Guid? DataGroupId { get; set; } // Filter theo DataGroup ID chính xác
    }
    ```
-   **Tệp 4:** Tạo file `DataCoreExcelDto.cs` (Dùng cho xuất Excel - Optional)
    ```csharp
    using System;
    using MiniExcelLibs.Attributes;

    namespace Aqt.CoreFW.Application.Contracts.DataCores.Dtos;

    /// <summary>
    /// DTO được thiết kế riêng cho việc xuất dữ liệu DataCore ra Excel.
    /// </summary>
    public class DataCoreExcelDto
    {
        [ExcelColumnName("Mã DL Cốt lõi")]
        public string Code { get; set; } = string.Empty;

        [ExcelColumnName("Tên DL Cốt lõi")]
        public string Name { get; set; } = string.Empty;

        [ExcelColumnName("Mã Nhóm DL")] // Thêm thông tin nhóm dữ liệu
        public string? DataGroupCode { get; set; }

        [ExcelColumnName("Tên Nhóm DL")] // Thêm thông tin nhóm dữ liệu
        public string? DataGroupName { get; set; }

        [ExcelColumnName("Thứ tự")]
        public int Order { get; set; }

        [ExcelColumnName("Trạng thái")]
        public string StatusText { get; set; } = string.Empty; // Lấy từ localization

        [ExcelColumnName("Mô tả")]
        public string? Description { get; set; }

        // Có thể thêm các trường audit nếu cần
        // [ExcelColumnName("Ngày tạo")]
        // [ExcelFormat("yyyy-MM-dd HH:mm:ss")]
        // public DateTime CreationTime { get; set; }
    }
    ```
-   **Tệp 5:** Tạo file `DataCoreLookupDto.cs` (Dùng cho lookup, đặt trong thư mục dùng chung)
    -   **Vị trí:** `src/Aqt.CoreFW.Application.Contracts/Shared/Lookups/DataCoreLookupDto.cs` (Tạo thư mục `Shared/Lookups` nếu chưa có)
    -   **Nội dung:**
        ```csharp
        using System;
        using Volo.Abp.Application.Dtos;

        namespace Aqt.CoreFW.Application.Contracts.Shared.Lookups; // Namespace dùng chung

        // Dùng cho việc lookup DataCore dạng danh sách phẳng (flat list)
        public class DataCoreLookupDto : EntityDto<Guid>
        {
            public string Name { get; set; } = string.Empty;
            public string Code { get; set; } = string.Empty; // Thêm Code để dễ nhận biết
            // Không cần DataGroupId ở đây vì thường lookup theo DataGroup đã chọn
        }
        ```
-   **Tệp 6:** Sử dụng `DataGroupLookupDto` (Đã định nghĩa trong kế hoạch DataGroup)
    -   **Vị trí:** `src/Aqt.CoreFW.Application.Contracts/Shared/Lookups/DataGroupLookupDto.cs`
    -   **Mục đích:** Dùng để hiển thị danh sách DataGroup cho người dùng chọn khi tạo/sửa DataCore.

## 2. AppService Interface (`IDataCoreAppService.cs`)

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Application.Contracts/DataCores`
-   **Tệp:** Tạo file `IDataCoreAppService.cs`
    ```csharp
    using System;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Application.Contracts.DataCores.Dtos; // Namespace chứa DTOs
    using Aqt.CoreFW.Application.Contracts.Shared.Lookups; // Namespace chứa DataGroupLookupDto và DataCoreLookupDto
    using Volo.Abp.Application.Dtos;
    using Volo.Abp.Application.Services;
    using Volo.Abp.Content; // Required for IRemoteStreamContent

    namespace Aqt.CoreFW.Application.Contracts.DataCores;

    public interface IDataCoreAppService :
        ICrudAppService< // Kế thừa ICrudAppService cho CRUD cơ bản
            DataCoreDto,                  // DTO hiển thị
            Guid,                         // Kiểu khóa chính
            GetDataCoresInput,            // DTO lọc/phân trang
            CreateUpdateDataCoreDto>      // DTO tạo/cập nhật
    {
        /// <summary>
        /// Lấy danh sách DataCore dạng phẳng (flat list) cho lookup theo DataGroupId.
        /// Chỉ trả về các DataCore đang hoạt động.
        /// </summary>
        /// <param name="dataGroupId">ID của DataGroup cần lấy DataCore.</param>
        Task<ListResultDto<DataCoreLookupDto>> GetLookupByDataGroupAsync(Guid dataGroupId);

        /// <summary>
        /// Lấy danh sách DataGroup dạng lookup (đã có trong IDataGroupAppService).
        /// Cần đảm bảo interface này có thể truy cập được.
        /// </summary>
        // Task<ListResultDto<DataGroupLookupDto>> GetDataGroupLookupAsync(); // Có thể gọi qua IDataGroupAppService

        /// <summary>
        /// (Optional) Xuất danh sách DataCore (dạng phẳng) ra file Excel dựa trên bộ lọc.
        /// </summary>
        Task<IRemoteStreamContent> GetListAsExcelAsync(GetDataCoresInput input);
    }
    ```

## 3. Permissions

-   **Vị trí 1:** Cập nhật file `src/Aqt.CoreFW.Application.Contracts/Permissions/CoreFWPermissions.cs`
-   **Nội dung cần thêm:**
    ```csharp
    public static class CoreFWPermissions
    {
        public const string GroupName = "CoreFW";

        // ... các permission khác (Provinces, Districts, Communes, Ranks, DataGroups) ...

        // Thêm định nghĩa permission cho DataCores
        public static class DataCores // Sử dụng tên class khớp với module
        {
            // Sử dụng convention đặt tên quyền: CoreFW.DataCores
            public const string Default = GroupName + ".DataCores"; // Quyền xem mặc định
            public const string Create = Default + ".Create";
            public const string Update = Default + ".Update";
            public const string Delete = Default + ".Delete";
            public const string Export = Default + ".Export"; 
        }
        // ... các module khác ...
    }
    ```
-   **Vị trí 2:** Cập nhật file `src/Aqt.CoreFW.Application.Contracts/Permissions/CoreFWPermissionDefinitionProvider.cs`
-   **Nội dung cần thêm vào phương thức `Define`:**
    ```csharp
    // ... Lấy context.GetGroup(CoreFWPermissions.GroupName);

    // Thêm định nghĩa permissions cho DataCores
    var dataCorePermission = coreFwGroup.AddPermission(CoreFWPermissions.DataCores.Default, L("Permission:DataCoreManagement"));
        dataCorePermission.AddChild(CoreFWPermissions.DataCores.Create, L("Permission:DataCores.Create"));
        dataCorePermission.AddChild(CoreFWPermissions.DataCores.Update, L("Permission:DataCores.Update"));
        dataCorePermission.AddChild(CoreFWPermissions.DataCores.Delete, L("Permission:DataCores.Delete"));        
        dataCorePermission.AddChild(CoreFWPermissions.DataCores.Export, L("Permission:DataCores.Export"));
    // ... các AddPermission khác ...
    ```

## 4. Lưu ý

*   **Namespaces:** Đảm bảo sử dụng đúng namespaces cho các DTOs, Interfaces và Permissions.
*   **DataAnnotations:** Sử dụng DataAnnotations (`[Required]`, `[StringLength]`) trên `CreateUpdateDataCoreDto` để validation cơ bản.
*   **Lookup DTOs:** `DataCoreLookupDto` chỉ chứa các trường cần thiết cho việc hiển thị trong dropdown. `DataGroupLookupDto` được tái sử dụng từ module DataGroup.
*   **Permissions:** Đảm bảo các keys localization (`L["Permission:..."]`) đã được định nghĩa trong tầng `Domain.Shared` (kế hoạch bước 1).
*   **Excel Export:** Việc triển khai `GetListAsExcelAsync` là tùy chọn và cần thư viện hỗ trợ (ví dụ: MiniExcel). Nếu không cần, có thể bỏ qua DTO `DataCoreExcelDto` và phương thức tương ứng trong interface.
*   **DataGroup Lookup:** Interface `IDataCoreAppService` không định nghĩa lại `GetDataGroupLookupAsync` vì logic này thuộc về `IDataGroupAppService` và nên được gọi từ đó để tránh trùng lặp. 