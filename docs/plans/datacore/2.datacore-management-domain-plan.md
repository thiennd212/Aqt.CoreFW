# Kế hoạch chi tiết: Tầng Domain (`Aqt.CoreFW.Domain`) - Quản lý Danh mục Dữ liệu Cốt lõi (DataCore Management)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Domain` để hỗ trợ chức năng quản lý Danh mục Dữ liệu Cốt lõi (DataCore).

## 1. Entity (`DataCore.cs`)

**Nguyên tắc thiết kế Entity (DDD):**

*   **Đóng gói (Encapsulation):** Sử dụng `private set` cho các thuộc tính. `Code` sẽ không thay đổi sau khi tạo.
*   **Validation tập trung:** Tạo các phương thức `private` hoặc `internal` chứa logic validation (`Check.*`) sử dụng hằng số từ `DataCoreConsts`.
*   **Trạng thái hợp lệ (Valid State):** Constructor chính (`internal`) nhận tham số bắt buộc, gọi phương thức validation nội bộ để đảm bảo entity hợp lệ khi khởi tạo. Constructor `protected` dùng cho ORM.
*   **Hành vi (Behavior):** Định nghĩa phương thức `public` để thay đổi trạng thái có kiểm soát (ví dụ: `SetName`, `Activate`, `SetDataGroup`).
*   **Kế thừa:** Sử dụng `FullAuditedAggregateRoot<Guid>`. Mặc dù `DataCore` có thể không phải là gốc aggregate theo nghĩa DDD chặt chẽ (nó phụ thuộc `DataGroup`), việc kế thừa `AggregateRoot` giúp tận dụng các cơ chế Repository và UnitOfWork của ABP cho việc quản lý CRUD độc lập. Nếu có yêu cầu chặt chẽ hơn về Aggregate, cần xem xét lại.
*   **Quan hệ:** Tham chiếu bắt buộc đến `DataGroup` qua `DataGroupId`. Có thể có thuộc tính điều hướng `DataGroup` (optional, lazy-load).

**Cấu trúc `DataCore.cs`:**

-   **Vị trí:** `src/Aqt.CoreFW.Domain/DataCores/Entities/DataCore.cs` (Tạo thư mục `DataCores/Entities` nếu chưa có)
-   **Nội dung:**
    ```csharp
    using System;
    using Aqt.CoreFW.DataCores; // Namespace chứa Consts và Enum từ Domain.Shared
    using Aqt.CoreFW.Domain.DataGroups.Entities; // Namespace chứa Entity DataGroup
    using JetBrains.Annotations;
    using Volo.Abp;
    using Volo.Abp.Domain.Entities.Auditing;

    namespace Aqt.CoreFW.Domain.DataCores.Entities; // Namespace cụ thể cho Entity

    /// <summary>
    /// Represents a core data catalog item.
    /// Inherits from FullAuditedAggregateRoot for audit logging and soft delete.
    /// </summary>
    public class DataCore : FullAuditedAggregateRoot<Guid>
    {
        /// <summary>
        /// Unique code for the data core item. Cannot be changed after creation.
        /// Uniqueness constraint might be global or per DataGroup (confirm requirement).
        /// </summary>
        [NotNull]
        public virtual string Code { get; private set; }

        /// <summary>
        /// Name of the data core item.
        /// </summary>
        [NotNull]
        public virtual string Name { get; private set; }

        /// <summary>
        /// Status of the data core item (Active/Inactive).
        /// </summary>
        public virtual DataCoreStatus Status { get; private set; }

        /// <summary>
        /// Display or processing order.
        /// </summary>
        public virtual int Order { get; private set; }

        /// <summary>
        /// Optional description.
        /// </summary>
        [CanBeNull]
        public virtual string? Description { get; private set; }

        /// <summary>
        /// Foreign key to the DataGroup this item belongs to. Required.
        /// </summary>
        public virtual Guid DataGroupId { get; private set; } // Thay đổi qua Domain Service

        // Navigation property (optional, configure for lazy-loading in EF Core mapping)
        // public virtual DataGroup DataGroup { get; private set; }

        /// <summary>
        /// Protected constructor for ORM frameworks.
        /// </summary>
        protected DataCore()
        {
            /* For ORM */
            Code = string.Empty; // Khởi tạo giá trị mặc định hợp lệ
            Name = string.Empty; // Khởi tạo giá trị mặc định hợp lệ
        }

        /// <summary>
        /// Creates a new instance of the <see cref="DataCore"/> class.
        /// Ensures required fields are provided and validates initial state.
        /// Use DataCoreManager to create instances.
        /// </summary>
        /// <param name="id">The unique identifier.</param>
        /// <param name="code">The unique code.</param>
        /// <param name="name">The name.</param>
        /// <param name="dataGroupId">The ID of the parent DataGroup.</param> // Manager sẽ validate dataGroupId
        /// <param name="order">The display order.</param>
        /// <param name="description">Optional description.</param>
        /// <param name="status">The status.</param>
        internal DataCore( // Constructor internal để buộc tạo qua DataCoreManager
            Guid id,
            [NotNull] string code,
            [NotNull] string name,
            Guid dataGroupId, // Manager đã kiểm tra
            int order = 0,
            [CanBeNull] string? description = null,
            DataCoreStatus status = DataCoreStatus.Active)
            : base(id)
        {
            // Set Code trực tiếp, chỉ một lần và đã được validate bởi DataCoreManager
            SetCodeInternal(code);
            DataGroupId = dataGroupId; // Gán DataGroupId đã được kiểm tra bởi Manager

            // Set các thuộc tính khác qua internal setters để validate
            SetNameInternal(name);
            SetOrderInternal(order);
            SetDescriptionInternal(description);
            Status = status; // Gán trực tiếp enum
        }

        // --- Internal setters with validation ---

        private void SetCodeInternal([NotNull] string code)
        {
            Check.NotNullOrWhiteSpace(code, nameof(code), DataCoreConsts.MaxCodeLength);
            Code = code;
        }

        private void SetNameInternal([NotNull] string name)
        {
            Check.NotNullOrWhiteSpace(name, nameof(name), DataCoreConsts.MaxNameLength);
            Name = name;
        }

         private void SetOrderInternal(int order)
        {
            Order = order;
        }

        private void SetDescriptionInternal([CanBeNull] string? description)
        {
            Check.Length(description, nameof(description), DataCoreConsts.MaxDescriptionLength);
            Description = description;
        }

        /// <summary>
        /// Internal method to change the DataGroup ID. Should only be called by DataCoreManager.
        /// </summary>
        internal void SetDataGroupIdInternal(Guid dataGroupId)
        {
            // DataCoreManager is responsible for validation (data group exists)
            DataGroupId = dataGroupId;
        }

        // --- Public methods to change state ---

        /// <summary>
        /// Changes the name of the data core item.
        /// </summary>
        public DataCore SetName([NotNull] string name)
        {
            SetNameInternal(name);
            return this;
        }

         /// <summary>
        /// Changes the display/processing order.
        /// </summary>
        public DataCore SetOrder(int order)
        {
            SetOrderInternal(order);
            return this;
        }

        /// <summary>
        /// Changes the description.
        /// </summary>
        public DataCore SetDescription([CanBeNull] string? description)
        {
            SetDescriptionInternal(description);
            return this.
        }

        /// <summary>
        /// Sets the data core status to Active.
        /// </summary>
        public DataCore Activate()
        {
            Status = DataCoreStatus.Active;
            return this;
        }

        /// <summary>
        /// Sets the data core status to Inactive.
        /// </summary>
        public DataCore Deactivate()
        {
            Status = DataCoreStatus.Inactive;
            return this;
        }

        // Lưu ý: Không có public SetCode method.
        // Lưu ý: Việc thay đổi DataGroupId phải qua DataCoreManager.
    }
    ```

## 2. Repository Interface (`IDataCoreRepository.cs`)

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Domain/DataCores` (nếu chưa có)
-   **Tệp:** Tạo file `IDataCoreRepository.cs`
-   **Nội dung:**
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Threading;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Domain.DataCores.Entities; // Namespace chứa Entity
    using Volo.Abp.Domain.Repositories;

    namespace Aqt.CoreFW.Domain.DataCores;

    /// <summary>
    /// Defines the repository interface for the DataCore entity.
    /// </summary>
    public interface IDataCoreRepository : IRepository<DataCore, Guid> // Kế thừa IRepository cơ bản
    {
        /// <summary>
        /// Finds a DataCore by its unique code (and optionally DataGroupId if uniqueness is per group).
        /// </summary>
        /// <param name="code">The code to search for.</param>
        /// <param name="includeDetails">Include details like DataGroup navigation property (if defined).</param>
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>The found DataCore or null.</returns>
        Task<DataCore?> FindByCodeAsync(
            [NotNull] string code,
            bool includeDetails = false, // Cân nhắc có cần include không
            CancellationToken cancellationToken = default);

        // Có thể thêm overload nếu Code unique theo DataGroupId
        // Task<DataCore?> FindByCodeAsync(
        //     [NotNull] string code,
        //     Guid dataGroupId,
        //     bool includeDetails = false,
        //     CancellationToken cancellationToken = default);

        /// <summary>
        /// Gets a list of DataCores based on filtering criteria.
        /// </summary>
        /// <param name="filterText">Text to search in Code or Name.</param>
        /// <param name="code">Filter by exact code.</param>
        /// <param name="name">Filter by name containing text.</param>
        /// <param name="status">Filter by status.</param>
        /// <param name="dataGroupId">Filter by DataGroup ID.</param>
        /// <param name="sorting">Sorting expression (e.g., "Name ASC").</param>
        /// <param name="maxResultCount">Maximum number of results to return.</param>
        /// <param name="skipCount">Number of results to skip (for pagination).</param>
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>A list of DataCores.</returns>
        Task<List<DataCore>> GetListAsync(
            string? filterText = null,
            string? code = null,
            string? name = null,
            DataCoreStatus? status = null,
            Guid? dataGroupId = null,
            string? sorting = null,
            int maxResultCount = int.MaxValue,
            int skipCount = 0,
            CancellationToken cancellationToken = default);

        /// <summary>
        /// Gets the total count of DataCores based on filtering criteria.
        /// </summary>
        /// <param name="filterText">Text to search in Code or Name.</param>
        /// <param name="code">Filter by exact code.</param>
        /// <param name="name">Filter by name containing text.</param>
        /// <param name="status">Filter by status.</param>
        /// <param name="dataGroupId">Filter by DataGroup ID.</param>
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>The total count.</returns>
        Task<long> GetCountAsync(
            string? filterText = null,
            string? code = null,
            string? name = null,
            DataCoreStatus? status = null,
            Guid? dataGroupId = null,
            CancellationToken cancellationToken = default);

        /// <summary>
        /// Checks if a DataCore with the given code already exists.
        /// </summary>
        /// <param name="code">The code to check.</param>
        /// <param name="dataGroupId">Optional: DataGroup ID if uniqueness is per group.</param>
        /// <param name="excludeId">Optional: Exclude this ID from the check (used during update).</param>
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>True if the code exists, false otherwise.</returns>
        Task<bool> CodeExistsAsync(
            [NotNull] string code,
            Guid? dataGroupId = null, // Thêm nếu cần check unique theo group
            Guid? excludeId = null,
            CancellationToken cancellationToken = default);

        /// <summary>
        /// Gets a list of DataCores belonging to a specific DataGroup, often used for lookups/dropdowns.
        /// </summary>
        /// <param name="dataGroupId">The ID of the DataGroup to filter by.</param>
        /// <param name="onlyActive">Whether to return only active DataCores (default: true).</param>
        /// <param name="sorting">Sorting expression (default: "Order ASC, Name ASC").</param>
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>A list of DataCores matching the criteria.</returns>
        Task<List<DataCore>> GetListByDataGroupIdAsync(
            Guid dataGroupId,
            bool onlyActive = true,
            string? sorting = null, // Mặc định có thể là "Order ASC, Name ASC" trong implementation
            CancellationToken cancellationToken = default);
    }
    ```

## 3. Domain Service (`DataCoreManager.cs`)

**Trách nhiệm:**

*   Thực thi các quy tắc nghiệp vụ phức tạp liên quan đến DataCore.
*   Đảm bảo tính nhất quán khi tạo (`CreateAsync`) và cập nhật (`UpdateAsync`) DataCore.
*   Kiểm tra sự tồn tại và tính hợp lệ của `DataGroupId`.
*   Kiểm tra tính duy nhất của `Code` (theo phạm vi đã xác định - toàn hệ thống hoặc theo `DataGroupId`).
*   Tương tác với `IDataCoreRepository` và `IDataGroupRepository` (nếu cần kiểm tra DataGroup).

**Cấu trúc `DataCoreManager.cs`:**

-   **Vị trí:** `src/Aqt.CoreFW.Domain/DataCores/`
-   **Tệp:** Tạo file `DataCoreManager.cs`
-   **Nội dung:**
    ```csharp
    using System;
    using System.Threading.Tasks;
    using Aqt.CoreFW.DataCores; // Namespaces cần thiết
    using Aqt.CoreFW.Domain.DataCores.Entities;
    using Aqt.CoreFW.Domain.DataGroups; // Để inject IDataGroupRepository
    using JetBrains.Annotations;
    using Volo.Abp;
    using Volo.Abp.Domain.Services;
    using Volo.Abp.Guids;

    namespace Aqt.CoreFW.Domain.DataCores;

    /// <summary>
    /// Domain service responsible for managing DataCore entities.
    /// </summary>
    public class DataCoreManager : DomainService
    {
        private readonly IDataCoreRepository _dataCoreRepository;
        private readonly IDataGroupRepository _dataGroupRepository; // Inject repository của DataGroup
        private readonly IGuidGenerator _guidGenerator;

        public DataCoreManager(
            IDataCoreRepository dataCoreRepository,
            IDataGroupRepository dataGroupRepository, // Inject
            IGuidGenerator guidGenerator)
        {
            _dataCoreRepository = dataCoreRepository;
            _dataGroupRepository = dataGroupRepository; // Gán
            _guidGenerator = guidGenerator;
        }

        /// <summary>
        /// Creates a new DataCore entity after validating business rules.
        /// </summary>
        /// <param name="code">Unique code.</param>
        /// <param name="name">Name.</param>
        /// <param name="dataGroupId">Parent DataGroup ID.</param>
        /// <param name="order">Display order.</param>
        /// <param name="description">Optional description.</param>
        /// <param name="status">Status.</param>
        /// <returns>The newly created DataCore entity.</returns>
        /// <exception cref="UserFriendlyException">Thrown if business rules are violated.</exception>
        public async Task<DataCore> CreateAsync(
            [NotNull] string code,
            [NotNull] string name,
            Guid dataGroupId,
            int order = 0,
            [CanBeNull] string? description = null,
            DataCoreStatus status = DataCoreStatus.Active)
        {
            Check.NotNullOrWhiteSpace(code, nameof(code), DataCoreConsts.MaxCodeLength);
            Check.NotNullOrWhiteSpace(name, nameof(name), DataCoreConsts.MaxNameLength);
            Check.Length(description, nameof(description), DataCoreConsts.MaxDescriptionLength);

            // 1. Validate DataGroup existence
            await ValidateDataGroupExistsAsync(dataGroupId);

            // 2. Validate Code uniqueness (assuming global uniqueness for now)
            //    Nếu unique theo group, cần truyền dataGroupId vào CodeExistsAsync
            if (await _dataCoreRepository.CodeExistsAsync(code/*, dataGroupId*/))
            {
                throw new UserFriendlyException(L["DataCoreCodeAlreadyExists", code]);
                // Hoặc dùng mã lỗi: throw new BusinessException(CoreFWDomainErrorCodes.DataCoreCodeAlreadyExists).WithData("code", code);
            }

            var dataCore = new DataCore(
                _guidGenerator.Create(),
                code,
                name,
                dataGroupId,
                order,
                description,
                status
            );

            // Không cần InsertAsync ở đây, Application Service sẽ gọi Repository.InsertAsync
            return dataCore;
        }

        /// <summary>
        /// Updates an existing DataCore entity after validating business rules.
        /// </summary>
        /// <param name="dataCore">The entity to update.</param>
        /// <param name="name">New name.</param>
        /// <param name="dataGroupId">New parent DataGroup ID.</param>
        /// <param name="order">New display order.</param>
        /// <param name="description">New optional description.</param>
        /// <param name="status">New status.</param>
        /// <returns>The updated DataCore entity.</returns>
        /// <exception cref="UserFriendlyException">Thrown if business rules are violated.</exception>
        public async Task<DataCore> UpdateAsync(
            [NotNull] DataCore dataCore,
            [NotNull] string name,
            Guid dataGroupId, // Cho phép thay đổi DataGroup
            int order,
            [CanBeNull] string? description,
            DataCoreStatus status)
        {
            Check.NotNull(dataCore, nameof(dataCore));
            Check.NotNullOrWhiteSpace(name, nameof(name), DataCoreConsts.MaxNameLength);
            Check.Length(description, nameof(description), DataCoreConsts.MaxDescriptionLength);

            // 1. Validate DataGroup existence if it's changed
            if (dataCore.DataGroupId != dataGroupId)
            {
                await ValidateDataGroupExistsAsync(dataGroupId);
                dataCore.SetDataGroupIdInternal(dataGroupId); // Change DataGroup ID via internal setter
            }

            // Update other properties
            dataCore.SetName(name);
            dataCore.SetOrder(order);
            dataCore.SetDescription(description);

            if (status == DataCoreStatus.Active) dataCore.Activate();
            else dataCore.Deactivate();

            // Không cần UpdateAsync ở đây, Application Service sẽ gọi Repository.UpdateAsync
            return dataCore;
        }

        /// <summary>
        /// Helper method to validate if a DataGroup exists.
        /// </summary>
        private async Task ValidateDataGroupExistsAsync(Guid dataGroupId)
        {
            // Dùng GetAsync hoặc FindAsync tùy logic, GetAsync sẽ ném lỗi nếu không tìm thấy
            // Hoặc dùng CountAsync để kiểm tra nhanh hơn
            var dataGroupExists = await _dataGroupRepository.AnyAsync(dg => dg.Id == dataGroupId);
            if (!dataGroupExists)
            {
                 throw new UserFriendlyException(L["DataGroupNotFound", dataGroupId]);
                // Hoặc dùng mã lỗi: throw new BusinessException(CoreFWDomainErrorCodes.DataGroupNotFound).WithData("id", dataGroupId);
            }
        }

        // Có thể thêm các phương thức nghiệp vụ khác nếu cần (ví dụ: ChangeDataGroup, etc.)
    }
    ```

## 4. Cập nhật `CoreFWDomainModule.cs`

-   **Vị trí:** `src/Aqt.CoreFW.Domain/CoreFWDomainModule.cs`
-   **Hành động:** Đảm bảo module `CoreFWDomainModule` không có thay đổi cụ thể nào liên quan trực tiếp đến việc thêm DataCore, vì ABP tự động đăng ký các Domain Services và Repositories theo quy ước. Tuy nhiên, cần kiểm tra lại nếu có cấu hình đặc biệt nào trước đó.

## 5. Lưu ý

*   **Tính duy nhất của `Code`:** Kế hoạch này giả định `Code` là duy nhất toàn hệ thống. Nếu yêu cầu là duy nhất trong phạm vi `DataGroupId`, cần điều chỉnh `IDataCoreRepository.FindByCodeAsync`, `IDataCoreRepository.CodeExistsAsync` và logic trong `DataCoreManager.CreateAsync`.
*   **Aggregate Root:** Việc chọn `FullAuditedAggregateRoot` thay vì `FullAuditedEntity` là để phù hợp với cách quản lý CRUD thông thường trong ABP. Cần xác nhận lại nếu có yêu cầu khác về mô hình Aggregate.
*   **Repository Dependency:** `DataCoreManager` phụ thuộc vào `IDataGroupRepository`. Đảm bảo rằng `Aqt.CoreFW.Domain` đã có tham chiếu đến project chứa `IDataGroupRepository` (thường là chính nó hoặc `Aqt.CoreFW.Domain.Shared` nếu interface được định nghĩa ở đó - nhưng theo mẫu thì nó ở Domain).
*   **Error Handling:** Sử dụng `UserFriendlyException` với localization key hoặc `BusinessException` với Error Code đã định nghĩa trong tầng Domain.Shared.
*   **Namespace:** Đảm bảo sử dụng đúng namespace cho các class và interface. 