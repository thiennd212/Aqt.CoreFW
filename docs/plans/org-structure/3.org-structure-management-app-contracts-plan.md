# Kế hoạch triển khai Tầng Application.Contracts - Module Quản lý Cơ cấu Tổ chức

**Module:** `Aqt.CoreFW.Application.Contracts`

**Mục tiêu:** Định nghĩa các Data Transfer Objects (DTOs), giao diện Application Services (Interfaces), và định nghĩa phân quyền (Permissions) cho module quản lý cơ cấu tổ chức.

## Nhiệm vụ chi tiết

### 1. Định nghĩa Permissions (`OrgStructurePermissions`)

- [ ] Tạo file `OrgStructure/OrgStructurePermissions.cs`.
- [ ] Định nghĩa một Permission Group Name: `public const string GroupName = "OrganizationStructure";`
- [ ] Định nghĩa các Permissions con cho từng chức năng:
    - **JobTitles:**
        - [ ] `Default` (Xem danh sách)
        - [ ] `Create`
        - [ ] `Update`
        - [ ] `Delete`
    - **UserProfiles:** (Có thể gộp vào quyền quản lý User của Identity hoặc tách riêng)
        - [ ] `Management` (Xem, Sửa)
        - [ ] `UpdateOwn` (Cho phép user tự sửa profile) - Cân nhắc nếu cần
    - **OrganizationUnits:** (Sử dụng quyền của module ABP hoặc định nghĩa lại nếu cần kiểm soát chặt hơn, đặc biệt cho việc sửa trường mở rộng)
        - [ ] `Management` (CRUD, bao gồm cả trường mở rộng) - Có thể cần định nghĩa permission riêng nếu muốn tách quyền sửa trường mở rộng.
        - [ ] `ViewExtendedProperties` (Quyền xem Mã liên thông, Địa chỉ) - Cân nhắc nếu cần
        - [ ] `UpdateExtendedProperties` (Quyền sửa Mã liên thông, Địa chỉ) - Cân nhắc nếu cần
    - **Positions:**
        - [ ] `Management` (CRUD cơ bản)
        - [ ] `AssignRoles` (Gán/Cập nhật Roles cho Position)
        - [ ] `SetPrimary` (Đặt làm vị trí chính)
        - [ ] `View` (Xem danh sách vị trí của user khác / vị trí trong OU)
        - [ ] `SwitchActive` (Cho phép user chuyển đổi vị trí)
- [ ] Tạo class `OrgStructurePermissionDefinitionProvider.cs`:
    - [ ] Kế thừa từ `PermissionDefinitionProvider`.
    - [ ] Override phương thức `Define`.
    - [ ] Lấy `var orgGroup = context.AddGroup(OrgStructurePermissions.GroupName, L("Permission:OrganizationStructure"));`
    - [ ] Add các permission con vào group, sử dụng localized string `L("Permission:...")`. Ví dụ: `orgGroup.AddPermission(OrgStructurePermissions.JobTitles.Default, L("Permission:JobTitles"));`
    - [ ] Thiết lập cấu trúc cha-con cho permissions nếu cần (vd: Create/Update/Delete là con của Default/Management).
- [ ] Thêm các khóa localization `Permission:*` vào file JSON (đã tạo ở Domain.Shared plan).

### 2. Định nghĩa Data Transfer Objects (DTOs)

- **JobTitle DTOs:**
    - [ ] `OrgStructure/JobTitles/Dtos/JobTitleDto.cs`: Kế thừa `AuditedEntityDto<Guid>`, thêm `MaChucVu`, `TenChucVu`, `MoTa`.
    - [ ] `OrgStructure/JobTitles/Dtos/CreateUpdateJobTitleDto.cs`: Thêm `MaChucVu?`, `TenChucVu` (Required), `MoTa?`. Áp dụng Data Annotations (Required, StringLength).
    - [ ] `OrgStructure/JobTitles/Dtos/GetJobTitleListInput.cs`: Kế thừa `PagedAndSortedResultRequestDto`, thêm `FilterText?` (string).

- **UserProfile DTOs:**
    - [ ] `OrgStructure/UserProfiles/Dtos/UserProfileDto.cs`: Kế thừa `EntityDto<Guid>`, thêm `UserId`, `HoTen`, `SoDienThoai`, `DiaChi`, `AnhDaiDienUrl`.
    - [ ] `OrgStructure/UserProfiles/Dtos/CreateUpdateUserProfileDto.cs`: Thêm các thuộc tính tương ứng, áp dụng Data Annotations.

- **OrganizationUnit DTOs (Mở rộng DTOs của ABP):**
    - [ ] **Quan trọng:** Kiểm tra phiên bản ABP đang dùng. ABP > v5.0 có thể đã có cơ chế tốt hơn để xử lý Extra Properties trong DTOs. Nếu không, cần tạo DTOs mới kế thừa từ DTOs gốc của ABP.
    - [ ] `OrgStructure/OrganizationUnits/Dtos/OrganizationUnitWithExtraPropertiesDto.cs` (Ví dụ tên): Kế thừa `OrganizationUnitDto`, thêm:
        - `MaLienThong` (string?)
        - `DiaChi` (string?)
    - [ ] `OrgStructure/OrganizationUnits/Dtos/CreateOrganizationUnitWithExtraPropertiesDto.cs` (Ví dụ tên): Kế thừa `CreateOrganizationUnitDto`, thêm:
        - `MaLienThong` (string?)
        - `DiaChi` (string?)
    - [ ] `OrgStructure/OrganizationUnits/Dtos/UpdateOrganizationUnitWithExtraPropertiesDto.cs` (Ví dụ tên): Kế thừa `UpdateOrganizationUnitDto`, thêm:
        - `MaLienThong` (string?)
        - `DiaChi` (string?)
    - [ ] Cập nhật các phương thức trong Interface `IOrganizationUnitAppService` (bước sau) để sử dụng các DTO mới này nếu cần.

- **Position DTOs:**
    - [ ] `OrgStructure/Positions/Dtos/PositionDto.cs`: Kế thừa `AuditedEntityDto<Guid>`, thêm `UserId`, `OrganizationUnitId`, `JobTitleId`, `IsPrimary`, `OrganizationUnitDisplayName?`, `JobTitleName?`, `UserName?`.
    - [ ] `OrgStructure/Positions/Dtos/CreatePositionInput.cs`: Thêm `UserId`, `OrganizationUnitId`, `JobTitleId`. Áp dụng Data Annotations.
    - [ ] `OrgStructure/Positions/Dtos/UpdatePositionRolesInput.cs`: Thêm `List<Guid> RoleIds`.
    - [ ] `OrgStructure/Positions/Dtos/GetPositionListInput.cs`: Kế thừa `PagedAndSortedResultRequestDto`, thêm `UserId?`, `OrganizationUnitId?`, `FilterText?`.
    - [ ] `OrgStructure/Positions/Dtos/PositionWithDetailsDto.cs` (Nếu cần): Bao gồm thông tin chi tiết về User, OU, JobTitle và danh sách Roles (`List<RoleDto>`).

### 3. Định nghĩa Giao diện Application Services (Interfaces)

- **`IJobTitleAppService`:**
    - [ ] Tạo file `OrgStructure/JobTitles/IJobTitleAppService.cs`.
    - [ ] Kế thừa `ICrudAppService<JobTitleDto, Guid, GetJobTitleListInput, CreateUpdateJobTitleDto>`.
    - [ ] Thêm các phương thức tùy chỉnh nếu cần.

- **`IUserProfileAppService`:**
    - [ ] Tạo file `OrgStructure/UserProfiles/IUserProfileAppService.cs`.
    - [ ] Kế thừa `IApplicationService`.
    - [ ] Định nghĩa các phương thức:
        - `Task<UserProfileDto> GetByUserIdAsync(Guid userId);`
        - `Task<UserProfileDto> UpdateAsync(Guid userId, CreateUpdateUserProfileDto input);` // Hoặc lấy id của UserProfile thay vì UserId
        - `Task<UserProfileDto> GetCurrentUserProfileAsync();` (Tùy chọn)
        - `Task UpdateCurrentUserProfileAsync(CreateUpdateUserProfileDto input);` (Tùy chọn)

- **`IOrganizationUnitAppService` (Mở rộng Interface của ABP):**
    - [ ] Nếu không thể tùy chỉnh trực tiếp DTOs của ABP, cần tạo Interface mới kế thừa từ `IOrganizationUnitAppService` gốc.
    - [ ] Override các phương thức `CreateAsync`, `UpdateAsync`, `GetAsync`, `GetListAsync` để sử dụng DTOs mới (`*WithExtraPropertiesDto`) nếu đã tạo ở bước DTO.
    - [ ] Ví dụ: `Task<OrganizationUnitWithExtraPropertiesDto> CreateAsync(CreateOrganizationUnitWithExtraPropertiesDto input);`

- **`IPositionAppService`:**
    - [ ] Tạo file `OrgStructure/Positions/IPositionAppService.cs`.
    - [ ] Kế thừa `IApplicationService`.
    - [ ] Định nghĩa các phương thức:
        - `Task<PagedResultDto<PositionDto>> GetListAsync(GetPositionListInput input);`
        - `Task<PositionDto> GetAsync(Guid id);` // Hoặc PositionWithDetailsDto
        - `Task<PositionDto> CreateAsync(CreatePositionInput input);`
        - `Task DeleteAsync(Guid id);`
        - `Task UpdateRolesAsync(Guid positionId, UpdatePositionRolesInput input);`
        - `Task SetAsPrimaryAsync(Guid positionId);`
        - `Task<ListResultDto<PositionDto>> GetCurrentUserPositionsAsync();` // Lấy danh sách vị trí của user đang đăng nhập
        - `Task SwitchActivePositionAsync(Guid positionId);` // Chuyển vị trí active
        - `Task<ListResultDto<LookupDto<Guid>>> GetJobTitleLookupAsync();` // Để đổ vào dropdown
        - `Task<ListResultDto<OrganizationUnitDto>> GetOrganizationUnitLookupAsync();` // Để đổ vào cây/dropdown OU

## Kết quả mong đợi

- Các lớp Permissions và Permission Provider được định nghĩa.
- Các DTOs cho JobTitle, UserProfile, Position, và OU (mở rộng) được tạo với validation phù hợp.
- Các Interfaces cho Application Services (`IJobTitleAppService`, `IUserProfileAppService`, `IPositionAppService`, `IOrganizationUnitAppService` mở rộng) được định nghĩa.

## Cập nhật Kế hoạch Tổng thể

- [ ] Đánh dấu hoàn thành Bước 3 trong `org-structure-management-plan-v1.md`.