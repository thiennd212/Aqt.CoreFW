# Kế hoạch triển khai Tầng EntityFrameworkCore - Module Quản lý Cơ cấu Tổ chức

**Module:** `Aqt.CoreFW.EntityFrameworkCore`

**Mục tiêu:** Cấu hình DbContext để ánh xạ các Entities của module Cơ cấu Tổ chức vào cơ sở dữ liệu, bao gồm cả các thuộc tính mở rộng (Extra Properties) của `OrganizationUnit`, và tạo database migration.

## Nhiệm vụ chi tiết

### 1. Cập nhật DbContext (`CoreFWDbContext`)

- [ ] Mở file `EntityFrameworkCore/CoreFWDbContext.cs` (hoặc tên DbContext tương ứng).
- [ ] **Thêm DbSet cho các Entity tùy chỉnh:**
    - [ ] `public DbSet<AppJobTitle> JobTitles { get; set; }`
    - [ ] `public DbSet<AppUserProfile> UserProfiles { get; set; }`
    - [ ] `public DbSet<AppPosition> Positions { get; set; }`
    - [ ] `public DbSet<AppPositionRole> PositionRoles { get; set; }`
- [ ] **Cấu hình Entities trong `OnModelCreating`:**
    - Gọi `builder.ConfigureOrgStructure();` (hoặc tên phương thức mở rộng tương tự).

### 2. Tạo DbContext Model Creating Extensions (`CoreFWDbContextModelCreatingExtensions`)

- [ ] Mở file `EntityFrameworkCore/CoreFWDbContextModelCreatingExtensions.cs` (hoặc tạo mới nếu chưa có).
- [ ] Tạo phương thức mở rộng `public static void ConfigureOrgStructure(this ModelBuilder builder)`
- [ ] **Cấu hình Entity `AppJobTitle`:**
    - [ ] `builder.Entity<AppJobTitle>(b => { ... });`
    - [ ] `b.ToTable(CoreFWConsts.DbTablePrefix + "JobTitles", CoreFWConsts.DbSchema);` // Sử dụng hằng số nếu có
    - [ ] `b.ConfigureByConvention();` // Áp dụng cấu hình mặc định của ABP
    - [ ] `b.Property(x => x.TenChucVu).IsRequired().HasMaxLength(OrgStructureConsts.MaxTenChucVuLength);`
    - [ ] `b.Property(x => x.MaChucVu).HasMaxLength(OrgStructureConsts.MaxMaChucVuLength);`
    - [ ] `b.Property(x => x.MoTa).HasMaxLength(OrgStructureConsts.MaxMoTaLength);`
    - [ ] `b.HasIndex(x => x.MaChucVu).IsUnique();` // Nếu MaChucVu là unique
- [ ] **Cấu hình Entity `AppUserProfile`:**
    - [ ] `builder.Entity<AppUserProfile>(b => { ... });`
    - [ ] `b.ToTable(CoreFWConsts.DbTablePrefix + "UserProfiles", CoreFWConsts.DbSchema);`
    - [ ] `b.ConfigureByConvention();`
    - [ ] `b.Property(x => x.HoTen).IsRequired().HasMaxLength(OrgStructureConsts.MaxUserProfileHoTenLength);`
    - [ ] `b.Property(x => x.SoDienThoai).HasMaxLength(OrgStructureConsts.MaxUserProfileSoDienThoaiLength);`
    - [ ] `b.Property(x => x.DiaChi).HasMaxLength(OrgStructureConsts.MaxUserProfileDiaChiLength);`
    - [ ] `b.Property(x => x.AnhDaiDienUrl).HasMaxLength(OrgStructureConsts.MaxUserProfileAnhDaiDienUrlLength);`
    - [ ] `b.HasIndex(x => x.UserId).IsUnique();` // Đảm bảo quan hệ 1-1
    - [ ] `b.HasOne<IdentityUser>().WithOne().HasForeignKey<AppUserProfile>(x => x.UserId).IsRequired();` // Định nghĩa quan hệ FK với AbpUser (IdentityUser là base class)
- [ ] **Cấu hình Entity `AppPosition`:**
    - [ ] `builder.Entity<AppPosition>(b => { ... });`
    - [ ] `b.ToTable(CoreFWConsts.DbTablePrefix + "Positions", CoreFWConsts.DbSchema);`
    - [ ] `b.ConfigureByConvention();`
    - [ ] `b.HasOne(x => x.User).WithMany().HasForeignKey(x => x.UserId).IsRequired().OnDelete(DeleteBehavior.Restrict);` // Hoặc Cascade nếu muốn xóa Position khi xóa User
    - [ ] `b.HasOne(x => x.OrganizationUnit).WithMany().HasForeignKey(x => x.OrganizationUnitId).IsRequired().OnDelete(DeleteBehavior.Restrict);` // Không cho xóa OU nếu còn Position
    - [ ] `b.HasOne(x => x.JobTitle).WithMany().HasForeignKey(x => x.JobTitleId).IsRequired().OnDelete(DeleteBehavior.Restrict);` // Không cho xóa JobTitle nếu còn Position
    - [ ] `b.HasIndex(x => new { x.UserId, x.OrganizationUnitId, x.JobTitleId }).IsUnique();` // Nếu cần ràng buộc unique
- [ ] **Cấu hình Entity `AppPositionRole`:**
    - [ ] `builder.Entity<AppPositionRole>(b => { ... });`
    - [ ] `b.ToTable(CoreFWConsts.DbTablePrefix + "PositionRoles", CoreFWConsts.DbSchema);`
    - [ ] `b.ConfigureByConvention();` // Không có Audit nên có thể không cần
    - [ ] `b.HasKey(x => new { x.PositionId, x.RoleId });` // Khóa chính phức hợp
    - [ ] `b.HasOne(x => x.Position).WithMany(p => p.PositionRoles).HasForeignKey(x => x.PositionId).IsRequired().OnDelete(DeleteBehavior.Cascade);` // Xóa PositionRole khi xóa Position
    - [ ] `b.HasOne(x => x.Role).WithMany().HasForeignKey(x => x.RoleId).IsRequired().OnDelete(DeleteBehavior.Cascade);` // Xóa PositionRole khi xóa Role
- [ ] **Cấu hình Extra Properties cho `OrganizationUnit`:**
    - [ ] Gọi lại cấu hình Object Extension trong `OnModelCreating` (ABP thường tự động làm điều này nếu đã cấu hình ở Domain, nhưng kiểm tra lại cho chắc).
    - [ ] `builder.Entity<OrganizationUnit>().ConfigureExtraProperties();` // Đảm bảo phương thức này được gọi.
    - [ ] **Quan trọng:** Đảm bảo rằng việc map `MaLienThong` và `DiaChi` đã được định nghĩa đúng cách trong `*DomainObjectExtensions.cs` để EF Core biết cách lưu chúng vào cột `ExtraProperties`.

### 3. Tạo Database Migration

- [ ] Mở Package Manager Console (PMC) hoặc Terminal trong thư mục chứa project `*.EntityFrameworkCore`.
- [ ] Chạy lệnh tạo migration:
    ```bash
    dotnet ef migrations add Added_OrgStructure_Module -c CoreFWDbContext -o Migrations/OrgStructure
    ```
    *(Điều chỉnh tên migration, tên DbContext `-c`, và thư mục output `-o` nếu cần)*
- [ ] Kiểm tra lại file migration vừa tạo:
    - [ ] Đảm bảo các bảng `JobTitles`, `UserProfiles`, `Positions`, `PositionRoles` được tạo đúng cấu trúc (cột, kiểu dữ liệu, khóa chính, khóa ngoại, index, ràng buộc unique).
    - [ ] Kiểm tra xem có thay đổi nào liên quan đến `AbpOrganizationUnits` (thường là không vì Extra Properties lưu vào cột JSON).

### 4. Cập nhật Database

- [ ] Chạy lệnh cập nhật database từ PMC hoặc Terminal (trong thư mục `*.DbMigrator` hoặc project host):
    ```bash
    dotnet run --project ../Aqt.CoreFW.DbMigrator/Aqt.CoreFW.DbMigrator.csproj
    ```
    *(Điều chỉnh đường dẫn đến project DbMigrator)*
- [ ] Hoặc cập nhật trực tiếp từ PMC (trong thư mục `*.EntityFrameworkCore`):
    ```bash
    dotnet ef database update -c CoreFWDbContext
    ```
- [ ] Kiểm tra lại cơ sở dữ liệu để đảm bảo các bảng và cấu trúc đã được tạo/cập nhật thành công.

## Kết quả mong đợi

- `CoreFWDbContext` được cập nhật với các DbSet và cấu hình cho Entities của module.
- Cấu hình ánh xạ cho `AppJobTitle`, `AppUserProfile`, `AppPosition`, `AppPositionRole` hoàn tất trong `CoreFWDbContextModelCreatingExtensions`.
- Cấu hình cho Extra Properties của `OrganizationUnit` được đảm bảo hoạt động.
- Database migration được tạo thành công (`Added_OrgStructure_Module.cs`).
- Cơ sở dữ liệu được cập nhật thành công với cấu trúc mới.

## Cập nhật Kế hoạch Tổng thể

- [ ] Đánh dấu hoàn thành Bước 5 trong `org-structure-management-plan-v1.md`.