# Kế hoạch triển khai Tầng Domain - Module Quản lý Cơ cấu Tổ chức

**Module:** `Aqt.CoreFW.Domain`

**Mục tiêu:** Định nghĩa các thực thể (Entities), Domain Services, và các quy tắc nghiệp vụ cốt lõi cho module quản lý cơ cấu tổ chức.

## Nhiệm vụ chi tiết

### 1. Định nghĩa Thực thể (Entities)

- **`AppJobTitle`:**
    - [ ] Tạo file `OrgStructure/AppJobTitle.cs`.
    - [ ] Kế thừa từ `FullAuditedAggregateRoot<Guid>`.
    - [ ] Thêm các thuộc tính:
        - `MaChucVu` (string, MaxLength = `OrgStructureConsts.MaxMaChucVuLength`, nullable) - Cân nhắc có cần unique không.
        - `TenChucVu` (string, MaxLength = `OrgStructureConsts.MaxTenChucVuLength`, required)
        - `MoTa` (string, MaxLength = `OrgStructureConsts.MaxMoTaLength`, nullable)
    - [ ] Cập nhật `OrgStructureConsts` nếu cần.

- **`AppUserProfile`:**
    - [ ] Tạo file `OrgStructure/AppUserProfile.cs`.
    - [ ] Kế thừa từ `FullAuditedAggregateRoot<Guid>`.
    - [ ] Thêm các thuộc tính:
        - `UserId` (Guid, required) - Khóa ngoại đến `AbpIdentityUser`. Cần đánh index và ràng buộc unique.
        - `HoTen` (string, MaxLength = ???, required) - Xác định độ dài max phù hợp.
        - `SoDienThoai` (string, MaxLength = ???, nullable) - Xác định độ dài max phù hợp.
        - `DiaChi` (string, MaxLength = ???, nullable) - Xác định độ dài max phù hợp.
        - `AnhDaiDienUrl` (string, MaxLength = ???, nullable) - Xác định độ dài max phù hợp.
    - [ ] Thiết lập quan hệ 1-1 với `AbpIdentityUser`.

- **`AppPosition`:**
    - [ ] Tạo file `OrgStructure/AppPosition.cs`.
    - [ ] Kế thừa từ `FullAuditedAggregateRoot<Guid>`.
    - [ ] Thêm các thuộc tính:
        - `UserId` (Guid, required) - Khóa ngoại đến `AbpIdentityUser`.
        - `OrganizationUnitId` (Guid, required) - Khóa ngoại đến `AbpOrganizationUnit`.
        - `JobTitleId` (Guid, required) - Khóa ngoại đến `AppJobTitle`.
        - `IsPrimary` (bool, default = false)
    - [ ] Thêm thuộc tính điều hướng (Navigation Properties): `User`, `OrganizationUnit`, `JobTitle`.
    - [ ] Thêm collection `PositionRoles` (kiểu `ICollection<AppPositionRole>`).
    - [ ] Cân nhắc thêm ràng buộc unique composite `(UserId, OrganizationUnitId, JobTitleId)` nếu nghiệp vụ yêu cầu.

- **`AppPositionRole` (Join Entity):**
    - [ ] Tạo file `OrgStructure/AppPositionRole.cs`.
    - [ ] Không cần kế thừa lớp nào nếu chỉ làm bảng nối, hoặc `Entity` nếu cần ID riêng (không khuyến khích).
    - [ ] Thêm các thuộc tính:
        - `PositionId` (Guid, required) - Khóa ngoại đến `AppPosition`.
        - `RoleId` (Guid, required) - Khóa ngoại đến `AbpIdentityRole`.
    - [ ] Định nghĩa khóa chính phức hợp (Composite Primary Key) `(PositionId, RoleId)`.
    - [ ] Thêm thuộc tính điều hướng: `Position`, `Role`.

### 2. Mở rộng Thực thể ABP (`OrganizationUnit`) bằng Object Extension

- [ ] Xác định module chứa logic cấu hình Object Extension (thường là `Domain` hoặc `Domain.Shared`).
- [ ] Tìm đến lớp `*DomainObjectExtensions.cs` (hoặc tạo mới).
- [ ] Trong phương thức `Configure`, sử dụng `ObjectExtensionManager.Instance.MapEfCoreProperty` hoặc phương thức tương đương:
    - [ ] Map thuộc tính `MaLienThong` cho `OrganizationUnit`:
        - Kiểu: `string`
        - Tên thuộc tính trong `ExtraProperties`: `OrgStructureConsts.OuMaLienThongExtraPropertyName`
        - Cấu hình trong DbContext (sẽ làm ở bước EF Core plan).
    - [ ] Map thuộc tính `DiaChi` cho `OrganizationUnit`:
        - Kiểu: `string`
        - Tên thuộc tính trong `ExtraProperties`: `OrgStructureConsts.OuDiaChiExtraPropertyName`
        - Cấu hình trong DbContext (sẽ làm ở bước EF Core plan).
- [ ] Định nghĩa các hằng số `OuMaLienThongExtraPropertyName` và `OuDiaChiExtraPropertyName` trong `OrgStructureConsts` (Domain.Shared).

### 3. Định nghĩa Domain Services (nếu cần)

- **`PositionManager` (ví dụ):**
    - [ ] Tạo interface `OrgStructure/IPositionManager.cs`.
    - [ ] Tạo class `OrgStructure/PositionManager.cs` implement `IPositionManager`, kế thừa `DomainService`.
    - [ ] Inject các repository cần thiết (`IRepository<AppPosition>`, `IRepository<AppPositionRole>`, `IRepository<AppJobTitle>`, `IOrganizationUnitRepository`, `UserManager`, `RoleManager`...).
    - [ ] **Triển khai các logic nghiệp vụ phức tạp:**
        - [ ] Phương thức `CreateAsync(...)`: Kiểm tra sự tồn tại của User, OU, JobTitle. Kiểm tra trùng lặp Position (nếu có unique constraint). Xử lý `IsPrimary` (đảm bảo chỉ có 1 primary/user).
        - [ ] Phương thức `UpdateRolesAsync(Guid positionId, List<Guid> roleIds)`: Cập nhật bảng `AppPositionRole`. **Quan trọng:** Sau khi cập nhật, phải trigger logic đồng bộ Role vào `AbpUserRole`.
        - [ ] Phương thức `SetAsPrimaryAsync(Guid positionId)`: Tìm Position, đặt `IsPrimary = true`. Tìm các Position khác của cùng User, đặt `IsPrimary = false`.
        - [ ] Phương thức `DeleteAsync(Guid positionId)`: Xóa Position và PositionRoles liên quan. **Quan trọng:** Trigger logic đồng bộ Role vào `AbpUserRole`.
        - [ ] Phương thức `SynchronizeUserRolesAsync(Guid userId)`:
            - Lấy tất cả các `PositionId` của `userId`.
            - Lấy tất cả các `RoleId` từ `AppPositionRole` ứng với các `PositionId` đó (distinct).
            - Lấy các `RoleId` hiện tại của `userId` từ `UserManager`.
            - So sánh và gọi `UserManager.AddToRolesAsync`/`RemoveFromRolesAsync`.
        - [ ] Phương thức kiểm tra ràng buộc trước khi xóa OU/JobTitle (có thể đặt trong service riêng hoặc ở đây). Ví dụ: `CanDeleteOrganizationUnitAsync(Guid ouId)`, `CanDeleteJobTitleAsync(Guid jobTitleId)`.

- **`UserProfileManager` (ví dụ, nếu cần):**
    - [ ] Tạo interface/class nếu có logic phức tạp liên quan đến UserProfile (vd: tự động tạo khi tạo User).

### 4. Định nghĩa Exceptions Tùy chỉnh (nếu cần)

- [ ] Tạo các lớp Exception kế thừa từ `BusinessException` cho các lỗi nghiệp vụ cụ thể (vd: `JobTitleCodeAlreadyExistsException`, `PositionAssignmentConflictException`, `CannotDeleteOuWithPositionsException`).

## Kết quả mong đợi

- Các lớp Entity (`AppJobTitle`, `AppUserProfile`, `AppPosition`, `AppPositionRole`) được định nghĩa chính xác.
- Cấu hình Object Extension cho `OrganizationUnit` hoàn tất.
- Các Domain Service (`PositionManager`, ...) chứa logic nghiệp vụ cốt lõi được triển khai.
- Các Exception tùy chỉnh (nếu cần) được định nghĩa.

## Cập nhật Kế hoạch Tổng thể

- [ ] Đánh dấu hoàn thành Bước 1 trong `org-structure-management-plan-v1.md`.