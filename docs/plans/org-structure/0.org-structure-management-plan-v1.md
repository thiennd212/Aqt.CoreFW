# Kế hoạch triển khai Module Quản lý Cơ cấu Tổ chức

## 0. Phân tích nghiệp vụ (Tóm tắt từ SRS)

### 0.1. Mục tiêu
- Xây dựng module cho phép quản lý các đơn vị/phòng ban (Organization Units - OU) bao gồm thông tin mở rộng (Mã liên thông, Địa chỉ), chức vụ (Job Titles), thông tin người dùng mở rộng (User Profiles), và vị trí công tác (Positions - User + OU + JobTitle + Roles).
- Tái sử dụng và mở rộng các module cốt lõi của ABP Framework (Identity, OrganizationUnits).
- Sử dụng Object Extension System của ABP để mở rộng `OrganizationUnit`.
- Sử dụng Dynamic HTTP API để expose các Application Services.
- Hỗ trợ người dùng đăng nhập và làm việc với ngữ cảnh của một vị trí công tác cụ thể.
- Đồng bộ hóa vai trò (Roles) từ vị trí công tác vào tài khoản người dùng ABP.

### 0.2. Đối tượng sử dụng
- **Quản trị hệ thống:** Toàn quyền quản lý module.
- **Quản trị viên đơn vị (Tùy chọn):** Quản lý người dùng/vị trí trong phạm vi OU được giao.
- **Người dùng cuối:** Xem thông tin, chọn/chuyển đổi vị trí công tác.

### 0.3. Yêu cầu chức năng chính (Tổng quan)
- **Quản lý Chức vụ (Job Titles):** CRUD.
- **Quản lý Thông tin Người dùng (User Profiles):** CRUD thông tin mở rộng, liên kết với `AbpUser`.
- **Quản lý Đơn vị/Phòng ban (Organization Units):** CRUD cấu trúc cây, bao gồm các trường mở rộng `MaLienThong`, `DiaChi` thông qua Object Extension.
- **Quản lý Vị trí công tác (Positions):**
    - Gán User vào OU với JobTitle cụ thể.
    - Gán Roles cho từng Position.
    - Đặt vị trí chính (Primary).
    - CRUD.
- **Đồng bộ Role:** Tự động cập nhật `AbpUserRole` dựa trên Roles của các Positions.
- **Đăng nhập & Chọn/Chuyển đổi Vị trí:** Xử lý logic chọn vị trí khi đăng nhập và cho phép chuyển đổi vị trí trong phiên làm việc.
- **Phân quyền:** Định nghĩa và áp dụng Permissions cho các chức năng.

### 0.4. Yêu cầu dữ liệu (Tổng quan)
- Sử dụng `AbpIdentityUser`, `AbpIdentityRole`, `AbpOrganizationUnit`.
- Mở rộng `AbpOrganizationUnit` với `MaLienThong` (string?), `DiaChi` (string?) qua Object Extension.
- Tạo các thực thể tùy chỉnh: `AppUserProfile` (1-1 với User), `AppJobTitle`, `AppPosition` (FK đến User, OU, JobTitle), `AppPositionRole` (bảng nối Position-Role).
- Đảm bảo ràng buộc dữ liệu (FK, UQ), Soft Delete.

### 0.5. Yêu cầu giao diện người dùng (UI - Tổng quan)
- Sử dụng MVC Razor Pages + LeptonX Lite.
- Hiển thị cây OU.
- Bảng dữ liệu (JobTitles, Users, Positions) với tìm kiếm, phân trang.
- Form nhập liệu (Modal) cho CRUD các thực thể.
- Giao diện chọn/chuyển đổi Position cho người dùng.
- Form OU phải có trường cho `MaLienThong`, `DiaChi`.

### 0.6. Yêu cầu về phân quyền (Tổng quan)
- Định nghĩa Permissions chi tiết (VD: `OrganizationStructure.JobTitles.Management`, `OrganizationStructure.Positions.AssignRoles`).
- Áp dụng kiểm tra quyền trong Application Services.

### 0.7. Quy tắc nghiệp vụ chính
- Mã Chức vụ là duy nhất (nếu có).
- UserProfile là duy nhất cho mỗi User.
- Chỉ có một vị trí chính (IsPrimary=true) cho mỗi User.
- Logic đồng bộ Role phải chính xác và được kích hoạt đúng thời điểm.
- Xử lý các trường hợp User không có Position, có 1 Position, có nhiều Positions khi đăng nhập.
- Kiểm tra ràng buộc khi xóa (VD: không xóa OU/JobTitle nếu còn Position liên kết).

**Lưu ý chung:** Luôn luôn cập nhật kết quả mỗi bước sau khi hoàn thành vào tệp kế hoạch tương ứng.

## Tóm tắt Tiến độ Thực hiện Dự kiến

- [x] **Bước 1: Tầng Domain (`Aqt.CoreFW.Domain`)** - Xem chi tiết: [org-structure-management-domain-plan.md](./org-structure-management-domain-plan.md)
- [x] **Bước 2: Tầng Domain.Shared (`Aqt.CoreFW.Domain.Shared`)** - Xem chi tiết: [org-structure-management-domain-shared-plan.md](./org-structure-management-domain-shared-plan.md)
- [ ] **Bước 3: Tầng Application.Contracts (`Aqt.CoreFW.Application.Contracts`)** - Xem chi tiết: [org-structure-management-app-contracts-plan.md](./org-structure-management-app-contracts-plan.md)
- [ ] **Bước 4: Tầng Application (`Aqt.CoreFW.Application`)** - Xem chi tiết: [org-structure-management-application-plan.md](./org-structure-management-application-plan.md)
- [ ] **Bước 5: Tầng EntityFrameworkCore (`Aqt.CoreFW.EntityFrameworkCore`)** - Xem chi tiết: [org-structure-management-efcore-plan.md](./org-structure-management-efcore-plan.md)
- [ ] **Bước 6: Tầng Web (`Aqt.CoreFW.Web`)** - Xem chi tiết: [org-structure-management-web-plan.md](./org-structure-management-web-plan.md)
- [ ] **Bước 7: Các bước triển khai và kiểm thử cuối cùng (Thực hiện thủ công)** - Xem chi tiết: [org-structure-management-final-steps-plan.md](./org-structure-management-final-steps-plan.md)