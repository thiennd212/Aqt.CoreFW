# Kế hoạch triển khai Tầng Application - Module Quản lý Cơ cấu Tổ chức

**Module:** `Aqt.CoreFW.Application`

**Mục tiêu:** Triển khai logic ứng dụng, thực thi các yêu cầu chức năng được định nghĩa trong SRS và sử dụng các thành phần từ tầng Domain và Application.Contracts. Áp dụng kiểm tra phân quyền và sử dụng AutoMapper để ánh xạ giữa Entities và DTOs.

## Nhiệm vụ chi tiết

### 1. Cấu hình AutoMapper (`OrgStructureApplicationAutoMapperProfile`)

- [ ] Tạo file `OrgStructure/OrgStructureApplicationAutoMapperProfile.cs`.
- [ ] Kế thừa từ `Profile`.
- [ ] Override constructor và định nghĩa các mapping:
    - **JobTitle:**
        - [ ] `CreateMap<CreateUpdateJobTitleDto, AppJobTitle>();`
        - [ ] `CreateMap<AppJobTitle, JobTitleDto>();`
    - **UserProfile:**
        - [ ] `CreateMap<CreateUpdateUserProfileDto, AppUserProfile>();`
        - [ ] `CreateMap<AppUserProfile, UserProfileDto>();`
    - **OrganizationUnit:**
        - [ ] Nếu đã tạo DTOs tùy chỉnh (`*WithExtraPropertiesDto`):
            - `CreateMap<CreateOrganizationUnitWithExtraPropertiesDto, OrganizationUnit>();` // Map thuộc tính thường
                - `.ForMember(dest => dest.ExtraProperties, opt => opt.MapFrom(src => MapExtraProperties(src)));` // Tạo hàm helper MapExtraProperties
            - `CreateMap<UpdateOrganizationUnitWithExtraPropertiesDto, OrganizationUnit>();` // Tương tự
            - `CreateMap<OrganizationUnit, OrganizationUnitWithExtraPropertiesDto>();` // Map thuộc tính thường
                - `.ForMember(dest => dest.MaLienThong, opt => opt.MapFrom(src => src.GetProperty<string>(OrgStructureConsts.OuMaLienThongExtraPropertyName)))`
                - `.ForMember(dest => dest.DiaChi, opt => opt.MapFrom(src => src.GetProperty<string>(OrgStructureConsts.OuDiaChiExtraPropertyName)))`
        - [ ] **Lưu ý:** Việc mapping với `ExtraProperties` cần xử lý cẩn thận. Cân nhắc việc custom mapping logic thay vì dựa hoàn toàn vào AutoMapper nếu phức tạp.
    - **Position:**
        - [ ] `CreateMap<CreatePositionInput, AppPosition>();`
        - [ ] `CreateMap<AppPosition, PositionDto>();`
            - `.ForMember(dest => dest.OrganizationUnitDisplayName, opt => opt.MapFrom(src => src.OrganizationUnit.DisplayName))` // Nếu include OU
            - `.ForMember(dest => dest.JobTitleName, opt => opt.MapFrom(src => src.JobTitle.TenChucVu))` // Nếu include JobTitle
            - `.ForMember(dest => dest.UserName, opt => opt.MapFrom(src => src.User.UserName))` // Nếu include User
        - [ ] `CreateMap<AppPosition, PositionWithDetailsDto>();` // Map sâu hơn nếu cần
    - **Lookup DTOs:**
        - [ ] `CreateMap<AppJobTitle, LookupDto<Guid>>() .ForMember(dest => dest.DisplayName, opt => opt.MapFrom(src => src.TenChucVu));`
        - [ ] `CreateMap<OrganizationUnit, LookupDto<Guid>>() .ForMember(dest => dest.DisplayName, opt => opt.MapFrom(src => src.DisplayName));` // Hoặc DTO khác nếu cần

### 2. Triển khai Application Services

- **`JobTitleAppService`:**
    - [ ] Tạo file `OrgStructure/JobTitles/JobTitleAppService.cs`.
    - [ ] Kế thừa từ `CrudAppService<AppJobTitle, JobTitleDto, Guid, GetJobTitleListInput, CreateUpdateJobTitleDto>` và implement `IJobTitleAppService`.
    - [ ] Inject `IRepository<AppJobTitle, Guid>`.
    - [ ] Override các phương thức CRUD:
        - `GetListAsync`: Áp dụng filter (`input.FilterText`) cho `MaChucVu` và `TenChucVu`.
        - `CreateAsync`: Kiểm tra quyền `OrgStructurePermissions.JobTitles.Create`. Kiểm tra trùng `MaChucVu` (nếu có và là unique).
        - `UpdateAsync`: Kiểm tra quyền `OrgStructurePermissions.JobTitles.Update`. Kiểm tra trùng `MaChucVu` khi thay đổi.
        - `DeleteAsync`: Kiểm tra quyền `OrgStructurePermissions.JobTitles.Delete`. **Quan trọng:** Gọi Domain Service/Repository để kiểm tra ràng buộc (vd: `positionManager.CanDeleteJobTitleAsync(id)`) trước khi xóa. Ném `UserFriendlyException` nếu không được xóa.
    - [ ] Áp dụng `[Authorize]` attribute cho các phương thức với Permission tương ứng.

- **`UserProfileAppService`:**
    - [ ] Tạo file `OrgStructure/UserProfiles/UserProfileAppService.cs`.
    - [ ] Kế thừa `ApplicationService` và implement `IUserProfileAppService`.
    - [ ] Inject `IRepository<AppUserProfile, Guid>`, `UserManager`.
    - [ ] Triển khai các phương thức:
        - `GetByUserIdAsync`: Kiểm tra quyền (`OrgStructurePermissions.UserProfiles.Management` hoặc quyền xem user của Identity). Tìm UserProfile theo `UserId`. Map sang DTO.
        - `UpdateAsync`: Kiểm tra quyền (`OrgStructurePermissions.UserProfiles.Management`). Tìm UserProfile theo `UserId`, map từ DTO vào Entity, gọi `_userProfileRepository.UpdateAsync`.
        - `GetCurrentUserProfileAsync`: Lấy `CurrentUser.Id`, gọi `GetByUserIdAsync`.
        - `UpdateCurrentUserProfileAsync`: Lấy `CurrentUser.Id`, gọi `UpdateAsync`.

- **`OrganizationUnitAppService` (Kế thừa và Mở rộng Service của ABP):**
    - [ ] Tạo file `OrgStructure/OrganizationUnits/CustomOrganizationUnitAppService.cs` (tên ví dụ).
    - [ ] Kế thừa từ `OrganizationUnitAppService` gốc của ABP và implement `IOrganizationUnitAppService` mới (nếu đã tạo interface tùy chỉnh).
    - [ ] Inject các dependency cần thiết (vd: `IOrganizationUnitRepository`, `ObjectMapper`).
    - [ ] **Override các phương thức liên quan đến Extra Properties (nếu dùng DTO tùy chỉnh):**
        - `CreateAsync(CreateOrganizationUnitWithExtraPropertiesDto input)`:
            - Kiểm tra quyền (`OrganizationUnitPermissions.ManageOrganizationTree` hoặc permission tùy chỉnh).
            - Map `input` sang `OrganizationUnit` bằng AutoMapper (hoặc thủ công).
            - **Quan trọng:** Logic set `ExtraProperties["MaLienThong"] = input.MaLienThong`, `ExtraProperties["DiaChi"] = input.DiaChi`.
            - Gọi base method hoặc repository để tạo OU.
            - Map kết quả trả về sang `OrganizationUnitWithExtraPropertiesDto`.
        - `UpdateAsync(Guid id, UpdateOrganizationUnitWithExtraPropertiesDto input)`:
            - Kiểm tra quyền.
            - Lấy OU từ repository.
            - Map các thuộc tính chuẩn từ `input` vào entity.
            - Cập nhật `ExtraProperties`.
            - Gọi repository để update.
            - Map kết quả trả về.
        - `GetAsync(Guid id)`:
            - Kiểm tra quyền.
            - Lấy OU.
            - Map sang `OrganizationUnitWithExtraPropertiesDto`.
        - `GetListAsync(...)`:
            - Kiểm tra quyền.
            - Lấy danh sách OU.
            - Map từng OU sang `OrganizationUnitWithExtraPropertiesDto`.
    - [ ] **Lưu ý:** Cần kiểm tra kỹ cách ABP xử lý `ExtraProperties` trong phiên bản đang dùng để tránh làm sai logic gốc. Có thể cần custom mapping hoặc xử lý thủ công thay vì override hoàn toàn.

- **`PositionAppService`:**
    - [ ] Tạo file `OrgStructure/Positions/PositionAppService.cs`.
    - [ ] Kế thừa `ApplicationService` và implement `IPositionAppService`.
    - [ ] Inject `IPositionManager`, `IRepository<AppPosition, Guid>`, `IRepository<AppJobTitle, Guid>`, `IOrganizationUnitRepository`, `UserManager`, `RoleManager`.
    - [ ] Triển khai các phương thức:
        - `GetListAsync`: Kiểm tra quyền `OrgStructurePermissions.Positions.View` hoặc `Management`. Lọc theo `UserId`, `OrganizationUnitId`, `FilterText`. Include `OrganizationUnit`, `JobTitle`, `User` nếu cần cho DTO. Áp dụng phân trang, sắp xếp. Map sang `PositionDto`.
        - `GetAsync`: Kiểm tra quyền. Lấy Position, include các bảng liên quan nếu cần `PositionWithDetailsDto`. Map sang DTO.
        - `CreateAsync`: Kiểm tra quyền `OrgStructurePermissions.Positions.Management`. Gọi `_positionManager.CreateAsync(input.UserId, input.OrganizationUnitId, input.JobTitleId)`. Map kết quả sang `PositionDto`.
        - `DeleteAsync`: Kiểm tra quyền `OrgStructurePermissions.Positions.Management`. Gọi `_positionManager.DeleteAsync(id)`.
        - `UpdateRolesAsync`: Kiểm tra quyền `OrgStructurePermissions.Positions.AssignRoles`. Gọi `_positionManager.UpdateRolesAsync(positionId, input.RoleIds)`.
        - `SetAsPrimaryAsync`: Kiểm tra quyền `OrgStructurePermissions.Positions.SetPrimary`. Gọi `_positionManager.SetAsPrimaryAsync(positionId)`.
        - `GetCurrentUserPositionsAsync`: Lấy `CurrentUser.Id`. Gọi `GetListAsync` với `UserId` filter. Trả về `ListResultDto<PositionDto>`.
        - `SwitchActivePositionAsync`: Kiểm tra quyền `OrgStructurePermissions.Positions.SwitchActive`. Kiểm tra xem `positionId` có thuộc `CurrentUser` không. Logic cập nhật claim/context (có thể cần service khác hỗ trợ).
        - `GetJobTitleLookupAsync`: Lấy danh sách `AppJobTitle`, map sang `LookupDto<Guid>`.
        - `GetOrganizationUnitLookupAsync`: Lấy danh sách `OrganizationUnit` (có thể chỉ lấy cây gốc hoặc toàn bộ tùy UI), map sang `OrganizationUnitDto` hoặc `LookupDto<Guid>`.
    - [ ] Áp dụng `[Authorize]` attribute cho các phương thức.

### 3. Xử lý Logic Chuyển đổi Vị trí (`SwitchActivePosition`)

- [ ] Logic này phức tạp và có thể liên quan đến việc cập nhật Claims Principal của người dùng trong phiên hiện tại.
- [ ] Cân nhắc tạo một Service riêng (vd: `IUserContextService`) hoặc tích hợp vào `PositionAppService`.
- [ ] Khi gọi `SwitchActivePositionAsync`:
    - Xác thực `positionId` thuộc về `CurrentUser`.
    - Lấy thông tin Position và các Role liên quan.
    - Cập nhật claim đặc biệt trong `CurrentUser` để lưu `ActivePositionId` (ví dụ: `AqtClaimTypes.ActivePositionId`).
    - **Quan trọng:** Có thể cần đăng xuất và đăng nhập lại người dùng hoặc cập nhật lại cookie/token để claims mới có hiệu lực hoàn toàn, tùy thuộc vào cơ chế xác thực và quản lý phiên. Cần nghiên cứu kỹ cách ABP xử lý việc cập nhật claims trong phiên đang hoạt động.

## Kết quả mong đợi

- `OrgStructureApplicationAutoMapperProfile` được cấu hình đầy đủ.
- Các Application Services (`JobTitleAppService`, `UserProfileAppService`, `CustomOrganizationUnitAppService`, `PositionAppService`) được triển khai với logic ứng dụng, kiểm tra quyền, và mapping DTO/Entity.
- Logic xử lý `ExtraProperties` cho `OrganizationUnit` hoạt động chính xác.
- Logic đồng bộ Role được kích hoạt đúng chỗ từ `PositionAppService` (thông qua `PositionManager`).
- Logic chuyển đổi vị trí được triển khai (có thể cần hoàn thiện sau khi có UI).

## Cập nhật Kế hoạch Tổng thể

- [ ] Đánh dấu hoàn thành Bước 4 trong `org-structure-management-plan-v1.md`.