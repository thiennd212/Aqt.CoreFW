# Kế hoạch triển khai Tầng Web - Module Quản lý Cơ cấu Tổ chức

**Module:** `Aqt.CoreFW.Web` (Hoặc `Aqt.CoreFW.HttpApi.Host` nếu là Blazor WASM/MAUI)

**Mục tiêu:** Xây dựng giao diện người dùng (UI) cho các chức năng quản lý Cơ cấu Tổ chức, sử dụng Razor Pages (hoặc Blazor components), theme LeptonX Lite, và tương tác với backend thông qua các Application Service API (sử dụng generated JavaScript proxies).

## Nhiệm vụ chi tiết

### 1. Cấu hình Menu và Navigation

- [ ] Mở file định nghĩa Menu (`CoreFWMenuContributor.cs`).
- [ ] Thêm một mục menu cha "Cơ cấu Tổ chức" (hoặc tương đương).
    - Yêu cầu quyền: `OrgStructurePermissions.GroupName` (hoặc một quyền xem tổng quát).
    - Sắp xếp vị trí phù hợp trong menu.
- [ ] Thêm các mục menu con:
    - [ ] "Quản lý Chức vụ": Trỏ đến trang `/OrgStructure/JobTitles/Index`. Yêu cầu quyền `OrgStructurePermissions.JobTitles.Default`.
    - [ ] "Quản lý Đơn vị": Trỏ đến trang `/OrgStructure/OrganizationUnits/Index` (hoặc trang quản lý OU của ABP nếu dùng trang đó). Yêu cầu quyền `OrganizationUnitPermissions.ManageOrganizationTree` hoặc quyền tùy chỉnh.
    - [ ] "Quản lý Vị trí": Trỏ đến trang `/OrgStructure/Positions/Index`. Yêu cầu quyền `OrgStructurePermissions.Positions.View` hoặc `Management`.
    - [ ] "Thông tin cá nhân": (Thường đã có sẵn trong menu User Profile của ABP/LeptonX). Nếu cần trang riêng để sửa UserProfile, thêm mục menu ở đây hoặc trong menu user. Yêu cầu đăng nhập.
- [ ] Cập nhật file localization cho tên các mục menu.

### 2. Triển khai Trang Quản lý Chức vụ (`JobTitles`)

- **Trang Index (`Pages/OrgStructure/JobTitles/Index.cshtml` và `.cs`):**
    - [ ] Tạo PageModel kế thừa từ `CoreFWPageModel` (hoặc base page model của bạn).
    - [ ] Inject `IJobTitleAppService`.
    - [ ] Sử dụng `abp-card` và `abp-table` component của LeptonX.
    - [ ] Thêm nút "Thêm mới Chức vụ" (`abp-button`) - Hiển thị nếu có quyền `Create`.
    - [ ] Cấu hình `abp-table` để gọi API `jobTitleAppService.getList` thông qua JavaScript proxy.
        - Hiển thị các cột: `MaChucVu`, `TenChucVu`.
        - Thêm cột Actions với nút Sửa (`abp-button`) và Xóa (`abp-button`).
    - [ ] Implement bộ lọc `FilterText` trên đầu bảng.
    - [ ] Implement các nút Sửa/Xóa để mở modal tương ứng.
- **Modal Tạo/Sửa (`Pages/OrgStructure/JobTitles/CreateModal.cshtml` và `.cs`, `EditModal.cshtml` và `.cs`):**
    - [ ] Tạo các PageModel cho modal, inject `IJobTitleAppService`.
    - [ ] Sử dụng `abp-modal` component.
    - [ ] Tạo ViewModel (`CreateEditJobTitleViewModel`) bind với form, kế thừa `CreateUpdateJobTitleDto`. Áp dụng `[BindProperty]`.
    - [ ] Sử dụng `abp-form` và các `abp-input` cho `MaChucVu`, `TenChucVu`, `MoTa`. Áp dụng validation từ DTO.
    - [ ] `OnGetAsync`: Nếu là Edit, gọi `jobTitleAppService.get` để lấy dữ liệu và map vào ViewModel.
    - [ ] `OnPostAsync`: Gọi `jobTitleAppService.create` hoặc `update` tương ứng. Đóng modal và refresh lại table ở trang Index.
- **JavaScript (`Pages/OrgStructure/JobTitles/index.js`):**
    - [ ] Khởi tạo `abp.libs.datatables.createAjax` cho table.
    - [ ] Xử lý sự kiện click nút Thêm mới, Sửa, Xóa để mở modal (`abp.ModalManager`).
    - [ ] Xử lý sự kiện khi modal đóng để refresh table.
    - [ ] Xử lý nút Xóa: Hiển thị confirm dialog (`abp.message.confirm`), gọi API `delete`, hiển thị thông báo thành công (`abp.notify.success`), refresh table.

### 3. Triển khai Trang Quản lý Đơn vị/Phòng ban (`OrganizationUnits`)

- **Phương án 1: Sử dụng lại trang quản lý OU của ABP**
    - [ ] Đảm bảo module `Volo.Abp.AspNetCore.Mvc.UI.Theme.LeptonX` (hoặc theme tương tự) và `Volo.Abp.OrganizationUnits.Web` được cài đặt.
    - [ ] Trang này thường đã có sẵn tại `/OrganizationUnits`.
    - [ ] **Thách thức:** Tùy chỉnh trang này để hiển thị và cho phép nhập/sửa các trường `MaLienThong`, `DiaChi`.
        - [ ] Có thể cần override Razor Page hoặc View Component của ABP.
        - [ ] Hoặc sử dụng JavaScript để thêm/sửa các trường trên form sau khi modal được hiển thị. Đây là cách phức tạp và dễ bị lỗi khi nâng cấp ABP.
        - [ ] Cần đảm bảo API backend (đã sửa ở Application plan) được gọi đúng khi lưu.
- **Phương án 2: Tạo trang quản lý OU tùy chỉnh**
    - [ ] Tạo `Pages/OrgStructure/OrganizationUnits/Index.cshtml` và `.cs`.
    - [ ] Sử dụng thư viện JavaScript hiển thị cây (ví dụ: jsTree, hoặc component cây có sẵn trong LeptonX nếu có).
    - [ ] Gọi API `customOrganizationUnitAppService.getList` để lấy dữ liệu cây (bao gồm trường mở rộng).
    - [ ] Implement các nút Thêm, Sửa, Xóa node trên cây.
    - [ ] Tạo Modal Thêm/Sửa (`CreateModal.cshtml`, `EditModal.cshtml`) tương tự như JobTitles, nhưng form có thêm trường `MaLienThong`, `DiaChi` và chọn Parent OU (dropdown hoặc chọn từ cây). Sử dụng ViewModel tùy chỉnh và gọi API `customOrganizationUnitAppService.create/update`.
    - [ ] Xử lý logic JavaScript tương ứng.
- **Quyết định:** Nên bắt đầu bằng **Phương án 1** và cố gắng tùy chỉnh trang có sẵn của ABP. Nếu quá phức tạp hoặc không khả thi, mới chuyển sang **Phương án 2**.

### 4. Triển khai Trang Quản lý Vị trí công tác (`Positions`)

- **Trang Index (`Pages/OrgStructure/Positions/Index.cshtml` và `.cs`):**
    - [ ] Giao diện có thể phức tạp hơn, cần cách để lọc/xem vị trí theo User hoặc theo OU.
    - [ ] **Cách 1: Danh sách phẳng:** Hiển thị bảng `abp-table` tất cả các vị trí.
        - Bộ lọc: Chọn User (lookup), Chọn OU (cây/lookup), Chọn JobTitle (lookup).
        - Cột: User Name, OU Name, JobTitle Name, IsPrimary.
        - Actions: Sửa Roles, Đặt làm Primary, Xóa.
    - [ ] **Cách 2: Xem theo OU:** Hiển thị cây OU bên trái, click vào OU hiển thị danh sách User/Position thuộc OU đó bên phải.
    - [ ] **Cách 3: Xem theo User:** Danh sách User bên trái, click vào User hiển thị danh sách Position của User đó bên phải.
    - [ ] **Quyết định:** Bắt đầu với **Cách 1 (Danh sách phẳng)** cho đơn giản, có thể nâng cấp sau.
    - [ ] Inject `IPositionAppService`, `IIdentityUserAppService` (để lấy lookup user), `IOrganizationUnitAppService` (để lấy lookup OU), `IJobTitleAppService` (để lấy lookup JobTitle).
    - [ ] Thêm nút "Gán Vị trí mới".
    - [ ] Cấu hình `abp-table` gọi `positionAppService.getList`.
    - [ ] Implement các nút action.
- **Modal Tạo Vị trí (`Pages/OrgStructure/Positions/CreateModal.cshtml` và `.cs`):**
    - [ ] Form nhập liệu:
        - Chọn User (`abp-select` hoặc lookup component).
        - Chọn OU (`abp-select` với cây hoặc component chọn cây).
        - Chọn JobTitle (`abp-select`).
    - [ ] ViewModel bind với form.
    - [ ] `OnGetAsync`: Load dữ liệu cho các lookup User, OU, JobTitle.
    - [ ] `OnPostAsync`: Gọi `positionAppService.create`.
- **Modal Sửa Vai trò (`Pages/OrgStructure/Positions/AssignRolesModal.cshtml` và `.cs`):**
    - [ ] Inject `IPositionAppService`, `IIdentityRoleAppService`.
    - [ ] `OnGetAsync(Guid positionId)`:
        - Lấy thông tin Position (để hiển thị User/OU/JobTitle).
        - Lấy danh sách tất cả Roles (`roleAppService.getAllList`).
        - Lấy danh sách Roles hiện tại của Position (cần phương thức API mới trong `IPositionAppService` hoặc lấy từ `PositionWithDetailsDto`).
        - Hiển thị danh sách Roles dưới dạng Checkbox list, check sẵn các role đã gán.
    - [ ] ViewModel chứa `PositionId` và `List<Guid> SelectedRoleIds`.
    - [ ] `OnPostAsync`: Gọi `positionAppService.updateRoles`.
- **JavaScript (`Pages/OrgStructure/Positions/index.js`):**
    - [ ] Khởi tạo Datatable, xử lý bộ lọc.
    - [ ] Xử lý mở các modal (Create, AssignRoles).
    - [ ] Xử lý nút "Đặt làm Primary": Gọi API `positionAppService.setAsPrimary`, refresh table.
    - [ ] Xử lý nút Xóa: Tương tự JobTitles.

### 5. Triển khai Trang/Component Sửa Thông tin Cá nhân (`UserProfile`)

- [ ] Tạo trang `Pages/OrgStructure/UserProfiles/EditModal.cshtml` (hoặc component riêng).
- [ ] Inject `IUserProfileAppService`.
- [ ] ViewModel kế thừa `CreateUpdateUserProfileDto`.
- [ ] Form với các trường `HoTen`, `SoDienThoai`, `DiaChi`, `AnhDaiDienUrl` (cần component upload ảnh).
- [ ] `OnGetAsync`: Gọi `userProfileAppService.getCurrentUserProfile`.
- [ ] `OnPostAsync`: Gọi `userProfileAppService.updateCurrentUserProfile`.
- [ ] Tích hợp trang/modal này vào menu User của LeptonX.

### 6. Triển khai Chức năng Chọn/Chuyển đổi Vị trí

- **Hiển thị Vị trí Hiện tại & Nút Chuyển đổi:**
    - [ ] Tìm đến Layout (`_Layout.cshtml` hoặc partial view tương ứng trong LeptonX) nơi hiển thị thông tin user đăng nhập (thường ở header).
    - [ ] Tạo một View Component (`ActivePositionViewComponent`) hoặc sử dụng Partial View.
    - [ ] Inject `IPositionAppService`, `ICurrentUser`.
    - [ ] Trong `InvokeAsync`:
        - Lấy `CurrentUser.Id`.
        - Lấy `ActivePositionId` từ Claim (vd: `CurrentUser.FindClaim(AqtClaimTypes.ActivePositionId)?.Value`).
        - Gọi `positionAppService.getCurrentUserPositions` để lấy danh sách vị trí.
        - Tìm vị trí active trong danh sách.
        - Hiển thị tên OU/JobTitle của vị trí active.
        - Nếu user có > 1 vị trí, hiển thị dropdown (`abp-dropdown`) chứa các vị trí khác.
    - [ ] Render View Component này ở vị trí phù hợp trong layout.
- **Xử lý Chuyển đổi (JavaScript):**
    - [ ] Khi người dùng chọn vị trí khác từ dropdown:
        - Lấy `positionId` của vị trí được chọn.
        - Gọi API `positionAppService.switchActivePosition(positionId)` bằng AJAX.
        - **Quan trọng:** Sau khi API trả về thành công, cần **reload lại trang** (`location.reload()`) để server cập nhật lại Claims Principal và UI hiển thị đúng ngữ cảnh mới.

### 7. Kiểm tra Phân quyền trên UI

- [ ] Sử dụng Tag Helper `abp-button-xxx` hoặc `abp-item` với thuộc tính `required-policy` để ẩn/hiện các nút Thêm mới, Sửa, Xóa, Gán Role, Đặt Primary dựa trên Permissions đã định nghĩa.
    - Ví dụ: `<abp-button button-type="Primary" text="@L["Create"]" required-policy="@OrgStructurePermissions.JobTitles.Create" />`

## Kết quả mong đợi

- Menu điều hướng được cập nhật.
- Các trang quản lý CRUD cho JobTitles, OrganizationUnits (tùy chỉnh hoặc dùng lại), Positions hoạt động đầy đủ với UI thân thiện.
- Modal sửa thông tin cá nhân UserProfile hoạt động.
- Chức năng hiển thị vị trí active và chuyển đổi vị trí hoạt động trên layout.
- Phân quyền được áp dụng đúng trên các thành phần UI.
- Giao diện tuân thủ theme LeptonX Lite.

## Cập nhật Kế hoạch Tổng thể

- [ ] Đánh dấu hoàn thành Bước 6 trong `org-structure-management-plan-v1.md`.