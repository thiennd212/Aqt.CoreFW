# Kế hoạch triển khai Các bước cuối cùng - Module Quản lý Cơ cấu Tổ chức

**Mục tiêu:** Hoàn thiện module, đảm bảo chất lượng thông qua kiểm thử, bổ sung dữ liệu mẫu, và đóng gói chuẩn bị cho triển khai.

## Nhiệm vụ chi tiết

### 1. Kiểm thử Đơn vị (Unit Tests)

- **Tầng Domain (`*.Domain.Tests`):**
    - [ ] Viết Unit Test cho `PositionManager`:
        - Mock các Dependencies (Repositories, UserManager, RoleManager...).
        - Test logic `CreateAsync` (trùng lặp, xử lý IsPrimary).
        - Test logic `UpdateRolesAsync` (cập nhật đúng PositionRoles, trigger sync).
        - Test logic `SetAsPrimaryAsync`.
        - Test logic `DeleteAsync` (xóa đúng, trigger sync).
        - Test logic `SynchronizeUserRolesAsync` (tính toán đúng roles cần thêm/xóa, gọi đúng UserManager).
        - Test logic kiểm tra ràng buộc xóa OU/JobTitle.
    - [ ] Viết Unit Test cho các Entity (nếu có logic phức tạp trong constructor hoặc methods).
- **Tầng Application (`*.Application.Tests`):**
    - [ ] Viết Unit Test cho các `AppService`:
        - Mock Dependencies (Repositories, Managers, ObjectMapper...).
        - Test các phương thức CRUD cơ bản (gọi đúng repository/manager, map đúng DTO).
        - Test logic filter, phân trang, sắp xếp trong `GetListAsync`.
        - Test việc kiểm tra quyền (`PermissionChecker`).
        - Test việc xử lý `ExtraProperties` trong `CustomOrganizationUnitAppService`.
        - Test logic gọi các phương thức của `PositionManager` từ `PositionAppService`.
        - Test việc gọi đúng API lấy lookup data.

### 2. Kiểm thử Tích hợp (Integration Tests)

- **Tầng Application (`*.Application.Tests`):**
    - [ ] Viết Integration Test cho các `AppService` sử dụng Test Base của ABP:
        - Test các kịch bản CRUD hoàn chỉnh từ API đến Database (không mock repository).
        - Test kịch bản tạo Position, gán Roles, rồi kiểm tra `AbpUserRole` có được cập nhật đúng không.
        - Test kịch bản thay đổi Roles của Position và kiểm tra lại `AbpUserRole`.
        - Test kịch bản xóa Position và kiểm tra lại `AbpUserRole`.
        - Test kịch bản thêm/sửa OU với `MaLienThong`, `DiaChi` và kiểm tra giá trị trong `ExtraProperties` ở DB.
        - Test ràng buộc không cho xóa OU/JobTitle khi còn Position liên kết.
- **Tầng Web/UI (Nếu có framework Test UI):**
    - [ ] Test các kịch bản người dùng trên giao diện (tạo JobTitle, tạo OU, gán Position, đổi vị trí...).

### 3. Kiểm thử Thủ công (Manual Testing)

- [ ] Thực hiện các kịch bản sử dụng chính theo SRS:
    - [ ] Quản trị viên tạo JobTitle, tạo OU (có Mã liên thông, Địa chỉ).
    - [ ] Quản trị viên tạo User.
    - [ ] Quản trị viên gán User vào nhiều Position khác nhau với các JobTitle và OU khác nhau.
    - [ ] Quản trị viên gán Roles khác nhau cho từng Position.
    - [ ] Kiểm tra xem Roles tổng hợp trong `AbpUserRole` (qua trang quản lý User của Identity) có đúng không.
    - [ ] Quản trị viên đặt một Position làm Primary.
    - [ ] Người dùng đăng nhập:
        - Trường hợp không có Position.
        - Trường hợp có 1 Position (tự động active).
        - Trường hợp có >1 Position (hiển thị chọn, gợi ý primary).
    - [ ] Người dùng chuyển đổi giữa các Position đang active, kiểm tra UI header cập nhật, kiểm tra quyền hạn thay đổi theo Position mới (thử truy cập chức năng chỉ được phép ở 1 vị trí).
    - [ ] Người dùng tự cập nhật UserProfile.
    - [ ] Quản trị viên xóa Position, kiểm tra `AbpUserRole` cập nhật.
    - [ ] Quản trị viên thử xóa OU/JobTitle đang có Position -> Bị chặn.
    - [ ] Kiểm tra các chức năng tìm kiếm, phân trang, sắp xếp trên các bảng.
    - [ ] Kiểm tra validation trên các form.
    - [ ] Kiểm tra việc ẩn/hiện nút theo phân quyền cho các vai trò khác nhau (Admin, User thường).

### 4. Seed Dữ liệu Mẫu (Data Seeding)

- [ ] Xác định xem có cần seed dữ liệu ban đầu không (ví dụ: một vài JobTitle mặc định, OU gốc).
- [ ] Tạo một `IDataSeedContributor` mới (ví dụ: `OrgStructureDataSeedContributor`) trong project `*.Domain` hoặc `*.Application`.
- [ ] Implement phương thức `SeedAsync`:
    - Kiểm tra xem dữ liệu đã tồn tại chưa.
    - Tạo các bản ghi JobTitle, OU mẫu nếu cần.
- [ ] Đăng ký Seeder này vào `CoreFWDbMigrationService` (hoặc tương đương).

### 5. Rà soát và Tối ưu Code

- [ ] Kiểm tra lại toàn bộ code của module:
    - [ ] Tuân thủ Coding Conventions.
    - [ ] Loại bỏ code thừa, comment không cần thiết.
    - [ ] Tối ưu các truy vấn LINQ (sử dụng `AsNoTracking`, `Select`, tránh N+1).
    - [ ] Xử lý `async/await` đúng cách.
    - [ ] Kiểm tra xử lý lỗi và log (nếu có).
    - [ ] Đảm bảo không có thông tin nhạy cảm bị lộ (vd: trong logs, exceptions).
- [ ] Chạy lại các bài test sau khi tối ưu.

### 6. Viết Tài liệu (Documentation)

- [ ] Cập nhật tài liệu SRS (nếu có thay đổi trong quá trình triển khai).
- [ ] Viết tài liệu hướng dẫn sử dụng cơ bản cho Quản trị viên và Người dùng cuối.
- [ ] (Tùy chọn) Viết tài liệu kỹ thuật mô tả kiến trúc, các quyết định thiết kế quan trọng của module.

## Kết quả mong đợi

- Module được kiểm thử kỹ lưỡng (Unit, Integration, Manual).
- Các lỗi được phát hiện và sửa chữa.
- Dữ liệu mẫu (nếu cần) được seed vào hệ thống.
- Code được rà soát, tối ưu và clean.
- Tài liệu cần thiết được hoàn thành.
- Module sẵn sàng để đóng gói và triển khai.

## Cập nhật Kế hoạch Tổng thể

- [ ] Đánh dấu hoàn thành Bước 7 trong `org-structure-management-plan-v1.md`.