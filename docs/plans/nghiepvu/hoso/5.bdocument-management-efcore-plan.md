# Kế hoạch chi tiết: Tầng EntityFrameworkCore (`Aqt.CoreFW.EntityFrameworkCore`) - Quản lý Hồ sơ (BDocument)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.EntityFrameworkCore` cho module Quản lý Hồ sơ (BDocument).

## 1. DbContext

-   **Vị trí:** Cập nhật file `src/Aqt.CoreFW.EntityFrameworkCore/EntityFrameworkCore/CoreFWDbContext.cs`
-   **Nội dung cần thêm:**
    ```csharp
    using Aqt.CoreFW.Domain.BDocuments.Entities; // Thêm using cho BDocument Entities
    using Microsoft.EntityFrameworkCore;
    using System.Reflection;
    // ... other usings ...

    public class CoreFWDbContext : AbpDbContext<CoreFWDbContext>, /* ... các interface khác ... */
    {
        // ... các DbSet khác ...
        public DbSet<BDocument> BDocuments { get; set; } // Thêm DbSet cho BDocument
        public DbSet<BDocumentData> BDocumentData { get; set; } // Thêm DbSet cho BDocumentData

        public CoreFWDbContext(DbContextOptions<CoreFWDbContext> options)
            : base(options)
        {
        }

        protected override void OnModelCreating(ModelBuilder builder)
        {
            base.OnModelCreating(builder);

            // Cấu hình các module khác của ABP...
            // ...

            // Áp dụng tất cả cấu hình entity trong assembly này
            builder.ApplyConfigurationsFromAssembly(Assembly.GetExecutingAssembly());
        }
    }
    ```

## 2. Entity Configuration (`BDocumentConfiguration.cs`)

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.EntityFrameworkCore/EntityTypeConfigurations/BDocuments` (Tạo thư mục nếu chưa có)
-   **Tệp:** Tạo file `BDocumentConfiguration.cs`
-   **Nội dung:**
    ```csharp
    using Aqt.CoreFW.BDocuments; // Namespace chứa BDocumentConsts
    using Aqt.CoreFW.Domain.BDocuments.Entities; // BDocument Entity
    using Aqt.CoreFW.Domain.Procedures.Entities; // Procedure Entity for relationship
    using Aqt.CoreFW.Domain.WorkflowStatuses.Entities; // WorkflowStatus Entity for relationship
    using Aqt.CoreFW.Domain.Shared; // Namespace chứa CoreFWConsts
    using Microsoft.EntityFrameworkCore;
    using Microsoft.EntityFrameworkCore.Metadata.Builders;
    using Volo.Abp.EntityFrameworkCore.Modeling;

    namespace Aqt.CoreFW.EntityFrameworkCore.EntityTypeConfigurations.BDocuments;

    /// <summary>
    /// Cấu hình ánh xạ cơ sở dữ liệu cho entity <see cref="BDocument"/>.
    /// </summary>
    public class BDocumentConfiguration : IEntityTypeConfiguration<BDocument>
    {
        public void Configure(EntityTypeBuilder<BDocument> builder)
        {
            // Sử dụng DbTablePrefix và DbSchema từ CoreFWConsts
            builder.ToTable(CoreFWConsts.DbTablePrefix + "BDocuments", CoreFWConsts.DbSchema);

            builder.ConfigureByConvention(); // Áp dụng quy ước FullAuditedAggregateRoot

            builder.HasKey(x => x.Id);

            // --- Property Configurations ---
            builder.Property(x => x.ProcedureId)
                .IsRequired()
                .HasColumnName(nameof(BDocument.ProcedureId));

            builder.Property(x => x.Code)
                .IsRequired()
                .HasMaxLength(BDocumentConsts.MaxCodeLength)
                .HasColumnName(nameof(BDocument.Code));

            builder.Property(x => x.ApplicantName)
                .IsRequired()
                .HasMaxLength(BDocumentConsts.MaxApplicantNameLength)
                .HasColumnName(nameof(BDocument.ApplicantName));

            builder.Property(x => x.ApplicantIdentityNumber)
                .HasMaxLength(BDocumentConsts.MaxApplicantIdentityNumberLength)
                .HasColumnName(nameof(BDocument.ApplicantIdentityNumber));

            builder.Property(x => x.ApplicantAddress)
                .HasMaxLength(BDocumentConsts.MaxApplicantAddressLength)
                .HasColumnName(nameof(BDocument.ApplicantAddress));

            builder.Property(x => x.ApplicantEmail)
                .HasMaxLength(BDocumentConsts.MaxApplicantEmailLength)
                .HasColumnName(nameof(BDocument.ApplicantEmail));

            builder.Property(x => x.ApplicantPhoneNumber)
                .HasMaxLength(BDocumentConsts.MaxApplicantPhoneNumberLength)
                .HasColumnName(nameof(BDocument.ApplicantPhoneNumber));

            // --- LOẠI BỎ CẤU HÌNH TRƯỜNG TỜ KHAI ---

            // Cấu hình trường mới
            builder.Property(x => x.ScopeOfActivity)
                .HasColumnName(nameof(BDocument.ScopeOfActivity))
                .HasColumnType("NCLOB") // Hoặc "text" tùy DB, hoặc bỏ qua nếu mặc định phù hợp
                .IsRequired(false); // Nullable

            builder.Property(x => x.ReceiveByPost)
                .IsRequired() // bool không nullable
                .HasColumnName(nameof(BDocument.ReceiveByPost));

            // WorkflowStatusId là nullable Guid?
            builder.Property(x => x.WorkflowStatusId)
                .HasColumnName(nameof(BDocument.WorkflowStatusId))
                .IsRequired(false); // Nullable

            builder.Property(x => x.SubmissionDate).HasColumnName(nameof(BDocument.SubmissionDate));
            builder.Property(x => x.ReceptionDate).HasColumnName(nameof(BDocument.ReceptionDate));
            builder.Property(x => x.AppointmentDate).HasColumnName(nameof(BDocument.AppointmentDate));
            builder.Property(x => x.ResultDate).HasColumnName(nameof(BDocument.ResultDate));

            builder.Property(x => x.RejectionOrAdditionReason)
                .HasMaxLength(BDocumentConsts.MaxRejectionOrAdditionReasonLength)
                .HasColumnName(nameof(BDocument.RejectionOrAdditionReason));

            // Configure ExtraProperties JSON mapping
            builder.Property(x => x.ExtraProperties).HasJsonConversion();

            // --- Relationships ---

            // Relationship với Procedure
            builder.HasOne(d => d.Procedure)
                   .WithMany()
                   .HasForeignKey(d => d.ProcedureId)
                   .IsRequired()
                   .OnDelete(DeleteBehavior.Restrict);

            // Relationship với WorkflowStatus
            builder.HasOne(d => d.WorkflowStatus)
                   .WithMany()
                   .HasForeignKey(d => d.WorkflowStatusId)
                   .IsRequired(false) // FK is nullable
                   .OnDelete(DeleteBehavior.Restrict);

            // Relationship với BDocumentData
            builder.HasMany(d => d.DocumentData)
                   .WithOne() // No navigation property back needed here
                   .HasForeignKey(dd => dd.BDocumentId)
                   .IsRequired()
                   .OnDelete(DeleteBehavior.Cascade); // Xóa data khi xóa document


            // --- Indexes ---

            // Index cho Code (Unique)
            builder.HasIndex(x => x.Code)
                   .IsUnique()
                   .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}BDocuments_Code");

            // Indexes cho khóa ngoại và trường hay lọc
            builder.HasIndex(x => x.ProcedureId)
                   .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}BDocuments_ProcedureId");

            builder.HasIndex(x => x.WorkflowStatusId)
                   .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}BDocuments_WorkflowStatusId");

            builder.HasIndex(x => x.ApplicantName)
                   .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}BDocuments_ApplicantName");

            builder.HasIndex(x => x.CreationTime)
                   .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}BDocuments_CreationTime");

            builder.HasIndex(x => new { x.ProcedureId, x.WorkflowStatusId, x.CreationTime })
                  .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}BDocuments_Proc_Status_Created");

            // Thêm index cho trường mới nếu cần lọc nhiều
            builder.HasIndex(x => x.ReceiveByPost)
                   .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}BDocuments_ReceiveByPost");
        }
    }
    ```

## 2.1. Entity Configuration (`BDocumentDataConfiguration.cs`)

-   **Vị trí:** `src/Aqt.CoreFW.EntityFrameworkCore/EntityTypeConfigurations/BDocuments/`
-   **Tệp:** Tạo file `BDocumentDataConfiguration.cs`
-   **Nội dung:**
    ```csharp
    using Aqt.CoreFW.Domain.BDocuments.Entities; // BDocumentData Entity
    using Aqt.CoreFW.Domain.Shared; // CoreFWConsts
    using Microsoft.EntityFrameworkCore;
    using Microsoft.EntityFrameworkCore.Metadata.Builders;
    using Volo.Abp.EntityFrameworkCore.Modeling;

    namespace Aqt.CoreFW.EntityFrameworkCore.EntityTypeConfigurations.BDocuments;

    /// <summary>
    /// Cấu hình ánh xạ cơ sở dữ liệu cho entity <see cref="BDocumentData"/>.
    /// </summary>
    public class BDocumentDataConfiguration : IEntityTypeConfiguration<BDocumentData>
    {
        public void Configure(EntityTypeBuilder<BDocumentData> builder)
        {
            // Table Name and Schema
            builder.ToTable(CoreFWConsts.DbTablePrefix + "BDocumentData", CoreFWConsts.DbSchema);

            builder.ConfigureByConvention(); // Apply standard conventions (AuditedEntity)

            builder.HasKey(x => x.Id);

            // --- Property Configurations ---
            builder.Property(x => x.BDocumentId)
                .IsRequired()
                .HasColumnName(nameof(BDocumentData.BDocumentId));

            builder.Property(x => x.ProcedureComponentId)
                .IsRequired()
                .HasColumnName(nameof(BDocumentData.ProcedureComponentId));

            // Cấu hình cho InputData - cần kiểu dữ liệu lớn cho JSON
            builder.Property(x => x.InputData)
                .HasColumnName(nameof(BDocumentData.InputData))
                .IsRequired(false) // Nullable
                .HasColumnType("NCLOB"); // Kiểu dữ liệu lớn cho Oracle, hoặc "nvarchar(max)" cho SQL Server, "text" cho PostgreSQL/MySQL

            // FileId là nullable Guid?
             builder.Property(x => x.FileId)
                .HasColumnName(nameof(BDocumentData.FileId))
                .IsRequired(false); // Nullable

            // --- Relationships ---
            // Relationship back to BDocument đã được định nghĩa trong BDocumentConfiguration

            // --- Indexes ---
            builder.HasIndex(x => x.BDocumentId)
                   .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}BDocumentData_BDocumentId");

            builder.HasIndex(x => x.ProcedureComponentId)
                   .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}BDocumentData_ProcedureComponentId");

            builder.HasIndex(x => x.FileId)
                   .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}BDocumentData_FileId");

            // Composite index đảm bảo mỗi component chỉ có 1 entry cho mỗi document
            builder.HasIndex(x => new { x.BDocumentId, x.ProcedureComponentId })
                   .IsUnique()
                   .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}BDocumentData_Doc_Comp");
        }
    }
    ```

## 3. Repository Implementation (`BDocumentRepository.cs`)

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.EntityFrameworkCore/Repositories/BDocuments` (Tạo thư mục nếu chưa có)
-   **Tệp:** Tạo file `BDocumentRepository.cs` bên trong thư mục trên
-   **Nội dung:** (Cập nhật nhẹ nếu cần thêm filter)
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Linq.Dynamic.Core;
    using System.Threading;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Domain.BDocuments; // IBDocumentRepository
    using Aqt.CoreFW.Domain.BDocuments.Entities; // Entities namespace
    using Aqt.CoreFW.EntityFrameworkCore; // CoreFWDbContext, EfCoreRepository
    using JetBrains.Annotations;
    using Microsoft.EntityFrameworkCore;
    using Volo.Abp.Domain.Repositories.EntityFrameworkCore;
    using Volo.Abp.EntityFrameworkCore;

    namespace Aqt.CoreFW.EntityFrameworkCore.Repositories.BDocuments;

    public class BDocumentRepository :
        EfCoreRepository<CoreFWDbContext, BDocument, Guid>,
        IBDocumentRepository
    {
        public BDocumentRepository(IDbContextProvider<CoreFWDbContext> dbContextProvider)
            : base(dbContextProvider)
        {
        }

        // Helper to optionally include details
        protected virtual async Task<IQueryable<BDocument>> GetQueryableAsync(bool includeDetails = false)
        {
            var query = (await GetDbSetAsync()).AsQueryable();
            if (includeDetails)
            {
                query = query.Include(d => d.DocumentData);
                // Optionally include Procedure and Status if needed, impacts performance
                // query = query.Include(d => d.Procedure);
                // query = query.Include(d => d.WorkflowStatus);
            }
            return query;
        }

        public async Task<BDocument?> FindByCodeAsync(
            [NotNull] string code,
            bool includeDetails = false,
            CancellationToken cancellationToken = default)
        {
            var query = await GetQueryableAsync(includeDetails);
            return await query.AsNoTracking()
                              .FirstOrDefaultAsync(p => p.Code == code, GetCancellationToken(cancellationToken));
        }

        public async Task<bool> CodeExistsAsync(
            [NotNull] string code,
            Guid? excludeId = null,
            CancellationToken cancellationToken = default)
        {
            var dbSet = await GetDbSetAsync();
            var query = dbSet.AsNoTracking().Where(p => p.Code == code);

            if (excludeId.HasValue)
            {
                query = query.Where(p => p.Id != excludeId.Value);
            }

            return await query.AnyAsync(GetCancellationToken(cancellationToken));
        }

        public async Task<List<BDocument>> GetListAsync(
            string? filterText = null,
            Guid? procedureId = null,
            Guid? workflowStatusId = null,
            DateTime? submissionDateFrom = null,
            DateTime? submissionDateTo = null,
            // bool? receiveByPost = null, // Thêm filter nếu có trong interface
            string? sorting = null,
            int maxResultCount = int.MaxValue,
            int skipCount = 0,
            bool includeDetails = false,
            CancellationToken cancellationToken = default)
        {
            var query = await GetListQueryInternalAsync(filterText, procedureId, workflowStatusId, submissionDateFrom, submissionDateTo, /* receiveByPost, */ includeDetails);

            query = query.OrderBy(sorting.IsNullOrWhiteSpace() ?
                $"{nameof(BDocument.CreationTime)} desc"
                : sorting);

            return await query.PageBy(skipCount, maxResultCount)
                              .ToListAsync(GetCancellationToken(cancellationToken));
        }

        public async Task<long> GetCountAsync(
            string? filterText = null,
            Guid? procedureId = null,
            Guid? workflowStatusId = null,
            DateTime? submissionDateFrom = null,
            DateTime? submissionDateTo = null,
            // bool? receiveByPost = null, // Thêm filter nếu có trong interface
            CancellationToken cancellationToken = default)
        {
            var query = await GetListQueryInternalAsync(filterText, procedureId, workflowStatusId, submissionDateFrom, submissionDateTo, /* receiveByPost, */ includeDetails: false);
            return await query.LongCountAsync(GetCancellationToken(cancellationToken));
        }

        public async Task<BDocument?> GetWithDataAsync(
            Guid id,
            CancellationToken cancellationToken = default)
        {
            var query = await GetQueryableAsync(includeDetails: true); // Include DocumentData
            return await query.FirstOrDefaultAsync(d => d.Id == id, GetCancellationToken(cancellationToken));
        }


        // --- Private Helper Method ---

        private async Task<IQueryable<BDocument>> GetListQueryInternalAsync(
             string? filterText = null,
             Guid? procedureId = null,
             Guid? workflowStatusId = null,
             DateTime? submissionDateFrom = null,
             DateTime? submissionDateTo = null,
             // bool? receiveByPost = null, // Thêm filter nếu có
             bool includeDetails = false)
        {
            var query = await GetQueryableAsync(includeDetails);

            query = query.AsNoTracking()
                 .WhereIf(!filterText.IsNullOrWhiteSpace(), p =>
                     (p.Code != null && p.Code.Contains(filterText!)) ||
                     (p.ApplicantName != null && p.ApplicantName.Contains(filterText!)))
                 .WhereIf(procedureId.HasValue, p => p.ProcedureId == procedureId!.Value)
                 .WhereIf(workflowStatusId.HasValue, p => p.WorkflowStatusId == workflowStatusId!.Value)
                 .WhereIf(submissionDateFrom.HasValue, p => p.SubmissionDate >= submissionDateFrom!.Value)
                 .WhereIf(submissionDateTo.HasValue, p => p.SubmissionDate <= submissionDateTo!.Value);
                 // .WhereIf(receiveByPost.HasValue, p => p.ReceiveByPost == receiveByPost.Value); // Thêm filter nếu có

            return query;
        }
    }
    ```

## 4. Cập nhật `CoreFWDbContextModelCreatingExtensions.cs` (Không bắt buộc nếu dùng `ApplyConfigurationsFromAssembly`)

-   **Hành động:** Không cần thay đổi nếu dùng `ApplyConfigurationsFromAssembly`. Nếu không, đảm bảo gọi `ApplyConfiguration` cho `BDocumentConfiguration` và `BDocumentDataConfiguration`.

## 5. Database Migrations

-   **Hành động:**
    1.  **Thêm Migration:**
        ```bash
        dotnet ef migrations add Updated_BDocuments_Structure_v2
        ```
        *(Đặt tên migration mô tả, ví dụ: `Updated_BDocuments_Structure_v2`)*
    2.  **Kiểm tra Migration:** Mở file migration mới. Kiểm tra kỹ:
        *   **Xóa** các cột Tờ khai cũ khỏi bảng `BDocuments`.
        *   **Thêm** các cột `ScopeOfActivity` (kiểu dữ liệu lớn `NCLOB` cho Oracle) và `ReceiveByPost` (boolean) vào bảng `BDocuments`.
        *   **Xác nhận** cột `WorkflowStatusId` trong `BDocuments` là nullable.
        *   **Xác nhận** cột `InputData` trong `BDocumentData` có kiểu dữ liệu lớn (`NCLOB` cho Oracle).
        *   Kiểm tra lại các index và foreign keys đã được cập nhật tên.
    3.  **Cập nhật Database:**
        ```bash
        dotnet ef database update
        ```

## 6. Lưu ý

*   **Entity Configuration:** Cấu hình đã được cập nhật để phản ánh đúng cấu trúc entity mới (tên trường, const, index tiếng Anh), bao gồm việc loại bỏ trường cũ, thêm trường mới, cấu hình nullability và kiểu dữ liệu.
*   **Repository Implementation:** Logic cơ bản giữ nguyên. Các phương thức và điều kiện `WhereIf` đã được cập nhật để sử dụng tên trường tiếng Anh.
*   **Migrations:** Bước quan trọng nhất là kiểm tra file migration để đảm bảo cấu trúc database được cập nhật chính xác theo entity configuration mới.