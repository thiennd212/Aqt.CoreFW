# Kế hoạch triển khai chức năng quản lý Hồ sơ (BDocument) - v1

## 0. Phân tích nghiệp vụ

### 0.1. Mục tiêu
- Xây dựng chức năng cho phép người dùng (ví dụ: cán bộ tiếp nhận, xử lý) tạo và quản lý các Hồ sơ (BDocument) tương ứng với từng Thủ tục hành chính (Procedure) cụ thể.
- Đảm bảo việc nhập liệu cho các thành phần dạng Form (bao gồm cả Form "Tờ khai" phức tạp) và tải lên tệp cho các thành phần dạng File được thực hiện đúng theo yêu cầu của Thủ tục hành chính liên quan, **tận dụng module quản lý tệp (`FileManagement`) và entity `EasyAbp.FileManagement.Files.File` đã có**.
- Có cơ chế tạo file tài liệu (ví dụ: PDF/Word) từ dữ liệu đã nhập trong Form "Tờ khai" và đính kèm file này vào hồ sơ.
- Quản lý vòng đời và trạng thái xử lý của Hồ sơ, **sử dụng danh mục Trạng thái quy trình (`WorkflowStatus`) đã được triển khai**.
- Cung cấp khả năng tra cứu, xem chi tiết và theo dõi tiến độ xử lý Hồ sơ.

### 0.2. Đối tượng sử dụng
- Cán bộ tiếp nhận hồ sơ.
- Cán bộ xử lý/thẩm định hồ sơ.
- Lãnh đạo/quản lý phê duyệt hồ sơ.
- Quản trị viên hệ thống (cho cấu hình và quản lý chung).
- (Có thể) Người nộp hồ sơ (nếu có cổng dịch vụ công). *(Phạm vi hiện tại tập trung vào quản lý nội bộ)*

### 0.3. Yêu cầu chức năng chính
- **Tạo mới Hồ sơ (Create):**
    - Hành động tạo mới được bắt đầu với `ProcedureId` đã biết trước.
    - Nhập thông tin Chủ hồ sơ (Tên, Số định danh, Địa chỉ, Liên hệ...).
    - Nhập thông tin bổ sung của hồ sơ như "Phạm vi và nội dung hoạt động...", chọn "Đăng ký nhận hồ sơ qua đường bưu điện".
    - Hệ thống tự động hiển thị các Thành phần thủ tục (Component) tương ứng với Procedure đã chọn:
        - **Đối với Component loại `Form` (đặc biệt là form "Tờ khai"):** Hiển thị động các trường nhập liệu dựa trên `FormDefinition` của Component. Dữ liệu nhập được lưu dưới dạng cấu trúc (ví dụ: JSON) vào `BDocumentData.DuLieuNhap`.
        - **Đối với Component loại `File`:** Cho phép tải lên tệp đính kèm thông qua việc gọi `IFileAppService` từ module `FileManagement`. `FileId` được lưu vào `BDocumentData.FileId`.
    - Hệ thống tự động gán Mã hồ sơ (có thể cấu hình quy tắc sinh mã).
    - **Trạng thái ban đầu của hồ sơ là `null`, sẽ được cập nhật bởi hệ thống Workflow sau khi tạo.**
    - Lưu trữ thông tin Chủ hồ sơ, thông tin bổ sung, dữ liệu Form đã nhập (JSON), và thông tin tham chiếu `FileId` vào các bản ghi `BDocument` và `BDocumentData` tương ứng.
- **Tạo file từ Tờ khai (Post-Create Action):**
    - Cần có một chức năng (nút bấm, action workflow, job...) để:
        - Đọc dữ liệu JSON từ `BDocumentData.DuLieuNhap` của component "Tờ khai".
        - Sử dụng template (Word/PDF) để tạo file chứa thông tin từ tờ khai.
        - Upload file vừa tạo lên `FileManagement`.
        - Cập nhật `BDocumentData.FileId` của component "Tờ khai" với `FileId` mới.
- **Xem danh sách (Read List):**
    - Hiển thị danh sách các Hồ sơ đã tạo dưới dạng bảng.
    - Các cột cơ bản: STT, Mã hồ sơ, Tên chủ hồ sơ, Tên thủ tục, **Tên Trạng thái (lấy từ `WorkflowStatus`)**, Ngày nộp/Ngày tạo.
    - Hỗ trợ tìm kiếm theo Mã hồ sơ, Tên chủ hồ sơ.
    - **Hỗ trợ lọc theo Trạng thái hồ sơ (sử dụng `WorkflowStatus` lookup)**, Ngày nộp (khoảng thời gian).
    - Hỗ trợ sắp xếp theo các cột chính.
    - Hỗ trợ phân trang.
    - Cung cấp các nút hành động trên từng dòng tùy thuộc vào **trạng thái (`WorkflowStatus`)** và quyền (Xem, Sửa thông tin chính, Xóa, Trigger Workflow...).
- **Xem chi tiết (Read Detail):**
    - Hiển thị đầy đủ thông tin của một Hồ sơ, bao gồm:
        - Thông tin Chủ hồ sơ và thông tin bổ sung (Phạm vi, Đăng ký bưu điện).
        - Thông tin Thủ tục hành chính liên quan.
        - **Trạng thái hiện tại (Tên và có thể cả màu sắc từ `WorkflowStatus`)** và lịch sử xử lý (nếu có).
        - **Hiển thị dữ liệu các Thành phần hồ sơ:**
            - **Component "Tờ khai":** Có thể hiển thị các trường đã nhập (từ `FormData`) hoặc hiển thị link tải file đã tạo từ tờ khai (nếu `FileId` đã có).
            - **Các Component `File`:** Hiển thị tên file (lấy từ `FileManagement`) và link tải về.
- **Sửa (Update):**
    - Cho phép chỉnh sửa thông tin Hồ sơ (Chủ hồ sơ, Phạm vi, Đăng ký bưu điện) khi Hồ sơ ở **trạng thái (`WorkflowStatus`)** cho phép.
    - **Việc sửa dữ liệu Form "Tờ khai" hoặc cập nhật/xóa/thêm mới tệp đính kèm cần có cơ chế riêng (ví dụ: trong trang chi tiết, không phải trong modal edit đơn giản).**
    - Mã hồ sơ không được phép sửa.
- **Xóa (Delete):**
    - Cho phép xóa Hồ sơ khi ở **trạng thái (`WorkflowStatus`)** cho phép.
    - Nên sử dụng cơ chế xóa mềm (Soft Delete). **Cần xem xét việc xóa các bản ghi `EasyAbp.FileManagement.Files.File` liên quan trong `FileManagement` (hoặc giữ lại tùy theo chính sách).**
    - Cần có bước xác nhận trước khi xóa.
- **Quản lý Trạng thái & Luồng xử lý:**
    - Việc thay đổi **Trạng thái (`WorkflowStatusId`)** của Hồ sơ được quản lý bởi hệ thống Workflow động, gọi vào service `ChangeStatusAsync`.
    - Các hành động (Duyệt, Từ chối, Yêu cầu bổ sung...) cần được ghi nhận lại (có thể thông qua Workflow history hoặc auditing).
- **Xuất Excel:** Cho phép xuất danh sách Hồ sơ (theo bộ lọc hiện tại) ra tệp Excel.

### 0.4. Yêu cầu dữ liệu (Sơ bộ)
- **BDocument (Entity chính):**
    - `Id` (Guid, PK)
    - `ProcedureId` (Guid, FK - Tham chiếu đến `Procedure`, bắt buộc)
    - `MaHoSo` (string, unique, có thể tự sinh)
    - `TenChuHoSo` (string, bắt buộc)
    - `SoDinhDanhChuHoSo` (string)
    - `DiaChiChuHoSo` (string)
    - `EmailChuHoSo` (string)
    - `SoDienThoaiChuHoSo` (string)
    - **`PhamViHoatDong` (string?, kiểu dữ liệu lớn)** // MỚI
    - **`DangKyNhanQuaBuuDien` (bool)** // MỚI
    - **`TrangThaiHoSoId` (Guid?, FK - Tham chiếu đến `WorkflowStatus`, nullable)** // Đổi thành Nullable
    - `NgayNop` (DateTime?, có thể là `CreationTime`)
    - `NgayTiepNhan` (DateTime?)
    - `NgayHenTra` (DateTime?)
    - `NgayTraKetQua` (DateTime?)
    - `LyDoTuChoiHoacBoSung` (string?)
    - Kế thừa `FullAuditedAggregateRoot<Guid>`.
- **BDocumentData (Lưu dữ liệu/tham chiếu theo Component):**
    - `Id` (Guid, PK)
    - `BDocumentId` (Guid, FK - Tham chiếu đến `BDocument`, bắt buộc)
    - `ProcedureComponentId` (Guid, FK - Tham chiếu đến `ProcedureComponent`, bắt buộc)
    - `DuLieuNhap` (string? - Lưu dữ liệu JSON cho Component loại `Form`, bao gồm cả "Tờ khai")
    - **`FileId` (Guid? - FK, Tham chiếu đến `EasyAbp.FileManagement.Files.File.Id` cho Component loại `File` hoặc file được tạo từ "Tờ khai")**
    - Có thể cần thông tin audit riêng.

### 0.5. Yêu cầu giao diện người dùng (UI)
- **Màn hình danh sách:**
    - Tương tự như kế hoạch trước.
- **Màn hình Tạo mới:**
    - Hiển thị thông tin Procedure (chỉ đọc).
    - Phần nhập thông tin Chủ hồ sơ.
    - Phần nhập thông tin bổ sung ("Phạm vi...", Checkbox "Đăng ký...").
    - **Phần render động các trường của "Tờ khai"** dựa trên `FormDefinition`.
    - **Phần bảng "Hồ sơ đính kèm":**
        - Liệt kê tất cả components (bao gồm cả "Tờ khai").
        - Dòng "Tờ khai": Cột file ban đầu trống.
        - Dòng component loại `File`: Có nút "Tải lên". Khi đã có file, hiển thị tên file, nút "Xóa"/"Tải về".
    - Các nút hành động ("Lưu hồ sơ", "Thực hiện tiếp nhận", "Hủy").
- **Màn hình Sửa:** Chỉ sửa thông tin chính (Chủ hồ sơ, Phạm vi, Đăng ký bưu điện). Việc sửa component data cần UI khác.
- **Màn hình Xem chi tiết:** Hiển thị tất cả thông tin, bao gồm dữ liệu Tờ khai (dạng đọc) và link tải các file đính kèm.

### 0.6. Yêu cầu về phân quyền
- Định nghĩa nhóm quyền mới: `CoreFW.BDocumentManagement`.
- Các quyền cụ thể (ví dụ):
    - `CoreFW.BDocumentManagement.BDocuments` (Xem danh sách, chi tiết)
    - `CoreFW.BDocumentManagement.BDocuments.Create`
    - `CoreFW.BDocumentManagement.BDocuments.Update` (Chỉ sửa thông tin chính)
    - `CoreFW.BDocumentManagement.BDocuments.Delete`
    - `CoreFW.BDocumentManagement.BDocuments.ManageComponents` (Quyền sửa dữ liệu component, upload file - có thể cần quyền này)
    - `CoreFW.BDocumentManagement.BDocuments.GenerateDeclarationFile` (Quyền trigger tạo file từ tờ khai)
    - `CoreFW.BDocumentManagement.BDocuments.Export`
- Giao diện cần ẩn/hiện các nút chức năng, trường dữ liệu, và các hành động dựa trên quyền và trạng thái (`WorkflowStatus`) hồ sơ.

### 0.7. Quy tắc nghiệp vụ
- Một `BDocument` phải luôn gắn với một `Procedure` hợp lệ.
- `MaHoSo` cần có quy tắc sinh mã và đảm bảo tính duy nhất.
- **Dữ liệu nhập vào Form "Tờ khai" phải được validate dựa trên `FormDefinition`.**
- Tệp tải lên phải đáp ứng yêu cầu của `ProcedureComponent`.
- Việc thay đổi trạng thái (`TrangThaiHoSoId`) được quản lý bởi Workflow.
- Chỉ có thể Sửa/Xóa `BDocument` ở những trạng thái cho phép.
- **Cần có quy tắc/template để tạo file từ dữ liệu Form "Tờ khai".**
- Cơ chế lưu trữ và quản lý tệp đính kèm sẽ sử dụng hạ tầng của module `FileManagement`.
- Validation cho tệp tải lên sẽ được xử lý bởi module `FileManagement`.

**Lưu ý chung:** Kế hoạch này dựa trên thông tin đã làm rõ. Các chi tiết về `FormDefinition`, template tạo file, và luồng xử lý cần được làm rõ và định nghĩa chính xác hơn trong các bước tiếp theo.

## Tóm tắt Tiến độ Thực hiện Dự kiến

- [ ] **Bước 0: Kế hoạch tổng thể** - File này
- [ ] **Bước 1: Tầng Domain.Shared (`Aqt.CoreFW.Domain.Shared`)** - Xem chi tiết: `1.bdocument-management-domain-shared-plan.md`
- [ ] **Bước 2: Tầng Domain (`Aqt.CoreFW.Domain`)** - Xem chi tiết: `2.bdocument-management-domain-plan.md`
- [ ] **Bước 3: Tầng Application.Contracts (`Aqt.CoreFW.Application.Contracts`)** - Xem chi tiết: `3.bdocument-management-app-contracts-plan.md`
- [ ] **Bước 4: Tầng Application (`Aqt.CoreFW.Application`)** - Xem chi tiết: `4.bdocument-management-application-plan.md`
- [ ] **Bước 5: Tầng EntityFrameworkCore (`Aqt.CoreFW.EntityFrameworkCore`)** - Xem chi tiết: `5.bdocument-management-efcore-plan.md`
- [ ] **Bước 6: Tầng Web (`Aqt.CoreFW.Web`)** - Xem chi tiết: `6.bdocument-management-web-plan.md`
- [ ] **Bước 7: Các bước triển khai và kiểm thử cuối cùng (Thực hiện thủ công)** - Xem chi tiết: `7.bdocument-management-final-steps-plan.md` (Chưa tạo)
