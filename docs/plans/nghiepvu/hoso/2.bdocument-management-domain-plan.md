# Kế hoạch chi tiết: Tầng Domain (`Aqt.CoreFW.Domain`) - Quản lý Hồ sơ (BDocument)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Domain` để hỗ trợ chức năng quản lý Hồ sơ (BDocument). Kế hoạch này dựa trên yêu cầu trong `docs/plans/nghiepvu/hoso/0.bdocument-plan-v1.md` và kế hoạch tầng Domain.Shared `1.bdocument-management-domain-shared-plan.md`.

## 1. Entity (`BDocument.cs`)

**Nguyên tắc thiết kế Entity (DDD):**

*   **Aggregate Root:** `BDocument` là Aggregate Root chính.
*   **Đóng gói:** Sử dụng `private set` hoặc `protected set` cho thuộc tính. Thay đổi được thực hiện qua phương thức public/internal.
*   **Validation tập trung:** Sử dụng `Check.*` với hằng số từ `BDocumentConsts`.
*   **Trạng thái hợp lệ:** Constructor `internal` đảm bảo entity hợp lệ khi khởi tạo.
*   **Hành vi:** Định nghĩa phương thức `public`/`internal` để thay đổi trạng thái có kiểm soát.
*   **Kế thừa:** Sử dụng `FullAuditedAggregateRoot<Guid>`.
*   **Quan hệ Một-Nhiều:** Quản lý collection `DocumentData`. Các phương thức quản lý collection này (`AddOrUpdateData`, `RemoveData`) là `internal` và được gọi từ Domain Service (`BDocumentManager`).
*   **Loại bỏ** các thuộc tính Tờ khai, **thêm** `ScopeOfActivity`, `ReceiveByPost`.
*   **Trạng thái nullable:** `WorkflowStatusId` là `Guid?`.

**Cấu trúc `BDocument.cs`:**

-   **Vị trí:** `src/Aqt.CoreFW.Domain/BDocuments/Entities/BDocument.cs` (Tạo thư mục `BDocuments/Entities` nếu chưa có)
-   **Nội dung:**
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Collections.ObjectModel;
    using Aqt.CoreFW.BDocuments; // Consts
    using Aqt.CoreFW.Domain.Procedures.Entities; // Procedure
    using Aqt.CoreFW.Domain.WorkflowStatuses.Entities; // WorkflowStatus
    using JetBrains.Annotations;
    using Volo.Abp;
    using Volo.Abp.Data; // For ExtraProperties
    using Volo.Abp.Domain.Entities.Auditing;

    namespace Aqt.CoreFW.Domain.BDocuments.Entities;

    /// <summary>
    /// Represents an administrative document/case/profile submitted for a specific procedure.
    /// </summary>
    public class BDocument : FullAuditedAggregateRoot<Guid>, IHasExtraProperties
    {
        /// <summary>
        /// Foreign key to the Procedure this document belongs to.
        /// </summary>
        public virtual Guid ProcedureId { get; protected set; }

        /// <summary>
        /// Navigation property to the related Procedure. Load explicitly.
        /// </summary>
        [CanBeNull]
        public virtual Procedure? Procedure { get; protected set; }

        /// <summary>
        /// Unique code for the document.
        /// </summary>
        [NotNull]
        public virtual string Code { get; private set; }

        /// <summary>
        /// Name of the applicant.
        /// </summary>
        [NotNull]
        public virtual string ApplicantName { get; private set; }

        /// <summary>
        /// Applicant's identification number.
        /// </summary>
        [CanBeNull]
        public virtual string? ApplicantIdentityNumber { get; private set; }

        /// <summary>
        /// Applicant's address.
        /// </summary>
        [CanBeNull]
        public virtual string? ApplicantAddress { get; private set; }

        /// <summary>
        /// Applicant's email address.
        /// </summary>
        [CanBeNull]
        public virtual string? ApplicantEmail { get; private set; }

        /// <summary>
        /// Applicant's phone number.
        /// </summary>
        [CanBeNull]
        public virtual string? ApplicantPhoneNumber { get; private set; }

        /// <summary>
        /// Scope and content of activities.
        /// </summary>
        [CanBeNull]
        public virtual string? ScopeOfActivity { get; private set; }

        /// <summary>
        /// Indicates if the applicant registered to receive results via postal service.
        /// </summary>
        public virtual bool ReceiveByPost { get; private set; }

        /// <summary>
        /// Foreign key to the current workflow status (nullable). Set by workflow process.
        /// </summary>
        public virtual Guid? WorkflowStatusId { get; private set; }

        /// <summary>
        /// Navigation property to the related WorkflowStatus. Load explicitly.
        /// </summary>
        [CanBeNull]
        public virtual WorkflowStatus? WorkflowStatus { get; protected set; }

        /// <summary>
        /// Submission date.
        /// </summary>
        [CanBeNull]
        public virtual DateTime? SubmissionDate { get; private set; }

        /// <summary>
        /// Reception date.
        /// </summary>
        [CanBeNull]
        public virtual DateTime? ReceptionDate { get; private set; }

        /// <summary>
        /// Expected result date.
        /// </summary>
        [CanBeNull]
        public virtual DateTime? AppointmentDate { get; private set; }

        /// <summary>
        /// Actual result date.
        /// </summary>
        [CanBeNull]
        public virtual DateTime? ResultDate { get; private set; }

        /// <summary>
        /// Reason for rejection or additional info request.
        /// </summary>
        [CanBeNull]
        public virtual string? RejectionOrAdditionReason { get; private set; }

        /// <summary>
        /// Collection of component data (form JSON, file IDs).
        /// </summary>
        public virtual ICollection<BDocumentData> DocumentData { get; protected set; }

        public virtual ExtraPropertyDictionary ExtraProperties { get; protected set; }

        /// <summary>
        /// Protected constructor for ORM.
        /// </summary>
        protected BDocument()
        {
            Code = string.Empty;
            ApplicantName = string.Empty;
            DocumentData = new Collection<BDocumentData>();
            ExtraProperties = new ExtraPropertyDictionary();
            this.SetDefaultsForExtraProperties();
        }

        /// <summary>
        /// Creates a new BDocument instance. Called via BDocumentManager.
        /// </summary>
        internal BDocument(
            Guid id,
            Guid procedureId,
            [NotNull] string code,
            [NotNull] string applicantName,
            [CanBeNull] string? applicantIdentityNumber = null,
            [CanBeNull] string? applicantAddress = null,
            [CanBeNull] string? applicantEmail = null,
            [CanBeNull] string? applicantPhoneNumber = null,
            [CanBeNull] string? scopeOfActivity = null,
            bool receiveByPost = false,
            [CanBeNull] DateTime? submissionDate = null)
            : base(id)
        {
            ProcedureId = procedureId;
            SetCodeInternal(code);
            SetApplicantNameInternal(applicantName);
            SetApplicantIdentityNumberInternal(applicantIdentityNumber);
            SetApplicantAddressInternal(applicantAddress);
            SetApplicantEmailInternal(applicantEmail);
            SetApplicantPhoneNumberInternal(applicantPhoneNumber);
            SetScopeOfActivityInternal(scopeOfActivity);
            ReceiveByPost = receiveByPost;

            WorkflowStatusId = null;
            SubmissionDate = submissionDate ?? Clock.Now;

            DocumentData = new Collection<BDocumentData>();
            ExtraProperties = new ExtraPropertyDictionary();
            this.SetDefaultsForExtraProperties();
        }

        // --- Internal setters with validation ---

        private void SetCodeInternal([NotNull] string code)
        {
            Check.NotNullOrWhiteSpace(code, nameof(code), BDocumentConsts.MaxCodeLength);
            Code = code;
        }

        private void SetApplicantNameInternal([NotNull] string applicantName)
        {
            Check.NotNullOrWhiteSpace(applicantName, nameof(applicantName), BDocumentConsts.MaxApplicantNameLength);
            ApplicantName = applicantName;
        }

        private void SetApplicantIdentityNumberInternal([CanBeNull] string? identityNumber)
        {
            Check.Length(identityNumber, nameof(identityNumber), BDocumentConsts.MaxApplicantIdentityNumberLength);
            ApplicantIdentityNumber = identityNumber;
        }

        private void SetApplicantAddressInternal([CanBeNull] string? address)
        {
            Check.Length(address, nameof(address), BDocumentConsts.MaxApplicantAddressLength);
            ApplicantAddress = address;
        }

        private void SetApplicantEmailInternal([CanBeNull] string? email)
        {
            Check.Length(email, nameof(email), BDocumentConsts.MaxApplicantEmailLength);
            ApplicantEmail = email;
        }

        private void SetApplicantPhoneNumberInternal([CanBeNull] string? phone)
        {
            Check.Length(phone, nameof(phone), BDocumentConsts.MaxApplicantPhoneNumberLength);
            ApplicantPhoneNumber = phone;
        }

        private void SetScopeOfActivityInternal([CanBeNull] string? scope)
        {
            ScopeOfActivity = scope;
        }

        private void SetRejectionOrAdditionReasonInternal([CanBeNull] string? reason)
        {
            Check.Length(reason, nameof(reason), BDocumentConsts.MaxRejectionOrAdditionReasonLength);
            RejectionOrAdditionReason = reason;
        }

        // --- Public methods to change state ---

        /// <summary>
        /// Updates main information. Called via BDocumentManager.
        /// </summary>
        internal BDocument UpdateInfo(
            [NotNull] string applicantName,
            [CanBeNull] string? applicantIdentityNumber,
            [CanBeNull] string? applicantAddress,
            [CanBeNull] string? applicantEmail,
            [CanBeNull] string? applicantPhoneNumber,
            [CanBeNull] string? scopeOfActivity,
            bool receiveByPost)
        {
            SetApplicantNameInternal(applicantName);
            SetApplicantIdentityNumberInternal(applicantIdentityNumber);
            SetApplicantAddressInternal(applicantAddress);
            SetApplicantEmailInternal(applicantEmail);
            SetApplicantPhoneNumberInternal(applicantPhoneNumber);
            SetScopeOfActivityInternal(scopeOfActivity);
            ReceiveByPost = receiveByPost;
            return this;
        }

        /// <summary>
        /// Changes the current workflow status. Validation happens in BDocumentManager.
        /// </summary>
        internal BDocument SetWorkflowStatusId(Guid? newWorkflowStatusId,
            [CanBeNull] string? reason = null,
            [CanBeNull] DateTime? receptionDate = null,
            [CanBeNull] DateTime? resultDate = null)
        {
            WorkflowStatusId = newWorkflowStatusId;
            SetRejectionOrAdditionReasonInternal(reason);

            if(receptionDate.HasValue) ReceptionDate = receptionDate;
            if(resultDate.HasValue) ResultDate = resultDate;

            return this;
        }

        /// <summary>
        /// Updates appointment date.
        /// </summary>
        internal BDocument SetAppointmentDate([CanBeNull] DateTime? appointmentDate)
        {
            AppointmentDate = appointmentDate;
            return this;
        }

        // --- Methods to manage the DocumentData collection (Called by BDocumentManager) ---

        /// <summary>
        /// Adds new or updates existing data for a component.
        /// </summary>
        internal void AddOrUpdateData(Guid procedureComponentId, [CanBeNull] string? inputData, [CanBeNull] Guid? fileId)
        {
            var existingData = DocumentData.FirstOrDefault(d => d.ProcedureComponentId == procedureComponentId);
            if (existingData != null)
            {
                existingData.SetData(inputData, fileId);
            }
            else
            {
                var newData = new BDocumentData(this.Id, procedureComponentId, inputData, fileId);
                DocumentData.Add(newData);
            }
        }

        /// <summary>
        /// Removes data entry for a component.
        /// </summary>
        internal void RemoveData(Guid procedureComponentId)
        {
            var dataToRemove = DocumentData.FirstOrDefault(d => d.ProcedureComponentId == procedureComponentId);
            if (dataToRemove != null)
            {
                DocumentData.Remove(dataToRemove);
            }
        }

        /// <summary>
        /// Clears all associated component data.
        /// </summary>
        internal void ClearData()
        {
            DocumentData.Clear();
        }
    }
    ```

## 1.1. Value Object / Entity (`BDocumentData.cs`)

**Thiết kế:**
*   Là một phần của `BDocument` Aggregate.
*   Chứa `InputData` (JSON Tờ khai) hoặc `FileId`.
*   Sử dụng `Guid` làm khóa chính.
*   Các thuộc tính có `protected set`.

**Cấu trúc `BDocumentData.cs`:**

-   **Vị trí:** `src/Aqt.CoreFW.Domain/BDocuments/Entities/BDocumentData.cs`
-   **Nội dung:** (Không đổi so với kế hoạch trước)
    ```csharp
    using System;
    using JetBrains.Annotations;
    using Volo.Abp.Domain.Entities.Auditing; // Hoặc Entity<Guid>

    namespace Aqt.CoreFW.Domain.BDocuments.Entities;

    /// <summary>
    /// Represents the data associated with a specific ProcedureComponent within a BDocument.
    /// Stores either form input data (InputData) or a reference to an uploaded file (FileId).
    /// </summary>
    public class BDocumentData : AuditedEntity<Guid> // Hoặc Entity<Guid>
    {
        public virtual Guid BDocumentId { get; protected set; }
        public virtual Guid ProcedureComponentId { get; protected set; }

        /// <summary>
        /// Stores input data (e.g., JSON for Form type).
        /// </summary>
        [CanBeNull]
        public virtual string? InputData { get; protected set; }

        /// <summary>
        /// Stores the ID of the uploaded file (File type or generated from Form).
        /// </summary>
        [CanBeNull]
        public virtual Guid? FileId { get; protected set; }

        protected BDocumentData() { }

        internal BDocumentData(
            Guid bDocumentId,
            Guid procedureComponentId,
            [CanBeNull] string? inputData,
            [CanBeNull] Guid? fileId)
            : base(GuidGenerator.Create())
        {
            BDocumentId = bDocumentId;
            ProcedureComponentId = procedureComponentId;
            InputData = inputData;
            FileId = fileId;
        }

        internal void SetData([CanBeNull] string? inputData, [CanBeNull] Guid? fileId)
        {
            InputData = inputData;
            FileId = fileId;
        }
    }
    ```

## 2. Repository Interface (`IBDocumentRepository.cs`)

-   **Vị trí:** `src/Aqt.CoreFW.Domain/BDocuments/`
-   **Tệp:** `IBDocumentRepository.cs`
-   **Nội dung:** (Không đổi so với kế hoạch trước, trừ khi cần query theo trường mới)
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Threading;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Domain.BDocuments.Entities;
    using JetBrains.Annotations;
    using Volo.Abp.Domain.Repositories;

    namespace Aqt.CoreFW.Domain.BDocuments;

    public interface IBDocumentRepository : IRepository<BDocument, Guid>
    {
        Task<BDocument?> FindByCodeAsync(
            [NotNull] string code,
            bool includeDetails = false,
            CancellationToken cancellationToken = default);

        Task<bool> CodeExistsAsync(
            [NotNull] string code,
            Guid? excludeId = null,
            CancellationToken cancellationToken = default);

        Task<List<BDocument>> GetListAsync(
            string? filterText = null,
            Guid? procedureId = null,
            Guid? workflowStatusId = null,
            DateTime? submissionDateFrom = null,
            DateTime? submissionDateTo = null,
            string? sorting = null,
            int maxResultCount = int.MaxValue,
            int skipCount = 0,
            bool includeDetails = false,
            CancellationToken cancellationToken = default);

        Task<long> GetCountAsync(
            string? filterText = null,
            Guid? procedureId = null,
            Guid? workflowStatusId = null,
            DateTime? submissionDateFrom = null,
            DateTime? submissionDateTo = null,
            CancellationToken cancellationToken = default);

        Task<BDocument?> GetWithDataAsync(
            Guid id,
            CancellationToken cancellationToken = default);

        // Add other specific query methods if needed
    }
    ```

## 3. Domain Service (`BDocumentManager.cs`)

**Trách nhiệm:**
*   Thực thi quy tắc nghiệp vụ khi tạo (`CreateAsync`), cập nhật (`UpdateInfoAsync`), quản lý data (`AddOrUpdateComponentDataAsync`, `RemoveComponentDataAsync`), đổi trạng thái (`ChangeStatusAsync`).
*   Đảm bảo tính nhất quán (`Code` unique, `ProcedureId` hợp lệ).
*   Phối hợp validate và cập nhật `BDocumentData`.
*   Validate chuyển đổi trạng thái.
*   Tương tác với các Repository và `IFileManager`.
*   **Không** chứa logic tạo file từ Tờ khai.

**Cấu trúc `BDocumentManager.cs`:**

-   **Vị trí:** `src/Aqt.CoreFW.Domain/BDocuments/`
-   **Tệp:** `BDocumentManager.cs`
-   **Nội dung:**
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Aqt.CoreFW.BDocuments; // Consts
    using Aqt.CoreFW.Domain.BDocuments.Entities;
    using Aqt.CoreFW.Domain.Procedures; // Procedure Repositories/Entities
    using Aqt.CoreFW.Domain.Procedures.Entities;
    using Aqt.CoreFW.Domain.WorkflowStatuses; // WorkflowStatus Repositories/Entities
    using Aqt.CoreFW.Domain.WorkflowStatuses.Entities;
    using Aqt.CoreFW.Domain.Components; // Component Repositories/Entities
    using Aqt.CoreFW.Domain.Components.Entities;
    using EasyAbp.FileManagement.Files; // IFileManager
    using JetBrains.Annotations;
    using Volo.Abp;
    using Volo.Abp.Domain.Repositories;
    using Volo.Abp.Domain.Services;
    using Volo.Abp.Guids;
    using Volo.Abp.Uow;

    namespace Aqt.CoreFW.Domain.BDocuments;

    /// <summary>
    /// Domain service for managing BDocument entities and related business logic.
    /// </summary>
    public class BDocumentManager : DomainService
    {
        private readonly IBDocumentRepository _bDocumentRepository;
        private readonly IProcedureRepository _procedureRepository;
        private readonly IWorkflowStatusRepository _workflowStatusRepository;
        private readonly IProcedureComponentRepository _componentRepository;
        private readonly IFileManager _fileManager;
        private readonly IGuidGenerator _guidGenerator;
        private readonly IUnitOfWorkManager _unitOfWorkManager;

        public BDocumentManager(
            IBDocumentRepository bDocumentRepository,
            IProcedureRepository procedureRepository,
            IWorkflowStatusRepository workflowStatusRepository,
            IProcedureComponentRepository componentRepository,
            IFileManager fileManager,
            IGuidGenerator guidGenerator,
            IUnitOfWorkManager unitOfWorkManager)
        {
            _bDocumentRepository = bDocumentRepository;
            _procedureRepository = procedureRepository;
            _workflowStatusRepository = workflowStatusRepository;
            _componentRepository = componentRepository;
            _fileManager = fileManager;
            _guidGenerator = guidGenerator;
            _unitOfWorkManager = unitOfWorkManager;
        }

        /// <summary>
        /// Creates a new BDocument entity.
        /// </summary>
        public async Task<BDocument> CreateAsync(
            Guid procedureId,
            [NotNull] string code,
            [NotNull] string applicantName,
            [CanBeNull] string? applicantIdentityNumber = null,
            [CanBeNull] string? applicantAddress = null,
            [CanBeNull] string? applicantEmail = null,
            [CanBeNull] string? applicantPhoneNumber = null,
            [CanBeNull] string? scopeOfActivity = null,
            bool receiveByPost = false,
            [CanBeNull] DateTime? submissionDate = null)
        {
            // 1. Validate basic inputs
            Check.NotNullOrWhiteSpace(code, nameof(code), BDocumentConsts.MaxCodeLength);
            Check.NotNullOrWhiteSpace(applicantName, nameof(applicantName), BDocumentConsts.MaxApplicantNameLength);
            // ... validate other lengths ...

            // 2. Validate Code uniqueness
            await ValidateCodeUniquenessAsync(code);

            // 3. Validate Procedure existence
            await ValidateProcedureExistsAsync(procedureId);

            // 4. Create the BDocument entity
            var bDocument = new BDocument(
                _guidGenerator.Create(),
                procedureId,
                code,
                applicantName,
                applicantIdentityNumber,
                applicantAddress,
                applicantEmail,
                applicantPhoneNumber,
                scopeOfActivity,
                receiveByPost,
                submissionDate
            );

            // Initial status is null. BDocumentData added via AddOrUpdateComponentDataAsync in AppService.

            return bDocument;
        }

        /// <summary>
        /// Updates main information for an existing BDocument.
        /// </summary>
        public async Task<BDocument> UpdateInfoAsync(
            [NotNull] BDocument bDocument,
            [NotNull] string applicantName,
            [CanBeNull] string? applicantIdentityNumber,
            [CanBeNull] string? applicantAddress,
            [CanBeNull] string? applicantEmail,
            [CanBeNull] string? applicantPhoneNumber,
            [CanBeNull] string? scopeOfActivity,
            bool receiveByPost)
        {
            Check.NotNull(bDocument, nameof(bDocument));
            await ValidateUpdatableStatusAsync(bDocument); // Check if status allows update

            bDocument.UpdateInfo(
                applicantName,
                applicantIdentityNumber,
                applicantAddress,
                applicantEmail,
                applicantPhoneNumber,
                scopeOfActivity,
                receiveByPost
            );
            return bDocument;
        }

        /// <summary>
        /// Adds or updates data for a specific component.
        /// </summary>
        public async Task<BDocument> AddOrUpdateComponentDataAsync(
             [NotNull] BDocument bDocument,
             Guid procedureComponentId,
             [CanBeNull] string? inputData,
             [CanBeNull] Guid? fileId)
        {
             Check.NotNull(bDocument, nameof(bDocument));
             await ValidateUpdatableComponentDataStatusAsync(bDocument); // Check status allowance

             // 1. Validate Component exists and belongs to the Procedure
             var component = await ValidateProcedureComponentAsync(bDocument.ProcedureId, procedureComponentId);

             // 2. Validate data consistency (Form vs File) based on component type
             ValidateComponentDataType(component, inputData, fileId);

             // 3. Validate FileId exists if provided
             if (fileId.HasValue)
             {
                 await ValidateFileExistsAsync(fileId.Value);
             }

             // 4. Use the entity's method to add/update data
             bDocument.AddOrUpdateData(procedureComponentId, inputData, fileId);

             return bDocument;
        }

         /// <summary>
        /// Removes the data associated with a specific component. Optionally deletes the file.
        /// </summary>
        public async Task<BDocument> RemoveComponentDataAsync(
            [NotNull] BDocument bDocument,
            Guid procedureComponentId,
            bool deleteAssociatedFile = false)
        {
            Check.NotNull(bDocument, nameof(bDocument));
            await ValidateUpdatableComponentDataStatusAsync(bDocument); // Check status allowance

            var dataToRemove = bDocument.DocumentData.FirstOrDefault(d => d.ProcedureComponentId == procedureComponentId);

            if (dataToRemove != null)
            {
                 Guid? fileIdToDelete = dataToRemove.FileId;
                 bDocument.RemoveData(procedureComponentId); // Remove link from BDocument

                 if (deleteAssociatedFile && fileIdToDelete.HasValue)
                 {
                     await DeleteFileAsync(fileIdToDelete.Value, bDocument.Id, procedureComponentId);
                 }
            }
            return bDocument;
        }

        /// <summary>
        /// Changes the status of a BDocument.
        /// </summary>
        public async Task<BDocument> ChangeStatusAsync(
            [NotNull] BDocument bDocument,
            Guid newWorkflowStatusId,
            [CanBeNull] string? reason = null)
        {
            Check.NotNull(bDocument, nameof(bDocument));

            Guid? currentStatusId = bDocument.WorkflowStatusId;
            if (currentStatusId == newWorkflowStatusId) return bDocument;

            // 1. Validate new status exists
            var newStatus = await _workflowStatusRepository.FindAsync(newWorkflowStatusId)
                 ?? throw new UserFriendlyException(L[CoreFWDomainErrorCodes.WorkflowStatusNotFoundForDocument]);

            // 2. Validate the transition logic
            await ValidateStatusTransitionAsync(bDocument, currentStatusId, newWorkflowStatusId);

            // 3. Determine dates to update based on the new status
            DateTime? receptionDate = null;
            DateTime? resultDate = null;
            // Example: Logic to set dates based on newStatus.Code or properties
            // if (newStatus.IsReceptionStatus()) receptionDate = Clock.Now;
            // if (newStatus.IsFinalStatus()) resultDate = Clock.Now;

            // 4. Use the entity's internal method
            bDocument.SetWorkflowStatusId(newWorkflowStatusId, reason, receptionDate, resultDate);

            return bDocument;
        }

        // --- Public Helper Method for Validation (used by AppService) ---
        public void ValidateComponentDataType(ProcedureComponent component, string? inputData, Guid? fileId) {
             if (component.Type == ComponentType.Form && fileId.HasValue) {
                 throw new UserFriendlyException("Cannot associate a file with a Form component."); // TODO: Add Error Code
             }
             if (component.Type == ComponentType.File && !string.IsNullOrEmpty(inputData)) {
                 throw new UserFriendlyException("Cannot save form data for a File component."); // TODO: Add Error Code
             }
        }

        // --- Private Validation Helpers ---

        private async Task ValidateProcedureExistsAsync(Guid procedureId) {
             if (!await _procedureRepository.AnyAsync(p => p.Id == procedureId)) {
                 throw new UserFriendlyException(L[CoreFWDomainErrorCodes.ProcedureNotFoundForDocument]);
             }
        }

        private async Task<ProcedureComponent> ValidateProcedureComponentAsync(Guid procedureId, Guid componentId) {
             var component = await _componentRepository.FindAsync(componentId);
             if (component == null) {
                 throw new UserFriendlyException("ProcedureComponent not found."); // TODO: Add Error Code
             }
             // Assume ComponentRepository has a method to check link
             var isLinked = await _componentRepository.IsLinkedToProcedureAsync(componentId, procedureId);
             if (!isLinked) {
                  throw new UserFriendlyException("ProcedureComponent does not belong to the document's procedure."); // TODO: Add Error Code
             }
             return component;
        }

        private async Task ValidateFileExistsAsync(Guid fileId) {
             var file = await _fileManager.FindAsync(fileId);
             if (file == null) {
                 throw new UserFriendlyException(L[CoreFWDomainErrorCodes.FileManagementInteractionFailed, $"File with ID {fileId} not found."]);
             }
        }

         private async Task DeleteFileAsync(Guid fileId, Guid bDocumentId, Guid componentId) {
            try {
                var file = await _fileManager.FindAsync(fileId);
                if (file != null) {
                    await _fileManager.DeleteAsync(file);
                }
            } catch(Exception ex) {
                Logger.LogError(ex, $"Failed to delete file {fileId} for BDocument {bDocumentId}, Component {componentId}.");
                 throw new UserFriendlyException(L[CoreFWDomainErrorCodes.FileManagementInteractionFailed, ex.Message]);
            }
         }

        private async Task ValidateCodeUniqueness([NotNull] string code, Guid? excludeId = null)
        {
             if (await _bDocumentRepository.CodeExistsAsync(code, excludeId))
            {
                throw new UserFriendlyException(L[CoreFWDomainErrorCodes.BDocumentCodeAlreadyExists, code]);
            }
        }

        private async Task ValidateStatusTransition(BDocument bDocument, Guid? fromStatusId, Guid toStatusId)
        {
            // Fetch statuses if needed for rule checking
            WorkflowStatus? fromStatus = fromStatusId.HasValue ? await _workflowStatusRepository.FindAsync(fromStatusId.Value) : null;
            WorkflowStatus toStatus = await _workflowStatusRepository.GetAsync(toStatusId); // Assuming toStatus must exist

            // TODO: Implement actual workflow transition rules based on fromStatus and toStatus properties/codes.
            // Example: Cannot transition from a 'COMPLETED' status
            // if (fromStatus?.Code == "COMPLETED") {
            //     throw new UserFriendlyException(L[CoreFWDomainErrorCodes.InvalidDocumentStatusTransition, fromStatus.Name, toStatus.Name]);
            // }
            // Example: Initial transition must be to specific statuses
            // if (fromStatus == null && !new[] { "PENDING", "RECEIVED" }.Contains(toStatus.Code)) {
            //    throw new UserFriendlyException(...)
            // }

            await Task.CompletedTask; // Placeholder
        }

         private async Task ValidateUpdatableStatus(BDocument bDocument) {
             if (!bDocument.WorkflowStatusId.HasValue) return; // Can update if no status yet? Or require initial status?
             var currentStatus = await _workflowStatusRepository.FindAsync(bDocument.WorkflowStatusId.Value);
             // TODO: Check if currentStatus allows updating document info
             // if (currentStatus != null && !currentStatus.AllowUpdate) { // Assuming AllowUpdate property
             //    throw new UserFriendlyException(L[CoreFWDomainErrorCodes.CannotUpdateDocumentInCurrentStatus, currentStatus.Name]);
             // }
             await Task.CompletedTask; // Placeholder
         }

          private async Task ValidateUpdatableComponentDataStatus(BDocument bDocument) {
             if (!bDocument.WorkflowStatusId.HasValue) return;
             var currentStatus = await _workflowStatusRepository.FindAsync(bDocument.WorkflowStatusId.Value);
             // TODO: Check if currentStatus allows updating component data
             // if (currentStatus != null && !currentStatus.AllowComponentUpdate) { // Assuming AllowComponentUpdate property
             //    throw new UserFriendlyException(...)
             // }
              await Task.CompletedTask; // Placeholder
         }
    }
    ```

## 4. Cập nhật `CoreFWDomainModule.cs`

-   **Hành động:** Không cần thay đổi.

## 5. Lưu ý

*   **BDocument Entity:** Cập nhật để phản ánh cấu trúc dữ liệu mới.
*   **BDocumentData:** Không đổi.
*   **BDocumentManager:** `CreateAsync` và `UpdateInfoAsync` được cập nhật. `AddOrUpdateComponentDataAsync` và `RemoveComponentDataAsync` giữ nguyên logic cốt lõi. Thêm các hàm validation helper chi tiết hơn. Logic tạo file Tờ khai **không** ở đây.
*   **File Management:** Tương tác với `IFileManager` để kiểm tra/xóa file.
*   **Workflow Logic:** `ValidateStatusTransitionAsync` vẫn là placeholder cần logic thực tế. Thêm các placeholder kiểm tra trạng thái cho phép cập nhật (`ValidateUpdatableStatusAsync`, `ValidateUpdatableComponentDataStatusAsync`).