# Kế hoạch chi tiết: Tầng Domain.Shared (`Aqt.CoreFW.Domain.Shared`) - Quản lý Hồ sơ (BDocument)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Domain.Shared` cho chức năng quản lý Hồ sơ (BDocument). Kế hoạch này dựa trên yêu cầu trong `docs/plans/nghiepvu/hoso/0.bdocument-plan-v1.md`.

## 1. Constants

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Domain.Shared/BDocuments`
-   **Tệp:** Tạo file `BDocumentConsts.cs`
-   **Nội dung:**
    ```csharp
    // src/Aqt.CoreFW.Domain.Shared/BDocuments/BDocumentConsts.cs
    namespace Aqt.CoreFW.BDocuments;

    public static class BDocumentConsts
    {
        // Độ dài tối đa cho các trường của BDocument
        public const int MaxCodeLength = 50;
        public const int MaxApplicantNameLength = 250;
        public const int MaxApplicantIdentityNumberLength = 50;
        public const int MaxApplicantAddressLength = 500;
        public const int MaxApplicantEmailLength = 100;
        public const int MaxApplicantPhoneNumberLength = 20;
        // MaxLength cho ScopeOfActivity nên dựa vào kiểu dữ liệu DB (NCLOB/text thì không cần)
        // public const int MaxScopeOfActivityLength = 4000; // Ví dụ nếu dùng nvarchar
        public const int MaxRejectionOrAdditionReasonLength = 1000;

        // Hằng số cho tên component đặc biệt (Tờ khai) nếu cần tham chiếu trong code
        public const string DeclarationFormComponentCode = "TO_KHAI"; // Giữ nguyên nếu là mã code nghiệp vụ
    }
    ```

## 2. Enums

-   **Mô tả:** Không cần định nghĩa Enum mới. Sử dụng `WorkflowStatus` và `ComponentType`.

## 3. Error Codes (Sử dụng Partial Class)

-   **Bước 3.1: Kiểm tra file gốc**
    -   **Vị trí:** Mở file `src/Aqt.CoreFW.Domain.Shared/CoreFWDomainErrorCodes.cs`
    -   **Hành động:** Đảm bảo lớp đã được khai báo là `partial`.

-   **Bước 3.2: Tạo file partial cho BDocument**
    -   **Vị trí:** Tạo file mới trong thư mục `src/Aqt.CoreFW.Domain.Shared/BDocuments/`
    -   **Tên file:** `CoreFWDomainErrorCodes.BDocuments.cs`
    -   **Nội dung:**
        ```csharp
        // src/Aqt.CoreFW.Domain.Shared/BDocuments/CoreFWDomainErrorCodes.BDocuments.cs
        namespace Aqt.CoreFW;

        // Phần mở rộng của CoreFWDomainErrorCodes dành riêng cho BDocuments
        public static partial class CoreFWDomainErrorCodes
        {
            // BDocuments Error Codes
            // Định dạng: CoreFW:[ModuleName]:<Số thứ tự 5 chữ số>
            // !!! Quan trọng: Kiểm tra số thứ tự cuối cùng và sử dụng số duy nhất tiếp theo !!!
            // Giả sử Components dùng 0012x, BDocuments bắt đầu từ 00131.
            public const string BDocumentCodeAlreadyExists = "CoreFW:BDocuments:00131";
            public const string ProcedureNotFoundForDocument = "CoreFW:BDocuments:00132";
            public const string WorkflowStatusNotFoundForDocument = "CoreFW:BDocuments:00133";
            public const string RequiredComponentDataMissing = "CoreFW:BDocuments:00134";
            public const string InvalidDocumentStatusTransition = "CoreFW:BDocuments:00135";
            public const string CannotUpdateDocumentInCurrentStatus = "CoreFW:BDocuments:00136";
            public const string CannotDeleteDocumentInCurrentStatus = "CoreFW:BDocuments:00137";
            public const string FileManagementInteractionFailed = "CoreFW:BDocuments:00138";
            public const string DeclarationFormComponentNotFound = "CoreFW:BDocuments:00139"; // Khi không tìm thấy component Tờ khai
            public const string InputDataGenerationFailed = "CoreFW:BDocuments:00140"; // Lỗi khi tạo JSON từ form động
            public const string DeclarationFileGenerationFailed = "CoreFW:BDocuments:00141"; // Lỗi khi tạo file từ tờ khai
            public const string InvalidInputDataForDeclaration = "CoreFW:BDocuments:00142"; // Dữ liệu JSON của tờ khai không hợp lệ
            // Thêm các mã lỗi khác nếu cần
        }
        ```

## 4. Localization

-   **Vị trí:** Cập nhật các file `*.json` trong `src/Aqt.CoreFW.Domain.Shared/Localization/CoreFW` (quan trọng: bao gồm cả `en.json`, `vi.json` và các ngôn ngữ khác nếu có).
-   **Nội dung cần thêm/sửa vào phần `texts` của mỗi file:**

    -   **Ví dụ cho `en.json`:**
        ```json
        {
          // --- BDocument Management ---
          "Menu:BDocumentManagement": "Document Management",
          "Menu:BDocuments": "Documents",
          "BDocuments": "Documents",
          "NewBDocument": "New Document",
          "EditBDocument": "Edit Document",
          "ViewBDocument": "View Document",
          "ApplicantInformation": "Applicant Information",
          "DeclarationForm": "Declaration Form",
          "AttachedDocuments": "Attached Documents",
          "ScopeOfActivity": "Scope and Content of Activity",
          "ReceiveByPost": "Register to receive results by post",
          "DisplayName:BDocument.Code": "Document Code",
          "DisplayName:BDocument.ApplicantName": "Applicant Name",
          "DisplayName:BDocument.ApplicantIdentityNumber": "Applicant ID Number",
          "DisplayName:BDocument.ApplicantAddress": "Applicant Address",
          "DisplayName:BDocument.ApplicantEmail": "Applicant Email",
          "DisplayName:BDocument.ApplicantPhoneNumber": "Applicant Phone",
          "DisplayName:BDocument.ProcedureId": "Procedure",
          "DisplayName:BDocument.WorkflowStatusId": "Status",
          "DisplayName:BDocument.ScopeOfActivity": "Scope of Activity",
          "DisplayName:BDocument.ReceiveByPost": "Receive by Post",
          "DisplayName:BDocument.SubmissionDate": "Submission Date",
          "DisplayName:BDocument.ReceptionDate": "Reception Date",
          "DisplayName:BDocument.AppointmentDate": "Appointment Date",
          "DisplayName:BDocument.ResultDate": "Result Date",
          "DisplayName:BDocument.RejectionOrAdditionReason": "Reason for Rejection/Addition",
          "DisplayName:BDocumentData.Component": "Component",
          "DisplayName:BDocumentData.AttachedFile": "Attached File",
          "DisplayName:BDocumentData.InputData": "Input Data",
          "UploadFile": "Upload File",
          "DownloadFile": "Download File",
          "DeleteFile": "Delete File",
          "GenerateFileFromDeclaration": "Generate File from Declaration",
          "FileGeneratedFromDeclaration": "File generated from declaration",
          "WaitingForGeneration": "Pending generation",
          "AreYouSureToDeleteBDocument": "Are you sure you want to delete this document: {0}?",
          "AreYouSureToDeleteFile": "Are you sure you want to delete the file: {0}?",
          "Permission:BDocumentManagement": "Document Management",
          "Permission:BDocuments": "View Documents",
          "Permission:BDocuments.Create": "Create Documents",
          "Permission:BDocuments.Update": "Update Document Info",
          "Permission:BDocuments.Delete": "Delete Documents",
          "Permission:BDocuments.ManageComponents": "Manage Document Components",
          "Permission:BDocuments.GenerateDeclarationFile": "Generate Declaration File",
          "Permission:BDocuments.Export": "Export Documents",
          "BDocumentCodeAlreadyExists": "The document code '{0}' already exists.",
          "ProcedureNotFoundForDocument": "The selected procedure could not be found.",
          "WorkflowStatusNotFoundForDocument": "The selected workflow status could not be found.",
          "RequiredComponentDataMissing": "Required data for component '{0}' is missing.",
          "InvalidDocumentStatusTransition": "Cannot change document status from '{0}' to '{1}'.",
          "CannotUpdateDocumentInCurrentStatus": "Cannot update the document while it is in '{0}' status.",
          "CannotDeleteDocumentInCurrentStatus": "Cannot delete the document while it is in '{0}' status.",
          "FileManagementInteractionFailed": "An error occurred while interacting with the file management system: {0}",
          "DeclarationFormComponentNotFound": "The declaration form component definition was not found for this procedure.",
          "InputDataGenerationFailed": "Failed to generate data structure from the declaration form.",
          "DeclarationFileGenerationFailed": "Failed to generate the document file from the declaration form data.",
          "InvalidInputDataForDeclaration": "The provided data for the declaration form is invalid or incomplete.",
          "FileIsRequired{0}": "File for component '{0}' is required.",
          "FieldIsRequired{0}": "Field '{0}' is required.",
          "ErrorCode:CoreFW:BDocuments:00131": "The document code '{0}' already exists.",
          "ErrorCode:CoreFW:BDocuments:00132": "The selected procedure could not be found.",
          "ErrorCode:CoreFW:BDocuments:00133": "The selected workflow status could not be found.",
          "ErrorCode:CoreFW:BDocuments:00134": "Required data for component '{0}' is missing.",
          "ErrorCode:CoreFW:BDocuments:00135": "Cannot change document status from '{0}' to '{1}'.",
          "ErrorCode:CoreFW:BDocuments:00136": "Cannot update the document while it is in '{0}' status.",
          "ErrorCode:CoreFW:BDocuments:00137": "Cannot delete the document while it is in '{0}' status.",
          "ErrorCode:CoreFW:BDocuments:00138": "An error occurred while interacting with the file management system: {0}",
          "ErrorCode:CoreFW:BDocuments:00139": "The declaration form component definition was not found for this procedure.",
          "ErrorCode:CoreFW:BDocuments:00140": "Failed to generate data structure from the declaration form.",
          "ErrorCode:CoreFW:BDocuments:00141": "Failed to generate the document file from the declaration form data.",
          "ErrorCode:CoreFW:BDocuments:00142": "The provided data for the declaration form is invalid or incomplete.",
        }
        ```
    -   **Ví dụ cho `vi.json`:** (Dịch tương ứng các key trên)
        ```json
        {
          // --- Quản lý Hồ sơ ---
          "Menu:BDocumentManagement": "Quản lý Hồ sơ",
          "Menu:BDocuments": "Hồ sơ",
          "BDocuments": "Hồ sơ",
          "NewBDocument": "Tạo mới Hồ sơ",
          "EditBDocument": "Sửa Hồ sơ",
          "ViewBDocument": "Xem Hồ sơ",
          "ApplicantInformation": "Thông tin chủ hồ sơ",
          "DeclarationForm": "Tờ khai",
          "AttachedDocuments": "Hồ sơ đính kèm",
          "ScopeOfActivity": "Phạm vi và nội dung hoạt động",
          "ReceiveByPost": "Đăng ký nhận kết quả qua bưu điện",
          "DisplayName:BDocument.Code": "Mã hồ sơ",
          "DisplayName:BDocument.ApplicantName": "Tên chủ hồ sơ",
          "DisplayName:BDocument.ApplicantIdentityNumber": "Số định danh",
          "DisplayName:BDocument.ApplicantAddress": "Địa chỉ",
          "DisplayName:BDocument.ApplicantEmail": "Email",
          "DisplayName:BDocument.ApplicantPhoneNumber": "Số điện thoại",
          "DisplayName:BDocument.ProcedureId": "Thủ tục",
          "DisplayName:BDocument.WorkflowStatusId": "Trạng thái",
          "DisplayName:BDocument.ScopeOfActivity": "Phạm vi hoạt động",
          "DisplayName:BDocument.ReceiveByPost": "Nhận qua bưu điện",
          "DisplayName:BDocument.SubmissionDate": "Ngày nộp",
          "DisplayName:BDocument.ReceptionDate": "Ngày tiếp nhận",
          "DisplayName:BDocument.AppointmentDate": "Ngày hẹn trả",
          "DisplayName:BDocument.ResultDate": "Ngày trả kết quả",
          "DisplayName:BDocument.RejectionOrAdditionReason": "Lý do từ chối/bổ sung",
          "DisplayName:BDocumentData.Component": "Thành phần",
          "DisplayName:BDocumentData.AttachedFile": "Tệp đính kèm",
          "DisplayName:BDocumentData.InputData": "Dữ liệu nhập",
          "UploadFile": "Tải lên Tệp",
          "DownloadFile": "Tải xuống Tệp",
          "DeleteFile": "Xóa Tệp",
          "GenerateFileFromDeclaration": "Tạo file từ Tờ khai",
          "FileGeneratedFromDeclaration": "File đã tạo từ tờ khai",
          "WaitingForGeneration": "Chờ tạo file",
          "AreYouSureToDeleteBDocument": "Bạn có chắc muốn xóa hồ sơ này: {0}?",
          "AreYouSureToDeleteFile": "Bạn có chắc muốn xóa tệp này: {0}?",
          "Permission:BDocumentManagement": "Quản lý Hồ sơ",
          "Permission:BDocuments": "Xem Hồ sơ",
          "Permission:BDocuments.Create": "Tạo Hồ sơ",
          "Permission:BDocuments.Update": "Cập nhật thông tin Hồ sơ",
          "Permission:BDocuments.Delete": "Xóa Hồ sơ",
          "Permission:BDocuments.ManageComponents": "Quản lý Thành phần Hồ sơ",
          "Permission:BDocuments.GenerateDeclarationFile": "Tạo File Tờ khai",
          "Permission:BDocuments.Export": "Xuất Hồ sơ",
          "BDocumentCodeAlreadyExists": "Mã hồ sơ '{0}' đã tồn tại.",
          "ProcedureNotFoundForDocument": "Không tìm thấy thủ tục hành chính đã chọn.",
          "WorkflowStatusNotFoundForDocument": "Không tìm thấy trạng thái quy trình đã chọn.",
          "RequiredComponentDataMissing": "Thiếu dữ liệu bắt buộc cho thành phần '{0}'.",
          "InvalidDocumentStatusTransition": "Không thể chuyển trạng thái hồ sơ từ '{0}' sang '{1}'.",
          "CannotUpdateDocumentInCurrentStatus": "Không thể cập nhật hồ sơ khi đang ở trạng thái '{0}'.",
          "CannotDeleteDocumentInCurrentStatus": "Không thể xóa hồ sơ khi đang ở trạng thái '{0}'.",
          "FileManagementInteractionFailed": "Có lỗi xảy ra khi tương tác với hệ thống quản lý tệp: {0}",
          "DeclarationFormComponentNotFound": "Không tìm thấy định nghĩa thành phần Tờ khai cho thủ tục này.",
          "InputDataGenerationFailed": "Không thể tạo cấu trúc dữ liệu từ Tờ khai.",
          "DeclarationFileGenerationFailed": "Không thể tạo file tài liệu từ dữ liệu Tờ khai.",
          "InvalidInputDataForDeclaration": "Dữ liệu cung cấp cho Tờ khai không hợp lệ hoặc không đầy đủ.",
          "FileIsRequired{0}": "Cần tải lên tệp cho thành phần '{0}'.",
          "FieldIsRequired{0}": "Trường '{0}' là bắt buộc.",
          "ErrorCode:CoreFW:BDocuments:00131": "Mã hồ sơ '{0}' đã tồn tại.",
          "ErrorCode:CoreFW:BDocuments:00132": "Không tìm thấy thủ tục hành chính đã chọn.",
          "ErrorCode:CoreFW:BDocuments:00133": "Không tìm thấy trạng thái quy trình đã chọn.",
          "ErrorCode:CoreFW:BDocuments:00134": "Thiếu dữ liệu bắt buộc cho thành phần '{0}'.",
          "ErrorCode:CoreFW:BDocuments:00135": "Không thể chuyển trạng thái hồ sơ từ '{0}' sang '{1}'.",
          "ErrorCode:CoreFW:BDocuments:00136": "Không thể cập nhật hồ sơ khi đang ở trạng thái '{0}'.",
          "ErrorCode:CoreFW:BDocuments:00137": "Không thể xóa hồ sơ khi đang ở trạng thái '{0}'.",
          "ErrorCode:CoreFW:BDocuments:00138": "Có lỗi xảy ra khi tương tác với hệ thống quản lý tệp: {0}",
          "ErrorCode:CoreFW:BDocuments:00139": "Không tìm thấy định nghĩa thành phần Tờ khai cho thủ tục này.",
          "ErrorCode:CoreFW:BDocuments:00140": "Không thể tạo cấu trúc dữ liệu từ Tờ khai.",
          "ErrorCode:CoreFW:BDocuments:00141": "Không thể tạo file tài liệu từ dữ liệu Tờ khai.",
          "ErrorCode:CoreFW:BDocuments:00142": "Dữ liệu cung cấp cho Tờ khai không hợp lệ hoặc không đầy đủ.",
        }
        ```
-   **Lưu ý quan trọng:**
    -   **Xác minh:** Kiểm tra lại `BDocumentConsts` và các giá trị `Max...Length` đã được đổi tên đúng.
    -   **Mã lỗi duy nhất:** Đảm bảo các mã lỗi (`CoreFW:BDocuments:xxxxx`) là duy nhất và tăng dần. Các tên hằng số mã lỗi đã được cập nhật.
    -   **Namespace:** Thêm namespace `Aqt.CoreFW.BDocuments` vào các file `.cs` mới tạo.
    -   **Đa ngôn ngữ:** Dịch và cập nhật **các key** (`DisplayName:*`) trong tất cả các tệp ngôn ngữ khác mà dự án hỗ trợ. Các chuỗi thông báo lỗi (value) giữ nguyên ngôn ngữ của file JSON.
    -   **Quyền:** Các quyền (`Permission:BDocuments...`) đã được cập nhật.
    -   **Thông báo lỗi:** Câu chữ trong localization của mã lỗi cần rõ ràng, thân thiện với người dùng. Đảm bảo các lỗi được cập nhật để tham chiếu đúng tên ErrorCode mới.