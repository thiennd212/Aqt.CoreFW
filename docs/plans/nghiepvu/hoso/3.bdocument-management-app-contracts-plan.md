# Kế hoạch chi tiết: Tầng Application.Contracts (`Aqt.CoreFW.Application.Contracts`) - Quản lý Hồ sơ (BDocument)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Application.Contracts` cho module Quản lý Hồ sơ (BDocument).

## 1. DTOs

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Application.Contracts/BDocuments/Dtos` (Tạo thư mục `BDocuments/Dtos` nếu chưa có)

-   **Tệp 1:** Tạo file `BDocumentDataDto.cs` (Đại diện dữ liệu/file của một Component trong Hồ sơ - Không đổi cấu trúc)
    ```csharp
    using System;
    using Aqt.CoreFW.Application.Contracts.Files; // Giả sử có FileInfoDto từ FileManagement Contracts
    using Aqt.CoreFW.Components; // Enum ComponentType

    namespace Aqt.CoreFW.Application.Contracts.BDocuments.Dtos;

    /// <summary>
    /// Represents the data or file associated with a specific ProcedureComponent
    /// within a BDocument context.
    /// </summary>
    public class BDocumentDataDto
    {
        public Guid Id { get; set; } // ID của bản ghi BDocumentData
        public Guid ProcedureComponentId { get; set; }
        public string ComponentCode { get; set; } = string.Empty; // Mã của Component để dễ nhận biết
        public string ComponentName { get; set; } = string.Empty; // Tên của Component để hiển thị
        public ComponentType ComponentType { get; set; }
        public bool IsRequired { get; set; } // Cờ bắt buộc (cần lấy từ ProcedureComponentLink)

        // Dữ liệu cho loại Form (JSON Tờ khai)
        public string? FormData { get; set; }

        // Thông tin cho loại File (Lấy từ FileManagement)
        public Guid? FileId { get; set; }
        public FileInfoDto? FileInfo { get; set; } // DTO từ FileManagement chứa tên, kích thước, content type...
    }
    ```

-   **Tệp 2:** Tạo file `BDocumentDto.cs` (DTO chi tiết Hồ sơ - Cập nhật)
    ```csharp
    using System;
    using System.Collections.Generic;
    using Aqt.CoreFW.Application.Contracts.Procedures.Dtos; // ProcedureDto
    using Aqt.CoreFW.Application.Contracts.WorkflowStatuses.Dtos; // WorkflowStatusDto
    using Volo.Abp.Application.Dtos;

    namespace Aqt.CoreFW.Application.Contracts.BDocuments.Dtos;

    public class BDocumentDto : FullAuditedEntityDto<Guid>
    {
        public Guid ProcedureId { get; set; }
        public ProcedureDto? Procedure { get; set; } // Thông tin Thủ tục liên quan

        public string MaHoSo { get; set; } = string.Empty;
        public string TenChuHoSo { get; set; } = string.Empty;
        public string? SoDinhDanhChuHoSo { get; set; }
        public string? DiaChiChuHoSo { get; set; }
        public string? EmailChuHoSo { get; set; }
        public string? SoDienThoaiChuHoSo { get; set; }

        // --- LOẠI BỎ TRƯỜNG TỜ KHAI ---

        public string? PhamViHoatDong { get; set; } // MỚI
        public bool DangKyNhanQuaBuuDien { get; set; } // MỚI

        public Guid? TrangThaiHoSoId { get; set; } // Nullable
        public WorkflowStatusDto? TrangThaiHoSo { get; set; } // Thông tin Trạng thái liên quan

        public DateTime? NgayNop { get; set; }
        public DateTime? NgayTiepNhan { get; set; }
        public DateTime? NgayHenTra { get; set; }
        public DateTime? NgayTraKetQua { get; set; }
        public string? LyDoTuChoiHoacBoSung { get; set; }

        // Danh sách dữ liệu/file của các thành phần thuộc hồ sơ
        public List<BDocumentDataDto> DocumentData { get; set; } = new List<BDocumentDataDto>();
    }
    ```

-   **Tệp 3:** Tạo file `BDocumentListDto.cs` (DTO cho danh sách Hồ sơ - Cập nhật)
    ```csharp
    using System;
    using Volo.Abp.Application.Dtos;

    namespace Aqt.CoreFW.Application.Contracts.BDocuments.Dtos;

    /// <summary>
    /// DTO simplified for listing BDocuments.
    /// </summary>
    public class BDocumentListDto : EntityDto<Guid>
    {
        public string MaHoSo { get; set; } = string.Empty;
        public string TenChuHoSo { get; set; } = string.Empty;

        public Guid ProcedureId { get; set; }
        public string ProcedureName { get; set; } = string.Empty; // Tên thủ tục

        public Guid? TrangThaiHoSoId { get; set; } // Nullable
        public string TrangThaiHoSoName { get; set; } = string.Empty; // Tên trạng thái (có thể là "Chưa có")
        public string? TrangThaiHoSoColorCode { get; set; } // Màu trạng thái

        public DateTime CreationTime { get; set; } // Ngày tạo (hoặc NgayNop nếu dùng)

        // Có thể thêm cột khác nếu cần, ví dụ:
        // public bool DangKyNhanQuaBuuDien { get; set;}
    }
    ```

-   **Tệp 4:** Tạo file `CreateBDocumentInputDto.cs` (Input để tạo Hồ sơ - Cập nhật)
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.ComponentModel.DataAnnotations;
    using Aqt.CoreFW.BDocuments; // Constants

    namespace Aqt.CoreFW.Application.Contracts.BDocuments.Dtos;

    public class CreateBDocumentInputDto
    {
        [Required]
        public Guid ProcedureId { get; set; }

        // Thông tin chủ hồ sơ
        [Required(AllowEmptyStrings = false)]
        [StringLength(BDocumentConsts.MaxTenChuHoSoLength)]
        public string TenChuHoSo { get; set; } = string.Empty;

        [StringLength(BDocumentConsts.MaxSoDinhDanhChuHoSoLength)]
        public string? SoDinhDanhChuHoSo { get; set; }

        [StringLength(BDocumentConsts.MaxDiaChiChuHoSoLength)]
        public string? DiaChiChuHoSo { get; set; }

        [EmailAddress]
        [StringLength(BDocumentConsts.MaxEmailChuHoSoLength)]
        public string? EmailChuHoSo { get; set; }

        [Phone]
        [StringLength(BDocumentConsts.MaxSoDienThoaiChuHoSoLength)]
        public string? SoDienThoaiChuHoSo { get; set; }

        // --- LOẠI BỎ TRƯỜNG TỜ KHAI ---

        // Thông tin bổ sung
        public string? PhamViHoatDong { get; set; } // MỚI

        public bool DangKyNhanQuaBuuDien { get; set; } // MỚI

        // Danh sách dữ liệu/tham chiếu file cho các thành phần
        // Bao gồm cả dữ liệu JSON của "Tờ khai" trong FormData của item tương ứng
        [Required]
        public List<CreateBDocumentComponentDataInputDto> ComponentData { get; set; } = new List<CreateBDocumentComponentDataInputDto>();

        // MaHoSo tự sinh, TrangThaiHoSoId ban đầu null
    }
    ```

-   **Tệp 5:** Tạo file `CreateBDocumentComponentDataInputDto.cs` (Input cho dữ liệu component khi tạo - Không đổi cấu trúc)
    ```csharp
    using System;
    using System.ComponentModel.DataAnnotations;

    namespace Aqt.CoreFW.Application.Contracts.BDocuments.Dtos;

    /// <summary>
    /// Represents the input data for a single component during BDocument creation.
    /// </summary>
    public class CreateBDocumentComponentDataInputDto
    {
        [Required]
        public Guid ProcedureComponentId { get; set; }

        // Dữ liệu form (JSON Tờ khai)
        public string? FormData { get; set; }

        // ID file từ FileManagement (File upload)
        public Guid? FileId { get; set; }
    }
    ```

-   **Tệp 6:** Tạo file `UpdateBDocumentInputDto.cs` (Input để cập nhật thông tin chính - Cập nhật)
    ```csharp
    using System;
    using System.ComponentModel.DataAnnotations;
    using Aqt.CoreFW.BDocuments; // Constants

    namespace Aqt.CoreFW.Application.Contracts.BDocuments.Dtos;

    // DTO này chỉ dùng để cập nhật thông tin chính của BDocument.
    public class UpdateBDocumentInputDto
    {
        [Required(AllowEmptyStrings = false)]
        [StringLength(BDocumentConsts.MaxTenChuHoSoLength)]
        public string TenChuHoSo { get; set; } = string.Empty;

        [StringLength(BDocumentConsts.MaxSoDinhDanhChuHoSoLength)]
        public string? SoDinhDanhChuHoSo { get; set; }

        [StringLength(BDocumentConsts.MaxDiaChiChuHoSoLength)]
        public string? DiaChiChuHoSo { get; set; }

        [EmailAddress]
        [StringLength(BDocumentConsts.MaxEmailChuHoSoLength)]
        public string? EmailChuHoSo { get; set; }

        [Phone]
        [StringLength(BDocumentConsts.MaxSoDienThoaiChuHoSoLength)]
        public string? SoDienThoaiChuHoSo { get; set; }

        // --- LOẠI BỎ TRƯỜNG TỜ KHAI ---

        // Thông tin bổ sung có thể sửa
        public string? PhamViHoatDong { get; set; } // MỚI
        public bool DangKyNhanQuaBuuDien { get; set; } // MỚI
    }
    ```

-   **Tệp 7:** Tạo file `AddOrUpdateBDocumentDataInputDto.cs` (Input để thêm/sửa dữ liệu Component sau khi tạo - Không đổi cấu trúc)
    ```csharp
    using System;
    using System.ComponentModel.DataAnnotations;

    namespace Aqt.CoreFW.Application.Contracts.BDocuments.Dtos;

    public class AddOrUpdateBDocumentDataInputDto
    {
        [Required]
        public Guid ProcedureComponentId { get; set; }

        // Dùng để cập nhật JSON Tờ khai hoặc các Form khác
        public string? FormData { get; set; }

        // Dùng để cập nhật FileId cho component loại File
        public Guid? FileId { get; set; }
    }
    ```
-   **Tệp 8:** Tạo file `ChangeBDocumentStatusInputDto.cs` (Input để đổi trạng thái - Không đổi)
    ```csharp
    using System;
    using System.ComponentModel.DataAnnotations;
    using Aqt.CoreFW.BDocuments; // Constants

    namespace Aqt.CoreFW.Application.Contracts.BDocuments.Dtos;

    public class ChangeBDocumentStatusInputDto
    {
        [Required]
        public Guid NewStatusId { get; set; } // ID của WorkflowStatus mới

        [StringLength(BDocumentConsts.MaxLyDoTuChoiHoacBoSungLength)]
        public string? Reason { get; set; } // Lý do (nếu có)
    }

    ```

-   **Tệp 9:** Tạo file `GetBDocumentsInput.cs` (Input cho GetList - Không đổi)
    ```csharp
    using System;
    using Volo.Abp.Application.Dtos;

    namespace Aqt.CoreFW.Application.Contracts.BDocuments.Dtos;

    public class GetBDocumentsInput : PagedAndSortedResultRequestDto
    {
        public string? Filter { get; set; } // Filter theo MaHoSo hoặc TenChuHoSo
        public Guid? ProcedureId { get; set; } // Lọc theo Thủ tục
        public Guid? StatusId { get; set; } // Lọc theo Trạng thái (WorkflowStatusId)
        public DateTime? SubmissionDateFrom { get; set; } // Lọc theo ngày nộp từ
        public DateTime? SubmissionDateTo { get; set; } // Lọc theo ngày nộp đến
        // Thêm filter nếu cần
        // public bool? DangKyNhanQuaBuuDien { get; set; }
    }
    ```

-   **Tệp 10:** Tạo file `BDocumentExcelDto.cs` (Dùng cho xuất Excel - Cập nhật)
    ```csharp
    using System;
    using MiniExcelLibs.Attributes; // Giả sử dùng MiniExcel

    namespace Aqt.CoreFW.Application.Contracts.BDocuments.Dtos;

    /// <summary>
    /// DTO được thiết kế riêng cho việc xuất dữ liệu BDocument ra Excel.
    /// </summary>
    public class BDocumentExcelDto
    {
        [ExcelColumnName("Mã Hồ sơ")]
        public string MaHoSo { get; set; } = string.Empty;

        [ExcelColumnName("Tên Chủ hồ sơ")]
        public string TenChuHoSo { get; set; } = string.Empty;

        [ExcelColumnName("Thủ tục")]
        public string ProcedureName { get; set; } = string.Empty; // Tên thủ tục

        [ExcelColumnName("Trạng thái")]
        public string StatusName { get; set; } = string.Empty; // Tên trạng thái

        // Bỏ các trường Tờ khai

        [ExcelColumnName("Phạm vi hoạt động")] // MỚI
        public string? PhamViHoatDong { get; set; }

        [ExcelColumnName("Đăng ký nhận qua BĐ")] // MỚI
        public string DangKyNhanQuaBuuDien { get; set; } = string.Empty; // Map sang Yes/No

        [ExcelColumnName("Ngày nộp")]
        [ExcelFormat("yyyy-MM-dd HH:mm:ss")]
        public DateTime? NgayNop { get; set; }

        [ExcelColumnName("Ngày tiếp nhận")]
        [ExcelFormat("yyyy-MM-dd HH:mm:ss")]
        public DateTime? NgayTiepNhan { get; set; }

        [ExcelColumnName("Ngày hẹn trả")]
        [ExcelFormat("yyyy-MM-dd HH:mm:ss")]
        public DateTime? NgayHenTra { get; set; }

        [ExcelColumnName("Ngày trả kết quả")]
        [ExcelFormat("yyyy-MM-dd HH:mm:ss")]
        public DateTime? NgayTraKetQua { get; set; }
    }
    ```

## 2. AppService Interface (`IBDocumentAppService.cs`)

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Application.Contracts/BDocuments`
-   **Tệp:** Cập nhật file `IBDocumentAppService.cs`
    ```csharp
    using System;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Application.Contracts.BDocuments.Dtos; // Namespace chứa DTOs
    using Aqt.CoreFW.Application.Contracts.Files; // FileInfoDto
    using Volo.Abp.Application.Dtos;
    using Volo.Abp.Application.Services;
    using Volo.Abp.Content; // Required for IRemoteStreamContent

    namespace Aqt.CoreFW.Application.Contracts.BDocuments;

    public interface IBDocumentAppService : IApplicationService
    {
        /// <summary>
        /// Tạo BDocument mới với thông tin chủ hồ sơ, thông tin bổ sung,
        /// dữ liệu component ban đầu (bao gồm JSON tờ khai và FileId).
        /// Trạng thái ban đầu là null.
        /// </summary>
        Task<BDocumentDto> CreateAsync(CreateBDocumentInputDto input);

        /// <summary>
        /// Cập nhật thông tin chính của BDocument (chủ hồ sơ, phạm vi...).
        /// KHÔNG cập nhật component data qua phương thức này.
        /// </summary>
        Task<BDocumentDto> UpdateAsync(Guid id, UpdateBDocumentInputDto input);

        /// <summary>
        /// Lấy thông tin chi tiết của BDocument, bao gồm cả dữ liệu component.
        /// </summary>
        Task<BDocumentDto> GetAsync(Guid id);

        /// <summary>
        /// Lấy danh sách BDocument đã phân trang và lọc.
        /// </summary>
        Task<PagedResultDto<BDocumentListDto>> GetListAsync(GetBDocumentsInput input);

        /// <summary>
        /// Xóa một BDocument (xóa mềm).
        /// </summary>
        Task DeleteAsync(Guid id);

        /// <summary>
        /// Thêm hoặc cập nhật dữ liệu/file cho một thành phần cụ thể của BDocument.
        /// (Dùng để sửa Tờ khai JSON hoặc upload/thay đổi file đính kèm).
        /// </summary>
        Task<BDocumentDataDto> AddOrUpdateDataAsync(Guid id, AddOrUpdateBDocumentDataInputDto input);

        /// <summary>
        /// Xóa dữ liệu/file của một thành phần khỏi BDocument.
        /// </summary>
        /// <param name="id">ID của BDocument.</param>
        /// <param name="bDocumentDataId">ID của bản ghi BDocumentData cần xóa.</param>
        /// <param name="deleteFile">Chỉ định có xóa file vật lý trong FileManagement hay không.</param>
        Task RemoveDataAsync(Guid id, Guid bDocumentDataId, bool deleteFile = false);

        /// <summary>
        /// Thay đổi trạng thái của BDocument (được gọi bởi hệ thống Workflow).
        /// </summary>
        Task<BDocumentDto> ChangeStatusAsync(Guid id, ChangeBDocumentStatusInputDto input);

        /// <summary>
        /// (Optional) Trigger quá trình tạo file từ dữ liệu Tờ khai đã lưu.
        /// </summary>
        /// <param name="id">ID của BDocument.</param>
        /// <returns>Thông tin file đã tạo (FileInfoDto).</returns>
        Task<FileInfoDto> GenerateDeclarationFileAsync(Guid id);

        /// <summary>
        /// (Optional) Xuất danh sách BDocuments ra file Excel dựa trên bộ lọc.
        /// </summary>
        Task<IRemoteStreamContent> GetListAsExcelAsync(GetBDocumentsInput input);
    }
    ```

## 3. Permissions

-   **Vị trí 1:** Cập nhật file `src/Aqt.CoreFW.Application.Contracts/Permissions/CoreFWPermissions.cs`
-   **Nội dung cần thêm/sửa (bên trong class `CoreFWPermissions`):**
    ```csharp
    // ... các permission khác ...

    // Permissions for BDocument Management
    public static class BDocuments
    {
        public const string Default = GroupName + ".BDocuments"; // View permission
        public const string Create = Default + ".Create";
        public const string Update = Default + ".Update"; // Update main BDocument info only
        public const string Delete = Default + ".Delete";
        public const string ManageComponents = Default + ".ManageComponents"; // Add/Update/Remove BDocumentData
        public const string GenerateDeclarationFile = Default + ".GenerateDeclarationFile"; // Trigger file generation
        public const string Export = Default + ".Export";
    }
    // ... các module khác ...
    ```
-   **Vị trí 2:** Cập nhật file `src/Aqt.CoreFW.Application.Contracts/Permissions/CoreFWPermissionDefinitionProvider.cs`
-   **Nội dung cần thêm vào phương thức `Define`:**
    ```csharp
    // ... Lấy context.GetGroup(CoreFWPermissions.GroupName);

    // Define permissions for BDocuments
    var bdocumentsPermissionGroup = coreFwGroup.AddPermission(CoreFWPermissions.BDocuments.Default, L("Permission:BDocuments"));
    bdocumentsPermissionGroup.AddChild(CoreFWPermissions.BDocuments.Create, L("Permission:BDocuments.Create"));
    bdocumentsPermissionGroup.AddChild(CoreFWPermissions.BDocuments.Update, L("Permission:BDocuments.Update"));
    bdocumentsPermissionGroup.AddChild(CoreFWPermissions.BDocuments.Delete, L("Permission:BDocuments.Delete"));
    bdocumentsPermissionGroup.AddChild(CoreFWPermissions.BDocuments.ManageComponents, L("Permission:BDocuments.ManageComponents")); // MỚI
    bdocumentsPermissionGroup.AddChild(CoreFWPermissions.BDocuments.GenerateDeclarationFile, L("Permission:BDocuments.GenerateDeclarationFile")); // MỚI
    bdocumentsPermissionGroup.AddChild(CoreFWPermissions.BDocuments.Export, L("Permission:BDocuments.Export"));

    // ... các AddPermission khác ...
    ```

## 4. Lưu ý

*   **Namespaces:** Đảm bảo sử dụng đúng namespaces.
*   **DTO Structure:** Các DTO đã được cập nhật theo yêu cầu mới. `CreateBDocumentInputDto` chứa `ComponentData` để nhận JSON Tờ khai và FileId upload.
*   **AppService Interface:** Chữ ký phương thức phản ánh DTO mới. Thêm `GenerateDeclarationFileAsync`. `UpdateAsync` chỉ sửa thông tin chính. `AddOrUpdateDataAsync` dùng cho component data.
*   **File Management Integration:** `BDocumentDataDto` chứa `FileInfoDto`. `Create/AddOrUpdate` DTOs chứa `FileId`. Logic gọi `IFileAppService` nằm ở tầng Application.
*   **WorkflowStatus Integration:** `BDocumentDto`/`ListDto` chứa thông tin trạng thái. `TrangThaiHoSoId` là nullable. `ChangeStatusAsync` dùng để đổi trạng thái.
*   **Permissions:** Đã cập nhật theo yêu cầu mới, tách quyền `Update` và `ManageComponents`.
*   **Validation:** DataAnnotations cho validation cơ bản. Validation phức tạp hơn nằm ở tầng Application.
*   **Excel Export:** DTO đã được cập nhật.