# Kế hoạch chi tiết: Tầng Web (`Aqt.CoreFW.Web`) - Quản lý Hồ sơ (BDocument)

**Lưu ý:** Kế hoạch này giả định rằng Partial View `_DynamicFormRenderer.cshtml` đã được tạo theo **Kế hoạch 5.1** và có khả năng render form HTML từ JSON `FormDefinition`.

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Web` cho module Quản lý Hồ sơ (BDocument), với ProcedureId được biết trước và Tờ khai được render động bởi `_DynamicFormRenderer.cshtml`.

## 1. Cấu hình AutoMapper (Web Layer)

-   **Mục đích:** Định nghĩa cách chuyển đổi giữa ViewModel và DTO. **BDocumentViewModel không còn chứa các trường Tờ khai.** Mapping sẽ xử lý `ComponentDataList` chứa JSON `FormData`.
-   **Vị trí:** Cập nhật file `src/Aqt.CoreFW.Web/CoreFWWebAutoMapperProfile.cs`
-   **Nội dung cần thêm/cập nhật:**
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text.Json;
    using Aqt.CoreFW.Application.Contracts.BDocuments.Dtos;
    using Aqt.CoreFW.Application.Contracts.Files;
    using Aqt.CoreFW.Web.Pages.BDocuments.ViewModels;
    using AutoMapper;
    using Microsoft.AspNetCore.Mvc.Rendering;
    using EasyAbp.FileManagement.Files.Dtos;
    using Aqt.CoreFW.BDocuments; // Constants

    public class CoreFWWebAutoMapperProfile : Profile
    {
        public CoreFWWebAutoMapperProfile()
        {
            // ... existing mappings ...

            // --- BDocument Mappings ---
            // ViewModel -> Create Input DTO
            CreateMap<BDocumentViewModel, CreateBDocumentInputDto>()
                 // AutoMapper sẽ tự động map ComponentDataList (đã chứa JSON trong FormData)
                .ForMember(dest => dest.ComponentData, opt => opt.MapFrom(src => src.ComponentDataList));

            // ViewModel -> Update Input DTO (Chỉ map trường thông tin chính)
            CreateMap<BDocumentViewModel, UpdateBDocumentInputDto>();

            // Detail DTO -> ViewModel
            CreateMap<BDocumentDto, BDocumentViewModel>()
                .ForMember(dest => dest.TrangThaiHoSoName, opt => opt.MapFrom(src => src.TrangThaiHoSo != null ? src.TrangThaiHoSo.Name : null))
                .ForMember(dest => dest.TrangThaiHoSoColorCode, opt => opt.MapFrom(src => src.TrangThaiHoSo != null ? src.TrangThaiHoSo.ColorCode : null))
                .ForMember(dest => dest.ProcedureName, opt => opt.MapFrom(src => src.Procedure != null ? src.Procedure.Name : null))
                 // Bỏ qua mapping các trường Tờ khai ở đây
                .ForMember(dest => dest.ComponentDataList, opt => opt.MapFrom(src => src.DocumentData)); // Map BDocumentData

            // --- BDocumentData Mappings ---
            // DTO -> ViewModel
            CreateMap<BDocumentDataDto, BDocumentDataViewModel>()
                 .ForMember(dest => dest.FileName, opt => opt.MapFrom(src => src.FileInfo != null ? src.FileInfo.FileName : null))
                 .ForMember(dest => dest.FileSize, opt => opt.MapFrom(src => src.FileInfo != null ? src.FileInfo.Length : (long?)null))
                 .ForMember(dest => dest.FileContentType, opt => opt.MapFrom(src => src.FileInfo != null ? src.FileInfo.ContentType : null))
                 // FormDefinition và FormData sẽ được load từ AppService khi GetAsync, không cần map từ DTO ở đây
                 .ForMember(dest => dest.FormDefinition, opt => opt.Ignore()) // Sẽ được load riêng
                 .ForMember(dest => dest.FormData, opt => opt.MapFrom(src => src.FormData)); // Map dữ liệu JSON đã lưu

            // ViewModel -> Create Input DTO Component (Map trực tiếp)
            CreateMap<BDocumentDataViewModel, CreateBDocumentComponentDataInputDto>();

            // Map DTO của FileManagement sang FileInfoDto của Contracts
            CreateMap<EasyAbp.FileManagement.Files.Dtos.FileInfoDto, Aqt.CoreFW.Application.Contracts.Files.FileInfoDto>();


            // --- Lookup Mappings (Cho Filter trang Index) ---
            CreateMap<Application.Contracts.Procedures.Dtos.ProcedureLookupDto, SelectListItem>()
               .ForMember(dest => dest.Value, opt => opt.MapFrom(src => src.Id.ToString()))
               .ForMember(dest => dest.Text, opt => opt.MapFrom(src => $"{src.Code} - {src.Name}"));

            CreateMap<Application.Contracts.WorkflowStatuses.Dtos.WorkflowStatusLookupDto, SelectListItem>()
               .ForMember(dest => dest.Value, opt => opt.MapFrom(src => src.Id.ToString()))
               .ForMember(dest => dest.Text, opt => opt.MapFrom(src => src.Name));
        }
    }
    ```

## 2. Menu

-   **Vị trí 1:** Cập nhật file `src/Aqt.CoreFW.Web/Menus/CoreFWMenus.cs`
-   **Nội dung cần thêm:**
    ```csharp
    public const string BDocuments = Prefix + ".BDocuments";
    ```
-   **Vị trí 2:** Cập nhật file `src/Aqt.CoreFW.Web/Menus/CoreFWMenuContributor.cs`
-   **Nội dung cần thêm trong `ConfigureMainMenuAsync`:**
    ```csharp
    if (await context.IsGrantedAsync(CoreFWPermissions.BDocuments.Default))
    {
        context.Menu.AddItem(
             new ApplicationMenuItem(
                 CoreFWMenus.BDocuments, l["Menu:BDocuments"], "/BDocuments",
                 icon: "fas fa-folder-open", order: 20
             ).RequirePermissions(CoreFWPermissions.BDocuments.Default)
         );
    }
    ```

## 3. Razor Pages và ViewModels

-   **Vị trí:** `src/Aqt.CoreFW.Web/Pages/BDocuments`

-   **Tệp 1: ViewModel Dữ liệu Component:** `BDocumentDataViewModel.cs` (Thêm FormDefinition)
    ```csharp
    using System;
    using Aqt.CoreFW.Components; // Enum ComponentType
    using Microsoft.AspNetCore.Mvc;

    namespace Aqt.CoreFW.Web.Pages.BDocuments.ViewModels;

    public class BDocumentDataViewModel
    {
        [HiddenInput]
        public Guid? Id { get; set; } // ID của BDocumentData (nullable nếu là mới)

        [HiddenInput]
        public Guid ProcedureComponentId { get; set; }

        // Thông tin Component (để hiển thị)
        public string ComponentCode { get; set; } = string.Empty;
        public string ComponentName { get; set; } = string.Empty;
        public ComponentType ComponentType { get; set; }
        public bool IsRequired { get; set; } // Lấy từ ProcedureComponentLink
        public string? Description { get; set; } // Thêm Description
        public string? TempPath { get; set; } // Thêm đường dẫn template
        public string? FormDefinition { get; set; } // JSON definition cho Partial View

        // Dữ liệu đầu vào/hiển thị
        [HiddenInput] // Sẽ được JS cập nhật cho Tờ khai
        public string? FormData { get; set; } // Bind/Lưu dữ liệu JSON form Tờ khai

        [HiddenInput]
        public Guid? FileId { get; set; } // Bind FileId từ JS

        // Thông tin file đã upload (để hiển thị)
        public string? FileName { get; set; }
        public long? FileSize { get; set; }
        public string? FileContentType { get; set; }
    }
    ```

-   **Tệp 2: ViewModel Hồ sơ:** `BDocumentViewModel.cs` (**Loại bỏ** các trường Tờ khai)
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.ComponentModel.DataAnnotations;
    using Aqt.CoreFW.BDocuments; // Consts
    using Microsoft.AspNetCore.Mvc;

    namespace Aqt.CoreFW.Web.Pages.BDocuments.ViewModels;

    public class BDocumentViewModel
    {
        [HiddenInput]
        public Guid? Id { get; set; } // Nullable for Create

        // --- Thông tin từ Procedure và Status (Read-only) ---
        public string? ProcedureName { get; set; }
        public string? TrangThaiHoSoName { get; set; }
        public string? TrangThaiHoSoColorCode { get; set; }

        // --- Thông tin chính (Tạo/Sửa) ---
        [Required]
        [HiddenInput] // Không cần hiển thị dropdown nữa
        public Guid ProcedureId { get; set; }

        [Display(Name = "DisplayName:BDocument.MaHoSo")]
        [ReadOnlyInput]
        public string MaHoSo { get; set; } = string.Empty; // Hiển thị khi Edit

        [Required(AllowEmptyStrings = false)]
        [StringLength(BDocumentConsts.MaxTenChuHoSoLength)]
        [Display(Name = "DisplayName:BDocument.TenChuHoSo")]
        public string TenChuHoSo { get; set; } = string.Empty;

        [StringLength(BDocumentConsts.MaxSoDinhDanhChuHoSoLength)]
        [Display(Name = "DisplayName:BDocument.SoDinhDanhChuHoSo")]
        public string? SoDinhDanhChuHoSo { get; set; }

        [StringLength(BDocumentConsts.MaxDiaChiChuHoSoLength)]
        [Display(Name = "DisplayName:BDocument.DiaChiChuHoSo")]
        public string? DiaChiChuHoSo { get; set; }

        [EmailAddress]
        [StringLength(BDocumentConsts.MaxEmailChuHoSoLength)]
        [Display(Name = "DisplayName:BDocument.EmailChuHoSo")]
        public string? EmailChuHoSo { get; set; }

        [Phone]
        [StringLength(BDocumentConsts.MaxSoDienThoaiChuHoSoLength)]
        [Display(Name = "DisplayName:BDocument.SoDienThoaiChuHoSo")]
        public string? SoDienThoaiChuHoSo { get; set; }

        // --- BỎ CÁC TRƯỜNG TỜ KHAI RIÊNG LẺ ---

        // Thông tin bổ sung
        [Display(Name = "DisplayName:BDocument.PhamViHoatDong")]
        [DataType(DataType.MultilineText)]
        public string? PhamViHoatDong { get; set; } // MỚI

        [Display(Name = "DisplayName:BDocument.DangKyNhanQuaBuuDien")]
        public bool DangKyNhanQuaBuuDien { get; set; } // MỚI

        // Danh sách dữ liệu Component (Quan trọng cho Create Modal)
        // Chứa JSON tờ khai và FileId các file khác
        // Tên property khớp với cấu hình AutoMapper
        public List<BDocumentDataViewModel> ComponentDataList { get; set; } = new List<BDocumentDataViewModel>();

        // --- Thông tin ngày tháng (Read-only) ---
        [Display(Name = "DisplayName:BDocument.NgayNop")]
        [DataType(DataType.DateTime)]
        public DateTime? NgayNop { get; set; }

        [Display(Name = "DisplayName:BDocument.NgayTiepNhan")]
        [DataType(DataType.DateTime)]
        public DateTime? NgayTiepNhan { get; set; }

        [Display(Name = "DisplayName:BDocument.NgayHenTra")]
        [DataType(DataType.DateTime)]
        public DateTime? NgayHenTra { get; set; }

        [Display(Name = "DisplayName:BDocument.NgayTraKetQua")]
        [DataType(DataType.DateTime)]
        public DateTime? NgayTraKetQua { get; set; }

        [Display(Name = "DisplayName:BDocument.LyDoTuChoiHoacBoSung")]
        [ReadOnlyInput] // Chỉ hiển thị, không sửa ở đây
        public string? LyDoTuChoiHoacBoSung { get; set; }
    }
    ```

-   **Tệp 3: Trang danh sách:** `Index.cshtml` (Cập nhật Toolbar)
    ```cshtml
    @page
    @using Aqt.CoreFW.Permissions
    @using Microsoft.AspNetCore.Authorization
    @using Volo.Abp.AspNetCore.Mvc.UI.Layout
    @using Aqt.CoreFW.Web.Pages.BDocuments
    @using Aqt.CoreFW.Localization
    @using Microsoft.Extensions.Localization
    @using Aqt.CoreFW.Web.Menus
    @using Microsoft.AspNetCore.Mvc.Rendering // Thêm SelectListItem
    @model IndexModel
    @inject IStringLocalizer<CoreFWResource> L
    @inject IAuthorizationService AuthorizationService
    @inject IPageLayout PageLayout
    @{
        PageLayout.Content.Title = L["BDocuments"].Value;
        PageLayout.Content.MenuItemName = CoreFWMenus.BDocuments;
    }

    @section scripts {
        <script>
            const permissions = {
                canCreate: @Html.Raw(ViewData["CanCreate"]), // Thêm quyền tạo
                canEdit:   @Html.Raw(ViewData["CanEdit"]),
                canDelete: @Html.Raw(ViewData["CanDelete"]),
                canExport: @Html.Raw(ViewData["CanExport"])
            };
        </script>
        <abp-script src="/Pages/BDocuments/index.js" />
    }

    @section content_toolbar {
        <div class="input-group input-group-sm w-auto me-2"> @* Thêm nhóm input cho chọn thủ tục và nút New *@
            <label class="input-group-text" for="ProcedureSelectionForCreate">@L["SelectProcedure"]</label>
            <select id="ProcedureSelectionForCreate" class="form-select">
                <option value="">@L["Select"]...</option>
                 @foreach (var item in Model.AvailableProcedures)
                { <option value="@item.Value">@item.Text</option> }
            </select>
            <abp-button id="NewBDocumentButton" text="@L["New"].Value" icon="plus" button-type="Primary" size="Small" disabled="true"/>
        </div>

        @if ((bool?)ViewData["CanExport"] == true)
        {
            <abp-button id="ExportExcelButton" text="@L["ExportToExcel"].Value" icon="file-excel" button-type="Success" size="Small" class="ms-auto"/>
        }
    }

    <abp-card>
        <abp-card-header>
             <abp-row>
                <abp-column size-md="_6"> <h5>@L["BDocuments"]</h5> </abp-column>
                <abp-column size-md="_6" class="text-end"></abp-column>
            </abp-row>
        </abp-card-header>
        <abp-card-body>
            @* Filters *@
            <abp-row class="mb-3">
                <abp-column size-md="_3"> <input type="text" id="SearchFilter" class="form-control form-control-sm" placeholder="@L["Search"] (...)" /> </abp-column>
                <abp-column size-md="_3">
                    <select id="ProcedureFilter" class="form-select form-select-sm"> @* Dropdown lọc bảng *@
                        <option value="">@L["All"] (@L["DisplayName:BDocument.ProcedureId"])</option>
                        @foreach (var item in Model.AvailableProcedures) { <option value="@item.Value">@item.Text</option> }
                    </select>
                </abp-column>
                <abp-column size-md="_3">
                     <select id="StatusFilter" class="form-select form-select-sm">
                        <option value="">@L["All"] (@L["DisplayName:BDocument.TrangThaiHoSoId"])</option>
                        @foreach (var item in Model.AvailableStatuses) { <option value="@item.Value">@item.Text</option> }
                    </select>
                </abp-column>
                <abp-column size-md="_3" class="text-end"> <abp-button id="SearchButton" text="@L["Search"].Value" icon="search" button-type="Info" size="Small"/> </abp-column>
            </abp-row>
            @* DataTable *@
            <abp-table striped-rows="true" id="BDocumentTable" class="nowrap"></abp-table>
        </abp-card-body>
    </abp-card>
    ```

-   **Tệp 4: PageModel danh sách:** `Index.cshtml.cs` (Cập nhật `OnGetAsync` để kiểm tra quyền tạo)
    ```csharp
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Application.Contracts.Procedures;
    using Aqt.CoreFW.Application.Contracts.WorkflowStatuses;
    using Aqt.CoreFW.Permissions; // Import Permissions
    using Microsoft.AspNetCore.Authorization;
    using Microsoft.AspNetCore.Mvc.Rendering;
    using Volo.Abp.AspNetCore.Mvc.UI.RazorPages;

    namespace Aqt.CoreFW.Web.Pages.BDocuments;

    public class IndexModel : AbpPageModel
    {
        private readonly IAuthorizationService _authorizationService;
        private readonly IProcedureAppService _procedureAppService;
        private readonly IWorkflowStatusAppService _statusAppService;

        public List<SelectListItem> AvailableProcedures { get; set; } = new();
        public List<SelectListItem> AvailableStatuses { get; set; } = new();

        public IndexModel(
            IAuthorizationService authorizationService,
            IProcedureAppService procedureAppService,
            IWorkflowStatusAppService statusAppService)
        {
            _authorizationService = authorizationService;
            _procedureAppService = procedureAppService;
            _statusAppService = statusAppService;
        }

        public async Task OnGetAsync()
        {
            await LoadLookupsAsync();
            ViewData["CanCreate"] = await _authorizationService.IsGrantedAsync(CoreFWPermissions.BDocuments.Create); // Thêm kiểm tra quyền tạo
            ViewData["CanEdit"] = await _authorizationService.IsGrantedAsync(CoreFWPermissions.BDocuments.Update);
            ViewData["CanDelete"] = await _authorizationService.IsGrantedAsync(CoreFWPermissions.BDocuments.Delete);
            ViewData["CanExport"] = await _authorizationService.IsGrantedAsync(CoreFWPermissions.BDocuments.Export);
        }

        private async Task LoadLookupsAsync()
        {
            try
            {
                 var procedureLookup = await _procedureAppService.GetLookupAsync();
                 AvailableProcedures = procedureLookup.Items.Select(p => new SelectListItem($"{p.Code} - {p.Name}", p.Id.ToString())).ToList();
                 var statusLookup = await _statusAppService.GetLookupAsync();
                 AvailableStatuses = statusLookup.Items.Select(s => new SelectListItem(s.Name, s.Id.ToString())).ToList();
            }
            catch (System.Exception ex) { /* ... Log Error ... */ }
        }
    }
    ```

-   **Tệp 5: Modal Thêm mới:** `CreateModal.cshtml` (Gọi Partial View `_DynamicFormRenderer`)
    ```cshtml
    @page "{handler?}"
    @using Microsoft.AspNetCore.Mvc.Localization
    @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
    @using Aqt.CoreFW.Localization
    @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form
    @using Aqt.CoreFW.Web.Pages.BDocuments.ViewModels
    @using Aqt.CoreFW.Application.Contracts.Components.Dtos
    @using Aqt.CoreFW.Components
    @model CreateModalModel
    @inject IHtmlLocalizer<CoreFWResource> L
    @{ Layout = null; }

    <abp-dynamic-form abp-model="BDocumentViewModel" asp-page="/BDocuments/CreateModal" id="CreateBDocumentForm">
        <abp-modal size="XLarge">
            <abp-modal-header title="@L["NewBDocument"].Value (@Model.ProcedureName)"></abp-modal-header>
            <abp-modal-body>
                @* Hidden ProcedureId *@
                <input type="hidden" asp-for="BDocumentViewModel.ProcedureId" />

                @* Thông tin Chủ hồ sơ *@
                <h5>@L["ApplicantInformation"]</h5>
                <abp-row>
                    <abp-column size-md="_6"> <abp-input asp-for="BDocumentViewModel.TenChuHoSo" /> </abp-column>
                    <abp-column size-md="_6"> <abp-input asp-for="BDocumentViewModel.SoDinhDanhChuHoSo" /> </abp-column>
                    <abp-column size-md="_6"> <abp-input asp-for="BDocumentViewModel.DiaChiChuHoSo" /> </abp-column>
                    <abp-column size-md="_6"> <abp-input asp-for="BDocumentViewModel.EmailChuHoSo" type="email"/> </abp-column>
                    <abp-column size-md="_6"> <abp-input asp-for="BDocumentViewModel.SoDienThoaiChuHoSo" type="tel"/> </abp-column>
                </abp-row>
                <hr />

                @* Thông tin bổ sung *@
                <h5>@L["AdditionalInformation"]</h5>
                <abp-row> <abp-input asp-for="BDocumentViewModel.PhamViHoatDong"/> </abp-row>
                <abp-row> <abp-check asp-for="BDocumentViewModel.DangKyNhanQuaBuuDien"/> </abp-row>
                 <hr />

                @* Phần Tờ khai - Gọi Partial View *@
                @if (Model.DeclarationComponentData != null)
                {
                    <h5>@L["DeclarationForm"]: @Model.DeclarationComponentData.ComponentName</h5>
                    <div id="DeclarationFormContainer" data-component-id="@Model.DeclarationComponentData.ProcedureComponentId" class="border p-3 mb-3">
                        @* === GỌI PARTIAL VIEW (Được tạo ở Kế hoạch 5.1) === *@
                        @await Html.PartialAsync("_DynamicFormRenderer", Model.DeclarationComponentData)
                 </div>
                     <hr />
                     @* Input ẩn để JS lưu JSON tờ khai vào đúng item trong list *@
                     <input type="hidden" name="BDocumentViewModel.ComponentDataList[@Model.DeclarationComponentIndex].FormData" id="declarationFormDataJson" />
                     <input type="hidden" name="BDocumentViewModel.ComponentDataList[@Model.DeclarationComponentIndex].ProcedureComponentId" value="@Model.DeclarationComponentData.ProcedureComponentId" />
                     <input type="hidden" name="BDocumentViewModel.ComponentDataList[@Model.DeclarationComponentIndex].FileId" value="" /> @* FileId sẽ được tạo sau *@
                 }

                 @* Bảng Hồ sơ đính kèm *@
                 <h5>@L["AttachedDocuments"]</h5>
                 <div class="table-responsive">
                     <table class="table table-sm table-striped table-bordered" id="AttachedDocumentsTable">
                         <thead class="table-light">
                             <tr>
                                 <th style="width: 50px;">STT</th>
                                 <th>@L["DisplayName:BDocumentData.Component"]</th>
                                 <th>@L["DisplayName:BDocumentData.AttachedFile"]</th>
                             </tr>
                         </thead>
                         <tbody>
                             @if (Model.AttachmentComponents != null && Model.AttachmentComponents.Any())
                             {
                                 for (int i = 0; i < Model.AttachmentComponents.Count; i++)
                                 {
                                     var comp = Model.AttachmentComponents[i];
                                     var dataIndex = Model.GetComponentDataIndex(comp.Id);
                                     if(dataIndex < 0) continue; // Lỗi logic nếu không tìm thấy index

                                     <tr>
                                         <td class="text-center">@(i + 1)</td>
                                         <td>
                                             @comp.Name @(comp.IsRequired ? Html.Raw("<span class='text-danger ms-1'>*</span>") : Html.Raw(""))
                                             @if (!string.IsNullOrEmpty(comp.Description)) { <small class="d-block text-muted fst-italic">@comp.Description</small> }
                                             <input type="hidden" name="BDocumentViewModel.ComponentDataList[@dataIndex].ProcedureComponentId" value="@comp.Id" />
                                             <input type="hidden" name="BDocumentViewModel.ComponentDataList[@dataIndex].FormData" value="" /> @* FormData rỗng cho loại File *@
                                         </td>
                                         <td>
                                             @if (comp.Type == ComponentType.Form) // Dòng Tờ khai
                                             {
                                                 <div id="fileInfo_@comp.Id" class="file-upload-info text-muted fst-italic"> @L["WaitingForGeneration"] </div>
                                                 <input type="hidden" name="BDocumentViewModel.ComponentDataList[@dataIndex].FileId" id="BDocumentViewModel.ComponentDataList[@dataIndex].FileId" value="" />
                                             }
                                             else // Component loại File
                                             {
                                                 <div class="input-group input-group-sm">
                                                     <input type="file" class="form-control file-upload-input" id="fileInput_@comp.Id" data-target-hidden="#BDocumentViewModel_ComponentDataList_@(dataIndex)__FileId" data-target-info="#fileInfo_@comp.Id" />
                                                 </div>
                                                 <div id="fileInfo_@comp.Id" class="mt-1 file-upload-info small"></div>
                                                 <input type="hidden" name="BDocumentViewModel.ComponentDataList[@dataIndex].FileId" id="BDocumentViewModel_ComponentDataList_@(dataIndex)__FileId" value="" />
                                                  @if (!string.IsNullOrEmpty(comp.TempPath)) { <div class="mt-1 small"><a href="#" class="download-template" data-path="@comp.TempPath"><i class="fas fa-download me-1"></i>@L["DownloadTemplate"]</a></div> }
                                             }
                                         </td>
                                     </tr>
                                 }
                             }
                             else { <tr><td colspan="3" class="text-center text-muted">@L["NoComponentsConfiguredForProcedure"]</td></tr> }
                         </tbody>
                     </table>
                 </div>
                 <div class="form-text text-danger small">@L["RequiredField"] (*)</div>

            </abp-modal-body>
            <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer> @* Hoặc các nút tùy chỉnh theo UI *@
        </abp-modal>
    </abp-dynamic-form>

    <abp-script src="/Pages/BDocuments/createModal.js" />
    ```

-   **Tệp 5.1: Partial View Render Form Động:** `_DynamicFormRenderer.cshtml`
    -   **Ghi chú:** File này được tạo và định nghĩa chi tiết trong **Kế hoạch 5.1**.

-   **Tệp 6: PageModel Thêm mới:** `CreateModal.cshtml.cs` (Không đổi)
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text.Json;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Application.Contracts.BDocuments;
    using Aqt.CoreFW.Application.Contracts.BDocuments.Dtos;
    using Aqt.CoreFW.Application.Contracts.Components;
    using Aqt.CoreFW.Application.Contracts.Components.Dtos;
    using Aqt.CoreFW.Application.Contracts.Procedures;
    using Aqt.CoreFW.Web.Pages.BDocuments.ViewModels;
    using Microsoft.AspNetCore.Http;
    using Microsoft.AspNetCore.Mvc;
    using Volo.Abp.AspNetCore.Mvc.UI.RazorPages;
    using EasyAbp.FileManagement.Files;
    using Volo.Abp.Validation;
    using Aqt.CoreFW.Components; // Enum
    using Microsoft.Extensions.Logging;

    namespace Aqt.CoreFW.Web.Pages.BDocuments;
    public class CreateModalModel : AbpPageModel
    {
        [BindProperty]
        public BDocumentViewModel BDocumentViewModel { get; set; } = new();

        // Dữ liệu để render View và Partial View
        public List<ProcedureComponentDto> AttachmentComponents { get; set; } = new(); // Tất cả components
        public BDocumentDataViewModel? DeclarationComponentData { get; set; } // ViewModel cho Partial View
        public string ProcedureName { get; set; } = string.Empty;
        public int DeclarationComponentIndex { get; set; } = -1;

        // Inject services...
        private readonly IBDocumentAppService _bDocumentAppService;
        private readonly IProcedureAppService _procedureAppService;
        private readonly IProcedureComponentAppService _componentAppService;
        private readonly IFileAppService _fileAppService; // Inject FileManagement service
        private readonly IValidationErrorHandler _validationErrorHandler;

        public CreateModalModel(
            IBDocumentAppService bDocumentAppService,
            IProcedureAppService procedureAppService,
            IProcedureComponentAppService componentAppService,
            IFileAppService fileAppService,
            IValidationErrorHandler validationErrorHandler)
        {
            _bDocumentAppService = bDocumentAppService;
            _procedureAppService = procedureAppService;
            _componentAppService = componentAppService;
            _fileAppService = fileAppService;
            _validationErrorHandler = validationErrorHandler;
            LocalizationResourceType = typeof(Aqt.CoreFW.Localization.CoreFWResource);
        }

        public async Task<IActionResult> OnGetAsync(Guid procedureId)
        {
            if (procedureId == Guid.Empty) return BadRequest("ProcedureId is required.");
            BDocumentViewModel.ProcedureId = procedureId;
            try
            {
                var procedureLookup = await _procedureAppService.GetLookupAsync();
                ProcedureName = procedureLookup.Items.FirstOrDefault(p => p.Id == procedureId)?.Name ?? L["Unknown"];
                var allComponents = await _componentAppService.GetListByProcedureAsync(procedureId);
                AttachmentComponents = allComponents; // Bảng hiển thị tất cả

                // Khởi tạo ComponentDataList và tìm Tờ khai
                BDocumentViewModel.ComponentDataList = new List<BDocumentDataViewModel>();
                DeclarationComponentIndex = -1;
                DeclarationComponentData = null;

                for (int i = 0; i < allComponents.Count; i++)
                {
                    var comp = allComponents[i];
                    var dataVm = new BDocumentDataViewModel {
                         ProcedureComponentId = comp.Id,
                         // Thông tin để hiển thị bảng
                         ComponentName = comp.Name, ComponentCode = comp.Code, ComponentType = comp.Type,
                         Description = comp.Description, IsRequired = comp.IsRequired, TempPath = comp.TempPath
                    };

                    if (comp.Type == ComponentType.Form) {
                         DeclarationComponentIndex = i; // Lưu index
                         dataVm.FormDefinition = comp.FormDefinition; // Gán definition cho partial view
                         // Khởi tạo FormData nếu cần giá trị mặc định (chưa có)
                         // dataVm.FormData = "{}";
                         DeclarationComponentData = dataVm; // Model cho partial view
                    }
                    BDocumentViewModel.ComponentDataList.Add(dataVm);
                }
            }
            catch (Exception ex) { Logger.LogError(ex, "Error OnGetAsync CreateModal"); Alerts.Danger(L["ErrorLoadingInitialData"]); }
            return Page();
        }

        public async Task<IActionResult> OnPostAsync()
        {
            // 1. Lấy JSON Tờ khai từ hidden input (do JS cập nhật)
            var declarationJsonFromForm = Request.Form["declarationFormDataJson"].FirstOrDefault();
            if (DeclarationComponentIndex >= 0 && BDocumentViewModel.ComponentDataList.Count > DeclarationComponentIndex)
            {
                 BDocumentViewModel.ComponentDataList[DeclarationComponentIndex].FormData = declarationJsonFromForm;
            }
            else if (!string.IsNullOrWhiteSpace(declarationJsonFromForm))
            {
                 Logger.LogWarning("Received declaration JSON but couldn't find the corresponding component data index.");
            }

            // 2. Validate Server-side
            await ValidateServerSideAsync();

            if (!ModelState.IsValid)
            {
                await ReloadDataForViewAsync(); // Nạp lại definition cho partial view
                return Page();
            }

            // 3. Map sang DTO và gọi AppService
            var createDto = ObjectMapper.Map<BDocumentViewModel, CreateBDocumentInputDto>(BDocumentViewModel);
            try
            {
            await _bDocumentAppService.CreateAsync(createDto);
            return NoContent();
            }
            catch (AbpValidationException validationException)
            {
                 _validationErrorHandler.Handle(validationException);
                 await ReloadDataForViewAsync();
                 return Page();
            }
            catch (Exception ex)
            {
                 Logger.LogError(ex, "Error creating BDocument.");
                 ModelState.AddModelError("", L["ErrorCreatingDocument"]);
                 await ReloadDataForViewAsync();
                 return Page();
            }
        }

        // Handler Upload File (Gọi FileManagement)
        public async Task<JsonResult> OnPostUploadFileAsync(IFormFile file, Guid? parentId = null)
        {
             if (file == null) return new JsonResult(new { error = L["NoFileUploaded"].Value });
             try
             {
                 var createDto = new CreateFileInput
                 {
                     FileContainerName = BDocumentConsts.FileContainerName, // Sử dụng Consts
                     FileName = file.FileName,
                     ParentId = parentId,
                     FileType = FileType.RegularFile,
                     Bytes = await file.GetAllBytesAsync()
                 };
                 var result = await _fileAppService.CreateAsync(createDto);
                 var resultDto = ObjectMapper.Map<EasyAbp.FileManagement.Files.Dtos.FileInfoDto, Aqt.CoreFW.Application.Contracts.Files.FileInfoDto>(result);
                 return new JsonResult(resultDto);
             }
             catch (Exception ex)
             {
                 Logger.LogError(ex, "File upload failed.");
                 return new JsonResult(new { error = L["FileUploadFailed"].Value + (ex is UserFriendlyException ufe ? $": {ufe.Message}" : "") });
             }
        }

        // Handler Download Template
        public async Task<IActionResult> OnGetDownloadTemplateAsync(string templatePath)
        {
            if (string.IsNullOrEmpty(templatePath)) return NotFound();
             try
             {
                 // Logic lấy file template từ Blob Storage/DB dựa vào templatePath
                 // Placeholder - Thay bằng logic thực tế
                 await Task.Delay(50);
                 return NotFound("Template download logic not implemented.");
             }
             catch (Exception ex)
             {
                 Logger.LogError(ex, "Error downloading template: {TemplatePath}", templatePath);
                 return NotFound($"Error downloading template: {templatePath}");
             }
        }

        // Lấy index của Component trong list (Không đổi)
        public int GetComponentDataIndex(Guid componentId)
        {
             if(BDocumentViewModel?.ComponentDataList == null) return -1;
             return BDocumentViewModel.ComponentDataList.FindIndex(d => d.ProcedureComponentId == componentId);
        }

        // --- Helper Methods ---
        private async Task ValidateServerSideAsync()
        {
            List<ProcedureComponentDto> definitions;
            try { definitions = await _componentAppService.GetListByProcedureAsync(BDocumentViewModel.ProcedureId); }
            catch { definitions = new List<ProcedureComponentDto>(); Logger.LogError("Failed to get component definitions for validation"); }

            for(int i = 0; i < BDocumentViewModel.ComponentDataList.Count; i++)
            {
                var dataVm = BDocumentViewModel.ComponentDataList[i];
                var definition = definitions.FirstOrDefault(d => d.Id == dataVm.ProcedureComponentId);
                if (definition == null) continue;

                if (definition.IsRequired)
                {
                    if (definition.Type == ComponentType.Form && string.IsNullOrWhiteSpace(dataVm.FormData))
                         ModelState.AddModelError($"BDocumentViewModel.ComponentDataList[{i}].FormData", L["FieldIsRequired{0}", definition.Name].Value);
                    else if (definition.Type == ComponentType.File && !dataVm.FileId.HasValue)
                         ModelState.AddModelError($"BDocumentViewModel.ComponentDataList[{i}].FileId", L["FileIsRequired{0}", definition.Name].Value);
                }
                // TODO: Validate JSON structure/content if needed
            }
        }

        private async Task ReloadDataForViewAsync()
        {
            try
            {
                var procedureLookup = await _procedureAppService.GetLookupAsync();
                ProcedureName = procedureLookup.Items.FirstOrDefault(p => p.Id == BDocumentViewModel.ProcedureId)?.Name ?? L["Unknown"];
                var allComponents = await _componentAppService.GetListByProcedureAsync(BDocumentViewModel.ProcedureId);
                AttachmentComponents = allComponents;

                // Tìm lại DeclarationComponentData và gán FormDefinition
                DeclarationComponentIndex = -1;
                DeclarationComponentData = null;
                for(int i=0; i< allComponents.Count; i++) {
                    if(allComponents[i].Type == ComponentType.Form) {
                         DeclarationComponentIndex = i;
                         if(BDocumentViewModel.ComponentDataList.Count > i) {
                             BDocumentViewModel.ComponentDataList[i].FormDefinition = allComponents[i].FormDefinition; // Gán lại definition
                             DeclarationComponentData = BDocumentViewModel.ComponentDataList[i]; // Giữ lại dữ liệu đã nhập
                         }
                         break;
                    }
                }
            }
            catch (Exception ex) { Logger.LogError(ex, "Error reloading data for CreateModal after validation failed."); }
        }
    }
    ```

-   **Tệp 7: Modal Sửa:** `EditModal.cshtml` (Không đổi)
    ```cshtml
    @page "/BDocuments/EditModal"
    @using Microsoft.AspNetCore.Mvc.Localization
    @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
    @using Aqt.CoreFW.Localization
    @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form
    @using Aqt.CoreFW.Web.Pages.BDocuments.ViewModels
    @model EditModalModel
    @inject IHtmlLocalizer<CoreFWResource> L
    @{ Layout = null; }

    <abp-dynamic-form abp-model="BDocumentViewModel" asp-page="/BDocuments/EditModal" id="EditBDocumentForm">
         <abp-modal size="Large">
            <abp-modal-header title="@L["EditBDocument"].Value"></abp-modal-header>
            <abp-modal-body>
                <abp-input asp-for="Id" /> @* Hidden ID *@
                <abp-input asp-for="MaHoSo" readonly="true"/>
                <abp-input asp-for="ProcedureName" readonly="true" label="@L["DisplayName:BDocument.ProcedureId"].Value"/>
                <abp-input asp-for="TrangThaiHoSoName" readonly="true" label="@L["DisplayName:BDocument.TrangThaiHoSoId"].Value"/>
                <hr />
                 <h5>@L["ApplicantInformation"]</h5>
                 <abp-input asp-for="TenChuHoSo" />
                 <abp-input asp-for="SoDinhDanhChuHoSo" />
                 <abp-input asp-for="DiaChiChuHoSo" />
                 <abp-input asp-for="EmailChuHoSo" type="email"/>
                 <abp-input asp-for="SoDienThoaiChuHoSo" type="tel"/>
                 <hr/>
                 <h5>@L["AdditionalInformation"]</h5>
                 <abp-input asp-for="PhamViHoatDong"/>
                 <abp-check asp-for="DangKyNhanQuaBuuDien"/>
            </abp-modal-body>
            <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
        </abp-modal>
    </abp-dynamic-form>
    <abp-script src="/Pages/BDocuments/editModal.js" />
    ```

-   **Tệp 8: PageModel Sửa:** `EditModal.cshtml.cs` (Không đổi)
    ```csharp
    using System;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Application.Contracts.BDocuments;
    using Aqt.CoreFW.Application.Contracts.BDocuments.Dtos;
    using Aqt.CoreFW.Web.Pages.BDocuments.ViewModels;
    using Microsoft.AspNetCore.Mvc;
    using Volo.Abp.AspNetCore.Mvc.UI.RazorPages;
    using Volo.Abp.Validation;

    namespace Aqt.CoreFW.Web.Pages.BDocuments;
    public class EditModalModel : AbpPageModel
    {
        [HiddenInput]
        [BindProperty(SupportsGet = true)]
        public Guid Id { get; set; }

        [BindProperty]
        public BDocumentViewModel BDocumentViewModel { get; set; } = new();

        private readonly IBDocumentAppService _bDocumentAppService;
        private readonly IValidationErrorHandler _validationErrorHandler;

        public EditModalModel(/*... inject ...*/) { /*...*/ }

        public async Task OnGetAsync() { /* ... Get DTO, Map to ViewModel ... */ }

        public async Task<IActionResult> OnPostAsync() { /* ... Validate, Map, Call UpdateAsync ... */ return NoContent(); }
    }
    ```

## 4. JavaScript (`index.js`)

-   **Vị trí:** `src/Aqt.CoreFW.Web/wwwroot/pages/bdocuments/index.js`
-   **Nội dung (Cập nhật):** Thêm logic cho dropdown chọn thủ tục và nút "Thêm mới".
    ```javascript
    $(function () {
        let l = abp.localization.getResource('CoreFW');
        let bDocumentService = aqt.coreFW.application.bDocuments.bDocument; // Kiểm tra lại Proxy namespace
        let editModal = new abp.ModalManager({
            viewUrl: abp.appPath + 'BDocuments/EditModal',
            scriptUrl: abp.appPath + 'Pages/BDocuments/editModal.js', // Check path
            modalClass: 'editBDocument'
        });
        // Thêm Create Modal
        let createModal = new abp.ModalManager({
            viewUrl: abp.appPath + 'BDocuments/CreateModal',
            scriptUrl: abp.appPath + 'Pages/BDocuments/createModal.js',
            modalClass: 'createBDocument'
        });
        let dataTable = null;
        let getFilterInputs = function () {
             return {
                 filter: $('#SearchFilter').val(),
                 procedureId: $('#ProcedureFilter').val() || null, // Dropdown lọc bảng
                 statusId: $('#StatusFilter').val() || null
             };
        };

        function initializeDataTable() {
            if (dataTable) { dataTable.destroy(); }
            dataTable = $('#BDocumentTable').DataTable(
                abp.libs.datatables.normalizeConfiguration({
                    serverSide: true, paging: true, order: [[5, "desc"]], searching: false, scrollX: true,
                    ajax: abp.libs.datatables.createAjax(bDocumentService.getList, getFilterInputs),
                    columnDefs: [
                        {
                            title: l('Actions'), rowAction: { items: [
                                    // { text: l('ViewDetails'), action: ... }, // Có thể thêm nút xem chi tiết riêng
                                    { text: l('Edit'), icon: "fas fa-pencil-alt", visible: permissions.canEdit, action: (data) => { editModal.open({ id: data.record.id }); } },
                                    { text: l('Delete'), icon: "fas fa-trash", visible: permissions.canDelete, confirmMessage: (data) => l('AreYouSureToDeleteBDocument', data.record.maHoSo || data.record.id), action: (data) => {
                                        bDocumentService.delete(data.record.id)
                                            .then(() => {
                                                abp.notify.success(l('SuccessfullyDeleted'));
                                                dataTable.ajax.reload();
                                            });
                                      }
                                    }
                                    // { text: l('GenerateFileFromDeclaration'), action: ... } // Nút tạo file tờ khai (nếu cần)
                                ]
                            }, width: "120px"
                        },
                        { title: l('DisplayName:BDocument.MaHoSo'), data: "maHoSo", width: "150px" },
                        { title: l('DisplayName:BDocument.TenChuHoSo'), data: "tenChuHoSo" },
                        { title: l('DisplayName:BDocument.ProcedureId'), data: "procedureName", width: "250px" },
                        { title: l('DisplayName:BDocument.TrangThaiHoSoId'), data: "trangThaiHoSoName", width: "150px", render: (data, type, row) => {
                            let color = row.trangThaiHoSoColorCode || 'secondary';
                            let name = data || l('NotSet');
                            return `<span class="badge bg-${color}">${name}</span>`;
                          }
                        },
                        { title: l('CreationTime'), data: "creationTime", width: "180px", render: (data) => data ? luxon.DateTime.fromISO(data, { locale: abp.localization.currentCulture.name }).toLocaleString(luxon.DateTime.DATETIME_SHORT) : '' }
                    ]
                })
            );
        }

        // --- Event Handlers ---
        $('#SearchButton').click(() => dataTable.ajax.reload());
        $('#SearchFilter').on('keypress', (e) => { if (e.which === 13) dataTable.ajax.reload(); });
        $('#ProcedureFilter, #StatusFilter').change(() => dataTable.ajax.reload()); // Lọc bảng

        // Xử lý khi chọn thủ tục để tạo mới
        $('#ProcedureSelectionForCreate').on('change', function() {
            let selectedProcedureId = $(this).val();
            let canCreate = permissions.canCreate; // Lấy từ ViewData
            $('#NewBDocumentButton').prop('disabled', !selectedProcedureId || !canCreate);
        });

        // Xử lý khi nhấn nút Thêm mới
        $('#NewBDocumentButton').on('click', function() {
            let selectedProcedureId = $('#ProcedureSelectionForCreate').val();
            if (selectedProcedureId) {
                createModal.open({ procedureId: selectedProcedureId }); // Mở modal và truyền procedureId
            }
        });

        // Xử lý kết quả modal
        createModal.onResult(function () {
            dataTable.ajax.reload();
            abp.notify.success(l('SuccessfullyCreated'));
        });
        editModal.onResult(() => {
            dataTable.ajax.reload();
            abp.notify.success(l('SuccessfullySaved'));
        });

        // Export Excel
        $('#ExportExcelButton')?.on('click', function (e) {
             e.preventDefault();
             let filterInput = getFilterInputs();
             let sortInfo = dataTable ? dataTable.order()[0] : null;
             let sorting = 'creationTime desc'; // Default sort
             if (sortInfo) {
                 let columnIndex = sortInfo[0];
                 let sortDirection = sortInfo[1];
                 let sortableMap = { 1: 'maHoSo', 2: 'tenChuHoSo', 5: 'creationTime' }; // Map column index to sort field
                 let columnName = sortableMap[columnIndex];
                 if(columnName) sorting = `${columnName} ${sortDirection}`;
             }
             let params = new URLSearchParams();
             if (filterInput.filter) params.append('Filter', filterInput.filter);
             if (filterInput.procedureId) params.append('ProcedureId', filterInput.procedureId);
             if (filterInput.statusId) params.append('StatusId', filterInput.statusId);
             if (sorting) params.append('Sorting', sorting);
             // Endpoint cần được tạo ở backend Application layer và HttpApi layer
             let exportUrl = abp.appPath + 'api/app/b-document/as-excel?' + params.toString();
             location.href = exportUrl;
        });

        // --- Initialization ---
        initializeDataTable();
        $('#ProcedureSelectionForCreate').trigger('change'); // Kích hoạt kiểm tra ban đầu cho nút New
    });
    ```

## 4.1 JavaScript dành riêng cho Modal (Lazy Loading)

-   **`createModal.js`:**
    -   **Vị trí:** `src/Aqt.CoreFW.Web/wwwroot/pages/bdocuments/createModal.js`
    -   **Nội dung (Không đổi):** Logic chính là `collectDeclarationFormData` để đọc các control động và tạo JSON.
    ```javascript
    // Sử dụng IIFE
    (function ($) {
        var l = abp.localization.getResource('CoreFW');
        var form = $('#CreateBDocumentForm');
        var declarationContainer = form.find('#DeclarationFormContainer');
        var declarationFormDataInput = form.find('#declarationFormDataJson'); // ID của hidden input JSON
        var attachedDocsTableBody = form.find('#AttachedDocumentsTable tbody');
        var fileAppService = easyAbp.fileManagement.files.file; // Check proxy name

        // --- File Upload Logic ---
        function initializeFileUploads(container) {
             container.find('.file-upload-input').each(function() {
                var $fileInput = $(this);
                var $hiddenInput = $($fileInput.data('target-hidden'));
                var $infoDiv = $($fileInput.data('target-info'));

                $fileInput.off('change').on('change', function(event) {
                    var file = event.target.files[0];
                    if (!file) { /* Clear info */ return; }
                    $infoDiv.html(/* Spinner */);
                    var formData = new FormData();
                    formData.append('file', file);
                    $.ajax({
                        url: abp.appPath + 'api/app/file/upload', // Endpoint cần kiểm tra
                        type: 'POST', data: formData, processData: false, contentType: false,
                        headers: { RequestVerificationToken: abp.security.antiForgery.getToken() },
                        success: function(result) {
                             if (result && result.id) {
                                 $hiddenInput.val(result.id);
                                 $infoDiv.html(/* Success message, download link, delete button */);
                                 initializeRemoveFileButtons($infoDiv); // Gắn sự kiện xóa cho nút mới
                             } else { /* Handle error */ }
                         }, error: function(jqXhr) { /* Handle error */ }
                     });
                 });
             });
         }
        // --- Remove Uploaded File Logic ---
        function initializeRemoveFileButtons(container) {
             container.find('.remove-file').off('click').on('click', function() {
                 var $button = $(this);
                 var $infoDiv = $button.parent();
                 var $hiddenInput = $($button.data('target-hidden'));
                 var $fileInput = $($button.data('target-input'));
                 abp.message.confirm(/* Confirmation */).then((confirmed) => {
                     if(confirmed) {
                         $hiddenInput.val(''); $fileInput.val(''); $infoDiv.html('');
                         // Optional: Call API to delete file from storage
                     }
                 });
             });
        }
        // --- Download Template ---
        function initializeDownloadTemplateLinks(container) {
             container.find('.download-template').off('click').on('click', function(e) {
                 e.preventDefault();
                 var templatePath = $(this).data('path');
                 if (templatePath) {
                      var downloadUrl = abp.appPath + `BDocuments/CreateModal/DownloadTemplate?templatePath=${encodeURIComponent(templatePath)}`;
                      window.open(downloadUrl, '_blank');
                 }
             });
        }

        // --- Dynamic Form Data Collection ---
        function collectDeclarationFormData() {
            var formData = {};
            // Dùng selector tìm các control có data-field-name bên trong container Tờ khai
            declarationContainer.find('[data-field-name]').each(function() {
                var $input = $(this);
                var fieldName = $input.data('field-name');
                if (!fieldName) return;
                var value = $input.is(':checkbox') ? $input.is(':checked') : $input.val();
                formData[fieldName] = value;
            });
            var jsonString = JSON.stringify(formData);
            declarationFormDataInput.val(jsonString); // Cập nhật hidden input
            console.log("Declaration JSON collected:", jsonString);
            return jsonString;
        }

        // --- Initialization on Modal Load ---
        $(function() {
            // Khởi tạo upload/remove/download cho bảng
            initializeFileUploads(attachedDocsTableBody);
            // initializeRemoveFileButtons should be called inside upload success
            initializeDownloadTemplateLinks(attachedDocsTableBody);

            // Bắt sự kiện thay đổi trên form động để cập nhật JSON (optional, có thể chỉ lấy khi submit)
            declarationContainer.on('change input', '[data-field-name]', collectDeclarationFormData);

            // Thu thập JSON lần cuối trước khi submit
            form.on('submit', function(e) {
                collectDeclarationFormData(); // Quan trọng: đảm bảo JSON được cập nhật
            });

             // Khởi tạo các control đặc biệt khác nếu cần (datepicker, select2...)
             // declarationContainer.find('.datepicker').datepicker({...});
        });

    })(jQuery);
    ```
-   **`editModal.js`:**
    -   **Vị trí:** `src/Aqt.CoreFW.Web/wwwroot/pages/bdocuments/editModal.js`
    -   **Nội dung:** (Vẫn giữ đơn giản)
    ```javascript
    // Sử dụng IIFE
    (function ($) { /* ... (Có thể thêm client validation nếu cần) ... */ })(jQuery);
    ```

## 5. Localization (Checklist)

-   Đảm bảo tất cả các key cần thiết đã được định nghĩa, bao gồm:
    -   `Menu:BDocuments`
    -   `BDocuments`
    -   `NewBDocument`
    -   `EditBDocument`
    -   `ApplicantInformation`
    -   `AdditionalInformation`
    -   `DeclarationForm`
    -   `AttachedDocuments`
    -   `DisplayName:*` (Cho tất cả các trường/cột)
    -   `UploadFile`, `Uploading`, `DownloadFile`, `DeleteFile`, `DownloadTemplate`, `WaitingForGeneration`
    -   `AreYouSureToDeleteBDocument`, `AreYouSureToDeleteFile`, `AreYouSure`
    -   `Permission:*`
    -   Thông báo lỗi (`*Required*`, `FileUploadFailed`, `ErrorLoadingInitialData`, `ErrorCreatingDocument`, `ErrorUpdatingDocument`, etc.)
    -   Text dùng chung (`All`, `Search`, `Yes`, `No`, `Select`, `New`, `Edit`, `Delete`, `Actions`, `SuccessfullySaved`, `SuccessfullyDeleted`)
    -   Các key trong `FormDefinition`.
    -   **MỚI:** `SelectProcedure`
    -   **MỚI:** `SuccessfullyCreated`

## 6. Lưu ý

*   **Dependency:** Phụ thuộc vào **Kế hoạch 5.1** (`_DynamicFormRenderer.cshtml`).
*   **Data Flow (Tờ khai):** (Không đổi) Dữ liệu được render bởi Partial View, thu thập bởi JS, gửi lên server dưới dạng JSON.
*   **Validation:** Kết hợp client-side và server-side.
*   **File Management:** Cần cấu hình và tích hợp đúng (Container Name, API endpoints).
*   **UI Framework:** Giả định ABP Razor Pages.
*   **Quyền:** JS và C# cần kiểm tra quyền (`Create`, `Update`, `Delete`, `Export`).
*   **Export Excel:** Cần tạo endpoint API `/api/app/b-document/as-excel` ở backend để xử lý việc xuất dữ liệu.
