# Kế hoạch 5.1: Tạo Partial View Render Form Động (`_DynamicFormRenderer.cshtml`)

**Mục đích:** Tạo một Partial View Razor (`.cshtml`) trong tầng Web có khả năng nhận vào một chuỗi JSON định nghĩa cấu trúc form (`FormDefinition`) và một chuỗi JSON chứa dữ liệu ban đầu (`FormData`), sau đó tự động sinh ra các thẻ HTML input tương ứng. Component này được thiết kế để tái sử dụng, hiển thị các form động dựa trên cấu hình JSON, điển hình là phần "Tờ khai" trong module Quản lý Hồ sơ (BDocument).

## 1. Yêu cầu chức năng

-   **Nhận đầu vào:** Partial View cần nhận được Model là một ViewModel dùng chung (ví dụ: `DynamicFormViewModel`) chứa hai thuộc tính chuỗi chính:
    -   `FormDefinition`: Chuỗi JSON mô tả các trường của form (tên, nhãn, kiểu dữ liệu, bắt buộc, lựa chọn, v.v.). Cấu trúc JSON dự kiến có một mảng `fields`.
    -   `FormData`: Chuỗi JSON chứa dữ liệu ban đầu cho form (dạng key-value, với key là tên trường). Có thể là null hoặc chuỗi JSON rỗng nếu là form mới.
    -   *(Tùy chọn)*: Có thể thêm `InstanceId` để tạo ID HTML duy nhất, `FormName` để hiển thị tiêu đề.
-   **Phân tích JSON:** Sử dụng C# và `System.Text.Json.Nodes` để parse chuỗi `FormDefinition` và `FormData`. Cần xử lý các trường hợp JSON không hợp lệ một cách an toàn.
-   **Sinh HTML động:**
    -   Lặp qua mảng `fields` trong `FormDefinition`.
    -   Với mỗi field, dựa vào thuộc tính `type` (ví dụ: "text", "textarea", "select", "date", "checkbox", "number", "email", "tel", "url"), sinh ra thẻ HTML tương ứng (`<input>`, `<select>`, `<textarea>`). **Không** sử dụng Tag Helper như `<abp-input>` vì chúng bind vào thuộc tính cố định của ViewModel.
    -   Thiết lập các attribute HTML cần thiết:
        -   `name`: Theo quy ước `DynamicFormData[{fieldName}]` (hoặc một tiền tố khác nếu cần) để JavaScript dễ dàng thu thập và server có thể bind vào Dictionary hoặc ViewModel tương ứng.
        -   `id`: Duy nhất cho mỗi control để liên kết với `<label>` (ví dụ: `{instanceId}_{fieldName}`).
        -   `class`: Sử dụng các class của Bootstrap 5 (`form-control`, `form-select`, `form-check-input`, `form-control-sm`, etc.).
        -   `required`: Nếu field có `required: true` trong JSON.
        -   `placeholder`: Lấy từ thuộc tính `placeholder` trong JSON (và nên được localize).
        -   `value` / `checked`: Thiết lập dựa trên dữ liệu parse từ `FormData`.
        -   `data-field-name`: Gán tên gốc của trường (`field.name`) để JavaScript tham chiếu.
        -   `readonly`, `disabled`: Nếu field có `readonly: true` trong JSON.
    -   Hỗ trợ các loại control đặc biệt:
        -   `select`: Sinh các thẻ `<option>` dựa trên mảng `options` trong JSON (mỗi option có `value` và `text`).
        -   `checkbox`: Sinh `<input type="checkbox">` và xử lý trạng thái `checked`. Cần có hidden input đi kèm để gửi giá trị `false` nếu không được check.
        -   `radio`: Sinh các `<input type="radio">` với cùng `name` nhưng `value` khác nhau.
-   **Tạo Label:** Sinh thẻ `<label>` cho mỗi trường, lấy nội dung từ thuộc tính `label` trong `FormDefinition`. Hiển thị dấu `*` (ví dụ: `<span class='text-danger ms-1'>*</span>`) nếu `required: true`.
-   **Hỗ trợ Localization:** Nội dung của `label`, `placeholder`, và `text` của `<option>` nên được coi là *key localization*. Partial View phải sử dụng `IHtmlLocalizer<CoreFWResource>` (hoặc resource tương ứng) để dịch các key này trước khi hiển thị.
-   **Xử lý lỗi:** Nếu `FormDefinition` không hợp lệ hoặc không thể parse, hiển thị một thông báo lỗi rõ ràng (ví dụ: dùng `abp-alert`). Tương tự nếu `FormData` không parse được (nhưng thường chỉ log lỗi).
-   **Layout:** Sắp xếp các trường một cách hợp lý, ví dụ sử dụng `<abp-row>` và `<abp-column size-md="_6">` (hoặc giá trị từ `columnSpan` trong JSON) để tạo layout cột.
-   **Mô tả (Description):** Hiển thị nội dung `description` của field (nếu có trong JSON) dưới dạng text hỗ trợ (`form-text`).

## 2. Đầu vào (Model)

Partial View sẽ nhận Model là `Aqt.CoreFW.Web.Pages.Shared.ViewModels.DynamicFormViewModel` (đã được tạo).

```csharp
// Namespace: Aqt.CoreFW.Web.Pages.Shared.ViewModels
public class DynamicFormViewModel
{
    [Required]
    public string FormDefinition { get; set; } = string.Empty; // JSON định nghĩa form
    public string? FormData { get; set; } // JSON dữ liệu ban đầu (key-value)
    public string? InstanceId { get; set; } // ID duy nhất cho instance form
    public string? FormName { get; set; } // Tên form (tùy chọn)
    // public bool IsReadonly { get; set; } // Cờ chỉ đọc toàn form (tùy chọn)
}
```

## 3. Vị trí file

-   **Đã xác định:** `src/Aqt.CoreFW.Web/Pages/Shared/Components/DynamicFormRenderer/_DynamicFormRenderer.cshtml`

## 4. Mã nguồn Razor (Đã triển khai)

File `_DynamicFormRenderer.cshtml` đã được tạo và cập nhật theo các yêu cầu trên, sử dụng `DynamicFormViewModel` làm model đầu vào. Các đoạn code trong file này đã tuân thủ việc sử dụng tên biến, thuộc tính tiếng Anh và comment tiếng Việt.

**Điểm chính trong mã nguồn đã triển khai:**

*   Sử dụng `@model DynamicFormViewModel`.
*   Parse `Model.FormDefinition` và `Model.FormData` bằng `System.Text.Json.Nodes`.
*   Lặp qua `fields` trong `formDefinitionNode`.
*   Sinh HTML (`input`, `select`, `textarea`, `label`, `div`...) bằng cú pháp Razor, không dùng Tag Helper `<abp-input>`.
*   Đặt thuộc tính `name` là `DynamicFormData[{safeFieldName}]`.
*   Đặt thuộc tính `id` là `{instancePrefix}_{safeFieldName}`.
*   Sử dụng `data-field-name` để lưu tên gốc.
*   Hỗ trợ các loại `type` phổ biến, `required`, `placeholder`, `description`, `readonly`, `options`, `columnSpan`.
*   Sử dụng `IHtmlLocalizer<CoreFWResource>` (qua biến `L`) để localize `label`, `placeholder`, `description`, `option text`.
*   Hiển thị lỗi nếu `FormDefinition` không hợp lệ.
*   Sử dụng `<abp-row>` và `<abp-column>` để tạo layout.

## 5. Hướng dẫn sử dụng

Component này được gọi từ một Razor Page khác (ví dụ: `CreateModal.cshtml`) sử dụng `@await Html.PartialAsync(...)`.

**Yêu cầu phía nơi gọi (Ví dụ: `CreateModal.cshtml.cs`):**

1.  **Lấy `FormDefinition`:** Trong phương thức `OnGetAsync`, lấy chuỗi JSON `FormDefinition` từ nguồn dữ liệu (ví dụ: `ProcedureComponentDto`).
2.  **Lấy `FormData` (Nếu có):** Lấy chuỗi JSON `FormData` đã lưu (ví dụ: từ `BDocumentDataDto`).
3.  **Chuẩn bị Model:** Tạo một instance của `DynamicFormViewModel` và gán chuỗi `FormDefinition`, `FormData`, `InstanceId`, `FormName` vào các thuộc tính tương ứng.
4.  **Truyền Model cho View:** Truyền instance `DynamicFormViewModel` này tới View (`.cshtml`).

**Trong file Razor nơi gọi (Ví dụ: `CreateModal.cshtml`):**

1.  **Xác định vị trí:** Chọn `div` hoặc container nơi form động sẽ được hiển thị.
2.  **Gọi Partial View:** Sử dụng `@await Html.PartialAsync(\"~/Pages/Shared/Components/DynamicFormRenderer/_DynamicFormRenderer.cshtml\", yourDynamicFormViewModelInstance)` để render component, truyền vào instance `DynamicFormViewModel` đã chuẩn bị.

    ```cshtml
    @* Ví dụ trong CreateModal.cshtml *@
    @if (Model.DeclarationComponentData != null) // DeclarationComponentData là BDocumentDataViewModel trong PageModel
    {
        <h5>@L[\"DeclarationForm\"]: @Model.DeclarationComponentData.ComponentName</h5>
        @* Tạo ViewModel cho Partial View *@
        var dynamicFormModel = new DynamicFormViewModel
        {
            FormDefinition = Model.DeclarationComponentData.FormDefinition ?? \"{}\", // Truyền Definition
            FormData = Model.DeclarationComponentData.FormData, // Truyền Data ban đầu
            InstanceId = $\"decl_{Model.DeclarationComponentData.ProcedureComponentId}\", // Tạo Instance ID
            FormName = Model.DeclarationComponentData.ComponentName // Truyền tên form
        };
        <div id=\"DeclarationFormContainer_@dynamicFormModel.InstanceId\" data-component-id=\"@Model.DeclarationComponentData.ProcedureComponentId\" class=\"border p-3 mb-3\">
            @* Gọi Partial View *@
            @await Html.PartialAsync(\"~/Pages/Shared/Components/DynamicFormRenderer/_DynamicFormRenderer.cshtml\", dynamicFormModel)
        </div>
        <hr />
        @* Input ẩn để JS thu thập dữ liệu từ form động *@
        <input type=\"hidden\" name=\"BDocumentViewModel.ComponentDataList[@Model.DeclarationComponentIndex].InputData\" id=\"hiddenFormData_@dynamicFormModel.InstanceId\" /> @* Đã đổi tên thuộc tính thành InputData *@
        @* Các hidden input khác nếu cần *@
    }
    ```

3.  **JavaScript Thu thập dữ liệu:** Cần có mã JavaScript (ví dụ trong `createModal.js`) để:
    -   Tìm tất cả các input/select/textarea bên trong container (`#DeclarationFormContainer_...`) có attribute `data-field-name`.
    -   Đọc giá trị của chúng.
    -   Tạo một đối tượng JavaScript key-value.
    -   Chuyển đối tượng thành chuỗi JSON bằng `JSON.stringify()`.
    -   Gán chuỗi JSON này vào một input ẩn (ví dụ: `#hiddenFormData_...`) có `name` tương ứng với thuộc tính `InputData` trong list ViewModel cha. Hàm này nên được gọi trước khi form submit.

    ```javascript
    // Ví dụ trong createModal.js (đã có hàm collectDynamicFormData)
    function collectDynamicFormData() {
        var dynamicFormData = {}; // Đổi tên biến để rõ ràng hơn
        var containerId = '#' + declarationContainer.attr('id'); // Lấy ID container động
        $(containerId + ' [data-field-name]').each(function() {
            var $input = $(this);
            var fieldName = $input.data('field-name');
            if (!fieldName) return;
            var value;
            var inputType = $input.attr('type');
            var tagName = $input.prop('tagName').toLowerCase();

            if (tagName === 'textarea' || tagName === 'select') {
                value = $input.val();
            } else if (inputType === 'checkbox') {
                value = $input.is(':checked');
            } else if (inputType === 'radio') {
                if ($input.is(':checked')) {
                    dynamicFormData[fieldName] = $input.val(); // Gán trực tiếp cho radio
                }
                return; // Bỏ qua gán chung cho radio
            } else { 
                value = $input.val();
            }

            if (inputType !== 'radio') {
                 dynamicFormData[fieldName] = value;
            }
        });
        var jsonString = JSON.stringify(dynamicFormData);
        declarationFormDataInput.val(jsonString); // Gán vào input ẩn
        return jsonString;
    }

    // Gọi hàm này trong sự kiện submit của form cha
    form.on('submit', function(e) { // form là var form = $('#CreateBDocumentForm');
        if (declarationContainer.length > 0 && declarationFormDataInput.length > 0) {
            collectDynamicFormData();
        }
    });
    ```

## 6. Kiểm thử

-   Chuẩn bị các chuỗi JSON `FormDefinition` mẫu:
    -   Bao gồm tất cả các `type` được hỗ trợ.
    -   Có trường `required`, `placeholder`, `description`, `options`, `readonly`, `columnSpan`.
    -   Trường hợp JSON không hợp lệ.
    -   Trường hợp mảng `fields` rỗng hoặc thiếu.
-   Chuẩn bị `FormData` mẫu tương ứng.
-   Tạo một trang Razor đơn giản hoặc sử dụng `CreateModal` để gọi Partial View với các dữ liệu mẫu này.
-   **Kiểm tra:**
    -   Kết quả render HTML có đúng thẻ, class, attribute (`name`, `id`, `required`, `value`, `checked`, `placeholder`, `data-field-name`, `readonly`, `disabled`) không.
    -   Dữ liệu ban đầu từ `FormData` có được điền đúng không.
    -   Localization có hoạt động cho `label`, `placeholder`, `option text` không.
    -   Xử lý lỗi khi JSON `FormDefinition` không hợp lệ.
    -   Layout (chia cột theo `columnSpan`) có hoạt động không.
    -   Kiểm tra JavaScript thu thập dữ liệu (`collectDynamicFormData`) có lấy đúng giá trị và gán vào input ẩn không.
