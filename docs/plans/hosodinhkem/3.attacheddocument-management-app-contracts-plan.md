# Kế hoạch chi tiết: Tầng Application.Contracts (`Aqt.CoreFW.Application.Contracts`) - Quản lý Attached Document (AttachedDocument Management)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Application.Contracts` cho module Quản lý Attached Document.

## 1. DTOs

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Application.Contracts/AttachedDocuments/Dtos` (Tạo thư mục `AttachedDocuments/Dtos` nếu chưa có)
-   **Tệp 1:** Tạo file `AttachedDocumentDto.cs`
    ```csharp
    using System;
    using Aqt.CoreFW.AttachedDocuments; // Sử dụng Enum/Consts từ Domain.Shared namespace
    using Volo.Abp.Application.Dtos;

    namespace Aqt.CoreFW.Application.Contracts.AttachedDocuments.Dtos;

    public class AttachedDocumentDto : FullAuditedEntityDto<Guid> // Kế thừa FullAuditedEntityDto
    {
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public AttachedDocumentStatus Status { get; set; }
        public int Order { get; set; }
        public string? Description { get; set; }
        public Guid ProcedureId { get; set; } // ID của thủ tục hành chính

        // Thông tin bổ sung về thủ tục hành chính (optional, được fill bởi AppService)
        public string? ProcedureName { get; set; } // Tên của Procedure
        public string? ProcedureCode { get; set; } // Mã của Procedure
    }
    ```
-   **Tệp 2:** Tạo file `CreateUpdateAttachedDocumentDto.cs`
    ```csharp
    using System;
    using System.ComponentModel.DataAnnotations;
    using Aqt.CoreFW.AttachedDocuments; // Sử dụng Enum/Consts từ Domain.Shared namespace

    namespace Aqt.CoreFW.Application.Contracts.AttachedDocuments.Dtos;

    public class CreateUpdateAttachedDocumentDto
    {
        [Required]
        [StringLength(AttachedDocumentConsts.MaxCodeLength)]
        public string Code { get; set; } = string.Empty; // Bắt buộc khi tạo

        [Required]
        [StringLength(AttachedDocumentConsts.MaxNameLength)]
        public string Name { get; set; } = string.Empty;

        [Required]
        public AttachedDocumentStatus Status { get; set; } = AttachedDocumentStatus.Active;

        [Required]
        public int Order { get; set; }

        [StringLength(AttachedDocumentConsts.MaxDescriptionLength)]
        public string? Description { get; set; }

        [Required] // ProcedureId là bắt buộc
        public Guid ProcedureId { get; set; }
    }
    ```
-   **Tệp 3:** Tạo file `GetAttachedDocumentsInput.cs`
    ```csharp
    using System;
    using Aqt.CoreFW.AttachedDocuments; // Sử dụng Enum/Consts từ Domain.Shared namespace
    using Volo.Abp.Application.Dtos;

    namespace Aqt.CoreFW.Application.Contracts.AttachedDocuments.Dtos;

    public class GetAttachedDocumentsInput : PagedAndSortedResultRequestDto // Kế thừa để hỗ trợ phân trang và sắp xếp
    {
        public string? Filter { get; set; } // Filter theo Code hoặc Name
        public AttachedDocumentStatus? Status { get; set; } // Filter theo Status
        public Guid? ProcedureId { get; set; } // Filter theo Procedure ID chính xác
    }
    ```
-   **Tệp 4:** Tạo file `AttachedDocumentExcelDto.cs` (Dùng cho xuất Excel - Optional)
    ```csharp
    using System;
    using MiniExcelLibs.Attributes; // Giả định sử dụng MiniExcel

    namespace Aqt.CoreFW.Application.Contracts.AttachedDocuments.Dtos;

    /// <summary>
    /// DTO được thiết kế riêng cho việc xuất dữ liệu AttachedDocument ra Excel.
    /// </summary>
    public class AttachedDocumentExcelDto
    {
        [ExcelColumnName("Mã Hồ sơ")]
        public string Code { get; set; } = string.Empty;

        [ExcelColumnName("Tên Hồ sơ")]
        public string Name { get; set; } = string.Empty;

        [ExcelColumnName("Mã Thủ tục")] // Thêm thông tin Procedure
        public string? ProcedureCode { get; set; }

        [ExcelColumnName("Tên Thủ tục")] // Thêm thông tin Procedure
        public string? ProcedureName { get; set; }

        [ExcelColumnName("Thứ tự")]
        public int Order { get; set; }

        [ExcelColumnName("Trạng thái")]
        public string StatusText { get; set; } = string.Empty; // Lấy từ localization

        [ExcelColumnName("Mô tả")]
        public string? Description { get; set; }

        // Có thể thêm các trường audit nếu cần
        // [ExcelColumnName("Ngày tạo")]
        // [ExcelFormat("yyyy-MM-dd HH:mm:ss")]
        // public DateTime CreationTime { get; set; }
    }
    ```
-   **Tệp 5:** Tạo file `AttachedDocumentLookupDto.cs` (Dùng cho lookup, đặt trong thư mục dùng chung)
    -   **Vị trí:** `src/Aqt.CoreFW.Application.Contracts/Shared/Lookups/AttachedDocumentLookupDto.cs` (Tạo thư mục `Shared/Lookups` nếu chưa có)
    -   **Nội dung:**
        ```csharp
        using System;
        using Volo.Abp.Application.Dtos;

        namespace Aqt.CoreFW.Application.Contracts.Shared.Lookups; // Namespace dùng chung

        // Dùng cho việc lookup AttachedDocument dạng danh sách phẳng (flat list) theo Procedure
        public class AttachedDocumentLookupDto : EntityDto<Guid>
        {
            public string Name { get; set; } = string.Empty;
            public string Code { get; set; } = string.Empty; // Thêm Code để dễ nhận biết
        }
        ```
-   **Tệp 6:** Sử dụng `ProcedureLookupDto` (Giả định đã định nghĩa trong kế hoạch Procedure)
    -   **Vị trí:** `src/Aqt.CoreFW.Application.Contracts/Shared/Lookups/ProcedureLookupDto.cs` (Cần xác minh)
    -   **Mục đích:** Dùng để hiển thị danh sách Procedure cho người dùng chọn khi tạo/sửa AttachedDocument.

## 2. AppService Interface (`IAttachedDocumentAppService.cs`)

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Application.Contracts/AttachedDocuments`
-   **Tệp:** Tạo file `IAttachedDocumentAppService.cs`
    ```csharp
    using System;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Application.Contracts.AttachedDocuments.Dtos; // Namespace chứa DTOs
    using Aqt.CoreFW.Application.Contracts.Shared.Lookups; // Namespace chứa ProcedureLookupDto và AttachedDocumentLookupDto
    using Volo.Abp.Application.Dtos;
    using Volo.Abp.Application.Services;
    using Volo.Abp.Content; // Required for IRemoteStreamContent

    namespace Aqt.CoreFW.Application.Contracts.AttachedDocuments;

    public interface IAttachedDocumentAppService :
        ICrudAppService< // Kế thừa ICrudAppService cho CRUD cơ bản
            AttachedDocumentDto,               // DTO hiển thị
            Guid,                              // Kiểu khóa chính
            GetAttachedDocumentsInput,         // DTO lọc/phân trang
            CreateUpdateAttachedDocumentDto>   // DTO tạo/cập nhật
    {
        /// <summary>
        /// Lấy danh sách AttachedDocument dạng phẳng (flat list) cho lookup theo ProcedureId.
        /// Chỉ trả về các AttachedDocument đang hoạt động.
        /// </summary>
        /// <param name="procedureId">ID của Procedure cần lấy AttachedDocument.</param>
        Task<ListResultDto<AttachedDocumentLookupDto>> GetLookupByProcedureAsync(Guid procedureId);

        /// <summary>
        /// Lấy danh sách Procedure dạng lookup (Giả định có trong IProcedureAppService).
        /// Cần đảm bảo interface này có thể truy cập được.
        /// </summary>
        // Task<ListResultDto<ProcedureLookupDto>> GetProcedureLookupAsync(); // Gọi qua IProcedureAppService

        /// <summary>
        /// (Optional) Xuất danh sách AttachedDocument (dạng phẳng) ra file Excel dựa trên bộ lọc.
        /// </summary>
        Task<IRemoteStreamContent> GetListAsExcelAsync(GetAttachedDocumentsInput input);
    }
    ```

## 3. Permissions

-   **Vị trí 1:** Cập nhật file `src/Aqt.CoreFW.Application.Contracts/Permissions/CoreFWPermissions.cs`
-   **Nội dung cần thêm:**
    ```csharp
    public static class CoreFWPermissions
    {
        public const string GroupName = "CoreFW";

        // ... các permission khác ...

        // Thêm định nghĩa permission cho AttachedDocuments
        public static class AttachedDocuments // Sử dụng tên class khớp với module
        {
            // Sử dụng convention đặt tên quyền: CoreFW.AttachedDocuments
            public const string Default = GroupName + ".AttachedDocuments"; // Quyền xem mặc định
            public const string Create = Default + ".Create";
            public const string Update = Default + ".Update";
            public const string Delete = Default + ".Delete";
            public const string Export = Default + ".Export";
        }
        // ... các module khác ...
    }
    ```
-   **Vị trí 2:** Cập nhật file `src/Aqt.CoreFW.Application.Contracts/Permissions/CoreFWPermissionDefinitionProvider.cs`
-   **Nội dung cần thêm vào phương thức `Define`:**
    ```csharp
    // ... Lấy context.GetGroup(CoreFWPermissions.GroupName);

    // Thêm định nghĩa permissions cho AttachedDocuments
    var attachedDocumentPermission = coreFwGroup.AddPermission(CoreFWPermissions.AttachedDocuments.Default, L("Permission:AttachedDocumentManagement")); // Sử dụng key localization từ plan 1
    attachedDocumentPermission.AddChild(CoreFWPermissions.AttachedDocuments.Create, L("Permission:AttachedDocuments.Create"));
    attachedDocumentPermission.AddChild(CoreFWPermissions.AttachedDocuments.Update, L("Permission:AttachedDocuments.Update"));
    attachedDocumentPermission.AddChild(CoreFWPermissions.AttachedDocuments.Delete, L("Permission:AttachedDocuments.Delete"));
    attachedDocumentPermission.AddChild(CoreFWPermissions.AttachedDocuments.Export, L("Permission:AttachedDocuments.Export"));
    // ... các AddPermission khác ...
    ```

## 4. Lưu ý

*   **Namespaces:** Đảm bảo sử dụng đúng namespaces cho các DTOs, Interfaces và Permissions.
*   **DataAnnotations:** Sử dụng DataAnnotations (`[Required]`, `[StringLength]`) trên `CreateUpdateAttachedDocumentDto` để validation cơ bản.
*   **Lookup DTOs:** `AttachedDocumentLookupDto` chỉ chứa các trường cần thiết cho việc hiển thị trong dropdown khi đã chọn Procedure. `ProcedureLookupDto` được giả định tồn tại và tái sử dụng từ module Procedure.
*   **Permissions:** Đảm bảo các keys localization (`L["Permission:..."]`) đã được định nghĩa trong tầng `Domain.Shared` (kế hoạch bước 1).
*   **Excel Export:** Việc triển khai `GetListAsExcelAsync` là tùy chọn và cần thư viện hỗ trợ (ví dụ: MiniExcel). Nếu không cần, có thể bỏ qua DTO `AttachedDocumentExcelDto` và phương thức tương ứng trong interface.
*   **Procedure Lookup:** Interface `IAttachedDocumentAppService` không định nghĩa lại `GetProcedureLookupAsync` vì logic này thuộc về `IProcedureAppService` (giả định) và nên được gọi từ đó để tránh trùng lặp và đảm bảo tính nhất quán. 