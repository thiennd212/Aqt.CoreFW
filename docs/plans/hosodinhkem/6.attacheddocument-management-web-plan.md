# Kế hoạch chi tiết: Tầng Web (`Aqt.CoreFW.Web`) - Quản lý Attached Document (AttachedDocument Management)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Web` cho module Quản lý Attached Document.

## 1. Cấu hình AutoMapper (Web Layer)

-   **Mục đích:** Định nghĩa cách chuyển đổi giữa ViewModel (`AttachedDocumentViewModel`) và DTO (`CreateUpdateAttachedDocumentDto`, `AttachedDocumentDto`).
-   **Vị trí:** Cập nhật file `src/Aqt.CoreFW.Web/CoreFWWebAutoMapperProfile.cs`
-   **Nội dung cần thêm:**
    ```csharp
    using Aqt.CoreFW.Application.Contracts.AttachedDocuments.Dtos; // AttachedDocument DTOs
    using Aqt.CoreFW.Web.Pages.AttachedDocuments.ViewModels;     // AttachedDocument ViewModel
    // ... other necessary usings ...

    public class CoreFWWebAutoMapperProfile : Profile
    {
        public CoreFWWebAutoMapperProfile()
        {
            // ... existing mappings ...

            // Thêm mapping cho AttachedDocument ViewModel <-> DTO
            CreateMap<AttachedDocumentViewModel, CreateUpdateAttachedDocumentDto>();
            CreateMap<AttachedDocumentDto, AttachedDocumentViewModel>();
        }
    }
    ```

## 2. Menu

-   **Vị trí 1:** Cập nhật file `src/Aqt.CoreFW.Web/Menus/CoreFWMenus.cs`
-   **Nội dung cần thêm:**
    ```csharp
    public class CoreFWMenus
    {
        private const string Prefix = "CoreFW";
        public const string Home = Prefix + ".Home";
        // ... existing menu items (Provinces, Ranks, DataGroups, DataCores, Procedures...) ...
        public const string AttachedDocuments = Prefix + ".AttachedDocuments"; // Menu item for AttachedDocuments
    }
    ```
-   **Vị trí 2:** Cập nhật file `src/Aqt.CoreFW.Web/Menus/CoreFWMenuContributor.cs`
-   **Nội dung cần thêm trong phương thức `ConfigureMainMenuAsync` (Giả sử menu này thuộc về "CatalogManagement" hoặc một nhóm tương tự):**
    ```csharp
    // ... inside CoreFWMenuContributor class, inside ConfigureMainMenuAsync ...
    // ... Get or Add Parent Menu (e.g., CatalogManagement or ProcedureManagement) ...

        // Thêm menu AttachedDocuments vào menu cha thích hợp
        if (await context.IsGrantedAsync(CoreFWPermissions.AttachedDocuments.Default)) // Check AttachedDocument permission
        {
            parentMenu.AddItem(new ApplicationMenuItem( // Sử dụng parentMenu đã lấy
                CoreFWMenus.AttachedDocuments, // Menu constant
                l["Menu:AttachedDocuments"],    // Localization key: "Hồ sơ đính kèm"
                "/AttachedDocuments",         // Đường dẫn tới trang Index
                icon: "fa fa-paperclip", // Chọn icon phù hợp
                order: 4 // Điều chỉnh thứ tự trong menu cha
            ));
        }

    // ... other menu items ...
    ```
    **Lưu ý:** Cần xác định `parentMenu` thích hợp để thêm mục AttachedDocuments vào (ví dụ: bên trong menu Quản lý Thủ tục hoặc Quản lý Danh mục).

## 3. Razor Pages và ViewModels

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Web/Pages/AttachedDocuments`

-   **Tệp 1: ViewModel:** Tạo file `AttachedDocumentViewModel.cs` (trong thư mục **`Pages/AttachedDocuments/ViewModels`**)
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.ComponentModel.DataAnnotations;
    using Aqt.CoreFW.AttachedDocuments; // Consts/Enum for AttachedDocument
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.AspNetCore.Mvc.Rendering;
    using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form;

    namespace Aqt.CoreFW.Web.Pages.AttachedDocuments.ViewModels;

    public class AttachedDocumentViewModel
    {
        [HiddenInput]
        public Guid? Id { get; set; }

        [Required]
        [StringLength(AttachedDocumentConsts.MaxCodeLength)]
        [Display(Name = "DisplayName:AttachedDocument.Code")]
        public string Code { get; set; } = string.Empty;

        [Required]
        [StringLength(AttachedDocumentConsts.MaxNameLength)]
        [Display(Name = "DisplayName:AttachedDocument.Name")]
        public string Name { get; set; } = string.Empty;

        [Required]
        [Display(Name = "DisplayName:AttachedDocument.Order")]
        public int Order { get; set; }

        [Required]
        [Display(Name = "DisplayName:AttachedDocument.Status")]
        public AttachedDocumentStatus Status { get; set; } = AttachedDocumentStatus.Active;

        [StringLength(AttachedDocumentConsts.MaxDescriptionLength)]
        [Display(Name = "DisplayName:AttachedDocument.Description")]
        [DataType(DataType.MultilineText)]
        public string? Description { get; set; }

        [Required(ErrorMessage = "Validation:ProcedureIdRequired")] // Cần key localization nếu chưa có
        [Display(Name = "DisplayName:AttachedDocument.ProcedureId")]
        [SelectItems(nameof(ProcedureLookupList))] // Thuộc tính chứa danh sách SelectListItem
        public Guid ProcedureId { get; set; }

        // For Procedure dropdown population
        public List<SelectListItem>? ProcedureLookupList { get; set; }
    }
    ```

-   **Tệp 2: Trang danh sách:** Tạo file `Index.cshtml`
    ```cshtml
        @page
        @using Aqt.CoreFW.Permissions
        @using Microsoft.AspNetCore.Authorization
        @using Volo.Abp.AspNetCore.Mvc.UI.Layout
        @using Aqt.CoreFW.Web.Pages.AttachedDocuments // Namespace mới
        @using Aqt.CoreFW.Localization
        @using Microsoft.Extensions.Localization
        @using Aqt.CoreFW.Web.Menus
        @using Aqt.CoreFW.AttachedDocuments // Enum mới
        @model IndexModel
        @inject IStringLocalizer<CoreFWResource> L
        @inject IAuthorizationService AuthorizationService
        @inject IPageLayout PageLayout
        @{
            PageLayout.Content.Title = L["AttachedDocuments"].Value; // Title trang mới
            PageLayout.Content.MenuItemName = CoreFWMenus.AttachedDocuments; // Active menu item mới
        }

        @section scripts {
            <script>
                // Pass permissions to JS
                const permissions = {
                    canEdit:   @Html.Raw(ViewData["CanEdit"]),
                    canDelete: @Html.Raw(ViewData["CanDelete"])
                };
            </script>
            <abp-script src="/Pages/AttachedDocuments/index.js" /> @* Script mới *@
        }

        @section content_toolbar {
            @if (await AuthorizationService.IsGrantedAsync(CoreFWPermissions.AttachedDocuments.Create))
            {
                <abp-button id="NewAttachedDocumentButton" @* ID nút mới *@
                            text="@L["NewAttachedDocument"].Value" @* Key localization mới *@
                            icon="plus"
                            button-type="Primary" size="Small"/>
            }
            @if (await AuthorizationService.IsGrantedAsync(CoreFWPermissions.AttachedDocuments.Export))
            {
                <abp-button id="ExportExcelButton"
                            text="@L["ExportToExcel"].Value"
                            icon="file-excel"
                            button-type="Success" size="Small" class="ms-2"/>
            }
        }

        <abp-card>
            <abp-card-body>
                <abp-row class="mb-3">
                    <abp-column size-md="_4">
                        <input type="text" id="SearchFilter" class="form-control form-control-sm" placeholder="@L["Search"] (@L["DisplayName:AttachedDocument.Code"], @L["DisplayName:AttachedDocument.Name"])..." />
                    </abp-column>
                    <abp-column size-md="_3">
                        <select id="StatusFilter" class="form-select form-select-sm">
                            <option value="">@L["All"] (@L["DisplayName:AttachedDocument.Status"])</option>
                            <option value="@((byte)AttachedDocumentStatus.Active)">@L["Enum:AttachedDocumentStatus.1"]</option> @* Enum mới *@
                            <option value="@((byte)AttachedDocumentStatus.Inactive)">@L["Enum:AttachedDocumentStatus.0"]</option> @* Enum mới *@
                        </select>
                    </abp-column>
                    <abp-column size-md="_3">
                        <select id="ProcedureFilter" class="form-select form-select-sm"> @* Filter theo Procedure *@
                            <option value="">@L["All"] (@L["DisplayName:AttachedDocument.ProcedureId"])</option> @* Key localization mới *@
                        </select>
                    </abp-column>
                    <abp-column size-md="_2" class="text-end">
                        <abp-button id="SearchButton"
                                    text="@L["Search"].Value"
                                    icon="search"
                                    button-type="Info" size="Small"/>
                    </abp-column>
                </abp-row>

                @* Data Table *@
                <abp-table striped-rows="true" id="AttachedDocumentsTable"></abp-table> @* ID bảng mới *@
            </abp-card-body>
        </abp-card>
    ```

-   **Tệp 3: PageModel danh sách:** Tạo file `Index.cshtml.cs`
    ```csharp
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Application.Contracts.Procedures; // Using cho IProcedureAppService (Giả định)
    using Aqt.CoreFW.Application.Contracts.Shared.Lookups;
    using Aqt.CoreFW.Permissions; // Using cho Permissions
    using Microsoft.AspNetCore.Authorization;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.AspNetCore.Mvc.Rendering;
    using Volo.Abp.AspNetCore.Mvc.UI.RazorPages;

    namespace Aqt.CoreFW.Web.Pages.AttachedDocuments; // Namespace của PageModel mới

    public class IndexModel : AbpPageModel
    {
        private readonly IAuthorizationService _authorizationService;
        private readonly IProcedureAppService _procedureAppService; // Inject service Procedure để lấy lookup (Giả định)

        public IndexModel(
            IAuthorizationService authorizationService,
            IProcedureAppService procedureAppService) // (Giả định)
        {
            _authorizationService = authorizationService;
            _procedureAppService = procedureAppService;
        }

        public async Task OnGetAsync()
        {
            // Truyền permissions vào JS qua ViewData
            ViewData["CanEdit"] = (await _authorizationService.IsGrantedAsync(CoreFWPermissions.AttachedDocuments.Update)).ToString().ToLowerInvariant();
            ViewData["CanDelete"] = (await _authorizationService.IsGrantedAsync(CoreFWPermissions.AttachedDocuments.Delete)).ToString().ToLowerInvariant();
        }

        // Page Handler để cung cấp Procedure lookup cho filter dropdown trong JS
        public async Task<JsonResult> OnGetProcedureLookupAsync() // Đổi tên Handler
        {
            var lookupResult = await _procedureAppService.GetLookupAsync(); // (Giả định phương thức GetLookupAsync)
            var selectList = lookupResult.Items
                .OrderBy(i => i.Name) // Sắp xếp theo tên
                .Select(i => new SelectListItem($"{i.Name} ({i.Code})", i.Id.ToString())) // Giả định ProcedureLookupDto có Code
                .ToList();
            return new JsonResult(selectList);
        }
    }
    ```

-   **Tệp 4: Modal Thêm mới:** Tạo file `CreateModal.cshtml`
    ```cshtml
        @page "/AttachedDocuments/CreateModal" @* Đường dẫn mới *@
        @using Microsoft.AspNetCore.Mvc.Localization
        @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
        @using Aqt.CoreFW.Localization
        @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form
        @using Aqt.CoreFW.Web.Pages.AttachedDocuments // Namespace mới
        @model CreateModalModel
        @inject IHtmlLocalizer<CoreFWResource> L
    @{
        Layout = null;
    }

    <abp-dynamic-form abp-model="AttachedDocumentViewModel" asp-page="/AttachedDocuments/CreateModal" id="CreateAttachedDocumentForm"> @* Model, Page, ID Form mới *@
        <abp-modal>
            <abp-modal-header title="@L["NewAttachedDocument"].Value"></abp-modal-header> @* Key localization mới *@
            <abp-modal-body>
                <abp-form-content />
            </abp-modal-body>
            <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
        </abp-modal>
    </abp-dynamic-form>
    ```

-   **Tệp 5: PageModel Thêm mới:** Tạo file `CreateModal.cshtml.cs`
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Application.Contracts.AttachedDocuments; // AppService Interface mới
    using Aqt.CoreFW.Application.Contracts.AttachedDocuments.Dtos; // DTOs mới
    using Aqt.CoreFW.Application.Contracts.Procedures; // Procedure AppService (Giả định)
    using Aqt.CoreFW.Web.Pages.AttachedDocuments.ViewModels; // ViewModel mới
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.AspNetCore.Mvc.Rendering;
    using Volo.Abp.AspNetCore.Mvc.UI.RazorPages;
    using Aqt.CoreFW.AttachedDocuments; // Enum Status mới

    namespace Aqt.CoreFW.Web.Pages.AttachedDocuments; // Namespace PageModel mới

    public class CreateModalModel : AbpPageModel
    {
        [BindProperty]
        public AttachedDocumentViewModel AttachedDocumentViewModel { get; set; } = new(); // ViewModel mới

        private readonly IAttachedDocumentAppService _attachedDocumentAppService; // AppService mới
        private readonly IProcedureAppService _procedureAppService; // (Giả định)

        public CreateModalModel(
            IAttachedDocumentAppService attachedDocumentAppService,
            IProcedureAppService procedureAppService) // (Giả định)
        {
            _attachedDocumentAppService = attachedDocumentAppService;
            _procedureAppService = procedureAppService;
        }

        public async Task OnGetAsync()
        {
            AttachedDocumentViewModel = new AttachedDocumentViewModel { Status = AttachedDocumentStatus.Active }; // Set default mới
            await LoadProcedureLookupAsync(); // Load lookup Procedure
        }

        public async Task<IActionResult> OnPostAsync()
        {
            if (!ModelState.IsValid)
            {
                await LoadProcedureLookupAsync(); // Reload lookup nếu validation thất bại
                return Page();
            }
            var dto = ObjectMapper.Map<AttachedDocumentViewModel, CreateUpdateAttachedDocumentDto>(AttachedDocumentViewModel); // Mapping mới
            await _attachedDocumentAppService.CreateAsync(dto); // Gọi service mới
            return NoContent(); // Thành công
        }

        // Load Procedure lookup
        private async Task LoadProcedureLookupAsync()
        {
            var lookup = await _procedureAppService.GetLookupAsync(); // (Giả định)
            AttachedDocumentViewModel.ProcedureLookupList = lookup.Items
                .OrderBy(x => x.Name) // Giả định ProcedureLookupDto có Name
                .Select(x => new SelectListItem($"{x.Name} ({x.Code})", x.Id.ToString())) // Giả định có Name, Code
                .ToList();
        }
    }
    ```

-   **Tệp 6: Modal Sửa:** Tạo file `EditModal.cshtml`
    ```cshtml
    @page "/AttachedDocuments/EditModal" @* Đường dẫn mới *@
    @using Microsoft.AspNetCore.Mvc.Localization
    @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
    @using Aqt.CoreFW.Localization
    @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form
    @using Aqt.CoreFW.Web.Pages.AttachedDocuments // Namespace mới
    @model EditModalModel
    @inject IHtmlLocalizer<CoreFWResource> L
    @{
        Layout = null;
    }

    <abp-dynamic-form abp-model="AttachedDocumentViewModel" asp-page="/AttachedDocuments/EditModal" id="EditAttachedDocumentForm"> @* Model, Page, ID Form mới *@
        <abp-modal>
            <abp-modal-header title="@L["EditAttachedDocument"].Value"></abp-modal-header> @* Key localization mới *@
            <abp-modal-body>
                <abp-input asp-for="Id" /> @* Id vẫn giữ nguyên *@
                <abp-form-content />
            </abp-modal-body>
            <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
        </abp-modal>
    </abp-dynamic-form>
    ```

-   **Tệp 7: PageModel Sửa:** Tạo file `EditModal.cshtml.cs`
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Application.Contracts.AttachedDocuments; // AppService Interface mới
    using Aqt.CoreFW.Application.Contracts.AttachedDocuments.Dtos; // DTOs mới
    using Aqt.CoreFW.Application.Contracts.Procedures; // Procedure AppService (Giả định)
    using Aqt.CoreFW.Web.Pages.AttachedDocuments.ViewModels; // ViewModel mới
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.AspNetCore.Mvc.Rendering;
    using Volo.Abp.AspNetCore.Mvc.UI.RazorPages;

    namespace Aqt.CoreFW.Web.Pages.AttachedDocuments; // Namespace PageModel mới

    public class EditModalModel : AbpPageModel
    {
        [HiddenInput]
        [BindProperty(SupportsGet = true)]
        public Guid Id { get; set; }

        [BindProperty]
        public AttachedDocumentViewModel AttachedDocumentViewModel { get; set; } = new(); // ViewModel mới

        private readonly IAttachedDocumentAppService _attachedDocumentAppService; // AppService mới
        private readonly IProcedureAppService _procedureAppService; // (Giả định)

        public EditModalModel(
            IAttachedDocumentAppService attachedDocumentAppService,
            IProcedureAppService procedureAppService) // (Giả định)
        {
            _attachedDocumentAppService = attachedDocumentAppService;
            _procedureAppService = procedureAppService;
        }

        public async Task OnGetAsync()
        {
            var dto = await _attachedDocumentAppService.GetAsync(Id); // Gọi service mới
            AttachedDocumentViewModel = ObjectMapper.Map<AttachedDocumentDto, AttachedDocumentViewModel>(dto); // Mapping mới
            await LoadProcedureLookupAsync(); // Load lookup Procedure
        }

        public async Task<IActionResult> OnPostAsync()
        {
            if (!ModelState.IsValid)
            {
                await LoadProcedureLookupAsync();
                return Page();
            }
            var dto = ObjectMapper.Map<AttachedDocumentViewModel, CreateUpdateAttachedDocumentDto>(AttachedDocumentViewModel); // Mapping mới
            await _attachedDocumentAppService.UpdateAsync(Id, dto); // Gọi service mới
            return NoContent();
        }

         // Load Procedure lookup
        private async Task LoadProcedureLookupAsync()
        {
            var lookup = await _procedureAppService.GetLookupAsync(); // (Giả định)
            AttachedDocumentViewModel.ProcedureLookupList = lookup.Items
                .OrderBy(x => x.Name) // Giả định có Name
                .Select(x => new SelectListItem($"{x.Name} ({x.Code})", x.Id.ToString())) // Giả định có Name, Code
                .ToList();
        }
    }
    ```

## 4. JavaScript (`index.js`)

-   **Vị trí:** Tạo file `src/Aqt.CoreFW.Web/wwwroot/attacheddocuments/index.js`
-   **Nội dung:**
    ```javascript
    $(function () {
        let l = abp.localization.getResource('CoreFW');

        // Service Proxies - Đảm bảo namespace chính xác
        // !! Kiểm tra lại tên proxy được generate !!
        let attachedDocumentService = aqt.coreFW.application.attachedDocuments.attachedDocument; // Proxy mới
        let procedureService = aqt.coreFW.application.procedures.procedure; // Proxy cho Procedure lookup (Giả định)

        // Modals
        let createModal = new abp.ModalManager(abp.appPath + 'AttachedDocuments/CreateModal'); // Đường dẫn modal mới
        let editModal = new abp.ModalManager(abp.appPath + 'AttachedDocuments/EditModal'); // Đường dẫn modal mới

        // DataTable Instance
        let dataTable = null;

        // Function to load Procedure filter options
        function loadProcedureFilter() { // Đổi tên hàm
            $('#ProcedureFilter option:gt(0)').remove(); // Clear existing except "All"

            procedureService.getLookup() // Gọi service Procedure (Giả định)
                .then(function (result) {
                    if (result && result.items && result.items.length > 0) {
                        result.items.forEach(function (item) {
                             $('#ProcedureFilter').append($('<option>', {
                                value: item.id,
                                text: `${item.name} (${item.code || ''})` // Giả định ProcedureLookupDto có Name, Code
                            }));
                        });
                    }
                })
                .catch(function (error) {
                    console.error("Error loading Procedure filter:", error);
                });
        }


        // Function to get current filter values
        let getFilterInputs = function () {
            return {
                filter: $('#SearchFilter').val(),
                status: $('#StatusFilter').val() === "" ? null : parseInt($('#StatusFilter').val()),
                procedureId: $('#ProcedureFilter').val() === "" ? null : $('#ProcedureFilter').val() // Filter theo procedureId
            };
        };

        // Function to initialize DataTable
        function initializeDataTable() {
            if (dataTable) { dataTable.destroy(); }

            dataTable = $('#AttachedDocumentsTable').DataTable( // ID bảng mới
                abp.libs.datatables.normalizeConfiguration({
                    serverSide: true,
                    paging: true,
                    order: [[4, "asc"], [1, "asc"]], // Sắp xếp theo Order, sau đó Code
                    searching: false, // Dùng filter tùy chỉnh
                    scrollX: true,
                    ajax: abp.libs.datatables.createAjax(attachedDocumentService.getList, getFilterInputs), // Gọi service mới
                    columnDefs: [
                        {
                            title: l('Actions'),
                            rowAction: {
                                items: [
                                    {
                                        text: l('Edit'),
                                        icon: "fas fa-pencil-alt",
                                        visible: permissions.canEdit, // Biến permission từ C#
                                        action: (data) => { editModal.open({ id: data.record.id }); }
                                    },
                                    {
                                        text: l('Delete'),
                                        icon: "fas fa-trash",
                                        visible: permissions.canDelete, // Biến permission từ C#
                                        // Key localization và service mới
                                        confirmMessage: (data) => l('AreYouSureToDeleteAttachedDocument', data.record.name || data.record.code), // Key mới
                                        action: (data) => {
                                            attachedDocumentService.delete(data.record.id) // Service mới
                                                .then(() => {
                                                    abp.notify.success(l('SuccessfullyDeleted'));
                                                    dataTable.ajax.reload();
                                                })
                                                .catch((error) => {
                                                    abp.notify.error(error.message || l('ErrorOccurred'));
                                                });
                                        }
                                    }
                                ]
                            }
                        },
                        // Cập nhật các key localization và data properties
                        { title: l('DisplayName:AttachedDocument.Code'), data: "code" }, // Key mới
                        { title: l('DisplayName:AttachedDocument.Name'), data: "name" }, // Key mới
                        {
                            title: l('DisplayName:AttachedDocument.ProcedureId'), data: "procedureName", orderable: false, // Key mới, data từ ProcedureName
                            render: (data, type, row) => data ? `${data} (${row.procedureCode || ''})` : '' // Hiển thị Name (Code) của Procedure
                        },
                        { title: l('DisplayName:AttachedDocument.Order'), data: "order" }, // Key mới
                        {
                            title: l('DisplayName:AttachedDocument.Status'), data: "status", className: 'text-center', // Key mới
                            // Key localization và enum value mới
                            render: (data) => `<span class="badge ${data === 1 ? 'bg-success' : 'bg-secondary'}">${l('Enum:AttachedDocumentStatus.' + data)}</span>` // Key enum mới
                        },
                        { title: l('DisplayName:AttachedDocument.Description'), data: "description", orderable: false } // Key mới
                    ]
                })
            );
        }

        // --- Initialization ---
        loadProcedureFilter(); // Load filter Procedure
        initializeDataTable();

        // --- Event Handlers ---

        // Search button click or Enter
        $('#SearchButton').click(function () { dataTable.ajax.reload(); });
        $('#SearchFilter').on('keypress', function (e) { if (e.which === 13) dataTable.ajax.reload(); });

        // Filter dropdown changes
        $('#StatusFilter, #ProcedureFilter').change(function () { // Filter Procedure
            dataTable.ajax.reload();
        });

        // New AttachedDocument button click
        $('#NewAttachedDocumentButton').click(function (e) { // ID nút mới
            e.preventDefault();
            createModal.open();
        });

        // Reload table on modal success
        createModal.onResult(function () {
            dataTable.ajax.reload();
            abp.notify.success(l('SuccessfullySaved'));
        });
        editModal.onResult(function () {
            dataTable.ajax.reload();
            abp.notify.success(l('SuccessfullySaved'));
        });

        // Excel Export Button Click (if exists)
        $('#ExportExcelButton')?.on('click', function (e) {
            e.preventDefault();
            let filterInput = getFilterInputs();
            let sortInfo = dataTable ? dataTable.order()[0] : null;
            let sorting = '';

            if (sortInfo) {
                 let columnIndex = sortInfo[0];
                 let sortDirection = sortInfo[1];
                 // Map index cột hiển thị sang tên trường DTO API (CẬP NHẬT MAP!!)
                 let columnMap = { 1: 'code', 2: 'name', 3: 'procedureName', 4: 'order', 5: 'status', 6: 'description' };
                 let columnName = columnMap[columnIndex];
                 if (columnName) {
                     sorting = columnName + ' ' + sortDirection;
                 } else {
                     sorting = 'order asc, name asc'; // Default sort
                 }
            } else {
                sorting = 'order asc, name asc'; // Default sort
            }

            let params = new URLSearchParams();
            if (filterInput.filter) params.append('Filter', filterInput.filter);
            if (filterInput.status !== null) params.append('Status', filterInput.status);
            if (filterInput.procedureId) params.append('ProcedureId', filterInput.procedureId); // Tham số mới
            if (sorting) params.append('Sorting', sorting);

            // !! Cập nhật API endpoint !!
            let exportUrl = abp.appPath + 'api/app/attached-document/as-excel?' + params.toString(); // Endpoint mới
            location.href = exportUrl; // Trigger download
        });
    });
    ```

## 5. Localization (Checklist)

Đảm bảo các key localization sau đã được định nghĩa trong các file `*.json` ở tầng `Domain.Shared`:

-   `Menu:AttachedDocuments`
-   `AttachedDocuments`
-   `NewAttachedDocument`
-   `EditAttachedDocument`
-   `DisplayName:AttachedDocument.Code`
-   `DisplayName:AttachedDocument.Name`
-   `DisplayName:AttachedDocument.Status`
-   `DisplayName:AttachedDocument.Order`
-   `DisplayName:AttachedDocument.Description`
-   `DisplayName:AttachedDocument.ProcedureId`
-   `Enum:AttachedDocumentStatus.0`
-   `Enum:AttachedDocumentStatus.1`
-   `AreYouSureToDeleteAttachedDocument`
-   `Validation:ProcedureIdRequired` (Cần tạo nếu chưa có)
-   `Permission:AttachedDocuments`
-   `Permission:AttachedDocuments.Create`
-   `Permission:AttachedDocuments.Update`
-   `Permission:AttachedDocuments.Delete`
-   `Permission:AttachedDocuments.Export`
-   `UnknownProcedure` (Cần tạo cho trường hợp không tìm thấy Procedure)
-   *(Các key dùng chung như `Actions`, `Search`, `All`, `ErrorOccurred`, `SuccessfullyDeleted`, `SuccessfullySaved`, `SelectProcedure` đã có sẵn hoặc cần kiểm tra)*

## 6. Lưu ý

*   **UI Framework:** Kế hoạch này giả định sử dụng ABP Blazor Server UI với Razor Pages, Tag Helpers và Modal Manager.
*   **ViewModel:** `AttachedDocumentViewModel` được tạo để tách biệt DTO và View.
*   **AutoMapper:** Cập nhật `CoreFWWebAutoMapperProfile` để map giữa `AttachedDocumentViewModel` và DTOs.
*   **JavaScript Proxy:** Tên service proxy JavaScript (`aqt.coreFW.application.attachedDocuments.attachedDocument`) cần được kiểm tra lại sau khi generate proxy. Tên proxy cho `Procedure` (`aqt.coreFW.application.procedures.procedure`) là giả định.
*   **Lookups:** Trang Index và Modals cần gọi `IProcedureAppService` (giả định) để lấy danh sách Procedure. Handler `OnGetProcedureLookupAsync` trong `Index.cshtml.cs` được thêm mới.
*   **Permissions:** JS và C# kiểm tra quyền `CoreFWPermissions.AttachedDocuments`.
*   **Validation:** Sử dụng DataAnnotations trên ViewModel. Cần key `Validation:ProcedureIdRequired`.
*   **API Endpoints:** URL trong JS cần được cập nhật để trỏ đến API của AttachedDocument (ví dụ: `/api/app/attached-document/...`).
*   **Sorting/Filtering:** Logic lọc/sắp xếp trong JS được cập nhật để lọc theo `procedureId` và gọi đến service của AttachedDocument.
*   **Giả định về Procedure:** Kế hoạch này giả định sự tồn tại của `IProcedureAppService`, `ProcedureLookupDto` (với `Name` và `Code`), và JavaScript proxy tương ứng. Cần điều chỉnh nếu khác.
