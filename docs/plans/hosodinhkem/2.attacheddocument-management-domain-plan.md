# Kế hoạch chi tiết: Tầng Domain (`Aqt.CoreFW.Domain`) - Quản lý Attached Document (AttachedDocument Management)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Domain` để hỗ trợ chức năng quản lý Attached Document. Kế hoạch này dựa trên yêu cầu trong `docs/srs/hosodinhkem-srs.md`, kế hoạch tổng thể `0.hosodinhkem-plan-v1.md` và kế hoạch tầng Domain.Shared `1.attacheddocument-management-domain-shared-plan.md`.

## 1. Entity (`AttachedDocument.cs`)

**Nguyên tắc thiết kế Entity (DDD):**

*   **Đóng gói (Encapsulation):** Sử dụng `private set` cho các thuộc tính. `Code` không thay đổi sau khi tạo.
*   **Validation tập trung:** Tạo các phương thức `private` hoặc `internal` chứa logic validation (`Check.*`) sử dụng hằng số từ `AttachedDocumentConsts`.
*   **Trạng thái hợp lệ (Valid State):** Constructor chính (`internal`) nhận tham số bắt buộc, gọi phương thức validation nội bộ để đảm bảo entity hợp lệ khi khởi tạo. Constructor `protected` dùng cho ORM.
*   **Hành vi (Behavior):** Định nghĩa phương thức `public` để thay đổi trạng thái có kiểm soát (ví dụ: `SetName`, `Activate`, `SetProcedure`).
*   **Kế thừa:** Sử dụng `FullAuditedAggregateRoot<Guid>`. Cần cân nhắc lại nếu AttachedDocument chỉ nên là `FullAuditedEntity` và thuộc về Aggregate `Procedure`. Tạm thời giữ `AggregateRoot` để đơn giản hóa repository và UoW.
*   **Quan hệ:** Tham chiếu bắt buộc đến `Procedure` qua `ProcedureId`.

**Cấu trúc `AttachedDocument.cs`:**

-   **Vị trí:** `src/Aqt.CoreFW.Domain/AttachedDocuments/Entities/AttachedDocument.cs` (Tạo thư mục `AttachedDocuments/Entities` nếu chưa có)
-   **Nội dung:**
    ```csharp
    using System;
    using Aqt.CoreFW.AttachedDocuments; // Namespace chứa Consts và Enum từ Domain.Shared
    using Aqt.CoreFW.Domain.Procedures.Entities; // Namespace chứa Entity Procedure (!! Giả định, cần xác minh !!)
    using JetBrains.Annotations;
    using Volo.Abp;
    using Volo.Abp.Domain.Entities.Auditing;

    namespace Aqt.CoreFW.Domain.AttachedDocuments.Entities; // Namespace cụ thể cho Entity

    /// <summary>
    /// Represents an attached document item related to an administrative procedure.
    /// Inherits from FullAuditedAggregateRoot for audit logging and soft delete.
    /// Consider changing to FullAuditedEntity if it's not a true Aggregate Root.
    /// </summary>
    public class AttachedDocument : FullAuditedAggregateRoot<Guid>
    {
        /// <summary>
        /// Unique code for the attached document within a specific Procedure.
        /// Cannot be changed after creation.
        /// </summary>
        [NotNull]
        public virtual string Code { get; private set; }

        /// <summary>
        /// Name of the attached document.
        /// </summary>
        [NotNull]
        public virtual string Name { get; private set; }

        /// <summary>
        /// Status of the attached document (Active/Inactive).
        /// </summary>
        public virtual AttachedDocumentStatus Status { get; private set; }

        /// <summary>
        /// Display or processing order.
        /// </summary>
        public virtual int Order { get; private set; }

        /// <summary>
        /// Optional description.
        /// </summary>
        [CanBeNull]
        public virtual string? Description { get; private set; }

        /// <summary>
        /// Foreign key to the Procedure this document belongs to. Required.
        /// </summary>
        public virtual Guid ProcedureId { get; private set; } // Thay đổi qua Domain Service

        // Navigation property (optional, configure for lazy-loading in EF Core mapping)
        // public virtual Procedure Procedure { get; private set; }

        /// <summary>
        /// Protected constructor for ORM frameworks.
        /// </summary>
        protected AttachedDocument()
        {
            /* For ORM */
            Code = string.Empty; // Khởi tạo giá trị mặc định hợp lệ
            Name = string.Empty; // Khởi tạo giá trị mặc định hợp lệ
        }

        /// <summary>
        /// Creates a new instance of the <see cref="AttachedDocument"/> class.
        /// Ensures required fields are provided and validates initial state.
        /// Use AttachedDocumentManager to create instances.
        /// </summary>
        /// <param name="id">The unique identifier.</param>
        /// <param name="code">The unique code (within the Procedure).</param>
        /// <param name="name">The name.</param>
        /// <param name="procedureId">The ID of the parent Procedure.</param> // Manager sẽ validate procedureId và tính duy nhất của Code
        /// <param name="order">The display order.</param>
        /// <param name="description">Optional description.</param>
        /// <param name="status">The status.</param>
        internal AttachedDocument( // Constructor internal để buộc tạo qua AttachedDocumentManager
            Guid id,
            [NotNull] string code,
            [NotNull] string name,
            Guid procedureId, // Manager đã kiểm tra Procedure tồn tại và Code là duy nhất trong Procedure này
            int order = 0,
            [CanBeNull] string? description = null,
            AttachedDocumentStatus status = AttachedDocumentStatus.Active)
            : base(id)
        {
            // Set Code trực tiếp, chỉ một lần và đã được validate bởi AttachedDocumentManager
            SetCodeInternal(code);
            ProcedureId = procedureId; // Gán ProcedureId đã được kiểm tra bởi Manager

            // Set các thuộc tính khác qua internal setters để validate
            SetNameInternal(name);
            SetOrderInternal(order);
            SetDescriptionInternal(description);
            Status = status; // Gán trực tiếp enum
        }

        // --- Internal setters with validation ---

        private void SetCodeInternal([NotNull] string code)
        {
            Check.NotNullOrWhiteSpace(code, nameof(code), AttachedDocumentConsts.MaxCodeLength);
            Code = code;
        }

        private void SetNameInternal([NotNull] string name)
        {
            Check.NotNullOrWhiteSpace(name, nameof(name), AttachedDocumentConsts.MaxNameLength);
            Name = name;
        }

         private void SetOrderInternal(int order)
        {
            Order = order;
        }

        private void SetDescriptionInternal([CanBeNull] string? description)
        {
            Check.Length(description, nameof(description), AttachedDocumentConsts.MaxDescriptionLength);
            Description = description;
        }

        /// <summary>
        /// Internal method to change the Procedure ID. Should only be called by AttachedDocumentManager.
        /// The manager is responsible for validating uniqueness of the code within the new procedure.
        /// </summary>
        internal void SetProcedureIdInternal(Guid procedureId)
        {
            // AttachedDocumentManager is responsible for validation (procedure exists, code uniqueness in new procedure)
            ProcedureId = procedureId;
        }

        // --- Public methods to change state ---

        /// <summary>
        /// Changes the name of the attached document.
        /// </summary>
        public AttachedDocument SetName([NotNull] string name)
        {
            SetNameInternal(name);
            return this;
        }

         /// <summary>
        /// Changes the display/processing order.
        /// </summary>
        public AttachedDocument SetOrder(int order)
        {
            SetOrderInternal(order);
            return this;
        }

        /// <summary>
        /// Changes the description.
        /// </summary>
        public AttachedDocument SetDescription([CanBeNull] string? description)
        {
            SetDescriptionInternal(description);
            return this;
        }

        /// <summary>
        /// Sets the attached document status to Active.
        /// </summary>
        public AttachedDocument Activate()
        {
            Status = AttachedDocumentStatus.Active;
            return this;
        }

        /// <summary>
        /// Sets the attached document status to Inactive.
        /// </summary>
        public AttachedDocument Deactivate()
        {
            Status = AttachedDocumentStatus.Inactive;
            return this;
        }

        // Lưu ý: Không có public SetCode method.
        // Lưu ý: Việc thay đổi ProcedureId phải qua AttachedDocumentManager.
    }
    ```

## 2. Repository Interface (`IAttachedDocumentRepository.cs`)

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Domain/AttachedDocuments` (nếu chưa có)
-   **Tệp:** Tạo file `IAttachedDocumentRepository.cs`
-   **Nội dung:**
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Threading;
    using System.Threading.Tasks;
    using Aqt.CoreFW.AttachedDocuments; // Namespace chứa Enum
    using Aqt.CoreFW.Domain.AttachedDocuments.Entities; // Namespace chứa Entity
    using JetBrains.Annotations;
    using Volo.Abp.Domain.Repositories;

    namespace Aqt.CoreFW.Domain.AttachedDocuments;

    /// <summary>
    /// Defines the repository interface for the AttachedDocument entity.
    /// </summary>
    public interface IAttachedDocumentRepository : IRepository<AttachedDocument, Guid> // Kế thừa IRepository cơ bản
    {
        /// <summary>
        /// Finds an AttachedDocument by its code within a specific Procedure.
        /// </summary>
        /// <param name="code">The code to search for.</param>
        /// <param name="procedureId">The ID of the Procedure.</param>
        /// <param name="includeDetails">Include details like Procedure navigation property (if defined).</param>
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>The found AttachedDocument or null.</returns>
        Task<AttachedDocument?> FindByCodeAsync(
            [NotNull] string code,
            Guid procedureId, // Bắt buộc vì Code unique theo Procedure
            bool includeDetails = false,
            CancellationToken cancellationToken = default);

        /// <summary>
        /// Gets a list of AttachedDocuments based on filtering criteria.
        /// </summary>
        /// <param name="filterText">Text to search in Code or Name.</param>
        /// <param name="code">Filter by exact code.</param>
        /// <param name="name">Filter by name containing text.</param>
        /// <param name="status">Filter by status.</param>
        /// <param name="procedureId">Filter by Procedure ID.</param> // Quan trọng để lọc
        /// <param name="sorting">Sorting expression (e.g., "Order ASC, Name ASC").</param>
        /// <param name="maxResultCount">Maximum number of results to return.</param>
        /// <param name="skipCount">Number of results to skip (for pagination).</param>
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>A list of AttachedDocuments.</returns>
        Task<List<AttachedDocument>> GetListAsync(
            string? filterText = null,
            string? code = null,
            string? name = null,
            AttachedDocumentStatus? status = null,
            Guid? procedureId = null, // Thường sẽ lọc theo Procedure này
            string? sorting = null,
            int maxResultCount = int.MaxValue,
            int skipCount = 0,
            CancellationToken cancellationToken = default);

        /// <summary>
        /// Gets the total count of AttachedDocuments based on filtering criteria.
        /// </summary>
        /// <param name="filterText">Text to search in Code or Name.</param>
        /// <param name="code">Filter by exact code.</param>
        /// <param name="name">Filter by name containing text.</param>
        /// <param name="status">Filter by status.</param>
        /// <param name="procedureId">Filter by Procedure ID.</param> // Quan trọng để đếm
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>The total count.</returns>
        Task<long> GetCountAsync(
            string? filterText = null,
            string? code = null,
            string? name = null,
            AttachedDocumentStatus? status = null,
            Guid? procedureId = null, // Thường sẽ lọc theo Procedure này
            CancellationToken cancellationToken = default);

        /// <summary>
        /// Checks if an AttachedDocument with the given code already exists within the specified Procedure.
        /// </summary>
        /// <param name="code">The code to check.</param>
        /// <param name="procedureId">The Procedure ID where uniqueness is checked.</param>
        /// <param name="excludeId">Optional: Exclude this ID from the check (used during update).</param>
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>True if the code exists in the procedure, false otherwise.</returns>
        Task<bool> CodeExistsAsync(
            [NotNull] string code,
            Guid procedureId, // Bắt buộc
            Guid? excludeId = null,
            CancellationToken cancellationToken = default);

        /// <summary>
        /// Gets a list of AttachedDocuments belonging to a specific Procedure, often used for lookups/dropdowns.
        /// </summary>
        /// <param name="procedureId">The ID of the Procedure to filter by.</param>
        /// <param name="onlyActive">Whether to return only active AttachedDocuments (default: true).</param>
        /// <param name="sorting">Sorting expression (default: "Order ASC, Name ASC").</param>
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>A list of AttachedDocuments matching the criteria.</returns>
        Task<List<AttachedDocument>> GetListByProcedureIdAsync(
            Guid procedureId,
            bool onlyActive = true,
            string? sorting = "Order ASC, Name ASC", // Cung cấp giá trị mặc định hợp lý
            CancellationToken cancellationToken = default);
    }
    ```

## 3. Domain Service (`AttachedDocumentManager.cs`)

**Trách nhiệm:**

*   Thực thi các quy tắc nghiệp vụ phức tạp liên quan đến AttachedDocument.
*   Đảm bảo tính nhất quán khi tạo (`CreateAsync`) và cập nhật (`UpdateAsync`) AttachedDocument.
*   Kiểm tra sự tồn tại và tính hợp lệ của `ProcedureId`.
*   Kiểm tra tính duy nhất của `Code` trong phạm vi `ProcedureId`.
*   Kiểm tra tính duy nhất của `Code` trong `ProcedureId` mới khi thực hiện thay đổi `ProcedureId`.
*   Tương tác với `IAttachedDocumentRepository` và `IProcedureRepository` (giả định).

**Cấu trúc `AttachedDocumentManager.cs`:**

-   **Vị trí:** `src/Aqt.CoreFW.Domain/AttachedDocuments/`
-   **Tệp:** Tạo file `AttachedDocumentManager.cs`
-   **Nội dung:**
    ```csharp
    using System;
    using System.Threading.Tasks;
    using Aqt.CoreFW.AttachedDocuments; // Namespaces cần thiết
    using Aqt.CoreFW.Domain.AttachedDocuments.Entities;
    using Aqt.CoreFW.Domain.Procedures; // (!! Giả định, cần namespace chứa IProcedureRepository !!)
    using JetBrains.Annotations;
    using Volo.Abp;
    using Volo.Abp.Domain.Services;
    using Volo.Abp.Guids;
    using Volo.Abp.Users; // Để inject ICurrentUser nếu cần kiểm tra quyền phức tạp hơn

    namespace Aqt.CoreFW.Domain.AttachedDocuments;

    /// <summary>
    /// Domain service responsible for managing AttachedDocument entities.
    /// </summary>
    public class AttachedDocumentManager : DomainService
    {
        private readonly IAttachedDocumentRepository _attachedDocumentRepository;
        private readonly IProcedureRepository _procedureRepository; // (!! Giả định tên Repository, cần xác minh !!)
        private readonly IGuidGenerator _guidGenerator;
        // private readonly ICurrentUser _currentUser; // Inject nếu cần

        public AttachedDocumentManager(
            IAttachedDocumentRepository attachedDocumentRepository,
            IProcedureRepository procedureRepository, // (!! Cần xác minh tên Repository !!)
            IGuidGenerator guidGenerator/*,
            ICurrentUser currentUser*/)
        {
            _attachedDocumentRepository = attachedDocumentRepository;
            _procedureRepository = procedureRepository;
            _guidGenerator = guidGenerator;
            // _currentUser = currentUser;
        }

        /// <summary>
        /// Creates a new AttachedDocument entity after validating business rules.
        /// </summary>
        /// <param name="code">Unique code within the Procedure.</param>
        /// <param name="name">Name.</param>
        /// <param name="procedureId">Parent Procedure ID.</param>
        /// <param name="order">Display order.</param>
        /// <param name="description">Optional description.</param>
        /// <param name="status">Status.</param>
        /// <returns>The newly created AttachedDocument entity.</returns>
        /// <exception cref="UserFriendlyException">Thrown if business rules are violated.</exception>
        public async Task<AttachedDocument> CreateAsync(
            [NotNull] string code,
            [NotNull] string name,
            Guid procedureId,
            int order = 0,
            [CanBeNull] string? description = null,
            AttachedDocumentStatus status = AttachedDocumentStatus.Active)
        {
            Check.NotNullOrWhiteSpace(code, nameof(code), AttachedDocumentConsts.MaxCodeLength);
            Check.NotNullOrWhiteSpace(name, nameof(name), AttachedDocumentConsts.MaxNameLength);
            Check.Length(description, nameof(description), AttachedDocumentConsts.MaxDescriptionLength);

            // 1. Validate Procedure existence
            await ValidateProcedureExistsAsync(procedureId);

            // 2. Validate Code uniqueness within the specified Procedure
            await ValidateCodeUniquenessAsync(code, procedureId);

            var attachedDocument = new AttachedDocument(
                _guidGenerator.Create(),
                code,
                name,
                procedureId,
                order,
                description,
                status
            );

            // Application Service sẽ gọi Repository.InsertAsync
            return attachedDocument;
        }

        /// <summary>
        /// Updates an existing AttachedDocument entity after validating business rules.
        /// </summary>
        /// <param name="attachedDocument">The entity to update.</param>
        /// <param name="name">New name.</param>
        /// <param name="procedureId">New parent Procedure ID.</param>
        /// <param name="order">New display order.</param>
        /// <param name="description">New optional description.</param>
        /// <param name="status">New status.</param>
        /// <returns>The updated AttachedDocument entity.</returns>
        /// <exception cref="UserFriendlyException">Thrown if business rules are violated.</exception>
        public async Task<AttachedDocument> UpdateAsync(
            [NotNull] AttachedDocument attachedDocument,
            [NotNull] string name,
            Guid procedureId, // Cho phép thay đổi Procedure
            int order,
            [CanBeNull] string? description,
            AttachedDocumentStatus status)
        {
            Check.NotNull(attachedDocument, nameof(attachedDocument));
            Check.NotNullOrWhiteSpace(name, nameof(name), AttachedDocumentConsts.MaxNameLength);
            Check.Length(description, nameof(description), AttachedDocumentConsts.MaxDescriptionLength);

            // 1. Validate Procedure existence if it's changed AND check Code uniqueness in the NEW procedure
            if (attachedDocument.ProcedureId != procedureId)
            {
                await ValidateProcedureExistsAsync(procedureId);
                // Kiểm tra Code có bị trùng trong Procedure mới không (bỏ qua chính nó vì Code không đổi)
                await ValidateCodeUniquenessAsync(attachedDocument.Code, procedureId, attachedDocument.Id);
                attachedDocument.SetProcedureIdInternal(procedureId); // Change Procedure ID via internal setter
            }

            // Update other properties
            attachedDocument.SetName(name);
            attachedDocument.SetOrder(order);
            attachedDocument.SetDescription(description);

            if (status == AttachedDocumentStatus.Active) attachedDocument.Activate();
            else attachedDocument.Deactivate();

            // Application Service sẽ gọi Repository.UpdateAsync
            return attachedDocument;
        }

        /// <summary>
        /// Changes the Procedure for an existing AttachedDocument.
        /// Ensures the code is unique in the new Procedure.
        /// </summary>
        public async Task ChangeProcedureAsync([NotNull] AttachedDocument attachedDocument, Guid newProcedureId)
        {
             Check.NotNull(attachedDocument, nameof(attachedDocument));

             if (attachedDocument.ProcedureId == newProcedureId)
             {
                 return; // No change needed
             }

             await ValidateProcedureExistsAsync(newProcedureId);
             await ValidateCodeUniquenessAsync(attachedDocument.Code, newProcedureId, attachedDocument.Id); // Check uniqueness in new procedure

             attachedDocument.SetProcedureIdInternal(newProcedureId);
             // Repository.UpdateAsync will be called by the Application Service
        }


        /// <summary>
        /// Helper method to validate if a Procedure exists.
        /// </summary>
        private async Task ValidateProcedureExistsAsync(Guid procedureId)
        {
            // (!! Cần phương thức tương ứng trong IProcedureRepository, ví dụ AnyAsync hoặc ExistsAsync !!)
            var procedureExists = await _procedureRepository.AnyAsync(p => p.Id == procedureId);
            if (!procedureExists)
            {
                 throw new UserFriendlyException(L["ProcedureNotFoundForAttachedDocument", procedureId]);
                // Hoặc dùng mã lỗi: throw new BusinessException(CoreFWDomainErrorCodes.ProcedureNotFoundForAttachedDocument).WithData("id", procedureId);
            }
        }

        /// <summary>
        /// Helper method to validate code uniqueness within a Procedure.
        /// </summary>
        private async Task ValidateCodeUniquenessAsync([NotNull] string code, Guid procedureId, Guid? excludeId = null)
        {
             if (await _attachedDocumentRepository.CodeExistsAsync(code, procedureId, excludeId))
            {
                throw new UserFriendlyException(L["AttachedDocumentCodeAlreadyExists", code]);
                // Hoặc dùng mã lỗi: throw new BusinessException(CoreFWDomainErrorCodes.AttachedDocumentCodeAlreadyExists).WithData("code", code);
            }
        }
    }
    ```

## 4. Cập nhật `CoreFWDomainModule.cs`

-   **Vị trí:** `src/Aqt.CoreFW.Domain/CoreFWDomainModule.cs`
-   **Hành động:** Không cần thay đổi. ABP tự động đăng ký `AttachedDocumentManager` và `IAttachedDocumentRepository` (nếu được triển khai ở tầng EF Core) thông qua cơ chế quét và đăng ký tự động.

## 5. Lưu ý

*   **Tính duy nhất của `Code`:** Kế hoạch này tuân thủ yêu cầu `Code` duy nhất trong phạm vi `ProcedureId`. Điều này được phản ánh trong `IAttachedDocumentRepository` và logic của `AttachedDocumentManager`.
*   **Aggregate Root:** Việc chọn `FullAuditedAggregateRoot` cần được xem xét lại. Nếu `AttachedDocument` không có vòng đời độc lập và luôn phụ thuộc vào `Procedure`, nó nên là `FullAuditedEntity` và được quản lý thông qua Aggregate `Procedure`.
*   **Repository Dependency:** `AttachedDocumentManager` phụ thuộc vào `IProcedureRepository`. Đảm bảo `Aqt.CoreFW.Domain` có tham chiếu đến project chứa `IProcedureRepository` và tên interface/phương thức (`AnyAsync`) là chính xác.
*   **Error Handling:** Sử dụng `UserFriendlyException` với localization key hoặc `BusinessException` với Error Code đã định nghĩa trong `CoreFWDomainErrorCodes.AttachedDocuments.cs`.
*   **Namespace:** Đảm bảo sử dụng đúng namespace cho các class và interface, đặc biệt là namespace của `Procedure` và `IProcedureRepository`.
*   **Thay đổi Procedure:** Đã thêm phương thức `ChangeProcedureAsync` và logic kiểm tra tính duy nhất của Code trong Procedure mới vào `UpdateAsync` để xử lý việc thay đổi `ProcedureId`.

</rewritten_file> 