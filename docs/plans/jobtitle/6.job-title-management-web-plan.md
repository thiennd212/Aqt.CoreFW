# Kế hoạch chi tiết: Tầng Web (`Aqt.CoreFW.Web`) - Quản lý Chức danh

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Web`.

## 1. Menu

- **Vị trí 1:** Cập nhật file `src/Aqt.CoreFW.Web/Menus/CoreFWMenus.cs`
- **Nội dung cần thêm:**
  ```csharp
  public class CoreFWMenus
  {
      private const string Prefix = "CoreFW";
      // ... các menu items khác ...
      public const string JobTitles = Prefix + ".JobTitles"; // Thêm menu Job Titles
  }
  ```
- **Vị trí 2:** Cập nhật file `src/Aqt.CoreFW.Web/Menus/CoreFWMenuContributor.cs`
- **Nội dung cần thêm trong phương thức `ConfigureMainMenuAsync`:**
  ```csharp
  // using Aqt.CoreFW.Permissions;
  // ...

  private async Task ConfigureMainMenuAsync(MenuConfigurationContext context)
  {
      // ... menu Home ...

      // Ví dụ: Thêm vào group Administration hoặc tạo group mới (ví dụ: HumanResources)
      var administration = context.Menu.GetAdministration(); // Hoặc context.Menu.AddItem(new ApplicationMenuItem(...)) cho group mới

      // Thêm mục JobTitles nếu user có quyền
      if (await context.IsGrantedAsync(CoreFWPermissions.JobTitles.Default))
      {
          administration.AddItem(new ApplicationMenuItem(
              CoreFWMenus.JobTitles,
              l["Menu:JobTitles"],
              "/JobTitles" // Đường dẫn tới trang quản lý Job Titles
          ).RequirePermissions(CoreFWPermissions.JobTitles.Default)); // Yêu cầu quyền để thấy menu
      }

      // ... các menu item khác ...
  }
  ```

## 2. Razor Pages và ViewModels

- **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Web/Pages/JobTitles`

- **Tệp 1: ViewModel chung:** Tạo file `JobTitleViewModel.cs`
  ```csharp
  using System;
  using System.ComponentModel.DataAnnotations;
  using Aqt.CoreFW.Domain.Shared.JobTitles;
  using Microsoft.AspNetCore.Mvc;

  namespace Aqt.CoreFW.Web.Pages.JobTitles.ViewModels; // Đặt vào thư mục con ViewModels cho gọn

  public class JobTitleViewModel
  {
      [HiddenInput]
      public Guid Id { get; set; }

      [Required]
      [StringLength(JobTitleConsts.MaxCodeLength)]
      [Display(Name = "JobTitleCode")]
      public string Code { get; set; }

      [Required]
      [StringLength(JobTitleConsts.MaxNameLength)]
      [Display(Name = "JobTitleName")]
      public string Name { get; set; }

      [StringLength(JobTitleConsts.MaxDescriptionLength)]
      [Display(Name = "JobTitleDescription")]
      [DataType(DataType.MultilineText)] // Hiển thị textarea
      public string? Description { get; set; }

      [Required]
      [Display(Name = "JobTitleIsActive")]
      public bool IsActive { get; set; } = true;
  }
  ```

- **Tệp 2: Trang danh sách:** Tạo file `Index.cshtml`
  ```cshtml
  @page
  @using Aqt.CoreFW.Permissions
  @using Microsoft.AspNetCore.Authorization
  @using Volo.Abp.AspNetCore.Mvc.UI.Layout
  @using Aqt.CoreFW.Web.Pages.JobTitles
  @using Aqt.CoreFW.Localization
  @using Microsoft.Extensions.Localization
  @using Aqt.CoreFW.Web.Menus
  @model IndexModel
  @inject IStringLocalizer<CoreFWResource> L
  @inject IAuthorizationService AuthorizationService
  @inject IPageLayout PageLayout
  @{
      PageLayout.Content.Title = L["JobTitles"].Value;
      PageLayout.Content.MenuItemName = CoreFWMenus.JobTitles;
  }

  @section scripts {
      <script>
            // Truyền permissions xuống JS
            const permissions = {
                canCreate: @((await AuthorizationService.IsGrantedAsync(CoreFWPermissions.JobTitles.Create)).ToString().ToLower()),
                canEdit: @((await AuthorizationService.IsGrantedAsync(CoreFWPermissions.JobTitles.Edit)).ToString().ToLower()),
                canDelete: @((await AuthorizationService.IsGrantedAsync(CoreFWPermissions.JobTitles.Delete)).ToString().ToLower())
            };
      </script>
      <abp-script src="/Pages/JobTitles/index.js" />
  }

  @section content_toolbar {
      @if (await AuthorizationService.IsGrantedAsync(CoreFWPermissions.JobTitles.Create))
      {
          <abp-button id="NewJobTitleButton"
                      text="@L["NewJobTitle"].Value"
                      icon="plus"
                      button-type="Primary" size="Small"/>
      }
  }

  <abp-card>
      <abp-card-body>
          @* Bộ lọc tìm kiếm *@
          <abp-row class="mb-3">
               <abp-column size-md="_4">
                    <input type="text" id="SearchFilter" class="form-control" placeholder="@L["Search"]..." />
               </abp-column>
               <abp-column size-md="_4">
                    <select id="IsActiveFilter" class="form-select">
                        <option value="">@L["All"]</option>
                        <option value="true">@L["Active"]</option>
                        <option value="false">@L["Inactive"]</option>
                    </select>
               </abp-column>
                <abp-column size-md="_4" class="text-end">
                     <abp-button id="SearchButton"
                               text="@L["Search"].Value"
                               icon="search"
                               button-type="Info" size="Small"/> @* Đổi màu nút Search *
                </abp-column>
          </abp-row>

          @* Bảng dữ liệu *@
          <abp-table striped-rows="true" id="JobTitlesTable"></abp-table>
      </abp-card-body>
  </abp-card>
  ```

- **Tệp 3: PageModel danh sách:** Tạo file `Index.cshtml.cs`
  ```csharp
  using Microsoft.AspNetCore.Mvc.RazorPages;

  namespace Aqt.CoreFW.Web.Pages.JobTitles;

  // Trang Index chỉ cần PageModel rỗng hoặc kế thừa PageModel cơ bản
  // vì logic load data và permission đã xử lý trong Razor và JS
  public class IndexModel : PageModel // Hoặc CoreFWPageModel nếu có logic chung
  {
      public void OnGet() { }
  }
  ```

- **Tệp 4: Modal Thêm mới:** `CreateModal.cshtml`
  ```cshtml
  @page "/JobTitles/CreateModal"
  @using Microsoft.AspNetCore.Mvc.Localization
  @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
  @using Aqt.CoreFW.Localization
  @using Aqt.CoreFW.Web.Pages.JobTitles.ViewModels
  @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form
  @model CreateModalModel
  @inject IHtmlLocalizer<CoreFWResource> L
  @{
      Layout = null;
  }
  <abp-dynamic-form abp-model="JobTitleViewModel" id="CreateJobTitleForm">
      <abp-modal>
          <abp-modal-header title="@L["NewJobTitle"].Value"></abp-modal-header>
          <abp-modal-body>
              <abp-form-content />
          </abp-modal-body>
          <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
      </abp-modal>
  </abp-dynamic-form>
  ```

- **Tệp 5: PageModel Thêm mới:** `CreateModal.cshtml.cs`
  ```csharp
  using System.Threading.Tasks;
  using Aqt.CoreFW.Web.Pages;
  using Aqt.CoreFW.Web.Pages.JobTitles.ViewModels;
  using Microsoft.AspNetCore.Mvc;

  namespace Aqt.CoreFW.Web.Pages.JobTitles;

  public class CreateModalModel : CoreFWPageModel // Hoặc PageModel nếu không có base
  {
      [BindProperty]
      public JobTitleViewModel JobTitleViewModel { get; set; }

      // Không cần inject AppService vì JS sẽ gọi API
      public CreateModalModel()
      {
          JobTitleViewModel = new JobTitleViewModel();
      }

      // OnGet để khởi tạo ViewModel
      public void OnGet()
      {
          JobTitleViewModel = new JobTitleViewModel { IsActive = true }; // Mặc định active
      }

      // OnPost chỉ cần trả về NoContent, JS sẽ xử lý submit
      public IActionResult OnPost()
      {
          return NoContent();
      }
  }
  ```

- **Tệp 6: Modal Sửa:** `EditModal.cshtml`
  ```cshtml
  @page "/JobTitles/EditModal"
  @model EditModalModel // Đổi Model
  @using Microsoft.AspNetCore.Mvc.Localization
  @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
  @using Aqt.CoreFW.Localization
  @using Aqt.CoreFW.Web.Pages.JobTitles.ViewModels
  @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form
  @inject IHtmlLocalizer<CoreFWResource> L
  @{
      Layout = null;
  }

  <abp-dynamic-form abp-model="JobTitleViewModel" id="EditJobTitleForm">
      <abp-modal>
          <abp-modal-header title="@L["EditJobTitle"].Value"></abp-modal-header>
          <abp-modal-body>
              @* Id đã có trong ViewModel và được bind tự động *
              <abp-form-content />
          </abp-modal-body>
          <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
      </abp-modal>
  </abp-dynamic-form>
  ```

- **Tệp 7: PageModel Sửa:** `EditModal.cshtml.cs`
  ```csharp
  using System;
  using System.Threading.Tasks;
  using Aqt.CoreFW.Application.Contracts.JobTitles;
  using Aqt.CoreFW.Application.Contracts.JobTitles.Dtos;
  using Aqt.CoreFW.Web.Pages;
  using Aqt.CoreFW.Web.Pages.JobTitles.ViewModels;
  using AutoMapper;
  using Microsoft.AspNetCore.Mvc;
  using Volo.Abp.ObjectMapping;

  namespace Aqt.CoreFW.Web.Pages.JobTitles;

  public class EditModalModel : CoreFWPageModel // Hoặc PageModel
  {
      [HiddenInput]
      [BindProperty(SupportsGet = true)] // Bind Id từ query string khi GET
      public Guid Id { get; set; }

      [BindProperty]
      public JobTitleViewModel JobTitleViewModel { get; set; }

      private readonly IJobTitleAppService _jobTitleAppService;

      public EditModalModel(IJobTitleAppService jobTitleAppService)
      {
          _jobTitleAppService = jobTitleAppService;
          JobTitleViewModel = new JobTitleViewModel();
      }

      // OnGet để lấy dữ liệu cũ hiển thị lên form
      public async Task OnGetAsync()
      {
          var dto = await _jobTitleAppService.GetAsync(Id);
          // Sử dụng ObjectMapper để map từ Dto sang ViewModel
          JobTitleViewModel = ObjectMapper.Map<JobTitleDto, JobTitleViewModel>(dto);
      }

      // OnPost chỉ cần trả về NoContent, JS sẽ xử lý submit
      public IActionResult OnPost()
      {
          return NoContent();
      }
  }
  ```

## 3. JavaScript

- **Vị trí:** Tạo file `src/Aqt.CoreFW.Web/wwwroot/Pages/JobTitles/index.js`
- **Nội dung:**
  ```javascript
  $(function () {
      const l = abp.localization.getResource('CoreFW'); // Lấy resource localization
      const jobTitleService = aqt.coreFW.application.contracts.jobTitles.jobTitleAppService; // Proxy service
      let createModal = new abp.ModalManager({
          viewUrl: abp.appPath + 'JobTitles/CreateModal',
          scriptUrl: '/Pages/JobTitles/createModal.js', // Optional: Nếu có logic JS riêng cho modal
          modalClass: 'jobTitleCreate'
      });
      let editModal = new abp.ModalManager({
          viewUrl: abp.appPath + 'JobTitles/EditModal',
          scriptUrl: '/Pages/JobTitles/editModal.js', // Optional: Nếu có logic JS riêng cho modal
          modalClass: 'jobTitleEdit'
      });

      // Khởi tạo DataTable
      const dataTable = $('#JobTitlesTable').DataTable(
          abp.libs.datatables.createAjax(jobTitleService.getList, {
              // Hàm lấy input filter từ UI
              getFilter: function () {
                  return {
                      filter: $('#SearchFilter').val(),
                      isActive: $('#IsActiveFilter').val() === "" ? null : ($('#IsActiveFilter').val().toLowerCase() === 'true')
                  };
              }
          }),
          {
              processing: true,
              serverSide: true,
              paging: true,
              searching: false, // Tắt searching mặc định của datatables, dùng filter riêng
              scrollX: true,
              // Định nghĩa các cột
              columnDefs: [
                  {
                      title: l('Actions'),
                      rowAction: {
                          items: [
                              {
                                  text: l('Edit'),
                                  visible: abp.auth.isGranted('CoreFW.JobTitles.Edit'), // Kiểm tra quyền Edit
                                  // Hoặc dùng biến permissions đã truyền từ cshtml: visible: permissions.canEdit,
                                  action: function (data) {
                                      editModal.open({ id: data.record.id });
                                  }
                              },
                              {
                                  text: l('Delete'),
                                  visible: abp.auth.isGranted('CoreFW.JobTitles.Delete'), // Kiểm tra quyền Delete
                                  // Hoặc dùng biến permissions: visible: permissions.canDelete,
                                  confirmMessage: function (data) {
                                      return l('AreYouSureToDeleteJobTitle', data.record.name);
                                  },
                                  action: function (data) {
                                      jobTitleService.delete(data.record.id)
                                          .then(function () {
                                              abp.notify.info(l('SuccessfullyDeleted'));
                                              dataTable.ajax.reload();
                                          })
                                          .catch(function (error) {
                                              abp.exceptionHandling.handle(error);
                                          });
                                  }
                              }
                          ]
                      }
                  },
                  {
                      title: l('JobTitleCode'),
                      data: 'code'
                  },
                  {
                      title: l('JobTitleName'),
                      data: 'name'
                  },
                   {
                      title: l('JobTitleDescription'),
                      data: 'description',
                      // Tránh wrap text nếu quá dài, có thể thêm class để xử lý ellipsis bằng CSS
                      render: function (data, type, row) {
                        return data ? `<span title="${data}">${abp.utils.truncateStringWithPostfix(data, 50)}</span>` : '';
                      }
                  },
                  {
                      title: l('JobTitleIsActive'),
                      data: 'isActive',
                      render: function (data) {
                          // Hiển thị icon check hoặc cross
                          return data
                              ? '<i class="fa fa-check text-success"></i>'
                              : '<i class="fa fa-times text-danger"></i>';
                      }
                  }
              ]
          }
      );

      // Sự kiện click nút "New Job Title"
      $('#NewJobTitleButton').click(function (e) {
          e.preventDefault();
          createModal.open();
      });

      // Sự kiện click nút "Search"
      $('#SearchButton').click(function (e) {
          e.preventDefault();
          dataTable.ajax.reload(); // Load lại data với filter mới
      });

       // Tùy chọn: Search khi nhấn Enter trong ô filter text
      $('#SearchFilter').keypress(function (e) {
        if (e.which == 13) { // 13 là mã phím Enter
          dataTable.ajax.reload();
          return false;
        }
      });

       // Tùy chọn: Search khi thay đổi dropdown trạng thái
      $('#IsActiveFilter').change(function(){
           dataTable.ajax.reload();
      });

      // Callback sau khi modal thêm mới được lưu thành công
      createModal.onResult(function () {
          dataTable.ajax.reload();
          abp.notify.success(l('SuccessfullyCreated')); // Thông báo thành công
      });

      // Callback sau khi modal sửa được lưu thành công
      editModal.onResult(function () {
          dataTable.ajax.reload();
          abp.notify.success(l('SuccessfullyUpdated')); // Thông báo thành công
      });
  });
  ```
- **Lưu ý:** Cần tạo thêm các file JS `createModal.js` và `editModal.js` nếu có logic phức tạp hơn cần xử lý riêng trong modal (ví dụ: validation phía client phức tạp, gọi API phụ...). Nếu không, các file này có thể bỏ qua và không cần khai báo `scriptUrl` trong `ModalManager`.

## 4. Dependencies

- Đảm bảo dự án `Aqt.CoreFW.Web` có tham chiếu đến `Aqt.CoreFW.Application.Contracts`.
- Đảm bảo các thư viện cần thiết (jQuery, DataTables, Bootstrap, abp-web) đã được bundle và load đúng cách. 