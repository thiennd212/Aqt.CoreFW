# Kế hoạch chi tiết: Tầng EntityFrameworkCore (`Aqt.CoreFW.EntityFrameworkCore`) - Quản lý Thủ tục hành chính (Procedure)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.EntityFrameworkCore` cho module Quản lý Thủ tục hành chính (Procedure).

## 1. DbContext

-   **Vị trí:** Cập nhật file `src/Aqt.CoreFW.EntityFrameworkCore/EntityFrameworkCore/CoreFWDbContext.cs`
-   **Nội dung cần thêm:**
    ```csharp
    using Aqt.CoreFW.Domain.Procedures.Entities; // Thêm using cho Procedure Entity
    using Microsoft.EntityFrameworkCore;
    using System.Reflection;
    // ... other usings ...

    public class CoreFWDbContext : AbpDbContext<CoreFWDbContext>, /* ... các interface khác ... */
    {
        // ... các DbSet khác (DataGroup, DataCore, DataImportant, etc.) ...
        public DbSet<Procedure> Procedures { get; set; } // Thêm DbSet cho Procedure


        public CoreFWDbContext(DbContextOptions<CoreFWDbContext> options)
            : base(options)
        {
        }

        protected override void OnModelCreating(ModelBuilder builder)
        {
            base.OnModelCreating(builder);

            // Cấu hình các module khác của ABP...
            // ...

            // Áp dụng tất cả cấu hình entity trong assembly này
            builder.ApplyConfigurationsFromAssembly(Assembly.GetExecutingAssembly());
        }
    }
    ```

## 2. Entity Configuration (`ProcedureConfiguration.cs`)

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.EntityFrameworkCore/EntityTypeConfigurations/Procedures` (Tạo thư mục nếu chưa có)
-   **Tệp:** Tạo file `ProcedureConfiguration.cs`
-   **Nội dung:**
    ```csharp
    using Aqt.CoreFW.Domain.Procedures.Entities; // Procedure Entity
    using Aqt.CoreFW.Domain.Shared; // Namespace chứa CoreFWConsts
    using Aqt.CoreFW.Procedures; // Namespace chứa ProcedureConsts và ProcedureStatus enum
    using Microsoft.EntityFrameworkCore;
    using Microsoft.EntityFrameworkCore.Metadata.Builders;
    using Volo.Abp.EntityFrameworkCore.Modeling;

    namespace Aqt.CoreFW.EntityFrameworkCore.EntityTypeConfigurations.Procedures; // Namespace Configuration

    /// <summary>
    /// Configures the database mapping for the <see cref="Procedure"/> entity.
    /// </summary>
    public class ProcedureConfiguration : IEntityTypeConfiguration<Procedure>
    {
        public void Configure(EntityTypeBuilder<Procedure> builder)
        {
            // Sử dụng DbTablePrefix và DbSchema từ CoreFWConsts
            builder.ToTable(CoreFWConsts.DbTablePrefix + "Procedures", CoreFWConsts.DbSchema);

            builder.ConfigureByConvention(); // Áp dụng các quy ước chuẩn của ABP

            builder.HasKey(x => x.Id);

            // --- Property Configurations ---
            builder.Property(x => x.Code)
                .IsRequired()
                .HasMaxLength(ProcedureConsts.MaxCodeLength)
                .HasColumnName(nameof(Procedure.Code));

            builder.Property(x => x.Name)
                .IsRequired()
                .HasMaxLength(ProcedureConsts.MaxNameLength)
                .HasColumnName(nameof(Procedure.Name));

            builder.Property(x => x.Status)
                .IsRequired()
                .HasColumnName(nameof(Procedure.Status))
                .HasConversion<byte>(); // Map enum sang byte

            builder.Property(x => x.Order)
                .IsRequired()
                .HasColumnName(nameof(Procedure.Order));

            builder.Property(x => x.Description)
                .HasMaxLength(ProcedureConsts.MaxDescriptionLength)
                .HasColumnName(nameof(Procedure.Description));

            builder.Property(x => x.LastSyncedDate)
                .HasColumnName(nameof(Procedure.LastSyncedDate));

            builder.Property(x => x.SyncRecordId)
                .HasColumnName(nameof(Procedure.SyncRecordId));

            builder.Property(x => x.SyncRecordCode)
                .HasMaxLength(ProcedureConsts.MaxSyncRecordCodeLength)
                .HasColumnName(nameof(Procedure.SyncRecordCode));

            // --- Foreign Keys --- (Không có FK nào được định nghĩa cho Procedure trong SRS)

            // --- Indexes ---

            // Index cho Code (Unique toàn hệ thống - theo giả định)
            builder.HasIndex(x => x.Code)
                   .IsUnique() // Đảm bảo Code là duy nhất toàn hệ thống
                   .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}Procedures_Code");

            builder.HasIndex(x => x.Name)
                   .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}Procedures_Name");

            builder.HasIndex(x => x.Status)
                   .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}Procedures_Status");

            // Index trên SyncRecordCode (nếu cần tìm kiếm theo mã đồng bộ)
            builder.HasIndex(x => x.SyncRecordCode)
                   .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}Procedures_SyncRecordCode");

            // Index kết hợp cho sắp xếp/lọc phổ biến
            builder.HasIndex(x => new { x.Status, x.Order, x.Name })
                  .HasDatabaseName($"IX_{CoreFWConsts.DbTablePrefix}Procedures_Status_Order_Name");
        }
    }
    ```

## 3. Repository Implementation (`ProcedureRepository.cs`)

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.EntityFrameworkCore/Repositories/Procedures` (Tạo thư mục nếu chưa có)
-   **Tệp:** Tạo file `ProcedureRepository.cs` bên trong thư mục trên
-   **Nội dung:**
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Linq.Dynamic.Core;
    using System.Threading;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Domain.Procedures; // IProcedureRepository
    using Aqt.CoreFW.Domain.Procedures.Entities; // Procedure Entity
    using Aqt.CoreFW.EntityFrameworkCore; // CoreFWDbContext, EfCoreRepository
    using Aqt.CoreFW.Procedures; // ProcedureStatus enum
    using JetBrains.Annotations;
    using Microsoft.EntityFrameworkCore;
    using Volo.Abp.Domain.Repositories.EntityFrameworkCore;
    using Volo.Abp.EntityFrameworkCore;

    namespace Aqt.CoreFW.EntityFrameworkCore.Repositories.Procedures;

    public class ProcedureRepository :
        EfCoreRepository<CoreFWDbContext, Procedure, Guid>,
        IProcedureRepository
    {
        public ProcedureRepository(IDbContextProvider<CoreFWDbContext> dbContextProvider)
            : base(dbContextProvider)
        {
        }

        public async Task<Procedure?> FindByCodeAsync(
            [NotNull] string code,
            bool includeDetails = false, // Typically false if no navigation props
            CancellationToken cancellationToken = default)
        {
            var dbSet = await GetDbSetAsync();
            var query = dbSet.AsNoTracking(); // Use AsNoTracking for read-only

            // If includeDetails is true and navigation properties exist, add .Include() here

            return await query.FirstOrDefaultAsync(
                p => p.Code == code,
                GetCancellationToken(cancellationToken));
        }

        public async Task<bool> CodeExistsAsync(
            [NotNull] string code,
            Guid? excludeId = null,
            CancellationToken cancellationToken = default)
        {
            var dbSet = await GetDbSetAsync();
            var query = dbSet.AsNoTracking().Where(p => p.Code == code);

            if (excludeId.HasValue)
            {
                query = query.Where(p => p.Id != excludeId.Value);
            }

            return await query.AnyAsync(GetCancellationToken(cancellationToken));
        }

        public async Task<List<Procedure>> GetListAsync(
            string? filterText = null,
            string? code = null,
            string? name = null,
            ProcedureStatus? status = null,
            string? sorting = null,
            int maxResultCount = int.MaxValue,
            int skipCount = 0,
            CancellationToken cancellationToken = default)
        {
            var query = await GetListQueryInternalAsync(filterText, code, name, status);

            query = query.OrderBy(sorting.IsNullOrWhiteSpace() ?
                $"{nameof(Procedure.Order)} asc, {nameof(Procedure.Name)} asc" // Default sort
                : sorting);

            return await query.PageBy(skipCount, maxResultCount)
                              .ToListAsync(GetCancellationToken(cancellationToken));
        }

        public async Task<long> GetCountAsync(
            string? filterText = null,
            string? code = null,
            string? name = null,
            ProcedureStatus? status = null,
            CancellationToken cancellationToken = default)
        {
            var query = await GetListQueryInternalAsync(filterText, code, name, status);
            return await query.LongCountAsync(GetCancellationToken(cancellationToken));
        }

        // Thêm phương thức GetLookupAsync đã định nghĩa trong IProcedureRepository
        public async Task<List<Procedure>> GetLookupAsync(
            bool onlyActive = true,
            string? sorting = "Order ASC, Name ASC",
            CancellationToken cancellationToken = default)
        {
            var dbSet = await GetDbSetAsync();
            var query = dbSet.AsNoTracking();

            if (onlyActive)
            {
                query = query.Where(p => p.Status == ProcedureStatus.Active);
            }

            query = query.OrderBy(sorting.IsNullOrWhiteSpace() ?
                $"{nameof(Procedure.Order)} asc, {nameof(Procedure.Name)} asc" // Default sort
                : sorting);

            // Không cần phân trang cho lookup
            return await query.ToListAsync(GetCancellationToken(cancellationToken));
        }


        // --- Private Helper Method ---

        private async Task<IQueryable<Procedure>> GetListQueryInternalAsync(
            string? filterText = null,
            string? code = null,
            string? name = null,
            ProcedureStatus? status = null)
        {
            var dbSet = await GetDbSetAsync();
            return dbSet.AsNoTracking()
                // Combined filter for Code or Name
                .WhereIf(!filterText.IsNullOrWhiteSpace(), p =>
                    (p.Code != null && p.Code.Contains(filterText!)) ||
                    (p.Name != null && p.Name.Contains(filterText!)))
                // Specific filters
                .WhereIf(!code.IsNullOrWhiteSpace(), p => p.Code == code)
                .WhereIf(!name.IsNullOrWhiteSpace(), p => p.Name != null && p.Name.Contains(name))
                .WhereIf(status.HasValue, p => p.Status == status!.Value);
        }
    }
    ```

## 4. Cập nhật `CoreFWDbContextModelCreatingExtensions.cs` (Không bắt buộc nếu dùng `ApplyConfigurationsFromAssembly`)

-   **Vị trí:** `src/Aqt.CoreFW.EntityFrameworkCore/EntityFrameworkCore/CoreFWDbContextModelCreatingExtensions.cs`
-   **Hành động:** Nếu bạn **không** sử dụng `builder.ApplyConfigurationsFromAssembly(Assembly.GetExecutingAssembly());` trong `CoreFWDbContext.OnModelCreating`, bạn cần gọi thủ công phương thức cấu hình cho `Procedure` tại đây.
    ```csharp
    public static void ConfigureCoreFW(this ModelBuilder builder)
    {
        Check.NotNull(builder, nameof(builder));

        // ... Cấu hình cho các entity khác ...

        // Cấu hình cho Procedure
        builder.ApplyConfiguration(new Aqt.CoreFW.EntityFrameworkCore.EntityTypeConfigurations.Procedures.ProcedureConfiguration());

        // ... các cấu hình khác ...
    }
    ```
    **Khuyến nghị:** Sử dụng `ApplyConfigurationsFromAssembly` để tự động áp dụng tất cả cấu hình.

## 5. Database Migrations

-   **Hành động:**
    1.  **Thêm Migration:** Mở Package Manager Console (PMC) hoặc terminal, chọn project `Aqt.CoreFW.EntityFrameworkCore` làm project mặc định.
        ```bash
        dotnet ef migrations add Added_Procedures_Module
        ```
        *(Sử dụng tên migration mô tả, ví dụ: `Added_Procedures_Module`, `Added_Procedures_Table`)*
    2.  **Kiểm tra Migration:** Mở file migration mới được tạo trong thư mục `Migrations` của project `Aqt.CoreFW.EntityFrameworkCore` để xem lại các thay đổi SQL được tạo ra (tạo bảng `Procedures`, thêm cột, **index unique cho Code**, các index khác).
    3.  **Cập nhật Database:**
        ```bash
        dotnet ef database update
        ```

## 6. Lưu ý

*   **Namespace:** Đảm bảo các namespace là chính xác cho Entity, Enum, Constants, Configuration, Repository và DbContext.
*   **Code Uniqueness:** Cấu hình và logic Repository đã được điều chỉnh để đảm bảo `Procedure.Code` là **duy nhất toàn hệ thống** (theo giả định). Điều này thể hiện qua `HasIndex(x => x.Code).IsUnique()` và các phương thức `FindByCodeAsync`, `CodeExistsAsync` không yêu cầu tham số bổ sung như `dataGroupId`.
*   **Foreign Keys:** Không có khóa ngoại nào được cấu hình cho `Procedure` dựa trên SRS.
*   **Indexes:** Đã thêm các index cần thiết, bao gồm index unique trên `Code` và các index khác để tối ưu lọc/sắp xếp.
*   **Repository Implementation:** Repository triển khai các phương thức trong `IProcedureRepository`, sử dụng LINQ và `IQueryable`, bao gồm cả `GetLookupAsync`.
*   **Raw SQL:** Tránh sử dụng Raw SQL.
*   **Migrations:** Luôn tạo và kiểm tra migration cẩn thận, đặc biệt là cấu trúc index unique, trước khi cập nhật database.
*   **Sync Fields:** Các trường đồng bộ (`LastSyncedDate`, `SyncRecordId`, `SyncRecordCode`) đã được cấu hình trong `ProcedureConfiguration` và có thể được truy vấn/cập nhật thông qua repository.