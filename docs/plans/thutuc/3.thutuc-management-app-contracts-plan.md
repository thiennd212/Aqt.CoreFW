# Kế hoạch chi tiết: Tầng Application.Contracts (`Aqt.CoreFW.Application.Contracts`) - Quản lý Thủ tục hành chính (Procedure)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Application.Contracts` cho module Quản lý Thủ tục hành chính (Procedure).

## 1. DTOs

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Application.Contracts/Procedures/Dtos` (Tạo thư mục `Procedures/Dtos` nếu chưa có)
-   **Tệp 1:** Tạo file `ProcedureDto.cs`
    ```csharp
    using System;
    using Aqt.CoreFW.Procedures; // Sử dụng Enum/Consts từ Domain.Shared namespace
    using Volo.Abp.Application.Dtos;

    namespace Aqt.CoreFW.Application.Contracts.Procedures.Dtos;

    public class ProcedureDto : FullAuditedEntityDto<Guid> // Kế thừa FullAuditedEntityDto
    {
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public ProcedureStatus Status { get; set; }
        public int Order { get; set; }
        public string? Description { get; set; }

        // Thông tin đồng bộ (hiển thị nếu cần)
        public DateTime? LastSyncedDate { get; set; }
        public Guid? SyncRecordId { get; set; }
        public string? SyncRecordCode { get; set; }
    }
    ```
-   **Tệp 2:** Tạo file `CreateUpdateProcedureDto.cs`
    ```csharp
    using System;
    using System.ComponentModel.DataAnnotations;
    using Aqt.CoreFW.Procedures; // Sử dụng Enum/Consts từ Domain.Shared namespace

    namespace Aqt.CoreFW.Application.Contracts.Procedures.Dtos;

    public class CreateUpdateProcedureDto
    {
        // Code chỉ bắt buộc và cho phép nhập khi tạo mới (AppService sẽ xử lý logic này)
        // Khi cập nhật, Code thường không được gửi lên hoặc bị bỏ qua
        [Required(AllowEmptyStrings = false)] // Bắt buộc khi Create
        [StringLength(ProcedureConsts.MaxCodeLength)]
        public string Code { get; set; } = string.Empty;

        [Required(AllowEmptyStrings = false)]
        [StringLength(ProcedureConsts.MaxNameLength)]
        public string Name { get; set; } = string.Empty;

        [Required]
        public ProcedureStatus Status { get; set; } = ProcedureStatus.Active;

        [Required]
        public int Order { get; set; }

        [StringLength(ProcedureConsts.MaxDescriptionLength)]
        public string? Description { get; set; }

        // Lưu ý: Các trường Sync (LastSyncedDate, SyncRecordId, SyncRecordCode) không được quản lý qua DTO này.
        // Chúng sẽ được cập nhật thông qua quy trình đồng bộ riêng biệt nếu cần.
    }
    ```
-   **Tệp 3:** Tạo file `GetProceduresInput.cs`
    ```csharp
    using System;
    using Aqt.CoreFW.Procedures; // Sử dụng Enum/Consts từ Domain.Shared namespace
    using Volo.Abp.Application.Dtos;

    namespace Aqt.CoreFW.Application.Contracts.Procedures.Dtos;

    public class GetProceduresInput : PagedAndSortedResultRequestDto // Kế thừa để hỗ trợ phân trang và sắp xếp
    {
        public string? Filter { get; set; } // Filter theo Code hoặc Name
        public ProcedureStatus? Status { get; set; } // Filter theo Status
    }
    ```
-   **Tệp 4:** Tạo file `ProcedureExcelDto.cs` (Dùng cho xuất Excel - Optional)
    ```csharp
    using System;
    using MiniExcelLibs.Attributes;

    namespace Aqt.CoreFW.Application.Contracts.Procedures.Dtos;

    /// <summary>
    /// DTO được thiết kế riêng cho việc xuất dữ liệu Procedure ra Excel.
    /// </summary>
    public class ProcedureExcelDto
    {
        [ExcelColumnName("Mã Thủ tục")]
        public string Code { get; set; } = string.Empty;

        [ExcelColumnName("Tên Thủ tục")]
        public string Name { get; set; } = string.Empty;

        [ExcelColumnName("Thứ tự")]
        public int Order { get; set; }

        [ExcelColumnName("Trạng thái")]
        public string StatusText { get; set; } = string.Empty; // Lấy từ localization

        [ExcelColumnName("Mô tả")]
        public string? Description { get; set; }

        [ExcelColumnName("Ngày đồng bộ cuối")]
        [ExcelFormat("yyyy-MM-dd HH:mm:ss")] // Định dạng ngày giờ
        public DateTime? LastSyncedDate { get; set; }

        // Có thể thêm các trường audit nếu cần
        // [ExcelColumnName("Ngày tạo")]
        // [ExcelFormat("yyyy-MM-dd HH:mm:ss")]
        // public DateTime CreationTime { get; set; }
    }
    ```
-   **Tệp 5:** Tạo file `ProcedureLookupDto.cs` (Dùng cho lookup, đặt trong thư mục dùng chung)
    -   **Vị trí:** `src/Aqt.CoreFW.Application.Contracts/Shared/Lookups/ProcedureLookupDto.cs` (Tạo thư mục `Shared/Lookups` nếu chưa có)
    -   **Nội dung:**
        ```csharp
        using System;
        using Volo.Abp.Application.Dtos;

        namespace Aqt.CoreFW.Application.Contracts.Shared.Lookups; // Namespace dùng chung

        // Dùng cho việc lookup Procedures dạng danh sách phẳng (flat list)
        public class ProcedureLookupDto : EntityDto<Guid>
        {
            public string Name { get; set; } = string.Empty;
            public string Code { get; set; } = string.Empty; // Thêm Code để dễ nhận biết
        }
        ```

## 2. AppService Interface (`IProcedureAppService.cs`)

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Application.Contracts/Procedures`
-   **Tệp:** Tạo file `IProcedureAppService.cs`
    ```csharp
    using System;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Application.Contracts.Procedures.Dtos; // Namespace chứa DTOs
    using Aqt.CoreFW.Application.Contracts.Shared.Lookups; // Namespace chứa ProcedureLookupDto
    using Volo.Abp.Application.Dtos;
    using Volo.Abp.Application.Services;
    using Volo.Abp.Content; // Required for IRemoteStreamContent

    namespace Aqt.CoreFW.Application.Contracts.Procedures;

    public interface IProcedureAppService :
        ICrudAppService< // Kế thừa ICrudAppService cho CRUD cơ bản
            ProcedureDto,               // DTO hiển thị
            Guid,                           // Kiểu khóa chính
            GetProceduresInput,         // DTO lọc/phân trang
            CreateUpdateProcedureDto>   // DTO tạo/cập nhật
            // Lưu ý: DTO cập nhật (Update) ở đây giống DTO tạo (Create),
            // nhưng logic xử lý trong AppService sẽ khác (ví dụ: không cho sửa Code)
    {
        /// <summary>
        /// Lấy danh sách Procedures dạng phẳng (flat list) cho lookup.
        /// Chỉ trả về các Procedures đang hoạt động.
        /// </summary>
        Task<ListResultDto<ProcedureLookupDto>> GetLookupAsync();

        /// <summary>
        /// (Optional) Xuất danh sách Procedures ra file Excel dựa trên bộ lọc.
        /// </summary>
        Task<IRemoteStreamContent> GetListAsExcelAsync(GetProceduresInput input);

        // Cân nhắc: Nếu cần phương thức cập nhật thông tin đồng bộ qua API,
        // có thể thêm một DTO và phương thức riêng ở đây.
        // Ví dụ: Task UpdateSyncInfoAsync(Guid id, UpdateProcedureSyncInfoDto syncInfo);
    }
    ```

## 3. Permissions

-   **Vị trí 1:** Cập nhật file `src/Aqt.CoreFW.Application.Contracts/Permissions/CoreFWPermissions.cs`
-   **Nội dung cần thêm:**
    ```csharp
    public static class CoreFWPermissions
    {
        public const string GroupName = "CoreFW";

        // ... các permission khác (Provinces, ..., DataImportants) ...

        // Thêm định nghĩa permission cho Procedures
        public static class Procedures // Sử dụng tên class khớp với module
        {
            // Sử dụng convention đặt tên quyền: CoreFW.Procedures
            public const string Default = GroupName + ".Procedures"; // Quyền xem mặc định
            public const string Create = Default + ".Create";
            public const string Update = Default + ".Update";
            public const string Delete = Default + ".Delete";
            public const string Export = Default + ".Export";
        }
        // ... các module khác ...
    }
    ```
-   **Vị trí 2:** Cập nhật file `src/Aqt.CoreFW.Application.Contracts/Permissions/CoreFWPermissionDefinitionProvider.cs`
-   **Nội dung cần thêm vào phương thức `Define`:**
    ```csharp
    // ... Lấy context.GetGroup(CoreFWPermissions.GroupName);

    // Thêm định nghĩa permissions cho Procedures
    var proceduresPermission = coreFwGroup.AddPermission(CoreFWPermissions.Procedures.Default, L("Permission:ProcedureManagement")); // Sử dụng key localization từ plan 1
    proceduresPermission.AddChild(CoreFWPermissions.Procedures.Create, L("Permission:Procedures.Create"));
    proceduresPermission.AddChild(CoreFWPermissions.Procedures.Update, L("Permission:Procedures.Update"));
    proceduresPermission.AddChild(CoreFWPermissions.Procedures.Delete, L("Permission:Procedures.Delete"));
    proceduresPermission.AddChild(CoreFWPermissions.Procedures.Export, L("Permission:Procedures.Export"));
    // ... các AddPermission khác ...
    ```

## 4. Lưu ý

*   **Namespaces:** Đảm bảo sử dụng đúng namespaces cho các DTOs, Interfaces và Permissions.
*   **DataAnnotations:** Sử dụng DataAnnotations (`[Required]`, `[StringLength]`) trên `CreateUpdateProcedureDto` để validation cơ bản phía client và API.
*   **Lookup DTO:** `ProcedureLookupDto` chỉ chứa các trường cần thiết cho việc hiển thị trong dropdown hoặc các mục đích lookup khác.
*   **Permissions:** Đảm bảo các keys localization (`L["Permission:..."]`) đã được định nghĩa trong tầng `Domain.Shared` (kế hoạch bước 1).
*   **Excel Export:** Việc triển khai `GetListAsExcelAsync` là tùy chọn và cần thư viện hỗ trợ (ví dụ: MiniExcel). Nếu không cần, có thể bỏ qua DTO `ProcedureExcelDto` và phương thức tương ứng trong interface.
*   **Update DTO:** Mặc dù `CreateUpdateProcedureDto` được dùng cho cả Create và Update trong `ICrudAppService`, logic trong `AppService` sẽ cần xử lý khác biệt (ví dụ: bỏ qua trường `Code` khi update).
*   **Sync Fields:** Các trường liên quan đến đồng bộ (`LastSyncedDate`, `SyncRecordId`, `SyncRecordCode`) không được bao gồm trong `CreateUpdateProcedureDto` vì chúng thường được quản lý bởi một quy trình riêng biệt, không phải qua CRUD thông thường. Nếu có yêu cầu cập nhật thông tin này qua API, cần định nghĩa DTO và phương thức riêng. 