# Kế hoạch chi tiết: Tầng Domain (`Aqt.CoreFW.Domain`) - Quản lý Danh mục Dữ liệu Quan trọng (DataImportant Management)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Domain` để hỗ trợ chức năng quản lý Danh mục Dữ liệu Quan trọng (DataImportant). Kế hoạch này dựa trên yêu cầu trong `docs/srs/dataimportant-srs.md`, kế hoạch tổng thể `0.dataimportant-management-plan-v1.md` và kế hoạch tầng Domain.Shared `1.dataimportant-management-domain-shared-plan.md`.

## 1. Entity (`DataImportant.cs`)

**Nguyên tắc thiết kế Entity (DDD):**

*   **Đóng gói (Encapsulation):** Sử dụng `private set` cho các thuộc tính. `Code` không thay đổi sau khi tạo.
*   **Validation tập trung:** Tạo các phương thức `private` hoặc `internal` chứa logic validation (`Check.*`) sử dụng hằng số từ `DataImportantConsts`.
*   **Trạng thái hợp lệ (Valid State):** Constructor chính (`internal`) nhận tham số bắt buộc, gọi phương thức validation nội bộ để đảm bảo entity hợp lệ khi khởi tạo. Constructor `protected` dùng cho ORM.
*   **Hành vi (Behavior):** Định nghĩa phương thức `public` để thay đổi trạng thái có kiểm soát (ví dụ: `SetName`, `Activate`, `SetDataGroup`).
*   **Kế thừa:** Sử dụng `FullAuditedAggregateRoot<Guid>`. Tương tự như DataCore, mặc dù `DataImportant` phụ thuộc `DataGroup`, việc kế thừa `AggregateRoot` giúp tận dụng các cơ chế Repository và UnitOfWork của ABP. Nếu có yêu cầu chặt chẽ hơn về Aggregate, cần xem xét lại.
*   **Quan hệ:** Tham chiếu bắt buộc đến `DataGroup` qua `DataGroupId`.

**Cấu trúc `DataImportant.cs`:**

-   **Vị trí:** `src/Aqt.CoreFW.Domain/DataImportants/Entities/DataImportant.cs` (Tạo thư mục `DataImportants/Entities` nếu chưa có)
-   **Nội dung:**
    ```csharp
    using System;
    using Aqt.CoreFW.DataImportants; // Namespace chứa Consts và Enum từ Domain.Shared
    using Aqt.CoreFW.Domain.DataGroups.Entities; // Namespace chứa Entity DataGroup
    using JetBrains.Annotations;
    using Volo.Abp;
    using Volo.Abp.Domain.Entities.Auditing;

    namespace Aqt.CoreFW.Domain.DataImportants.Entities; // Namespace cụ thể cho Entity

    /// <summary>
    /// Represents an important data catalog item.
    /// Inherits from FullAuditedAggregateRoot for audit logging and soft delete.
    /// </summary>
    public class DataImportant : FullAuditedAggregateRoot<Guid>
    {
        /// <summary>
        /// Unique code for the data important item within a specific DataGroup.
        /// Cannot be changed after creation.
        /// </summary>
        [NotNull]
        public virtual string Code { get; private set; }

        /// <summary>
        /// Name of the data important item.
        /// </summary>
        [NotNull]
        public virtual string Name { get; private set; }

        /// <summary>
        /// Status of the data important item (Active/Inactive).
        /// </summary>
        public virtual DataImportantStatus Status { get; private set; }

        /// <summary>
        /// Display or processing order.
        /// </summary>
        public virtual int Order { get; private set; }

        /// <summary>
        /// Optional description.
        /// </summary>
        [CanBeNull]
        public virtual string? Description { get; private set; }

        /// <summary>
        /// Foreign key to the DataGroup this item belongs to. Required.
        /// </summary>
        public virtual Guid DataGroupId { get; private set; } // Thay đổi qua Domain Service

        // Navigation property (optional, configure for lazy-loading in EF Core mapping)
        // public virtual DataGroup DataGroup { get; private set; }

        /// <summary>
        /// Protected constructor for ORM frameworks.
        /// </summary>
        protected DataImportant()
        {
            /* For ORM */
            Code = string.Empty; // Khởi tạo giá trị mặc định hợp lệ
            Name = string.Empty; // Khởi tạo giá trị mặc định hợp lệ
        }

        /// <summary>
        /// Creates a new instance of the <see cref="DataImportant"/> class.
        /// Ensures required fields are provided and validates initial state.
        /// Use DataImportantManager to create instances.
        /// </summary>
        /// <param name="id">The unique identifier.</param>
        /// <param name="code">The unique code (within the DataGroup).</param>
        /// <param name="name">The name.</param>
        /// <param name="dataGroupId">The ID of the parent DataGroup.</param> // Manager sẽ validate dataGroupId và tính duy nhất của Code
        /// <param name="order">The display order.</param>
        /// <param name="description">Optional description.</param>
        /// <param name="status">The status.</param>
        internal DataImportant( // Constructor internal để buộc tạo qua DataImportantManager
            Guid id,
            [NotNull] string code,
            [NotNull] string name,
            Guid dataGroupId, // Manager đã kiểm tra DataGroup tồn tại và Code là duy nhất trong Group này
            int order = 0,
            [CanBeNull] string? description = null,
            DataImportantStatus status = DataImportantStatus.Active)
            : base(id)
        {
            // Set Code trực tiếp, chỉ một lần và đã được validate bởi DataImportantManager
            SetCodeInternal(code);
            DataGroupId = dataGroupId; // Gán DataGroupId đã được kiểm tra bởi Manager

            // Set các thuộc tính khác qua internal setters để validate
            SetNameInternal(name);
            SetOrderInternal(order);
            SetDescriptionInternal(description);
            Status = status; // Gán trực tiếp enum
        }

        // --- Internal setters with validation ---

        private void SetCodeInternal([NotNull] string code)
        {
            Check.NotNullOrWhiteSpace(code, nameof(code), DataImportantConsts.MaxCodeLength);
            Code = code;
        }

        private void SetNameInternal([NotNull] string name)
        {
            Check.NotNullOrWhiteSpace(name, nameof(name), DataImportantConsts.MaxNameLength);
            Name = name;
        }

         private void SetOrderInternal(int order)
        {
            Order = order;
        }

        private void SetDescriptionInternal([CanBeNull] string? description)
        {
            Check.Length(description, nameof(description), DataImportantConsts.MaxDescriptionLength);
            Description = description;
        }

        /// <summary>
        /// Internal method to change the DataGroup ID. Should only be called by DataImportantManager.
        /// The manager is responsible for validating uniqueness of the code within the new group.
        /// </summary>
        internal void SetDataGroupIdInternal(Guid dataGroupId)
        {
            // DataImportantManager is responsible for validation (data group exists, code uniqueness in new group)
            DataGroupId = dataGroupId;
        }

        // --- Public methods to change state ---

        /// <summary>
        /// Changes the name of the data important item.
        /// </summary>
        public DataImportant SetName([NotNull] string name)
        {
            SetNameInternal(name);
            return this;
        }

         /// <summary>
        /// Changes the display/processing order.
        /// </summary>
        public DataImportant SetOrder(int order)
        {
            SetOrderInternal(order);
            return this;
        }

        /// <summary>
        /// Changes the description.
        /// </summary>
        public DataImportant SetDescription([CanBeNull] string? description)
        {
            SetDescriptionInternal(description);
            return this; // Sửa lại lỗi cú pháp từ ví dụ gốc
        }

        /// <summary>
        /// Sets the data important status to Active.
        /// </summary>
        public DataImportant Activate()
        {
            Status = DataImportantStatus.Active;
            return this;
        }

        /// <summary>
        /// Sets the data important status to Inactive.
        /// </summary>
        public DataImportant Deactivate()
        {
            Status = DataImportantStatus.Inactive;
            return this;
        }

        // Lưu ý: Không có public SetCode method.
        // Lưu ý: Việc thay đổi DataGroupId phải qua DataImportantManager.
    }
    ```

## 2. Repository Interface (`IDataImportantRepository.cs`)

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Domain/DataImportants` (nếu chưa có)
-   **Tệp:** Tạo file `IDataImportantRepository.cs`
-   **Nội dung:**
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Threading;
    using System.Threading.Tasks;
    using Aqt.CoreFW.DataImportants; // Namespace chứa Enum
    using Aqt.CoreFW.Domain.DataImportants.Entities; // Namespace chứa Entity
    using JetBrains.Annotations;
    using Volo.Abp.Domain.Repositories;

    namespace Aqt.CoreFW.Domain.DataImportants;

    /// <summary>
    /// Defines the repository interface for the DataImportant entity.
    /// </summary>
    public interface IDataImportantRepository : IRepository<DataImportant, Guid> // Kế thừa IRepository cơ bản
    {
        /// <summary>
        /// Finds a DataImportant by its code within a specific DataGroup.
        /// </summary>
        /// <param name="code">The code to search for.</param>
        /// <param name="dataGroupId">The ID of the DataGroup.</param>
        /// <param name="includeDetails">Include details like DataGroup navigation property (if defined).</param>
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>The found DataImportant or null.</returns>
        Task<DataImportant?> FindByCodeAsync(
            [NotNull] string code,
            Guid dataGroupId, // Bắt buộc vì Code unique theo Group
            bool includeDetails = false,
            CancellationToken cancellationToken = default);

        /// <summary>
        /// Gets a list of DataImportants based on filtering criteria.
        /// </summary>
        /// <param name="filterText">Text to search in Code or Name.</param>
        /// <param name="code">Filter by exact code.</param>
        /// <param name="name">Filter by name containing text.</param>
        /// <param name="status">Filter by status.</param>
        /// <param name="dataGroupId">Filter by DataGroup ID.</param> // Quan trọng để lọc
        /// <param name="sorting">Sorting expression (e.g., "Order ASC, Name ASC").</param>
        /// <param name="maxResultCount">Maximum number of results to return.</param>
        /// <param name="skipCount">Number of results to skip (for pagination).</param>
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>A list of DataImportants.</returns>
        Task<List<DataImportant>> GetListAsync(
            string? filterText = null,
            string? code = null,
            string? name = null,
            DataImportantStatus? status = null,
            Guid? dataGroupId = null, // Thường sẽ lọc theo Group này
            string? sorting = null,
            int maxResultCount = int.MaxValue,
            int skipCount = 0,
            CancellationToken cancellationToken = default);

        /// <summary>
        /// Gets the total count of DataImportants based on filtering criteria.
        /// </summary>
        /// <param name="filterText">Text to search in Code or Name.</param>
        /// <param name="code">Filter by exact code.</param>
        /// <param name="name">Filter by name containing text.</param>
        /// <param name="status">Filter by status.</param>
        /// <param name="dataGroupId">Filter by DataGroup ID.</param> // Quan trọng để đếm
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>The total count.</returns>
        Task<long> GetCountAsync(
            string? filterText = null,
            string? code = null,
            string? name = null,
            DataImportantStatus? status = null,
            Guid? dataGroupId = null, // Thường sẽ lọc theo Group này
            CancellationToken cancellationToken = default);

        /// <summary>
        /// Checks if a DataImportant with the given code already exists within the specified DataGroup.
        /// </summary>
        /// <param name="code">The code to check.</param>
        /// <param name="dataGroupId">The DataGroup ID where uniqueness is checked.</param>
        /// <param name="excludeId">Optional: Exclude this ID from the check (used during update).</param>
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>True if the code exists in the group, false otherwise.</returns>
        Task<bool> CodeExistsAsync(
            [NotNull] string code,
            Guid dataGroupId, // Bắt buộc
            Guid? excludeId = null,
            CancellationToken cancellationToken = default);

        /// <summary>
        /// Gets a list of DataImportants belonging to a specific DataGroup, often used for lookups/dropdowns.
        /// </summary>
        /// <param name="dataGroupId">The ID of the DataGroup to filter by.</param>
        /// <param name="onlyActive">Whether to return only active DataImportants (default: true).</param>
        /// <param name="sorting">Sorting expression (default: "Order ASC, Name ASC").</param>
        /// <param name="cancellationToken">Cancellation token.</param>
        /// <returns>A list of DataImportants matching the criteria.</returns>
        Task<List<DataImportant>> GetListByDataGroupIdAsync(
            Guid dataGroupId,
            bool onlyActive = true,
            string? sorting = "Order ASC, Name ASC", // Cung cấp giá trị mặc định hợp lý
            CancellationToken cancellationToken = default);
    }
    ```

## 3. Domain Service (`DataImportantManager.cs`)

**Trách nhiệm:**

*   Thực thi các quy tắc nghiệp vụ phức tạp liên quan đến DataImportant.
*   Đảm bảo tính nhất quán khi tạo (`CreateAsync`) và cập nhật (`UpdateAsync`) DataImportant.
*   Kiểm tra sự tồn tại và tính hợp lệ của `DataGroupId`.
*   Kiểm tra tính duy nhất của `Code` trong phạm vi `DataGroupId`.
*   Kiểm tra tính duy nhất của `Code` trong `DataGroupId` mới khi thực hiện thay đổi `DataGroupId`.
*   Tương tác với `IDataImportantRepository` và `IDataGroupRepository`.

**Cấu trúc `DataImportantManager.cs`:**

-   **Vị trí:** `src/Aqt.CoreFW.Domain/DataImportants/`
-   **Tệp:** Tạo file `DataImportantManager.cs`
-   **Nội dung:**
    ```csharp
    using System;
    using System.Threading.Tasks;
    using Aqt.CoreFW.DataImportants; // Namespaces cần thiết
    using Aqt.CoreFW.Domain.DataImportants.Entities;
    using Aqt.CoreFW.Domain.DataGroups; // Để inject IDataGroupRepository
    using JetBrains.Annotations;
    using Volo.Abp;
    using Volo.Abp.Domain.Services;
    using Volo.Abp.Guids;
    using Volo.Abp.Users; // Để inject ICurrentUser nếu cần kiểm tra quyền phức tạp hơn

    namespace Aqt.CoreFW.Domain.DataImportants;

    /// <summary>
    /// Domain service responsible for managing DataImportant entities.
    /// </summary>
    public class DataImportantManager : DomainService
    {
        private readonly IDataImportantRepository _dataImportantRepository;
        private readonly IDataGroupRepository _dataGroupRepository; // Inject repository của DataGroup
        private readonly IGuidGenerator _guidGenerator;
        // private readonly ICurrentUser _currentUser; // Inject nếu cần

        public DataImportantManager(
            IDataImportantRepository dataImportantRepository,
            IDataGroupRepository dataGroupRepository,
            IGuidGenerator guidGenerator/*,
            ICurrentUser currentUser*/)
        {
            _dataImportantRepository = dataImportantRepository;
            _dataGroupRepository = dataGroupRepository;
            _guidGenerator = guidGenerator;
            // _currentUser = currentUser;
        }

        /// <summary>
        /// Creates a new DataImportant entity after validating business rules.
        /// </summary>
        /// <param name="code">Unique code within the DataGroup.</param>
        /// <param name="name">Name.</param>
        /// <param name="dataGroupId">Parent DataGroup ID.</param>
        /// <param name="order">Display order.</param>
        /// <param name="description">Optional description.</param>
        /// <param name="status">Status.</param>
        /// <returns>The newly created DataImportant entity.</returns>
        /// <exception cref="UserFriendlyException">Thrown if business rules are violated.</exception>
        public async Task<DataImportant> CreateAsync(
            [NotNull] string code,
            [NotNull] string name,
            Guid dataGroupId,
            int order = 0,
            [CanBeNull] string? description = null,
            DataImportantStatus status = DataImportantStatus.Active)
        {
            Check.NotNullOrWhiteSpace(code, nameof(code), DataImportantConsts.MaxCodeLength);
            Check.NotNullOrWhiteSpace(name, nameof(name), DataImportantConsts.MaxNameLength);
            Check.Length(description, nameof(description), DataImportantConsts.MaxDescriptionLength);

            // 1. Validate DataGroup existence
            await ValidateDataGroupExistsAsync(dataGroupId);

            // 2. Validate Code uniqueness within the specified DataGroup
            await ValidateCodeUniquenessAsync(code, dataGroupId);

            var dataImportant = new DataImportant(
                _guidGenerator.Create(),
                code,
                name,
                dataGroupId,
                order,
                description,
                status
            );

            // Application Service sẽ gọi Repository.InsertAsync
            return dataImportant;
        }

        /// <summary>
        /// Updates an existing DataImportant entity after validating business rules.
        /// </summary>
        /// <param name="dataImportant">The entity to update.</param>
        /// <param name="name">New name.</param>
        /// <param name="dataGroupId">New parent DataGroup ID.</param>
        /// <param name="order">New display order.</param>
        /// <param name="description">New optional description.</param>
        /// <param name="status">New status.</param>
        /// <returns>The updated DataImportant entity.</returns>
        /// <exception cref="UserFriendlyException">Thrown if business rules are violated.</exception>
        public async Task<DataImportant> UpdateAsync(
            [NotNull] DataImportant dataImportant,
            [NotNull] string name,
            Guid dataGroupId, // Cho phép thay đổi DataGroup
            int order,
            [CanBeNull] string? description,
            DataImportantStatus status)
        {
            Check.NotNull(dataImportant, nameof(dataImportant));
            Check.NotNullOrWhiteSpace(name, nameof(name), DataImportantConsts.MaxNameLength);
            Check.Length(description, nameof(description), DataImportantConsts.MaxDescriptionLength);

            // 1. Validate DataGroup existence if it's changed AND check Code uniqueness in the NEW group
            if (dataImportant.DataGroupId != dataGroupId)
            {
                await ValidateDataGroupExistsAsync(dataGroupId);
                // Kiểm tra Code có bị trùng trong Group mới không (bỏ qua chính nó vì Code không đổi)
                await ValidateCodeUniquenessAsync(dataImportant.Code, dataGroupId, dataImportant.Id);
                dataImportant.SetDataGroupIdInternal(dataGroupId); // Change DataGroup ID via internal setter
            }

            // Update other properties
            dataImportant.SetName(name);
            dataImportant.SetOrder(order);
            dataImportant.SetDescription(description);

            if (status == DataImportantStatus.Active) dataImportant.Activate();
            else dataImportant.Deactivate();

            // Application Service sẽ gọi Repository.UpdateAsync
            return dataImportant;
        }

        /// <summary>
        /// Changes the DataGroup for an existing DataImportant.
        /// Ensures the code is unique in the new DataGroup.
        /// </summary>
        public async Task ChangeDataGroupAsync([NotNull] DataImportant dataImportant, Guid newDataGroupId)
        {
             Check.NotNull(dataImportant, nameof(dataImportant));

             if (dataImportant.DataGroupId == newDataGroupId)
             {
                 return; // No change needed
             }

             await ValidateDataGroupExistsAsync(newDataGroupId);
             await ValidateCodeUniquenessAsync(dataImportant.Code, newDataGroupId, dataImportant.Id); // Check uniqueness in new group

             dataImportant.SetDataGroupIdInternal(newDataGroupId);
             // Repository.UpdateAsync will be called by the Application Service
        }


        /// <summary>
        /// Helper method to validate if a DataGroup exists.
        /// </summary>
        private async Task ValidateDataGroupExistsAsync(Guid dataGroupId)
        {
            var dataGroupExists = await _dataGroupRepository.AnyAsync(dg => dg.Id == dataGroupId);
            if (!dataGroupExists)
            {
                 throw new UserFriendlyException(L["DataGroupNotFoundForImportant", dataGroupId]);
                // Hoặc dùng mã lỗi: throw new BusinessException(CoreFWDomainErrorCodes.DataGroupNotFoundForImportant).WithData("id", dataGroupId);
            }
        }

        /// <summary>
        /// Helper method to validate code uniqueness within a DataGroup.
        /// </summary>
        private async Task ValidateCodeUniquenessAsync([NotNull] string code, Guid dataGroupId, Guid? excludeId = null)
        {
             if (await _dataImportantRepository.CodeExistsAsync(code, dataGroupId, excludeId))
            {
                throw new UserFriendlyException(L["DataImportantCodeAlreadyExists", code]);
                // Hoặc dùng mã lỗi: throw new BusinessException(CoreFWDomainErrorCodes.DataImportantCodeAlreadyExists).WithData("code", code);
            }
        }
    }
    ```

## 4. Cập nhật `CoreFWDomainModule.cs`

-   **Vị trí:** `src/Aqt.CoreFW.Domain/CoreFWDomainModule.cs`
-   **Hành động:** Không cần thay đổi. ABP tự động đăng ký `DataImportantManager` và `IDataImportantRepository` (nếu được triển khai ở tầng EF Core) thông qua cơ chế quét và đăng ký tự động.

## 5. Lưu ý

*   **Tính duy nhất của `Code`:** Kế hoạch này tuân thủ yêu cầu `Code` duy nhất trong phạm vi `DataGroupId`. Điều này được phản ánh trong `IDataImportantRepository` và logic của `DataImportantManager`.
*   **Aggregate Root:** Việc chọn `FullAuditedAggregateRoot` được giữ lại theo mẫu `DataCore`. Cần xác nhận lại nếu `DataImportant` không nên là một Aggregate Root độc lập.
*   **Repository Dependency:** `DataImportantManager` phụ thuộc vào `IDataGroupRepository`. Đảm bảo `Aqt.CoreFW.Domain` có tham chiếu đến project chứa `IDataGroupRepository`.
*   **Error Handling:** Sử dụng `UserFriendlyException` với localization key hoặc `BusinessException` với Error Code đã định nghĩa trong `CoreFWDomainErrorCodes.DataImportants.cs`.
*   **Namespace:** Đảm bảo sử dụng đúng namespace cho các class và interface.
*   **Thay đổi DataGroup:** Đã thêm phương thức `ChangeDataGroupAsync` và logic kiểm tra tính duy nhất của Code trong Group mới vào `UpdateAsync` để xử lý việc thay đổi `DataGroupId`.
