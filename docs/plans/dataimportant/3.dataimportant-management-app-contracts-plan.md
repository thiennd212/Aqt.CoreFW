# Kế hoạch chi tiết: Tầng Application.Contracts (`Aqt.CoreFW.Application.Contracts`) - Quản lý Danh mục Dữ liệu Quan trọng (DataImportant Management)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Application.Contracts` cho module Quản lý Danh mục Dữ liệu Quan trọng (DataImportant).

## 1. DTOs

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Application.Contracts/DataImportants/Dtos` (Tạo thư mục `DataImportants/Dtos` nếu chưa có)
-   **Tệp 1:** Tạo file `DataImportantDto.cs`
    ```csharp
    using System;
    using Aqt.CoreFW.DataImportants; // Sử dụng Enum/Consts từ Domain.Shared namespace
    using Volo.Abp.Application.Dtos;

    namespace Aqt.CoreFW.Application.Contracts.DataImportants.Dtos;

    public class DataImportantDto : FullAuditedEntityDto<Guid> // Kế thừa FullAuditedEntityDto
    {
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public DataImportantStatus Status { get; set; }
        public int Order { get; set; }
        public string? Description { get; set; }
        public Guid DataGroupId { get; set; } // ID của nhóm dữ liệu

        // Thông tin bổ sung về nhóm dữ liệu (optional, được fill bởi AppService)
        public string? DataGroupName { get; set; } // Tên của DataGroup
        public string? DataGroupCode { get; set; } // Mã của DataGroup
    }
    ```
-   **Tệp 2:** Tạo file `CreateUpdateDataImportantDto.cs`
    ```csharp
    using System;
    using System.ComponentModel.DataAnnotations;
    using Aqt.CoreFW.DataImportants; // Sử dụng Enum/Consts từ Domain.Shared namespace

    namespace Aqt.CoreFW.Application.Contracts.DataImportants.Dtos;

    public class CreateUpdateDataImportantDto
    {
        [Required]
        [StringLength(DataImportantConsts.MaxCodeLength)]
        public string Code { get; set; } = string.Empty; // Bắt buộc khi tạo

        [Required]
        [StringLength(DataImportantConsts.MaxNameLength)]
        public string Name { get; set; } = string.Empty;

        [Required]
        public DataImportantStatus Status { get; set; } = DataImportantStatus.Active;

        [Required]
        public int Order { get; set; }

        [StringLength(DataImportantConsts.MaxDescriptionLength)]
        public string? Description { get; set; }

        [Required] // DataGroupId là bắt buộc
        public Guid DataGroupId { get; set; }
    }
    ```
-   **Tệp 3:** Tạo file `GetDataImportantsInput.cs`
    ```csharp
    using System;
    using Aqt.CoreFW.DataImportants; // Sử dụng Enum/Consts từ Domain.Shared namespace
    using Volo.Abp.Application.Dtos;

    namespace Aqt.CoreFW.Application.Contracts.DataImportants.Dtos;

    public class GetDataImportantsInput : PagedAndSortedResultRequestDto // Kế thừa để hỗ trợ phân trang và sắp xếp
    {
        public string? Filter { get; set; } // Filter theo Code hoặc Name
        public DataImportantStatus? Status { get; set; } // Filter theo Status
        public Guid? DataGroupId { get; set; } // Filter theo DataGroup ID chính xác
    }
    ```
-   **Tệp 4:** Tạo file `DataImportantExcelDto.cs` (Dùng cho xuất Excel - Optional)
    ```csharp
    using System;
    using MiniExcelLibs.Attributes;

    namespace Aqt.CoreFW.Application.Contracts.DataImportants.Dtos;

    /// <summary>
    /// DTO được thiết kế riêng cho việc xuất dữ liệu DataImportant ra Excel.
    /// </summary>
    public class DataImportantExcelDto
    {
        [ExcelColumnName("Mã DL Quan trọng")]
        public string Code { get; set; } = string.Empty;

        [ExcelColumnName("Tên DL Quan trọng")]
        public string Name { get; set; } = string.Empty;

        [ExcelColumnName("Mã Nhóm DL")]
        public string? DataGroupCode { get; set; }

        [ExcelColumnName("Tên Nhóm DL")]
        public string? DataGroupName { get; set; }

        [ExcelColumnName("Thứ tự")]
        public int Order { get; set; }

        [ExcelColumnName("Trạng thái")]
        public string StatusText { get; set; } = string.Empty; // Lấy từ localization

        [ExcelColumnName("Mô tả")]
        public string? Description { get; set; }

        // Có thể thêm các trường audit nếu cần
        // [ExcelColumnName("Ngày tạo")]
        // [ExcelFormat("yyyy-MM-dd HH:mm:ss")]
        // public DateTime CreationTime { get; set; }
    }
    ```
-   **Tệp 5:** Tạo file `DataImportantLookupDto.cs` (Dùng cho lookup, đặt trong thư mục dùng chung)
    -   **Vị trí:** `src/Aqt.CoreFW.Application.Contracts/Shared/Lookups/DataImportantLookupDto.cs` (Tạo thư mục `Shared/Lookups` nếu chưa có)
    -   **Nội dung:**
        ```csharp
        using System;
        using Volo.Abp.Application.Dtos;

        namespace Aqt.CoreFW.Application.Contracts.Shared.Lookups; // Namespace dùng chung

        // Dùng cho việc lookup DataImportant dạng danh sách phẳng (flat list) theo DataGroup
        public class DataImportantLookupDto : EntityDto<Guid>
        {
            public string Name { get; set; } = string.Empty;
            public string Code { get; set; } = string.Empty; // Thêm Code để dễ nhận biết
        }
        ```
-   **Tệp 6:** Sử dụng `DataGroupLookupDto` (Đã định nghĩa trong kế hoạch DataGroup)
    -   **Vị trí:** `src/Aqt.CoreFW.Application.Contracts/Shared/Lookups/DataGroupLookupDto.cs`
    -   **Mục đích:** Dùng để hiển thị danh sách DataGroup cho người dùng chọn khi tạo/sửa DataImportant.

## 2. AppService Interface (`IDataImportantAppService.cs`)

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Application.Contracts/DataImportants`
-   **Tệp:** Tạo file `IDataImportantAppService.cs`
    ```csharp
    using System;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Application.Contracts.DataImportants.Dtos; // Namespace chứa DTOs
    using Aqt.CoreFW.Application.Contracts.Shared.Lookups; // Namespace chứa DataGroupLookupDto và DataImportantLookupDto
    using Volo.Abp.Application.Dtos;
    using Volo.Abp.Application.Services;
    using Volo.Abp.Content; // Required for IRemoteStreamContent

    namespace Aqt.CoreFW.Application.Contracts.DataImportants;

    public interface IDataImportantAppService :
        ICrudAppService< // Kế thừa ICrudAppService cho CRUD cơ bản
            DataImportantDto,               // DTO hiển thị
            Guid,                           // Kiểu khóa chính
            GetDataImportantsInput,         // DTO lọc/phân trang
            CreateUpdateDataImportantDto>   // DTO tạo/cập nhật
    {
        /// <summary>
        /// Lấy danh sách DataImportant dạng phẳng (flat list) cho lookup theo DataGroupId.
        /// Chỉ trả về các DataImportant đang hoạt động.
        /// </summary>
        /// <param name="dataGroupId">ID của DataGroup cần lấy DataImportant.</param>
        Task<ListResultDto<DataImportantLookupDto>> GetLookupByDataGroupAsync(Guid dataGroupId);

        /// <summary>
        /// Lấy danh sách DataGroup dạng lookup (đã có trong IDataGroupAppService).
        /// Cần đảm bảo interface này có thể truy cập được.
        /// </summary>
        // Task<ListResultDto<DataGroupLookupDto>> GetDataGroupLookupAsync(); // Gọi qua IDataGroupAppService

        /// <summary>
        /// (Optional) Xuất danh sách DataImportant (dạng phẳng) ra file Excel dựa trên bộ lọc.
        /// </summary>
        Task<IRemoteStreamContent> GetListAsExcelAsync(GetDataImportantsInput input);
    }
    ```

## 3. Permissions

-   **Vị trí 1:** Cập nhật file `src/Aqt.CoreFW.Application.Contracts/Permissions/CoreFWPermissions.cs`
-   **Nội dung cần thêm:**
    ```csharp
    public static class CoreFWPermissions
    {
        public const string GroupName = "CoreFW";

        // ... các permission khác (Provinces, Districts, Communes, Ranks, DataGroups, DataCores) ...

        // Thêm định nghĩa permission cho DataImportants
        public static class DataImportants // Sử dụng tên class khớp với module
        {
            // Sử dụng convention đặt tên quyền: CoreFW.DataImportants
            public const string Default = GroupName + ".DataImportants"; // Quyền xem mặc định
            public const string Create = Default + ".Create";
            public const string Update = Default + ".Update";
            public const string Delete = Default + ".Delete";
            public const string Export = Default + ".Export";
        }
        // ... các module khác ...
    }
    ```
-   **Vị trí 2:** Cập nhật file `src/Aqt.CoreFW.Application.Contracts/Permissions/CoreFWPermissionDefinitionProvider.cs`
-   **Nội dung cần thêm vào phương thức `Define`:**
    ```csharp
    // ... Lấy context.GetGroup(CoreFWPermissions.GroupName);

    // Thêm định nghĩa permissions cho DataImportants
    var dataImportantPermission = coreFwGroup.AddPermission(CoreFWPermissions.DataImportants.Default, L("Permission:DataImportantManagement")); // Sử dụng key localization từ plan 1
    dataImportantPermission.AddChild(CoreFWPermissions.DataImportants.Create, L("Permission:DataImportants.Create"));
    dataImportantPermission.AddChild(CoreFWPermissions.DataImportants.Update, L("Permission:DataImportants.Update"));
    dataImportantPermission.AddChild(CoreFWPermissions.DataImportants.Delete, L("Permission:DataImportants.Delete"));
    dataImportantPermission.AddChild(CoreFWPermissions.DataImportants.Export, L("Permission:DataImportants.Export"));
    // ... các AddPermission khác ...
    ```

## 4. Lưu ý

*   **Namespaces:** Đảm bảo sử dụng đúng namespaces cho các DTOs, Interfaces và Permissions.
*   **DataAnnotations:** Sử dụng DataAnnotations (`[Required]`, `[StringLength]`) trên `CreateUpdateDataImportantDto` để validation cơ bản.
*   **Lookup DTOs:** `DataImportantLookupDto` chỉ chứa các trường cần thiết cho việc hiển thị trong dropdown khi đã chọn DataGroup. `DataGroupLookupDto` được tái sử dụng từ module DataGroup.
*   **Permissions:** Đảm bảo các keys localization (`L["Permission:..."]`) đã được định nghĩa trong tầng `Domain.Shared` (kế hoạch bước 1).
*   **Excel Export:** Việc triển khai `GetListAsExcelAsync` là tùy chọn và cần thư viện hỗ trợ (ví dụ: MiniExcel). Nếu không cần, có thể bỏ qua DTO `DataImportantExcelDto` và phương thức tương ứng trong interface.
*   **DataGroup Lookup:** Interface `IDataImportantAppService` không định nghĩa lại `GetDataGroupLookupAsync` vì logic này thuộc về `IDataGroupAppService` và nên được gọi từ đó để tránh trùng lặp và đảm bảo tính nhất quán.
