# Kế hoạch triển khai chức năng quản lý Thành phần thủ tục (ProcedureComponent) - v1

## 0. Phân tích nghiệp vụ

### 0.1. Mục tiêu
- Xây dựng chức năng cho phép người quản trị hệ thống hoặc người dùng được cấp quyền quản lý danh mục các Thành phần thủ tục (ProcedureComponent).
- Đảm bảo dữ liệu Thành phần thủ tục (Mã, Tên, Trạng thái, Thứ tự, Mô tả, Loại, FormDefinition, TempPath) là nhất quán và chính xác.
- Quản lý mối quan hệ nhiều-nhiều giữa Thành phần thủ tục và Thủ tục hành chính (Procedure).

### 0.2. Đối tượng sử dụng
- Quản trị viên hệ thống.
- Người dùng được cấp quyền quản lý danh mục Thành phần thủ tục.

### 0.3. Yêu cầu chức năng chính (CRUD + Liên kết)
- **Xem danh sách (Read):** Hiển thị danh sách các Thành phần thủ tục đã có trong hệ thống dưới dạng bảng. Hỗ trợ tìm kiếm theo Mã (`Code`) hoặc Tên (`Name`), lọc theo Trạng thái (`Status`), lọc theo Loại (`Type`). Hỗ trợ phân trang và sắp xếp theo các cột dữ liệu chính (Mã, Tên, Loại, Thứ tự, Trạng thái).
- **Thêm mới (Create):** Cho phép người dùng thêm một Thành phần thủ tục mới. Yêu cầu nhập Mã (`Code`), Tên (`Name`), Thứ tự hiển thị (`Order`), Loại (`Type`). Dựa vào Loại, yêu cầu nhập `FormDefinition` (nếu Loại là `Form`) hoặc `TempPath` (nếu Loại là `File`). Mô tả (`Description` - tùy chọn), Trạng thái (`Status`).
- **Sửa (Update):** Cho phép người dùng chỉnh sửa thông tin (Tên, Thứ tự, Mô tả, Trạng thái, Loại, FormDefinition, TempPath) của một Thành phần thủ tục đã tồn tại. Mã (`Code`) không được phép sửa sau khi tạo. Cập nhật `FormDefinition`/`TempPath` tương ứng khi Loại thay đổi.
- **Xóa (Delete):** Cho phép người dùng xóa một Thành phần thủ tục. Sử dụng cơ chế xóa mềm (Soft Delete). Cần có bước xác nhận trước khi xóa. Cần xem xét xử lý liên kết với Thủ tục hành chính.
- **Quản lý liên kết Thủ tục hành chính:** Trong màn hình sửa Thành phần thủ tục (hoặc một màn hình riêng), cho phép người dùng chọn/bỏ chọn các Thủ tục hành chính (Procedure) mà Thành phần này được áp dụng.
- **Xem chi tiết:** (Có thể tích hợp trong Sửa) Hiển thị đầy đủ thông tin của một Thành phần thủ tục, bao gồm danh sách các Thủ tục hành chính đang liên kết.

### 0.4. Yêu cầu dữ liệu (Dựa trên `docs/srs/component-srs.md`)
- **Mã (Code):**
    - Kiểu dữ liệu: Chuỗi (`string`).
    - Bắt buộc nhập.
    - Độ dài tối đa: `ComponentConsts.MaxCodeLength`. *(Giả định)*
    - Phải là duy nhất (unique) toàn hệ thống.
- **Tên (Name):**
    - Kiểu dữ liệu: Chuỗi (`string`).
    - Bắt buộc nhập.
    - Độ dài tối đa: `ComponentConsts.MaxNameLength`. *(Giả định)*
- **Trạng thái (Status):**
    - Kiểu dữ liệu: Enum `ComponentStatus` (`Active`, `Inactive`). *(Giả định)*
    - Bắt buộc.
    - Giá trị mặc định: `Active`.
- **Thứ tự hiển thị (Order):**
    - Kiểu dữ liệu: Số nguyên (`int`).
    - Bắt buộc.
    - Giá trị mặc định: `0`.
- **Mô tả (Description):**
    - Kiểu dữ liệu: Chuỗi (`string`).
    - Không bắt buộc.
    - Độ dài tối đa: `ComponentConsts.MaxDescriptionLength`. *(Giả định)*
- **Loại (Type):**
    - Kiểu dữ liệu: Enum `ComponentType` (`Form`, `File`). *(Giả định)*
    - Bắt buộc.
- **Định nghĩa Form (FormDefinition):**
    - Kiểu dữ liệu: Chuỗi (`string`), có thể là JSON.
    - Bắt buộc nếu `Type` là `Form`.
    - Có thể cần độ dài lớn (`TEXT` hoặc tương đương).
- **Đường dẫn Template (TempPath):**
    - Kiểu dữ liệu: Chuỗi (`string`).
    - Bắt buộc nếu `Type` là `File`.
    - Độ dài tối đa: `ComponentConsts.MaxTempPathLength`. *(Giả định)*
- **Liên kết Thủ tục hành chính (Procedures):**
    - Quan hệ Nhiều-Nhiều với `Procedure`.
    - Cần một bảng trung gian (ví dụ: `ProcedureProcedureComponent`) lưu `ProcedureId` và `ProcedureComponentId`.
- **Thông tin Audit:** Kế thừa từ `FullAuditedAggregateRoot<Guid>` để lưu thông tin tạo/sửa/xóa. *(Giả định Component là Aggregate Root)*

### 0.5. Yêu cầu giao diện người dùng (UI)
- **Màn hình danh sách:**
    - Ô tìm kiếm chung (lọc theo Mã hoặc Tên).
    - Bộ lọc Trạng thái (dropdown: "Tất cả", "Hoạt động", "Không hoạt động").
    - Bộ lọc Loại (dropdown: "Tất cả", "Form", "File").
    - Bảng hiển thị các cột: Mã, Tên, Loại, Thứ tự, Trạng thái.
    - Nút "Thêm mới Thành phần".
    - Các nút hành động (Sửa, Xóa) trên mỗi dòng của bảng.
    - Phân trang.
- **Modal Thêm mới/Sửa:**
    - Form nhập liệu cho Mã (chỉ cho phép nhập khi thêm mới), Tên, Thứ tự, Mô tả, Trạng thái (checkbox/radio), Loại (radio/dropdown).
    - Trường nhập `FormDefinition` (textarea, có thể hỗ trợ JSON editor) - chỉ hiển thị/bắt buộc khi Loại là `Form`.
    - Trường nhập `TempPath` (textbox, có thể có nút chọn file/đường dẫn) - chỉ hiển thị/bắt buộc khi Loại là `File`.
    - Tab/Khu vực riêng để quản lý liên kết với Thủ tục hành chính (ví dụ: bảng chọn nhiều dòng, dual listbox).
    - Các nút Lưu và Hủy.

### 0.6. Yêu cầu về phân quyền
- Định nghĩa nhóm quyền: `CoreFW.ComponentManagement`.
- Các quyền cụ thể:
    - `CoreFW.ComponentManagement.Components` (Quyền xem danh sách - mặc định)
    - `CoreFW.ComponentManagement.Components.Create`
    - `CoreFW.ComponentManagement.Components.Update`
    - `CoreFW.ComponentManagement.Components.Delete`
    - `CoreFW.ComponentManagement.Components.ManageProcedureLinks` *(Quyền quản lý liên kết với Thủ tục hành chính)*
- Giao diện cần ẩn/hiện các nút chức năng dựa trên quyền của người dùng đang đăng nhập.

### 0.7. Quy tắc nghiệp vụ
- Mã (`Code`) phải là duy nhất toàn hệ thống.
- Khi thêm mới hoặc sửa, phải kiểm tra tính duy nhất của Mã (bỏ qua bản ghi hiện tại khi sửa).
- Nếu `Type` là `Form`, `FormDefinition` là bắt buộc và `TempPath` phải là `null` hoặc rỗng.
- Nếu `Type` là `File`, `TempPath` là bắt buộc và `FormDefinition` phải là `null` hoặc rỗng.
- Khi xóa Thành phần, cần xem xét:
    - Chỉ xóa mềm (đánh dấu `IsDeleted = true`).
    - Có thể cần xóa các liên kết trong bảng trung gian `ProcedureProcedureComponent`.
- Khi cập nhật Loại, cần xóa dữ liệu ở trường không còn phù hợp (`FormDefinition` hoặc `TempPath`).
- Validate dữ liệu `FormDefinition` (ví dụ: kiểm tra có phải JSON hợp lệ không nếu quy định là JSON).

**Lưu ý chung:** Luôn luôn cập nhật kết quả mỗi bước sau khi hoàn thành vào tệp kế hoạch tương ứng.

## Tóm tắt Tiến độ Thực hiện Dự kiến

- [ ] **Bước 0: Kế hoạch tổng thể** - File này
- [ ] **Bước 1: Tầng Domain.Shared (`Aqt.CoreFW.Domain.Shared`)** - Xem chi tiết: `1.component-management-domain-shared-plan.md` (Chưa tạo)
- [ ] **Bước 2: Tầng Domain (`Aqt.CoreFW.Domain`)** - Xem chi tiết: `2.component-management-domain-plan.md` (Chưa tạo)
- [ ] **Bước 3: Tầng Application.Contracts (`Aqt.CoreFW.Application.Contracts`)** - Xem chi tiết: `3.component-management-app-contracts-plan.md` (Chưa tạo)
- [ ] **Bước 4: Tầng Application (`Aqt.CoreFW.Application`)** - Xem chi tiết: `4.component-management-application-plan.md` (Chưa tạo)
- [ ] **Bước 5: Tầng EntityFrameworkCore (`Aqt.CoreFW.EntityFrameworkCore`)** - Xem chi tiết: `5.component-management-efcore-plan.md` (Chưa tạo)
- [ ] **Bước 6: Tầng Web (`Aqt.CoreFW.Web`)** - Xem chi tiết: `6.component-management-web-plan.md` (Chưa tạo)
- [ ] **Bước 7: Các bước triển khai và kiểm thử cuối cùng (Thực hiện thủ công)** - Xem chi tiết: `7.component-management-final-steps-plan.md` (Chưa tạo) 