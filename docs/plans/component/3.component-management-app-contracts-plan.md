# Kế hoạch chi tiết: Tầng Application.Contracts (`Aqt.CoreFW.Application.Contracts`) - Quản lý Thành phần thủ tục (ProcedureComponent)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Application.Contracts` cho module Quản lý Thành phần thủ tục (ProcedureComponent).

## 1. DTOs

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Application.Contracts/Components/Dtos` (Tạo thư mục `Components/Dtos` nếu chưa có)
-   **Tệp 1:** Tạo file `ProcedureComponentDto.cs`
    ```csharp
    using System;
    using System.Collections.Generic; // For List<Guid>
    using Aqt.CoreFW.Components; // Sử dụng Enum/Consts từ Domain.Shared namespace
    using Volo.Abp.Application.Dtos;

    namespace Aqt.CoreFW.Application.Contracts.Components.Dtos;

    public class ProcedureComponentDto : FullAuditedEntityDto<Guid> // Kế thừa FullAuditedEntityDto
    {
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public ComponentStatus Status { get; set; }
        public int Order { get; set; }
        public string? Description { get; set; }
        public ComponentType Type { get; set; }
        public string? FormDefinition { get; set; } // Hiển thị nếu Type là Form
        public string? TempPath { get; set; } // Hiển thị nếu Type là File

        // Danh sách ID các Thủ tục hành chính liên kết (để hiển thị hoặc xử lý ở client)
        public List<Guid> ProcedureIds { get; set; } = new List<Guid>();
    }
    ```
-   **Tệp 2:** Tạo file `CreateUpdateProcedureComponentDto.cs`
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.ComponentModel.DataAnnotations;
    using Aqt.CoreFW.Components; // Sử dụng Enum/Consts từ Domain.Shared namespace

    namespace Aqt.CoreFW.Application.Contracts.Components.Dtos;

    public class CreateUpdateProcedureComponentDto
    {
        // Code chỉ bắt buộc và cho phép nhập khi tạo mới (AppService sẽ xử lý logic này)
        [Required(AllowEmptyStrings = false)] // Bắt buộc khi Create
        [StringLength(ComponentConsts.MaxCodeLength)]
        public string Code { get; set; } = string.Empty;

        [Required(AllowEmptyStrings = false)]
        [StringLength(ComponentConsts.MaxNameLength)]
        public string Name { get; set; } = string.Empty;

        [Required]
        public ComponentStatus Status { get; set; } = ComponentStatus.Active;

        [Required]
        public int Order { get; set; }

        [StringLength(ComponentConsts.MaxDescriptionLength)]
        public string? Description { get; set; }

        [Required]
        public ComponentType Type { get; set; }

        // FormDefinition: Bắt buộc nếu Type là Form. Validation logic sẽ ở AppService.
        // Có thể thêm [RequiredIf] hoặc Custom Validation nếu dùng thư viện hỗ trợ.
        public string? FormDefinition { get; set; }

        // TempPath: Bắt buộc nếu Type là File. Validation logic sẽ ở AppService.
        [StringLength(ComponentConsts.MaxTempPathLength)]
        public string? TempPath { get; set; }

        // Danh sách ID các Thủ tục hành chính cần liên kết với Component này.
        // AppService sẽ dùng danh sách này để gọi ProcedureComponentManager.UpdateProcedureLinksAsync
        [Required] // Yêu cầu phải có danh sách (có thể rỗng)
        public List<Guid> ProcedureIds { get; set; } = new List<Guid>();
    }
    ```
-   **Tệp 3:** Tạo file `GetProcedureComponentsInput.cs`
    ```csharp
    using System;
    using Aqt.CoreFW.Components; // Sử dụng Enum/Consts từ Domain.Shared namespace
    using Volo.Abp.Application.Dtos;

    namespace Aqt.CoreFW.Application.Contracts.Components.Dtos;

    public class GetProcedureComponentsInput : PagedAndSortedResultRequestDto // Kế thừa để hỗ trợ phân trang và sắp xếp
    {
        public string? Filter { get; set; } // Filter theo Code hoặc Name
        public ComponentStatus? Status { get; set; } // Filter theo Status
        public ComponentType? Type { get; set; } // Filter theo Type
        public Guid? ProcedureId { get; set; } // Filter theo Procedure liên kết
    }
    ```
-   **Tệp 4:** Tạo file `ProcedureComponentExcelDto.cs` (Dùng cho xuất Excel - Optional)
    ```csharp
    using System;
    using MiniExcelLibs.Attributes; // Giả sử dùng MiniExcel

    namespace Aqt.CoreFW.Application.Contracts.Components.Dtos;

    /// <summary>
    /// DTO được thiết kế riêng cho việc xuất dữ liệu ProcedureComponent ra Excel.
    /// </summary>
    public class ProcedureComponentExcelDto
    {
        [ExcelColumnName("Mã Thành phần")]
        public string Code { get; set; } = string.Empty;

        [ExcelColumnName("Tên Thành phần")]
        public string Name { get; set; } = string.Empty;

        [ExcelColumnName("Thứ tự")]
        public int Order { get; set; }

        [ExcelColumnName("Loại")] // Loại (Form/File)
        public string TypeText { get; set; } = string.Empty; // Lấy từ localization

        [ExcelColumnName("Trạng thái")]
        public string StatusText { get; set; } = string.Empty; // Lấy từ localization

        [ExcelColumnName("Mô tả")]
        public string? Description { get; set; }

        [ExcelColumnName("Định nghĩa Form (JSON)")] // Có thể không cần nếu quá dài
        public string? FormDefinition { get; set; }

        [ExcelColumnName("Đường dẫn Template")]
        public string? TempPath { get; set; }

        // Có thể thêm các trường audit nếu cần
        // [ExcelColumnName("Ngày tạo")]
        // [ExcelFormat("yyyy-MM-dd HH:mm:ss")]
        // public DateTime CreationTime { get; set; }
    }
    ```
-   **Tệp 5:** Tạo file `ProcedureComponentLookupDto.cs` (Dùng cho lookup, đặt trong thư mục dùng chung)
    -   **Vị trí:** `src/Aqt.CoreFW.Application.Contracts/Shared/Lookups/ProcedureComponentLookupDto.cs` (Tạo thư mục `Shared/Lookups` nếu chưa có)
    -   **Nội dung:**
        ```csharp
        using System;
        using Aqt.CoreFW.Components; // Để lấy Enum Type nếu cần
        using Volo.Abp.Application.Dtos;

        namespace Aqt.CoreFW.Application.Contracts.Shared.Lookups; // Namespace dùng chung

        // Dùng cho việc lookup ProcedureComponents dạng danh sách phẳng (flat list)
        public class ProcedureComponentLookupDto : EntityDto<Guid>
        {
            public string Name { get; set; } = string.Empty;
            public string Code { get; set; } = string.Empty; // Thêm Code để dễ nhận biết
            public ComponentType Type { get; set; } // Thêm Type để có thể lọc ở client nếu cần
        }
        ```

## 2. AppService Interface (`IProcedureComponentAppService.cs`)

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Application.Contracts/Components`
-   **Tệp:** Tạo file `IProcedureComponentAppService.cs`
    ```csharp
    using System;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Application.Contracts.Components.Dtos; // Namespace chứa DTOs
    using Aqt.CoreFW.Application.Contracts.Shared.Lookups; // Namespace chứa LookupDto
    using Aqt.CoreFW.Components; // Namespace chứa ComponentType Enum
    using Volo.Abp.Application.Dtos;
    using Volo.Abp.Application.Services;
    using Volo.Abp.Content; // Required for IRemoteStreamContent (Excel export)

    namespace Aqt.CoreFW.Application.Contracts.Components;

    public interface IProcedureComponentAppService :
        ICrudAppService< // Kế thừa ICrudAppService cho CRUD cơ bản
            ProcedureComponentDto,          // DTO hiển thị chi tiết
            Guid,                           // Kiểu khóa chính
            GetProcedureComponentsInput,    // DTO lọc/phân trang
            CreateUpdateProcedureComponentDto> // DTO tạo/cập nhật (bao gồm cả ProcedureIds)
    {
        /// <summary>
        /// Lấy danh sách ProcedureComponents dạng phẳng (flat list) cho lookup.
        /// Có thể lọc theo loại (Form/File) và chỉ lấy các component đang hoạt động.
        /// </summary>
        /// <param name="type">Lọc theo loại ComponentType (tùy chọn).</param>
        Task<ListResultDto<ProcedureComponentLookupDto>> GetLookupAsync(ComponentType? type = null);

        /// <summary>
        /// (Optional) Xuất danh sách ProcedureComponents ra file Excel dựa trên bộ lọc.
        /// </summary>
        Task<IRemoteStreamContent> GetListAsExcelAsync(GetProcedureComponentsInput input);

        // Ghi chú: Việc cập nhật liên kết Procedure-Component được xử lý thông qua
        // trường ProcedureIds trong CreateUpdateProcedureComponentDto khi gọi phương thức
        // CreateAsync hoặc UpdateAsync (từ ICrudAppService).
        // Không cần phương thức riêng biệt ở đây trừ khi có logic đặc biệt.
    }
    ```

## 3. Permissions

-   **Vị trí 1:** Cập nhật file `src/Aqt.CoreFW.Application.Contracts/Permissions/CoreFWPermissions.cs`
-   **Nội dung cần thêm (bên trong class `CoreFWPermissions`):**
    ```csharp
    // ... các permission khác ...

    // Thêm định nghĩa permission cho Components
    public static class Components // Sử dụng tên class khớp với module
    {
        // Group Permission Name: CoreFW.ComponentManagement (Từ kế hoạch 0)
        // Prefix: CoreFW.Components
        public const string Default = GroupName + ".Components"; // Quyền xem mặc định
        public const string Create = Default + ".Create";
        public const string Update = Default + ".Update";
        public const string Delete = Default + ".Delete";
        public const string ManageProcedureLinks = Default + ".ManageProcedureLinks"; // Quyền quản lý liên kết
        public const string Export = Default + ".Export"; // Quyền xuất Excel (Optional)
    }
    // ... các module khác ...
    ```
-   **Vị trí 2:** Cập nhật file `src/Aqt.CoreFW.Application.Contracts/Permissions/CoreFWPermissionDefinitionProvider.cs`
-   **Nội dung cần thêm vào phương thức `Define`:**
    ```csharp
    // ... Lấy context.GetGroup(CoreFWPermissions.GroupName);

    // Thêm định nghĩa permissions cho Components
    // Sử dụng key localization từ plan 1 (Domain.Shared)
    var componentsPermissionGroup = coreFwGroup.AddPermission(CoreFWPermissions.Components.Default, L("Permission:Components"));
    componentsPermissionGroup.AddChild(CoreFWPermissions.Components.Create, L("Permission:Components.Create"));
    componentsPermissionGroup.AddChild(CoreFWPermissions.Components.Update, L("Permission:Components.Update"));
    componentsPermissionGroup.AddChild(CoreFWPermissions.Components.Delete, L("Permission:Components.Delete"));
    // Quyền quản lý liên kết là con của quyền Update hoặc quyền Default tùy theo logic nghiệp vụ
    // Ví dụ: là con của Update nếu chỉ cho phép quản lý link khi đang sửa component
    componentsPermissionGroup.AddChild(CoreFWPermissions.Components.ManageProcedureLinks, L("Permission:Components.ManageProcedureLinks"));
    componentsPermissionGroup.AddChild(CoreFWPermissions.Components.Export, L("Permission:Components.Export")); // Optional

    // ... các AddPermission khác ...
    ```

## 4. Lưu ý

*   **Namespaces:** Đảm bảo sử dụng đúng namespaces cho các DTOs, Interfaces và Permissions (`Aqt.CoreFW.Application.Contracts.Components`, `Aqt.CoreFW.Application.Contracts.Shared.Lookups`).
*   **Validation:** Sử dụng DataAnnotations trên `CreateUpdateProcedureComponentDto` cho validation cơ bản. Validation phức tạp hơn (ví dụ: `FormDefinition`/`TempPath` dựa trên `Type`) sẽ được thực hiện trong tầng Application Service, có thể gọi Domain Service (`ProcedureComponentManager`) để kiểm tra.
*   **Many-to-Many:** Trường `ProcedureIds` trong `CreateUpdateProcedureComponentDto` được dùng để truyền danh sách ID các Thủ tục cần liên kết. Logic cập nhật liên kết thực tế sẽ nằm trong Application Service, gọi `ProcedureComponentManager.UpdateProcedureLinksAsync`. `ProcedureComponentDto` cũng bao gồm `ProcedureIds` để trả về thông tin liên kết hiện tại cho client.
*   **Lookup DTO:** `ProcedureComponentLookupDto` được đặt trong namespace dùng chung `Shared.Lookups` và chỉ chứa các trường cần thiết.
*   **Permissions:** Đảm bảo các tên quyền (constants) và các keys localization (`L["Permission:..."]`) khớp với định nghĩa ở tầng `Domain.Shared` (kế hoạch bước 1) và kế hoạch tổng thể (bước 0).
*   **Excel Export:** Là tùy chọn. Nếu triển khai, cần cấu hình thư viện Excel (như MiniExcel) và xử lý logic tạo file trong Application Service.
*   **ICrudAppService:** Kế thừa `ICrudAppService` cung cấp các phương thức CRUD chuẩn (`GetAsync`, `GetListAsync`, `CreateAsync`, `UpdateAsync`, `DeleteAsync`). Việc xử lý logic đặc thù (như kiểm tra `Code` khi tạo, gọi `UpdateProcedureLinksAsync` khi tạo/sửa) cần được thực hiện trong implementation của các phương thức này ở tầng Application.