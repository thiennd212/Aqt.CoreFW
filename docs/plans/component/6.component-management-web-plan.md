# Kế hoạch chi tiết: Tầng Web (`Aqt.CoreFW.Web`) - Quản lý Thành phần thủ tục (ProcedureComponent)

Phần này mô tả các thành phần cần tạo hoặc cập nhật trong tầng `Aqt.CoreFW.Web` cho module Quản lý Thành phần thủ tục (ProcedureComponent).

## 1. Cấu hình AutoMapper (Web Layer)

-   **Mục đích:** Định nghĩa cách chuyển đổi giữa ViewModel (`ProcedureComponentViewModel`) và DTO (`CreateUpdateProcedureComponentDto`, `ProcedureComponentDto`).
-   **Vị trí:** Cập nhật file `src/Aqt.CoreFW.Web/CoreFWWebAutoMapperProfile.cs`
-   **Nội dung cần thêm:**
    ```csharp
    using Aqt.CoreFW.Application.Contracts.Components.Dtos; // Component DTOs
    using Aqt.CoreFW.Web.Pages.Components.ViewModels;     // Component ViewModel
    // ... other necessary usings ...

    public class CoreFWWebAutoMapperProfile : Profile
    {
        public CoreFWWebAutoMapperProfile()
        {
            // ... existing mappings ...

            // Thêm mapping cho ProcedureComponent ViewModel <-> DTO
            CreateMap<ProcedureComponentViewModel, CreateUpdateProcedureComponentDto>();
            CreateMap<ProcedureComponentDto, ProcedureComponentViewModel>();

            // Mapping cho Lookup DTO của Procedure sang SelectListItem (nếu dùng dropdown)
            // CreateMap<ProcedureLookupDto, SelectListItem>()
            //    .ForMember(dest => dest.Value, opt => opt.MapFrom(src => src.Id.ToString()))
            //    .ForMember(dest => dest.Text, opt => opt.MapFrom(src => $"{src.Code} - {src.Name}"));
        }
    }
    ```

## 2. Menu

-   **Vị trí 1:** Cập nhật file `src/Aqt.CoreFW.Web/Menus/CoreFWMenus.cs`
-   **Nội dung cần thêm:**
    ```csharp
    public class CoreFWMenus
    {
        private const string Prefix = "CoreFW";
        public const string Home = Prefix + ".Home";
        // ... existing menu items (Procedures, Provinces, ...) ...
        public const string Components = Prefix + ".Components"; // Menu item for Component
    }
    ```
-   **Vị trí 2:** Cập nhật file `src/Aqt.CoreFW.Web/Menus/CoreFWMenuContributor.cs`
-   **Nội dung cần thêm trong phương thức `ConfigureMainMenuAsync` (đặt trong nhóm quản lý danh mục hoặc nhóm tương tự):**
    ```csharp
    // ... inside CoreFWMenuContributor class, inside ConfigureMainMenuAsync ...

    var administrationMenu = context.Menu.GetAdministration(); // Hoặc menu khác
    // Hoặc: var catalogManagementMenu = context.Menu.GetMenuItem(CatalogManagementMenus.GroupName);

    // Thêm menu Components vào dưới menu Procedures (ví dụ)
    if (await context.IsGrantedAsync(CoreFWPermissions.Components.Default)) // Check Components permission
    {
        // Giả sử thêm vào menu Administration
        administrationMenu.AddItem( // Hoặc catalogManagementMenu.AddItem(...)
             new ApplicationMenuItem(
                 CoreFWMenus.Components,    // Menu constant
                 l["Menu:Components"],       // Localization key: "Thành phần thủ tục"
                 "/Components",             // Đường dẫn tới trang Index
                 icon: "fas fa-puzzle-piece", // Chọn icon phù hợp
                 order: 11 // Đặt sau Procedures (ví dụ)
             ).RequirePermissions(CoreFWPermissions.Components.Default) // Có thể thêm require permission ở đây
         );

         // Hoặc thêm như một submenu của Procedure Management (nếu có menu cha)
         /*
         var procedureManagementMenu = context.Menu.GetMenuItem(CoreFWMenus.ProcedureManagement); // Giả định có menu cha
         if (procedureManagementMenu != null && await context.IsGrantedAsync(CoreFWPermissions.Components.Default))
         {
             procedureManagementMenu.AddItem(
                 new ApplicationMenuItem(
                     CoreFWMenus.Components,
                     l["Menu:Components"],
                     "/Components",
                     icon: "fas fa-puzzle-piece",
                     order: 2 // Thứ tự trong submenu
                 )
             );
         }
         */
    }

    // ... other menu items ...
    ```

## 3. Razor Pages và ViewModels

-   **Vị trí:** Tạo thư mục `src/Aqt.CoreFW.Web/Pages/Components`

-   **Tệp 1: ViewModel:** Tạo file `ProcedureComponentViewModel.cs` (trong thư mục **`Pages/Components/ViewModels`**)
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.ComponentModel.DataAnnotations;
    using Aqt.CoreFW.Components; // Consts/Enum for Component
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.AspNetCore.Mvc.Rendering; // For SelectListItem
    using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form;

    namespace Aqt.CoreFW.Web.Pages.Components.ViewModels;

    public class ProcedureComponentViewModel
    {
        [HiddenInput]
        public Guid? Id { get; set; }

        [Required(AllowEmptyStrings = false)]
        [StringLength(ComponentConsts.MaxCodeLength)]
        [Display(Name = "DisplayName:Component.Code")]
        // Thêm thuộc tính để không cho sửa Code trên form Edit
        [BindProperty(SupportsGet = true)] // Cần thiết để không bị mất giá trị khi postback validation fail
        [ReadOnlyInput] // Thuộc tính của ABP Tag Helper để vô hiệu hóa input
        public string Code { get; set; } = string.Empty;

        [Required(AllowEmptyStrings = false)]
        [StringLength(ComponentConsts.MaxNameLength)]
        [Display(Name = "DisplayName:Component.Name")]
        public string Name { get; set; } = string.Empty;

        [Required]
        [Display(Name = "DisplayName:Component.Order")]
        public int Order { get; set; }

        [Required]
        [Display(Name = "DisplayName:Component.Status")]
        public ComponentStatus Status { get; set; } = ComponentStatus.Active;

        [StringLength(ComponentConsts.MaxDescriptionLength)]
        [Display(Name = "DisplayName:Component.Description")]
        [DataType(DataType.MultilineText)]
        public string? Description { get; set; }

        [Required]
        [Display(Name = "DisplayName:Component.Type")]
        // Thêm attribute để kích hoạt JS thay đổi hiển thị FormDefinition/TempPath
        [InputInfoText("Changing the type will clear the corresponding content field.")] // Optional info text
        public ComponentType Type { get; set; }

        [Display(Name = "DisplayName:Component.FormDefinition")]
        [DataType(DataType.MultilineText)] // Cho phép nhập nhiều dòng
        // Validation RequiredIf Type is Form sẽ xử lý ở PageModel/JS hoặc Custom Attribute
        public string? FormDefinition { get; set; }

        [Display(Name = "DisplayName:Component.TempPath")]
        [StringLength(ComponentConsts.MaxTempPathLength)]
        // Validation RequiredIf Type is File sẽ xử lý ở PageModel/JS hoặc Custom Attribute
        public string? TempPath { get; set; }

        [Required] // Luôn yêu cầu có danh sách, dù là rỗng
        [Display(Name = "DisplayName:Component.Procedures")]
        // Sử dụng List<Guid> để lưu các ID được chọn
        public List<Guid> ProcedureIds { get; set; } = new List<Guid>();

        // Property để giữ danh sách Procedures cho việc lựa chọn (không bind khi POST)
        // Sẽ được đổ dữ liệu từ PageModel
        public List<SelectListItem> AvailableProcedures { get; set; } = new List<SelectListItem>();
    }
    ```

-   **Tệp 2: Trang danh sách:** Tạo file `Index.cshtml`
    ```cshtml
    @page
    @using Aqt.CoreFW.Permissions
    @using Microsoft.AspNetCore.Authorization
    @using Volo.Abp.AspNetCore.Mvc.UI.Layout
    @using Aqt.CoreFW.Web.Pages.Components // Updated namespace
    @using Aqt.CoreFW.Localization
    @using Microsoft.Extensions.Localization
    @using Aqt.CoreFW.Web.Menus
    @using Aqt.CoreFW.Components // Updated namespace for Enum
    @model IndexModel
    @inject IStringLocalizer<CoreFWResource> L
    @inject IAuthorizationService AuthorizationService
    @inject IPageLayout PageLayout
    @{
        PageLayout.Content.Title = L["Components"].Value; // Updated Title key
        PageLayout.Content.MenuItemName = CoreFWMenus.Components; // Updated menu item
    }

    @section scripts {
        <script>
            // Pass permissions to JS
            const permissions = {
                canEdit:   @Html.Raw(ViewData["CanEdit"]),
                canDelete: @Html.Raw(ViewData["CanDelete"]),
                canManageLinks: @Html.Raw(ViewData["CanManageLinks"]) // Thêm quyền quản lý link
            };
        </script>
        <abp-script src="/Pages/Components/index.js" /> @* Updated JS path *@
    }

    @section content_toolbar {
        @if (await AuthorizationService.IsGrantedAsync(CoreFWPermissions.Components.Create)) // Updated permission
        {
            <abp-button id="NewComponentButton" @* Updated ID *@
                        text="@L["NewComponent"].Value" @* Updated text key *@
                        icon="plus"
                        button-type="Primary" size="Small"/>
        }
        @if (await AuthorizationService.IsGrantedAsync(CoreFWPermissions.Components.Export)) // Updated permission
        {
            <abp-button id="ExportExcelButton"
                        text="@L["ExportToExcel"].Value"
                        icon="file-excel"
                        button-type="Success" size="Small" class="ms-2"/>
        }
    }

    <abp-card>
        <abp-card-body>
            <abp-row class="mb-3">
                <abp-column size-md="_4">
                    <input type="text" id="SearchFilter" class="form-control form-control-sm" placeholder="@L["Search"] (@L["DisplayName:Component.Code"], @L["DisplayName:Component.Name"])..." /> @* Updated display names *@
                </abp-column>
                 <abp-column size-md="_3">
                    <select id="TypeFilter" class="form-select form-select-sm">
                        <option value="">@L["All"] (@L["DisplayName:Component.Type"])</option> @* Updated display name *@
                        <option value="@((byte)ComponentType.Form)">@L["Enum:ComponentType.0"]</option> @* Updated enum/key *@
                        <option value="@((byte)ComponentType.File)">@L["Enum:ComponentType.1"]</option> @* Updated enum/key *@
                    </select>
                </abp-column>
                <abp-column size-md="_3">
                    <select id="StatusFilter" class="form-select form-select-sm">
                        <option value="">@L["All"] (@L["DisplayName:Component.Status"])</option> @* Updated display name *@
                        <option value="@((byte)ComponentStatus.Active)">@L["Enum:ComponentStatus.1"]</option> @* Updated enum/key *@
                        <option value="@((byte)ComponentStatus.Inactive)">@L["Enum:ComponentStatus.0"]</option> @* Updated enum/key *@
                    </select>
                </abp-column>
                <abp-column size-md="_2" class="text-end">
                    <abp-button id="SearchButton"
                                text="@L["Search"].Value"
                                icon="search"
                                button-type="Info" size="Small"/>
                </abp-column>
            </abp-row>
            <abp-table striped-rows="true" id="ComponentTable"></abp-table> @* Updated table ID *@
        </abp-card-body>
    </abp-card>
    ```

-   **Tệp 3: PageModel danh sách:** Tạo file `Index.cshtml.cs`
    ```csharp
    using System.Threading.Tasks;
    using Aqt.CoreFW.Permissions; // Using cho Permissions
    using Microsoft.AspNetCore.Authorization;
    using Volo.Abp.AspNetCore.Mvc.UI.RazorPages;

    namespace Aqt.CoreFW.Web.Pages.Components; // Updated namespace

    public class IndexModel : AbpPageModel
    {
        private readonly IAuthorizationService _authorizationService;

        public IndexModel(IAuthorizationService authorizationService)
        {
            _authorizationService = authorizationService;
        }

        public async Task OnGetAsync()
        {
            // Truyền permissions vào JS qua ViewData
            ViewData["CanEdit"] = (await _authorizationService.IsGrantedAsync(CoreFWPermissions.Components.Update)).ToString().ToLowerInvariant(); // Updated permission
            ViewData["CanDelete"] = (await _authorizationService.IsGrantedAsync(CoreFWPermissions.Components.Delete)).ToString().ToLowerInvariant(); // Updated permission
            ViewData["CanManageLinks"] = (await _authorizationService.IsGrantedAsync(CoreFWPermissions.Components.ManageProcedureLinks)).ToString().ToLowerInvariant(); // Thêm quyền link
        }
    }
    ```

-   **Tệp 4: Modal Thêm mới:** Tạo file `CreateModal.cshtml`
    ```cshtml
    @page "/Components/CreateModal" @* Updated path *@
    @using Microsoft.AspNetCore.Mvc.Localization
    @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
    @using Aqt.CoreFW.Localization
    @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form
    @using Aqt.CoreFW.Web.Pages.Components.ViewModels // Updated namespace
    @using Aqt.CoreFW.Components // For Enum
    @model CreateModalModel
    @inject IHtmlLocalizer<CoreFWResource> L
    @{ Layout = null; }

    @* Sử dụng abp-dynamic-form để tích hợp với ModalManager và AJAX submit *@
    <abp-dynamic-form abp-model="ComponentViewModel" asp-page="/Components/CreateModal" id="CreateComponentForm"> @* Updated model/page/id *@
        <abp-modal size="Large"> @* Có thể cần modal lớn hơn *@
            <abp-modal-header title="@L["NewComponent"].Value"></abp-modal-header> @* Updated title key *@
            <abp-modal-body>
                 @* Định nghĩa thủ công các trường input thay vì dùng <abp-form-content /> *@
                 <abp-input asp-for="Code" />
                 <abp-input asp-for="Name" />
                 <abp-input asp-for="Order" />
                 <abp-select asp-for="Status" /> @* Select cho Enum Status *@
                 <abp-input asp-for="Description" />
                 @* Input cho Type - Cần thêm JS để xử lý show/hide *@
                 <abp-select asp-for="Type" asp-items="Html.GetEnumSelectList<ComponentType>()" label="@L["DisplayName:Component.Type"].Value" name="ComponentViewModel.Type" id="ComponentTypeSelect"/>
                 @* Input cho FormDefinition - Chỉ hiển thị khi Type = Form *@
                 <div id="FormDefinitionGroup" style="display: none;"> @* Thêm ID và style *@
                    <abp-input asp-for="FormDefinition" />
                 </div>
                 @* Input cho TempPath - Chỉ hiển thị khi Type = File *@
                 <div id="TempPathGroup" style="display: none;"> @* Thêm ID và style *@
                    <abp-input asp-for="TempPath" />
                 </div>
                 @* Input để chọn Procedures liên kết *@
                 @* Lựa chọn 1: Multi-select dropdown (cần thư viện như Select2) *@
                 <abp-select asp-for="ProcedureIds"
                             asp-items="Model.ComponentViewModel.AvailableProcedures"
                             label="@L["DisplayName:Component.Procedures"].Value"
                             name="ComponentViewModel.ProcedureIds"
                             class="select2-multiple" @* Thêm class cho JS Select2 *@
                             multiple="true" /> @* Cho phép chọn nhiều *@

                 @* Lựa chọn 2: Checkbox list (tùy chỉnh) - cần code Razor phức tạp hơn *@

            </abp-modal-body>
            <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
        </abp-modal>
    </abp-dynamic-form>

    @* Script sẽ được load từ file riêng (createModal.js) khi sử dụng lazy loading trong ModalManager *@
    ```

-   **Tệp 5: PageModel Thêm mới:** Tạo file `CreateModal.cshtml.cs`
    ```csharp
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Application.Contracts.Components; // Updated AppService Interface
    using Aqt.CoreFW.Application.Contracts.Components.Dtos; // Updated DTOs
    using Aqt.CoreFW.Application.Contracts.Procedures; // Interface Procedure AppService
    using Aqt.CoreFW.Web.Pages.Components.ViewModels; // Updated ViewModel
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.AspNetCore.Mvc.Rendering;
    using Volo.Abp.AspNetCore.Mvc.UI.RazorPages;
    using Aqt.CoreFW.Components; // Updated Enum

    namespace Aqt.CoreFW.Web.Pages.Components; // Updated namespace

    public class CreateModalModel : AbpPageModel
    {
        [BindProperty]
        public ProcedureComponentViewModel ComponentViewModel { get; set; } = new(); // Updated ViewModel

        private readonly IProcedureComponentAppService _componentAppService; // Updated AppService
        private readonly IProcedureAppService _procedureAppService; // Service để lấy lookup Procedures

        public CreateModalModel(
            IProcedureComponentAppService componentAppService,
            IProcedureAppService procedureAppService)
        {
            _componentAppService = componentAppService;
            _procedureAppService = procedureAppService;
        }

        public async Task OnGetAsync()
        {
            ComponentViewModel = new ProcedureComponentViewModel { Status = ComponentStatus.Active }; // Set default
            await LoadAvailableProceduresAsync();
        }

        public async Task<IActionResult> OnPostAsync()
        {
            // Manual validation for Type/Content consistency if needed
            ValidateViewModel();

            if (!ModelState.IsValid)
            {
                await LoadAvailableProceduresAsync(); // Load lại lookup khi validation fail
                return Page();
            }
            var dto = ObjectMapper.Map<ProcedureComponentViewModel, CreateUpdateProcedureComponentDto>(ComponentViewModel); // Updated map
            await _componentAppService.CreateAsync(dto); // Updated service call
            return NoContent(); // Thành công
        }

        private async Task LoadAvailableProceduresAsync()
        {
             var lookupResult = await _procedureAppService.GetLookupAsync();
             ComponentViewModel.AvailableProcedures = lookupResult.Items
                 .Select(p => new SelectListItem( $"{p.Code} - {p.Name}", p.Id.ToString()))
                 .ToList();
        }

         private void ValidateViewModel()
         {
             if (ComponentViewModel.Type == ComponentType.Form && string.IsNullOrWhiteSpace(ComponentViewModel.FormDefinition))
             {
                 ModelState.AddModelError($"{nameof(ComponentViewModel)}.{nameof(ComponentViewModel.FormDefinition)}", "Form Definition is required when Type is Form.");
             }
             if (ComponentViewModel.Type == ComponentType.File && string.IsNullOrWhiteSpace(ComponentViewModel.TempPath))
             {
                  ModelState.AddModelError($"{nameof(ComponentViewModel)}.{nameof(ComponentViewModel.TempPath)}", "Template Path is required when Type is File.");
             }
         }
    }
    ```

-   **Tệp 6: Modal Sửa:** Tạo file `EditModal.cshtml`
    ```cshtml
    @page "/Components/EditModal" @* Updated path *@
    @using Microsoft.AspNetCore.Mvc.Localization
    @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal
    @using Aqt.CoreFW.Localization
    @using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form
    @using Aqt.CoreFW.Web.Pages.Components.ViewModels // Updated namespace
    @using Aqt.CoreFW.Components // For Enum
    @model EditModalModel
    @inject IHtmlLocalizer<CoreFWResource> L
    @{ Layout = null; }

    @* Sử dụng abp-dynamic-form để tích hợp với ModalManager và AJAX submit *@
    <abp-dynamic-form abp-model="ComponentViewModel" asp-page="/Components/EditModal" id="EditComponentForm"> @* Updated model/page/id *@
         <abp-modal size="Large"> @* Có thể cần modal lớn hơn *@
            <abp-modal-header title="@L["EditComponent"].Value"></abp-modal-header> @* Updated title key *@
            <abp-modal-body>
                <abp-input asp-for="Id" /> @* Hidden ID *@
                @* Định nghĩa thủ công các trường input *@
                <abp-input asp-for="Code" readonly="true" />
                <abp-input asp-for="Name" />
                <abp-input asp-for="Order" />
                <abp-select asp-for="Status" />
                <abp-input asp-for="Description" />
                <abp-select asp-for="Type" asp-items="Html.GetEnumSelectList<ComponentType>()" label="@L["DisplayName:Component.Type"].Value" name="ComponentViewModel.Type" id="ComponentTypeSelect"/>
                <div id="FormDefinitionGroup" style="display: none;">
                   <abp-input asp-for="FormDefinition" />
                </div>
                <div id="TempPathGroup" style="display: none;">
                   <abp-input asp-for="TempPath" />
                </div>
                 @* Input để chọn Procedures liên kết *@
                 <abp-select asp-for="ProcedureIds"
                             asp-items="Model.ComponentViewModel.AvailableProcedures"
                             label="@L["DisplayName:Component.Procedures"].Value"
                             name="ComponentViewModel.ProcedureIds"
                             class="select2-multiple"
                             multiple="true" />
            </abp-modal-body>
            <abp-modal-footer buttons="@(AbpModalButtons.Cancel | AbpModalButtons.Save)"></abp-modal-footer>
        </abp-modal>
    </abp-dynamic-form>

     @* Script sẽ được load từ file riêng (editModal.js) khi sử dụng lazy loading trong ModalManager *@
    ```

-   **Tệp 7: PageModel Sửa:** Tạo file `EditModal.cshtml.cs`
    ```csharp
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Aqt.CoreFW.Application.Contracts.Components; // Updated AppService Interface
    using Aqt.CoreFW.Application.Contracts.Components.Dtos; // Updated DTOs
    using Aqt.CoreFW.Application.Contracts.Procedures; // Interface Procedure AppService
    using Aqt.CoreFW.Web.Pages.Components.ViewModels; // Updated ViewModel
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.AspNetCore.Mvc.Rendering;
    using Volo.Abp.AspNetCore.Mvc.UI.RazorPages;
    using Aqt.CoreFW.Components; // Updated Enum

    namespace Aqt.CoreFW.Web.Pages.Components; // Updated namespace

    public class EditModalModel : AbpPageModel
    {
        [HiddenInput]
        [BindProperty(SupportsGet = true)]
        public Guid Id { get; set; }

        [BindProperty]
        public ProcedureComponentViewModel ComponentViewModel { get; set; } = new(); // Updated ViewModel

        private readonly IProcedureComponentAppService _componentAppService; // Updated AppService
        private readonly IProcedureAppService _procedureAppService; // Service để lấy lookup Procedures

        public EditModalModel(
            IProcedureComponentAppService componentAppService,
            IProcedureAppService procedureAppService)
        {
            _componentAppService = componentAppService;
            _procedureAppService = procedureAppService;
        }

        public async Task OnGetAsync()
        {
            var dto = await _componentAppService.GetAsync(Id); // Updated service call
            ComponentViewModel = ObjectMapper.Map<ProcedureComponentDto, ProcedureComponentViewModel>(dto); // Updated map
            await LoadAvailableProceduresAsync(); // Load lookup
        }

        public async Task<IActionResult> OnPostAsync()
        {
             // Manual validation for Type/Content consistency
            ValidateViewModel();

            if (!ModelState.IsValid)
            {
                await LoadAvailableProceduresAsync(); // Load lại lookup khi validation fail
                return Page();
            }
            var dto = ObjectMapper.Map<ProcedureComponentViewModel, CreateUpdateProcedureComponentDto>(ComponentViewModel); // Updated map
            await _componentAppService.UpdateAsync(Id, dto); // Updated service call
            return NoContent();
        }

        private async Task LoadAvailableProceduresAsync()
        {
             var lookupResult = await _procedureAppService.GetLookupAsync();
             ComponentViewModel.AvailableProcedures = lookupResult.Items
                 .Select(p => new SelectListItem( $"{p.Code} - {p.Name}", p.Id.ToString()))
                 .ToList();

             // Ensure currently selected IDs are marked in the list if using standard select multiple
             // For libraries like Select2, the values in ComponentViewModel.ProcedureIds are usually enough.
        }

         private void ValidateViewModel()
         {
             if (ComponentViewModel.Type == ComponentType.Form && string.IsNullOrWhiteSpace(ComponentViewModel.FormDefinition))
             {
                 ModelState.AddModelError($"{nameof(ComponentViewModel)}.{nameof(ComponentViewModel.FormDefinition)}", "Form Definition is required when Type is Form.");
             }
             if (ComponentViewModel.Type == ComponentType.File && string.IsNullOrWhiteSpace(ComponentViewModel.TempPath))
             {
                  ModelState.AddModelError($"{nameof(ComponentViewModel)}.{nameof(ComponentViewModel.TempPath)}", "Template Path is required when Type is File.");
             }
         }
    }
    ```

## 4. JavaScript (`index.js`)

-   **Vị trí:** Tạo file `src/Aqt.CoreFW.Web/wwwroot/pages/components/index.js`
-   **Nội dung:**
    ```javascript
    $(function () {
        let l = abp.localization.getResource('CoreFW');

        // Service Proxies - Kiểm tra lại tên proxy được generate!
        let componentService = aqt.coreFW.application.components.procedureComponent; // Updated Proxy name

        // Modals với lazy-loaded JS
        let createModal = new abp.ModalManager({
            viewUrl: abp.appPath + 'Components/CreateModal', // URL của trang Razor
            scriptUrl: abp.appPath + 'Pages/Components/createModal.js', // URL của file JS riêng
            modalClass: 'createComponent' // Optional: class để định danh modal nếu cần
        });

        let editModal = new abp.ModalManager({
            viewUrl: abp.appPath + 'Components/EditModal',
            scriptUrl: abp.appPath + 'Pages/Components/editModal.js', // URL của file JS riêng
            modalClass: 'editComponent' // Optional
        });


        // DataTable Instance
        let dataTable = null;

        // Function to get current filter values
        let getFilterInputs = function () {
            return {
                filter: $('#SearchFilter').val(),
                type: $('#TypeFilter').val() === "" ? null : parseInt($('#TypeFilter').val()),
                status: $('#StatusFilter').val() === "" ? null : parseInt($('#StatusFilter').val())
            };
        };

        // Function to initialize DataTable
        function initializeDataTable() {
            if (dataTable) { dataTable.destroy(); }

            dataTable = $('#ComponentTable').DataTable( // Updated table ID
                abp.libs.datatables.normalizeConfiguration({
                    serverSide: true,
                    paging: true,
                    order: [[3, "asc"], [1, "asc"]], // Sắp xếp theo Order, sau đó Code
                    searching: false, // Dùng filter tùy chỉnh
                    scrollX: true,
                    ajax: abp.libs.datatables.createAjax(componentService.getList, getFilterInputs), // Updated service call
                    columnDefs: [
                        {
                            title: l('Actions'),
                            rowAction: {
                                items: [
                                    {
                                        text: l('Edit'),
                                        icon: "fas fa-pencil-alt",
                                        // Chỉ hiển thị nút Edit nếu có quyền Update HOẶC quyền ManageLinks
                                        visible: permissions.canEdit || permissions.canManageLinks,
                                        action: (data) => { editModal.open({ id: data.record.id }); }
                                    },
                                    {
                                        text: l('Delete'),
                                        icon: "fas fa-trash",
                                        visible: permissions.canDelete,
                                        // Updated key localization and service
                                        confirmMessage: (data) => l('AreYouSureToDeleteComponent', data.record.name || data.record.code),
                                        action: (data) => {
                                            componentService.delete(data.record.id) // Updated service call
                                                .then(() => {
                                                    abp.notify.success(l('SuccessfullyDeleted'));
                                                    dataTable.ajax.reload();
                                                })
                                                .catch((error) => {
                                                    abp.notify.error(error.message || l('ErrorOccurred'));
                                                });
                                        }
                                    }
                                ]
                            }
                        },
                        // Cập nhật các key localization và data properties
                        { title: l('DisplayName:Component.Code'), data: "code" }, // Updated key
                        { title: l('DisplayName:Component.Name'), data: "name" }, // Updated key
                        { title: l('DisplayName:Component.Order'), data: "order" }, // Updated key
                        {
                            title: l('DisplayName:Component.Type'), data: "type", className: 'text-center', // Updated key
                            // Updated key localization and enum value
                            render: (data) => l('Enum:ComponentType.' + data)
                        },
                        {
                            title: l('DisplayName:Component.Status'), data: "status", className: 'text-center', // Updated key
                            // Updated key localization and enum value
                            render: (data) => `<span class="badge ${data === 1 ? 'bg-success' : 'bg-secondary'}">${l('Enum:ComponentStatus.' + data)}</span>`
                        },
                        { title: l('DisplayName:Component.Description'), data: "description", orderable: false }, // Updated key
                        // Không hiển thị FormDefinition/TempPath/ProcedureIds trong bảng list
                    ]
                })
            );
        }

        // --- Initialization ---
        initializeDataTable();

        // --- Event Handlers ---

        // Search button click or Enter
        $('#SearchButton').click(function () { dataTable.ajax.reload(); });
        $('#SearchFilter').on('keypress', function (e) { if (e.which === 13) dataTable.ajax.reload(); });

        // Filter dropdown changes
        $('#StatusFilter, #TypeFilter').change(function () {
            dataTable.ajax.reload();
        });

        // New Component button click
        $('#NewComponentButton').click(function (e) { // Updated button ID
            e.preventDefault();
            createModal.open();
        });

        // Reload table on modal success
        createModal.onResult(function () {
            dataTable.ajax.reload();
            abp.notify.success(l('SuccessfullySaved'));
        });
        editModal.onResult(function () {
            dataTable.ajax.reload();
            abp.notify.success(l('SuccessfullySaved'));
        });

        // Excel Export Button Click (if exists)
        $('#ExportExcelButton')?.on('click', function (e) {
            e.preventDefault();
            let filterInput = getFilterInputs();
            let sortInfo = dataTable ? dataTable.order()[0] : null;
            let sorting = '';

            if (sortInfo) {
                 let columnIndex = sortInfo[0];
                 let sortDirection = sortInfo[1];
                 // Map index cột hiển thị sang tên trường DTO API
                 // !! Điều chỉnh map theo thứ tự cột mới !!
                 let columnMap = { 1: 'code', 2: 'name', 3: 'order', 4: 'type', 5: 'status', 6: 'description' }; // Cập nhật map
                 let columnName = columnMap[columnIndex];
                 if (columnName) {
                     sorting = columnName + ' ' + sortDirection;
                 } else {
                     sorting = 'order asc, name asc'; // Default sort
                 }
            } else {
                sorting = 'order asc, name asc'; // Default sort
            }

            let params = new URLSearchParams();
            if (filterInput.filter) params.append('Filter', filterInput.filter);
            if (filterInput.status !== null) params.append('Status', filterInput.status);
            if (filterInput.type !== null) params.append('Type', filterInput.type); // Thêm filter Type
            if (sorting) params.append('Sorting', sorting);

            // !! Cập nhật API endpoint !!
            let exportUrl = abp.appPath + 'api/app/components/as-excel?' + params.toString(); // Updated endpoint
            location.href = exportUrl; // Trigger download
        });
    });
    ```
## 4.1 JavaScript dành riêng cho Modal (Lazy Loading)

-   **Mục đích:** Tách biệt logic JavaScript phức tạp của các modal Create và Edit ra khỏi trang Index và các file `.cshtml`, đồng thời chỉ tải JS khi modal được mở.
-   **Vị trí 1:** Tạo file `src/Aqt.CoreFW.Web/wwwroot/pages/components/createModal.js`
-   **Nội dung (`createModal.js`):**
    ```javascript
    // Sử dụng IIFE để tránh xung đột biến global
    (function ($) {
        var l = abp.localization.getResource('CoreFW');
        var form = $('#CreateComponentForm'); // ID của form trong CreateModal.cshtml

        // Khởi tạo Select2 (nếu dùng)
        // form.find('.select2-multiple').select2({ theme: 'bootstrap-5', width: '100%' });

        // Logic show/hide FormDefinition/TempPath
        var typeSelect = form.find('#ComponentTypeSelect');
        var formDefGroup = form.find('#FormDefinitionGroup');
        var tempPathGroup = form.find('#TempPathGroup');
        var formDefInput = form.find('#ComponentViewModel_FormDefinition');
        var tempPathInput = form.find('#ComponentViewModel_TempPath');

        function toggleContentFields() {
            var selectedType = parseInt(typeSelect.val());
            // Giá trị Enum ComponentType: Form = 0, File = 1 (cần kiểm tra lại)
            if (selectedType === 0) { // Form
                formDefGroup.show();
                tempPathGroup.hide();
            } else if (selectedType === 1) { // File
                formDefGroup.hide();
                tempPathGroup.show();
            } else {
                formDefGroup.hide();
                tempPathGroup.hide();
            }
        }

        // Gọi lần đầu khi modal load
        toggleContentFields();

        // Bắt sự kiện change của Type select để xóa giá trị không phù hợp và cập nhật hiển thị
        typeSelect.change(function() {
            var selectedType = parseInt($(this).val());
            if (selectedType === 0) { // Chuyển sang Form
                tempPathInput.val(''); // Xóa TempPath
            } else if (selectedType === 1) { // Chuyển sang File
                formDefInput.val(''); // Xóa FormDefinition
            } else {
                tempPathInput.val('');
                formDefInput.val('');
            }
            toggleContentFields(); // Cập nhật hiển thị
        });

        // Thêm JS tùy chỉnh khác cho Create Modal ở đây...

    })(jQuery);
    ```
-   **Vị trí 2:** Tạo file `src/Aqt.CoreFW.Web/wwwroot/pages/components/editModal.js`
-   **Nội dung (`editModal.js`):** (Tương tự `createModal.js` nhưng dùng ID form khác)
    ```javascript
    // Sử dụng IIFE
    (function ($) {
        var l = abp.localization.getResource('CoreFW');
        var form = $('#EditComponentForm'); // ID của form trong EditModal.cshtml

        // Khởi tạo Select2 (nếu dùng)
        // form.find('.select2-multiple').select2({ theme: 'bootstrap-5', width: '100%' });

        // Logic show/hide FormDefinition/TempPath
        var typeSelect = form.find('#ComponentTypeSelect');
        var formDefGroup = form.find('#FormDefinitionGroup');
        var tempPathGroup = form.find('#TempPathGroup');
        var formDefInput = form.find('#ComponentViewModel_FormDefinition');
        var tempPathInput = form.find('#ComponentViewModel_TempPath');

        function toggleContentFields() {
            var selectedType = parseInt(typeSelect.val());
             // Giá trị Enum ComponentType: Form = 0, File = 1
            if (selectedType === 0) { // Form
                formDefGroup.show();
                tempPathGroup.hide();
            } else if (selectedType === 1) { // File
                formDefGroup.hide();
                tempPathGroup.show();
            } else {
                formDefGroup.hide();
                tempPathGroup.hide();
            }
        }

        // Gọi lần đầu khi modal edit load
        toggleContentFields();

        // Bắt sự kiện change của Type select để xóa giá trị không phù hợp và cập nhật hiển thị
        typeSelect.change(function() {
            var selectedType = parseInt($(this).val());
            if (selectedType === 0) { // Chuyển sang Form
                tempPathInput.val(''); // Xóa TempPath
            } else if (selectedType === 1) { // Chuyển sang File
                formDefInput.val(''); // Xóa FormDefinition
            }
           // Không xóa cả 2 nếu giá trị không xác định để giữ lại giá trị ban đầu nếu người dùng chọn lại
            toggleContentFields(); // Cập nhật hiển thị
        });

        // Thêm JS tùy chỉnh khác cho Edit Modal ở đây...

    })(jQuery);
    ```

## 5. Localization (Checklist)

Đảm bảo các key localization sau đã được định nghĩa trong các file `*.json` ở tầng `Domain.Shared`:

-   `Menu:ComponentManagement`
-   `Menu:Components`
-   `Components`
-   `NewComponent`
-   `EditComponent`
-   `DisplayName:Component.Code`
-   `DisplayName:Component.Name`
-   `DisplayName:Component.Status`
-   `DisplayName:Component.Order`
-   `DisplayName:Component.Description`
-   `DisplayName:Component.Type`
-   `DisplayName:Component.FormDefinition`
-   `DisplayName:Component.TempPath`
-   `DisplayName:Component.Procedures` (Label cho phần chọn Procedures)
-   `Enum:ComponentStatus.0`
-   `Enum:ComponentStatus.1`
-   `Enum:ComponentType.0`
-   `Enum:ComponentType.1`
-   `AreYouSureToDeleteComponent`
-   `Permission:ComponentManagement`
-   `Permission:Components`
-   `Permission:Components.Create`
-   `Permission:Components.Update`
-   `Permission:Components.Delete`
-   `Permission:Components.ManageProcedureLinks`
-   `Permission:Components.Export` (Nếu có export)
-   `ComponentCodeCannotBeChanged` (Thông báo lỗi khi sửa code)
-   `OneOrMoreProceduresNotFound` (Thông báo lỗi khi ID procedure không hợp lệ)
-   *(Các key dùng chung như `Actions`, `Search`, `All`, `ErrorOccurred`, `SuccessfullyDeleted`, `SuccessfullySaved`, `ExportToExcel` đã có sẵn hoặc cần kiểm tra)*

## 6. Lưu ý

*   **UI Framework:** Giả định sử dụng ABP Blazor Server UI với Razor Pages, Tag Helpers và Modal Manager.
*   **ViewModel:** `ProcedureComponentViewModel` bao gồm các trường `Type`, `FormDefinition`, `TempPath`, `ProcedureIds` và `AvailableProcedures` (để load lookup). Trường `Code` được đánh dấu `ReadOnlyInput` trong ViewModel.
*   **AutoMapper:** Cập nhật profile để map giữa `ProcedureComponentViewModel` và DTOs.
*   **JavaScript Proxy:** Kiểm tra lại tên service proxy JavaScript (`aqt.coreFW.application.components.procedureComponent`).
*   **Lookups:** PageModel của Create/Edit Modal cần inject `IProcedureAppService` và gọi `GetLookupAsync` để lấy danh sách `Procedure` cho người dùng chọn liên kết.
*   **UI for Linking:** Kế hoạch này đề xuất sử dụng `abp-select` với `multiple="true"` (có thể tích hợp Select2).
*   **UI for Type:** Logic ẩn/hiện các trường `FormDefinition`/`TempPath` dựa trên `Type` được chuyển vào các file JS riêng (`createModal.js`, `editModal.js`) và được lazy load bởi `abp.ModalManager`. Các thẻ `<abp-script>` inline đã được xóa khỏi `.cshtml` của modal.
*   **Permissions:** JS và C# kiểm tra quyền `CoreFWPermissions.Components`. Quyền `ManageProcedureLinks` được truyền vào JS.
*   **Validation:** Validation cơ bản dùng DataAnnotations. Validation `RequiredIf` cho Type/Content được thực hiện trong PageModel (`ValidateViewModel`).
*   **API Endpoints:** Cập nhật URL trong JS để trỏ đến API của Components (`/api/app/components/...`).
*   **Sorting/Filtering:** JS được cập nhật để xử lý filter theo `Type` và các cột mới trong DataTable.